<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compliance — Mickey</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --green:#1B4F40;--green-light:#EAF1ED;--green-border:#C4DACE;--green-mid:#153D31;
  --cream:#F5F3EE;--cream-mid:#EAE6DF;--cream-dark:#D8D4CC;
  --white:#FFFFFF;--text:#1A1916;--text-mid:#706C65;--text-muted:#A8A49D;--text-faint:#C4BFB6;
  --amber:#C8A030;--amber-bg:#FFFBF0;--amber-border:#F0E8CC;
  --red:#C0392B;--red-bg:#FAEAE8;--red-border:#E8BCBC;
  --blue:#3A5BBF;--blue-bg:#EEF2FF;--blue-border:#C8D4F5;
  --success:#2D7A4F;--success-bg:#EAF4EE;--success-border:#B8DEC8;
  --purple:#6B3FA0;--purple-bg:#F3EEFF;--purple-border:#D4C2F0;
  --font-serif:'Lora',Georgia,serif;--font-sans:'Inter',sans-serif;--font-mono:'JetBrains Mono',monospace;
  --r:8px;--r-lg:12px;--r-xl:16px;
}
html,body{height:100%;font-family:var(--font-sans);font-size:13px;color:var(--text);background:var(--cream);line-height:1.5;-webkit-font-smoothing:antialiased;}
.app{display:flex;height:100vh;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:196px;flex-shrink:0;background:var(--white);border-right:1px solid var(--cream-mid);display:flex;flex-direction:column;overflow-y:auto;}
.sidebar-logo{padding:15px 15px 13px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:9px;}
.logo-mark{width:27px;height:27px;background:var(--green);border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:var(--font-serif);font-style:italic;color:#fff;font-size:15px;font-weight:600;text-decoration:none;}
.logo-text{font-family:var(--font-serif);font-size:17px;font-weight:600;color:var(--green);letter-spacing:-.3px;}
.user-row{padding:9px 13px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:8px;}
.user-avatar{width:26px;height:26px;border-radius:50%;background:var(--green);color:#fff;font-size:9.5px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.user-name{font-size:11.5px;font-weight:500;color:var(--text);line-height:1.2;}
.user-role{font-size:10px;color:var(--text-muted);}
.nav-group-label{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);padding:13px 13px 3px;}
.nav-item{display:flex;align-items:center;gap:7px;padding:6px 13px;cursor:pointer;color:var(--text-mid);font-size:12px;border-left:2px solid transparent;transition:all .12s;text-decoration:none;}
.nav-item:hover{background:var(--cream);color:var(--text);}
.nav-item.active{background:var(--green-light);color:var(--green);border-left-color:var(--green);font-weight:600;}
.nav-item svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.nav-badge{margin-left:auto;font-size:9.5px;font-weight:700;padding:1px 5px;border-radius:10px;line-height:1.6;}
.nb-red{background:var(--red-bg);color:var(--red);}
.nb-amber{background:var(--amber-bg);color:var(--amber);}
.nb-muted{background:var(--cream-mid);color:var(--text-muted);}

/* MAIN */
.main{flex:1;display:flex;overflow:hidden;}

/* SUB NAV */
.sub-nav{width:182px;flex-shrink:0;background:var(--cream);border-right:1px solid var(--cream-dark);overflow-y:auto;padding:14px 0;}
.sub-title{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);padding:0 13px 8px;}
.sub-item{display:flex;align-items:center;justify-content:space-between;padding:6px 13px;cursor:pointer;color:var(--text-mid);font-size:12px;border-left:2px solid transparent;transition:all .1s;user-select:none;}
.sub-item:hover{background:var(--cream-mid);color:var(--text);}
.sub-item.active{background:var(--white);color:var(--green);border-left-color:var(--green);font-weight:600;}
.sub-item-inner{display:flex;align-items:center;gap:6px;}
.sub-item svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.sub-divider{height:1px;background:var(--cream-dark);margin:7px 13px;}
.sub-section-label{font-size:8.5px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);padding:8px 13px 3px;}

/* CONTENT AREA */
.content{flex:1;overflow-y:auto;display:flex;flex-direction:column;background:var(--cream);}

/* TOPBAR */
.topbar{padding:18px 22px 0;display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0;background:var(--cream);}
.topbar-left h1{font-family:var(--font-serif);font-size:18px;font-weight:500;margin-bottom:2px;}
.topbar-left p{font-size:11px;color:var(--text-muted);}
.topbar-actions{display:flex;gap:6px;align-items:center;padding-top:2px;flex-wrap:wrap;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--r);font-size:12px;font-weight:500;cursor:pointer;border:none;font-family:var(--font-sans);transition:all .12s;white-space:nowrap;}
.btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.btn-primary{background:var(--green);color:#fff;}
.btn-primary:hover{background:var(--green-mid);}
.btn-primary:disabled{background:var(--cream-dark);color:var(--text-muted);cursor:not-allowed;}
.btn-secondary{background:var(--white);color:var(--text-mid);border:1px solid var(--cream-dark);}
.btn-secondary:hover{background:var(--cream);}
.btn-danger{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.btn-danger:hover{background:var(--red-border);}
.btn-sm{padding:4px 9px;font-size:11px;}
.btn-ghost{background:transparent;color:var(--text-muted);padding:4px 9px;border:1px solid var(--cream-dark);border-radius:var(--r);font-size:11px;cursor:pointer;font-family:var(--font-sans);}

/* RAG STRIP */
.rag-strip{display:flex;gap:7px;padding:12px 22px;flex-shrink:0;}
.rag-card{display:flex;align-items:center;gap:9px;background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:9px 13px;flex:1;}
.rag-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.rag-num{font-family:var(--font-serif);font-size:20px;font-weight:500;line-height:1;}
.rag-label{font-size:10px;color:var(--text-muted);margin-top:1px;}

/* FILTER BAR */
.filter-bar{display:flex;align-items:center;gap:6px;padding:0 22px 10px;flex-wrap:wrap;}
.search-wrap{display:flex;align-items:center;gap:6px;background:var(--white);border:1px solid var(--cream-dark);border-radius:var(--r);padding:6px 10px;font-size:12px;color:var(--text-muted);min-width:200px;}
.search-wrap input{border:none;outline:none;background:transparent;font-size:12px;font-family:var(--font-sans);color:var(--text);width:100%;}
.search-wrap svg{width:11px;height:11px;stroke:var(--text-muted);fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.chip{display:inline-flex;align-items:center;gap:4px;background:var(--white);border:1px solid var(--cream-dark);border-radius:20px;padding:3px 10px;font-size:11px;color:var(--text-mid);cursor:pointer;transition:all .1s;}
.chip:hover{background:var(--cream);}
.chip.active{background:var(--green-light);border-color:var(--green-border);color:var(--green);font-weight:500;}

/* TABLE */
.section{padding:0 22px 22px;}
.table-wrap{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{font-size:9.5px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-faint);background:var(--cream);padding:8px 13px;text-align:left;border-bottom:1px solid var(--cream-mid);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--cream-mid);transition:background .1s;cursor:pointer;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:#FAFAF8;}
tbody tr.row-red{background:var(--red-bg);}
tbody tr.row-red:hover{background:#F5DDD9;}
tbody tr.row-amber{background:var(--amber-bg);}
tbody tr.row-amber:hover{background:#FFF6E0;}
tbody td{padding:9px 13px;font-size:12px;color:var(--text);vertical-align:middle;}
.td-main{font-weight:500;line-height:1.3;}
.td-sub{font-size:10px;color:var(--text-muted);margin-top:2px;}

/* PILLS */
.pill{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:500;white-space:nowrap;}
.pill::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.pill-red{background:var(--red-bg);color:var(--red);}.pill-red::before{background:var(--red);}
.pill-amber{background:var(--amber-bg);color:var(--amber);}.pill-amber::before{background:var(--amber);}
.pill-green{background:var(--success-bg);color:var(--success);}.pill-green::before{background:var(--success);}
.pill-blue{background:var(--blue-bg);color:var(--blue);}.pill-blue::before{background:var(--blue);}
.pill-muted{background:var(--cream-mid);color:var(--text-muted);}.pill-muted::before{background:var(--text-faint);}
.pill-purple{background:var(--purple-bg);color:var(--purple);}.pill-purple::before{background:var(--purple);}

/* DEADLINE */
.dl{display:inline-flex;align-items:center;gap:4px;font-size:11px;}
.dl svg{width:11px;height:11px;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.dl-red{color:var(--red);}.dl-red svg{stroke:var(--red);}
.dl-amber{color:var(--amber);}.dl-amber svg{stroke:var(--amber);}
.dl-ok{color:var(--text-muted);}.dl-ok svg{stroke:var(--text-muted);}

/* AVATARS */
.av{width:22px;height:22px;border-radius:50%;background:var(--green-light);color:var(--green);font-size:9px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;}

/* ALERTS */
.alert-bar{display:flex;align-items:flex-start;gap:8px;border-radius:var(--r);padding:9px 12px;font-size:11.5px;margin-bottom:10px;line-height:1.5;}
.alert-bar svg{width:13px;height:13px;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;margin-top:1px;}
.alert-red{background:var(--red-bg);border:1px solid var(--red-border);color:var(--red);}.alert-red svg{stroke:var(--red);}
.alert-amber{background:var(--amber-bg);border:1px solid var(--amber-border);color:#7a5a10;}.alert-amber svg{stroke:var(--amber);}
.alert-blue{background:var(--blue-bg);border:1px solid var(--blue-border);color:var(--blue);}.alert-blue svg{stroke:var(--blue);}

/* EMPTY STATE */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 22px;text-align:center;color:var(--text-muted);}
.empty svg{width:34px;height:34px;stroke:var(--cream-dark);fill:none;stroke-width:1.4;margin-bottom:12px;}
.empty h3{font-family:var(--font-serif);font-size:15px;color:var(--text-mid);margin-bottom:5px;font-weight:500;}
.empty p{font-size:11.5px;max-width:240px;line-height:1.7;}

/* INFO GRID */
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.info-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:12px 15px;}
.info-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:4px;}
.info-val{font-size:12.5px;color:var(--text);}

/* RISK BADGES */
.risk-box{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:10.5px;font-weight:600;}
.risk-high{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.risk-medium{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-border);}
.risk-low{background:var(--success-bg);color:var(--success);border:1px solid var(--success-border);}

/* DEADLINE BAR */
.deadline-bar{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:12px 16px;display:flex;align-items:center;gap:14px;margin-bottom:10px;}
.deadline-bar.urgent{background:var(--red-bg);border-color:var(--red-border);}
.deadline-bar.warn{background:var(--amber-bg);border-color:var(--amber-border);}
.dl-days{font-family:var(--font-serif);font-size:28px;font-weight:500;line-height:1;width:50px;text-align:center;flex-shrink:0;}
.dl-days.urgent{color:var(--red);}
.dl-days.warn{color:var(--amber);}
.dl-body{flex:1;}
.dl-body strong{display:block;font-size:12.5px;font-weight:600;}
.dl-body span{font-size:11px;color:var(--text-muted);}

/* PROGRESS */
.progress-wrap{background:var(--cream-mid);border-radius:4px;height:4px;overflow:hidden;width:90px;}
.progress-bar{height:100%;border-radius:4px;}
.pb-green{background:var(--success);}.pb-amber{background:var(--amber);}.pb-red{background:var(--red);}

/* DPO CARD */
.dpo-hero{background:var(--white);border:1px solid var(--green-border);border-radius:var(--r-lg);padding:16px 20px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:16px;}
.dpo-avatar{width:40px;height:40px;border-radius:50%;background:var(--green);color:#fff;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.dpo-stats{display:flex;gap:22px;}
.dpo-stat{text-align:center;}
.dpo-stat-num{font-family:var(--font-serif);font-size:18px;font-weight:500;}
.dpo-stat-lbl{font-size:9.5px;color:var(--text-muted);}

/* DASHBOARD WIDGETS */
.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px 22px 22px;}
.dash-widget{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:16px 18px;cursor:pointer;transition:border-color .12s;}
.dash-widget:hover{border-color:var(--green-border);}
.dash-widget-title{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:12px;}
.dash-rag-row{display:flex;gap:8px;margin-bottom:14px;}
.dash-rag-item{flex:1;text-align:center;}
.dash-rag-num{font-family:var(--font-serif);font-size:22px;font-weight:500;line-height:1;}
.dash-rag-lbl{font-size:9.5px;color:var(--text-muted);margin-top:2px;}
.dash-actions{display:flex;flex-direction:column;gap:0;}
.dash-action{display:flex;align-items:center;gap:8px;font-size:11.5px;padding:6px 0;border-bottom:1px solid var(--cream-mid);}
.dash-action:last-child{border-bottom:none;}
.dash-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.dash-action-text{flex:1;color:var(--text);}
.dash-action-tag{font-size:10px;color:var(--text-muted);white-space:nowrap;}
.dash-empty{font-size:11.5px;color:var(--text-muted);text-align:center;padding:12px 0;font-style:italic;}

/* POLICY CARDS */
.policy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;padding:0 22px 22px;}
.policy-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:14px 16px;cursor:pointer;transition:border-color .12s;}
.policy-card:hover{border-color:var(--green-border);}
.policy-card-top{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;}
.p-icon{width:34px;height:34px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.p-icon svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.p-icon-doc{background:var(--blue-bg);color:var(--blue);}
.p-icon-advice{background:var(--green-light);color:var(--green);}
.p-icon-template{background:var(--purple-bg);color:var(--purple);}
.p-icon-radar{background:var(--amber-bg);color:var(--amber);}
.policy-name{font-size:12.5px;font-weight:500;line-height:1.3;}
.policy-meta{font-size:10.5px;color:var(--text-muted);margin-top:2px;}
.policy-footer{display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
.p-tag{display:inline-flex;align-items:center;gap:3px;font-size:9.5px;font-weight:600;padding:2px 7px;border-radius:20px;white-space:nowrap;}
.p-tag-kb{background:var(--success-bg);color:var(--success);}
.p-tag-radar{background:var(--amber-bg);color:var(--amber);}
.p-tag-module{background:var(--cream-mid);color:var(--text-mid);}
.policy-add-card{border:1px dashed var(--cream-dark);border-radius:var(--r-lg);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:110px;gap:6px;color:var(--text-muted);cursor:pointer;transition:border-color .12s;}
.policy-add-card:hover{border-color:var(--green);color:var(--green);}
.policy-add-card svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}

/* RADAR BANNER */
.radar-banner{display:flex;align-items:center;gap:10px;background:var(--amber-bg);border:1px solid var(--amber-border);border-radius:var(--r-lg);padding:11px 16px;margin:0 22px 12px;cursor:pointer;transition:border-color .12s;}
.radar-banner:hover{border-color:var(--amber);}
.radar-banner svg{width:14px;height:14px;stroke:var(--amber);fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.radar-banner-text{flex:1;font-size:11.5px;color:#7a5a10;}
.radar-banner-text strong{display:block;font-size:12px;font-weight:600;color:#5a3f00;margin-bottom:1px;}

/* ROLE TOGGLE */
.role-toggle{display:flex;background:var(--cream);border-radius:var(--r);padding:3px;gap:3px;}
.role-btn{flex:1;padding:5px 10px;border-radius:6px;border:none;font-size:11.5px;font-weight:500;cursor:pointer;font-family:var(--font-sans);color:var(--text-muted);background:transparent;transition:all .12s;}
.role-btn.active{background:var(--white);color:var(--green);font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.08);}

/* FORM */
.form-row{display:flex;gap:10px;margin-bottom:10px;}
.form-group{flex:1;}
.form-group label{display:block;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;}
.form-control{width:100%;background:var(--white);border:1px solid var(--cream-dark);border-radius:var(--r);padding:7px 10px;font-size:12px;font-family:var(--font-sans);color:var(--text);outline:none;transition:border-color .1s;}
.form-control:focus{border-color:var(--green);}
.form-control:disabled{background:var(--cream);color:var(--text-muted);}
.form-hint{font-size:10px;color:var(--text-muted);margin-top:3px;line-height:1.5;}
.form-section-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-top:16px;margin-bottom:8px;padding-top:12px;border-top:1px solid var(--cream-mid);}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(26,25,22,.38);z-index:200;align-items:center;justify-content:center;}
.overlay.open{display:flex;}
.modal{background:var(--white);border-radius:var(--r-xl);padding:26px;width:540px;max-height:86vh;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.16);}
.modal-wide{width:680px;}
.modal-title{font-family:var(--font-serif);font-size:17px;font-weight:500;margin-bottom:3px;}
.modal-sub{font-size:11px;color:var(--text-muted);margin-bottom:18px;line-height:1.6;}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:18px;padding-top:14px;border-top:1px solid var(--cream-mid);}

/* VIEWS */
.view{display:none;flex-direction:column;min-height:100%;}
.view.active{display:flex;}

/* STAGE PROGRESS */
.stage-track{display:flex;gap:3px;margin-bottom:4px;}
.stage-pip{flex:1;height:4px;border-radius:2px;background:var(--cream-mid);}
.stage-pip.done{background:var(--success);}
.stage-pip.current{background:var(--amber);}

/* SECTION DIVIDER */
.sec-divider{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);margin:18px 0 12px;display:flex;align-items:center;gap:8px;}
.sec-divider::after{content:'';flex:1;height:1px;background:var(--cream-mid);}

/* USER MATRIX */
.user-matrix{width:100%;border-collapse:collapse;}
.user-matrix th{font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-faint);padding:8px 10px;text-align:left;border-bottom:1px solid var(--cream-mid);}
.user-matrix td{padding:10px;border-bottom:1px solid var(--cream-mid);font-size:12px;vertical-align:middle;}
.user-matrix tr:last-child td{border-bottom:none;}
.user-matrix input[type=checkbox]{width:15px;height:15px;accent-color:var(--green);}

/* TOAST */
#toast{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:6px;}
.toast-item{background:var(--text);color:#fff;padding:10px 16px;border-radius:var(--r-lg);font-size:12.5px;box-shadow:0 4px 16px rgba(0,0,0,.2);animation:slide-in .2s ease;max-width:320px;}
.toast-item.toast-ok{background:var(--success);}
.toast-item.toast-err{background:var(--red);}
@keyframes slide-in{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--cream-dark);border-radius:10px;}

/* MISC */
.chevron{color:var(--text-faint);font-size:15px;}
.badge-tag{display:inline-flex;font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;}
.badge-blue{background:var(--blue-bg);color:var(--blue);}
.badge-muted{background:var(--cream-mid);color:var(--text-mid);}
.badge-green{background:var(--success-bg);color:var(--success);}
.badge-amber{background:var(--amber-bg);color:var(--amber);}
.badge-red{background:var(--red-bg);color:var(--red);}
.badge-purple{background:var(--purple-bg);color:var(--purple);}
.country-risk-high{font-size:10px;background:var(--red-bg);color:var(--red);padding:2px 5px;border-radius:4px;font-weight:600;}
.country-risk-medium{font-size:10px;background:var(--amber-bg);color:var(--amber);padding:2px 5px;border-radius:4px;font-weight:600;}
.country-risk-low{font-size:10px;background:var(--cream-mid);color:var(--text-mid);padding:2px 5px;border-radius:4px;font-weight:600;}
.mono{font-family:var(--font-mono);font-size:10.5px;color:var(--text-muted);}
.viewer-hidden{display:none !important;}

</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <a class="logo-mark" href="/app">m</a>
    <span class="logo-text">mickey</span>
  </div>
  <div class="user-row">
    <div class="user-avatar" id="sb-avatar">?</div>
    <div>
      <div class="user-name" id="sb-name">Loading…</div>
      <div class="user-role" id="sb-role"></div>
    </div>
  </div>
  <div class="nav-group-label">Workspace</div>
  <a class="nav-item" href="/app">
    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard
  </a>
  <div class="nav-group-label">Tools</div>
  <a class="nav-item" href="/legal-radar">
    <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Legal Radar
    <span class="nav-badge nb-red" id="sb-radar-badge" style="display:none"></span>
  </a>
  <a class="nav-item" href="/documents">
    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Documents
  </a>
  <a class="nav-item" href="/corporate">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Corporate
  </a>
  <a class="nav-item active" href="/compliance">
    <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Compliance
    <span class="nav-badge nb-red" id="sb-compliance-badge" style="display:none"></span>
  </a>
  <div class="nav-group-label">Knowledge</div>
  <a class="nav-item" href="/knowledge">
    <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Knowledge Base
  </a>
  <div class="nav-group-label">System</div>
  <a class="nav-item" href="/settings" id="sb-settings">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Settings
  </a>
  <a class="nav-item" href="/auth/logout" style="margin-top:auto;margin-bottom:6px;">
    <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign out
  </a>
</nav>

<div class="main">

<!-- GDPR MODULE -->
<div id="module-gdpr" class="module" style="display:flex;flex:1;overflow:hidden;">
  <div class="sub-nav">
    <div class="sub-title">GDPR</div>
    <div class="sub-item active" data-view="dpo" onclick="setView('gdpr','dpo')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>DPO</div>
    </div>
    <div class="sub-item" data-view="ropa" onclick="setView('gdpr','ropa')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/></svg>RoPA</div>
      <span class="nav-badge nb-amber" id="badge-ropa" style="display:none"></span>
    </div>
    <div class="sub-item" data-view="dsr" onclick="setView('gdpr','dsr')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>DSRs</div>
      <span class="nav-badge nb-red" id="badge-dsr" style="display:none"></span>
    </div>
    <div class="sub-item" data-view="breach" onclick="setView('gdpr','breach')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Data Breaches</div>
      <span class="nav-badge nb-red" id="badge-breach" style="display:none"></span>
    </div>
    <div class="sub-item" data-view="dpia" onclick="setView('gdpr','dpia')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>DPIAs</div>
      <span class="nav-badge nb-amber" id="badge-dpia" style="display:none"></span>
    </div>
    <div class="sub-item" data-view="tia" onclick="setView('gdpr','tia')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>TIAs</div>
      <span class="nav-badge nb-muted" id="badge-tia" style="display:none"></span>
    </div>
    <div class="sub-item" data-view="dpa" onclick="setView('gdpr','dpa')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"/><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"/></svg>DPAs</div>
      <span class="nav-badge nb-muted" id="badge-dpa" style="display:none"></span>
    </div>
    <div class="sub-divider"></div>
    <div class="sub-item" data-view="gdpr-policies" onclick="setView('gdpr','gdpr-policies')">
      <div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Policies &amp; Advice</div>
    </div>
    <div class="sub-divider"></div>
    <div class="sub-section-label">Other modules</div>
    <div class="sub-item" onclick="setModule('abc')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>Anti-Bribery</div></div>
    <div class="sub-item" id="sub-wb-link" onclick="setModule('wb')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg>Whistleblowing</div></div>
    <div class="sub-divider"></div>
    <div class="sub-section-label">Export</div>
    <div class="sub-item" onclick="exportAudit('gdpr')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Audit report</div></div>
  </div>

  <!-- GDPR CONTENT -->
  <div class="content" id="gdpr-content">

    <!-- DPO VIEW -->
    <div class="view active" id="view-gdpr-dpo">
      <div class="topbar">
        <div class="topbar-left"><h1>Data Protection Officer</h1><p id="dpo-subtitle">Art. 37–39 GDPR · Appointment, rationale &amp; supervisory authority</p></div>
        <div class="topbar-actions">
          <button class="btn btn-secondary editor-only" onclick="openModal('modal-dpo')"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>Edit DPO record</button>
        </div>
      </div>
      <div style="padding:14px 22px;overflow-y:auto;flex:1;" id="dpo-content">
        <div class="empty">
          <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          <h3>No DPO record</h3>
          <p>Add your Data Protection Officer details to get started.</p>
          <button class="btn btn-primary editor-only" style="margin-top:12px;" onclick="openModal('modal-dpo')">Add DPO record</button>
        </div>
      </div>
    </div>

    <!-- ROPA VIEW -->
    <div class="view" id="view-gdpr-ropa">
      <div class="topbar">
        <div class="topbar-left"><h1>Record of Processing Activities</h1><p>Art. 30 GDPR · Controller (Art. 30(1)) and processor (Art. 30(2)) records</p></div>
        <div class="topbar-actions">
          <button class="btn btn-secondary" onclick="exportRegister('ropa')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export Art. 30</button>
          <button class="btn btn-primary editor-only" onclick="openModal('modal-ropa')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add activity</button>
        </div>
      </div>
      <div class="rag-strip" id="ropa-rag"></div>
      <div class="filter-bar">
        <div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search activities…" oninput="filterTable('ropa-table',this.value)"></div>
        <span class="chip active" onclick="filterChip(this,'ropa-table','','role')">All</span>
        <span class="chip" onclick="filterChip(this,'ropa-table','controller','role')">Controller</span>
        <span class="chip" onclick="filterChip(this,'ropa-table','processor','role')">Processor</span>
      </div>
      <div class="section">
        <div class="table-wrap"><table id="ropa-table">
          <thead><tr><th style="width:26%">Processing activity</th><th>Role</th><th>Legal basis</th><th>Data categories</th><th>Retention</th><th>Review due</th><th>Status</th><th></th></tr></thead>
          <tbody id="ropa-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No activities recorded yet.</p></div></td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- DSR VIEW -->
    <div class="view" id="view-gdpr-dsr">
      <div class="topbar">
        <div class="topbar-left"><h1>Data Subject Requests</h1><p>Art. 15–22 GDPR · 1 calendar month deadline · Controller vs processor determines response path</p></div>
        <div class="topbar-actions">
          <button class="btn btn-primary editor-only" onclick="openModal('modal-dsr')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log DSR</button>
        </div>
      </div>
      <div class="rag-strip" id="dsr-rag"></div>
      <div class="filter-bar">
        <div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search requests…" oninput="filterTable('dsr-table',this.value)"></div>
        <span class="chip active" onclick="filterChip(this,'dsr-table','','status')">Open</span>
        <span class="chip" onclick="filterChip(this,'dsr-table','closed','status')">Closed</span>
        <span class="chip" onclick="filterChip(this,'dsr-table','controller','role')">Controller</span>
        <span class="chip" onclick="filterChip(this,'dsr-table','processor','role')">Processor</span>
      </div>
      <div class="section">
        <div id="dsr-alerts"></div>
        <div class="table-wrap"><table id="dsr-table">
          <thead><tr><th>Requester</th><th>Right</th><th>Role</th><th>Received</th><th>Deadline</th><th>Days left</th><th>Status</th><th class="editor-only"></th></tr></thead>
          <tbody id="dsr-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DSRs recorded yet.</p></div></td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- BREACH VIEW -->
    <div class="view" id="view-gdpr-breach">
      <div class="topbar">
        <div class="topbar-left"><h1>Data Breaches</h1><p>Art. 33–34 GDPR · 72-hour SA notification clock from detection</p></div>
        <div class="topbar-actions">
          <button class="btn btn-primary editor-only" onclick="openModal('modal-breach')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log breach</button>
        </div>
      </div>
      <div class="rag-strip" id="breach-rag"></div>
      <div class="section" style="padding-top:8px;">
        <div id="breach-alerts"></div>
        <div class="table-wrap"><table>
          <thead><tr><th>Ref</th><th style="width:28%">Description</th><th>Type</th><th>Detected</th><th>72h deadline</th><th>Risk</th><th>Status</th><th class="editor-only"></th></tr></thead>
          <tbody id="breach-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No breaches recorded.</p></div></td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- DPIA VIEW -->
    <div class="view" id="view-gdpr-dpia">
      <div class="topbar">
        <div class="topbar-left"><h1>Data Protection Impact Assessments</h1><p>Art. 35 GDPR · 7-stage workflow · DPO consultation mandatory</p></div>
        <div class="topbar-actions">
          <button class="btn btn-primary editor-only" onclick="openModal('modal-dpia')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Start DPIA</button>
        </div>
      </div>
      <div class="rag-strip" id="dpia-rag"></div>
      <div class="section">
        <div class="table-wrap"><table>
          <thead><tr><th style="width:28%">Processing activity</th><th>Stage</th><th>Role</th><th>DPO consulted</th><th>Risk level</th><th>Status</th><th class="editor-only"></th></tr></thead>
          <tbody id="dpia-tbody"><tr><td colspan="7"><div class="empty" style="padding:30px"><p>No DPIAs started.</p></div></td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- TIA VIEW -->
    <div class="view" id="view-gdpr-tia">
      <div class="topbar">
        <div class="topbar-left"><h1>Transfer Impact Assessments</h1><p>Art. 44+ GDPR · Post-Schrems II · One TIA per exporter–importer–country combination</p></div>
        <div class="topbar-actions">
          <button class="btn btn-primary editor-only" onclick="openModal('modal-tia')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New TIA</button>
        </div>
      </div>
      <div class="rag-strip" id="tia-rag"></div>
      <div class="section">
        <div class="table-wrap"><table>
          <thead><tr><th>Importer</th><th>Country</th><th>Mechanism</th><th>Risk</th><th>Reassess by</th><th>DPA linked</th><th>Status</th><th class="editor-only"></th></tr></thead>
          <tbody id="tia-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No TIAs recorded.</p></div></td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- DPA VIEW -->
    <div class="view" id="view-gdpr-dpa">
      <div class="topbar">
        <div class="topbar-left"><h1>Data Processing Agreements</h1><p>Art. 28 GDPR · Agreements with processors and controllers</p></div>
        <div class="topbar-actions">
          <button class="btn btn-primary editor-only" onclick="openModal('modal-dpa')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add DPA</button>
        </div>
      </div>
      <div class="section" style="padding-top:14px;">
        <div class="table-wrap"><table>
          <thead><tr><th style="width:25%">Counterparty</th><th>Our role</th><th>Purpose</th><th>TIA linked</th><th>Signed</th><th>Review</th><th>Status</th><th class="editor-only"></th></tr></thead>
          <tbody id="dpa-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DPAs recorded.</p></div></td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- GDPR POLICIES VIEW -->
    <div class="view" id="view-gdpr-gdpr-policies">
      <div class="topbar" style="padding-bottom:10px;">
        <div class="topbar-left"><h1>Policies &amp; Advice — GDPR</h1><p>Policies, guidance notes and Mickey-generated advice · Searchable in Knowledge Base</p></div>
        <div class="topbar-actions">
          <button class="btn btn-secondary editor-only" onclick="openModal('modal-upload-policy','gdpr')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Upload document</button>
          <button class="btn btn-primary editor-only" onclick="openModal('modal-add-advice','gdpr')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add advice note</button>
        </div>
      </div>
      <div class="radar-banner" onclick="window.location.href='/legal-radar'">
        <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <div class="radar-banner-text"><strong id="radar-gdpr-title">Legal Radar — GDPR</strong><span id="radar-gdpr-sub">View regulatory updates relevant to GDPR</span></div>
        <span style="color:var(--amber);font-size:16px;">›</span>
      </div>
      <div class="filter-bar">
        <div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search…" oninput="filterPolicies('gdpr',this.value)"></div>
        <span class="chip active">All</span><span class="chip" onclick="filterPolicies('gdpr','','policy')">Policy</span><span class="chip" onclick="filterPolicies('gdpr','','advice')">Advice</span><span class="chip" onclick="filterPolicies('gdpr','','template')">Template</span>
      </div>
      <div class="policy-grid" id="policies-gdpr"></div>
    </div>

  </div><!-- /gdpr-content -->
</div><!-- /module-gdpr -->

<!-- ABC MODULE -->
<div id="module-abc" class="module" style="display:none;flex:1;overflow:hidden;">
  <div class="sub-nav">
    <div class="sub-title">Anti-Bribery</div>
    <div class="sub-item active" data-view="gifts" onclick="setView('abc','gifts')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/></svg>Gifts &amp; Hospitality</div><span class="nav-badge nb-amber" id="badge-gifts" style="display:none"></span></div>
    <div class="sub-item" data-view="coi" onclick="setView('abc','coi')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/><line x1="20" y1="8" x2="20" y2="14"/></svg>Conflicts of Interest</div><span class="nav-badge nb-amber" id="badge-coi" style="display:none"></span></div>
    <div class="sub-item" data-view="tpdd" onclick="setView('abc','tpdd')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Third-Party DD</div><span class="nav-badge nb-red" id="badge-tpdd" style="display:none"></span></div>
    <div class="sub-item" data-view="donations" onclick="setView('abc','donations')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Political Donations</div></div>
    <div class="sub-item editor-only" data-view="flags" onclick="setView('abc','flags')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>Red Flag Log</div></div>
    <div class="sub-divider"></div>
    <div class="sub-item" data-view="abc-policies" onclick="setView('abc','abc-policies')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Policies &amp; Advice</div></div>
    <div class="sub-divider"></div>
    <div class="sub-section-label">Other modules</div>
    <div class="sub-item" onclick="setModule('gdpr')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>GDPR</div></div>
    <div class="sub-item" id="abc-wb-link" onclick="setModule('wb')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg>Whistleblowing</div></div>
  </div>
  <div class="content" id="abc-content">
    <!-- GIFTS -->
    <div class="view active" id="view-abc-gifts">
      <div class="topbar"><div class="topbar-left"><h1>Gifts &amp; Hospitality</h1><p>All gifts and entertainment must be logged · Pre-clearance above policy threshold</p></div>
      <div class="topbar-actions"><button class="btn btn-primary editor-only" onclick="openModal('modal-gift')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log gift</button></div></div>
      <div class="rag-strip" id="gifts-rag"></div>
      <div class="filter-bar">
        <div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search…" oninput="filterTable('gifts-table',this.value)"></div>
        <span class="chip active">All</span><span class="chip" onclick="filterChip(this,'gifts-table','received','direction')">Received</span><span class="chip" onclick="filterChip(this,'gifts-table','given','direction')">Given</span><span class="chip" onclick="filterChip(this,'gifts-table','pending','status')">Pending</span>
      </div>
      <div class="section"><div class="table-wrap"><table id="gifts-table">
        <thead><tr><th>Employee</th><th>Direction</th><th>Type</th><th>Third party</th><th>Country</th><th>Value</th><th>Date</th><th>Status</th><th class="editor-only"></th></tr></thead>
        <tbody id="gifts-tbody"><tr><td colspan="9"><div class="empty" style="padding:30px"><p>No gifts recorded.</p></div></td></tr></tbody>
      </table></div></div>
    </div>
    <!-- COI -->
    <div class="view" id="view-abc-coi">
      <div class="topbar"><div class="topbar-left"><h1>Conflicts of Interest</h1><p>Annual declaration · All employees and board members</p></div>
      <div class="topbar-actions"><button class="btn btn-secondary editor-only" id="btn-send-coi-reminders">Send reminders</button><button class="btn btn-primary editor-only" onclick="openModal('modal-coi')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log declaration</button></div></div>
      <div class="rag-strip" id="coi-rag"></div>
      <div class="section"><div id="coi-alerts"></div>
      <div class="table-wrap"><table>
        <thead><tr><th style="width:22%">Person</th><th>Category</th><th>Year</th><th>Declaration date</th><th>Conflict</th><th>Approved by</th><th>Status</th><th class="editor-only"></th></tr></thead>
        <tbody id="coi-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No COI declarations recorded.</p></div></td></tr></tbody>
      </table></div></div>
    </div>
    <!-- TPDD -->
    <div class="view" id="view-abc-tpdd">
      <div class="topbar"><div class="topbar-left"><h1>Third-Party Due Diligence</h1><p>Agents, intermediaries, JV partners, high-risk suppliers · Country risk auto-detected</p></div>
      <div class="topbar-actions"><button class="btn btn-primary editor-only" onclick="openModal('modal-tpdd')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add third party</button></div></div>
      <div class="rag-strip" id="tpdd-rag"></div>
      <div class="section"><div class="table-wrap"><table>
        <thead><tr><th style="width:22%">Company</th><th>Type</th><th>Country</th><th>DD level</th><th>Last DD</th><th>Next review</th><th>Country risk</th><th>Status</th><th class="editor-only"></th></tr></thead>
        <tbody id="tpdd-tbody"><tr><td colspan="9"><div class="empty" style="padding:30px"><p>No third parties recorded.</p></div></td></tr></tbody>
      </table></div></div>
    </div>
    <!-- DONATIONS -->
    <div class="view" id="view-abc-donations">
      <div class="topbar"><div class="topbar-left"><h1>Political Donations &amp; Sponsorships</h1><p>Corporate donations, sponsorships, charitable contributions · Board approval required</p></div>
      <div class="topbar-actions"><button class="btn btn-primary editor-only" onclick="openModal('modal-donation')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log donation</button></div></div>
      <div class="section" style="padding-top:14px;"><div class="table-wrap"><table>
        <thead><tr><th>Recipient</th><th>Type</th><th>Amount</th><th>Date</th><th>Jurisdiction</th><th>Board approval</th><th>Status</th><th class="editor-only"></th></tr></thead>
        <tbody id="donations-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No donations recorded.</p></div></td></tr></tbody>
      </table></div></div>
    </div>
    <!-- FLAGS (editor/admin only) -->
    <div class="view" id="view-abc-flags">
      <div class="topbar"><div class="topbar-left"><h1>Red Flag Log</h1><p>Internal record for legal review · Restricted to editors and admin</p></div>
      <div class="topbar-actions"><button class="btn btn-primary editor-only" onclick="openModal('modal-flag')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log concern</button></div></div>
      <div class="section" style="padding-top:14px;"><div class="table-wrap"><table>
        <thead><tr><th>Date</th><th style="width:30%">Description</th><th>Related party</th><th>Country</th><th>Severity</th><th>Status</th><th class="editor-only"></th></tr></thead>
        <tbody id="flags-tbody"><tr><td colspan="7"><div class="empty" style="padding:30px"><p>No red flags recorded.</p></div></td></tr></tbody>
      </table></div></div>
    </div>
    <!-- ABC POLICIES -->
    <div class="view" id="view-abc-abc-policies">
      <div class="topbar" style="padding-bottom:10px;"><div class="topbar-left"><h1>Policies &amp; Advice — Anti-Bribery</h1><p>ABC policies, guidance and advice notes · Searchable in Knowledge Base</p></div>
      <div class="topbar-actions"><button class="btn btn-secondary editor-only" onclick="openModal('modal-upload-policy','abc')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Upload</button>
      <button class="btn btn-primary editor-only" onclick="openModal('modal-add-advice','abc')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add advice note</button></div></div>
      <div class="radar-banner" onclick="window.location.href='/legal-radar'"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><div class="radar-banner-text"><strong>Legal Radar — Anti-Bribery</strong><span>View regulatory updates relevant to ABC compliance</span></div><span style="color:var(--amber);font-size:16px;">›</span></div>
      <div class="policy-grid" id="policies-abc"></div>
    </div>
  </div><!-- /abc-content -->
</div><!-- /module-abc -->

<!-- WHISTLEBLOWING MODULE -->
<div id="module-wb" class="module" style="display:none;flex:1;overflow:hidden;">
  <div class="sub-nav">
    <div class="sub-title">Whistleblowing</div>
    <div class="sub-item active" data-view="wb-cases" onclick="setView('wb','wb-cases')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Cases</div><span class="nav-badge nb-amber" id="badge-wb" style="display:none"></span></div>
    <div class="sub-item" data-view="wb-annual" onclick="setView('wb','wb-annual')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Annual report</div></div>
    <div class="sub-divider"></div>
    <div class="sub-item" data-view="wb-policies" onclick="setView('wb','wb-policies')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Policies &amp; Advice</div></div>
    <div class="sub-divider"></div>
    <div class="sub-section-label">Other modules</div>
    <div class="sub-item" onclick="setModule('gdpr')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>GDPR</div></div>
    <div class="sub-item" onclick="setModule('abc')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/></svg>Anti-Bribery</div></div>
  </div>
  <div class="content" id="wb-content">
    <div class="view active" id="view-wb-wb-cases">
      <div class="topbar"><div class="topbar-left"><h1>Whistleblowing Cases</h1><p>EU Directive 2019/1937 · 7-day acknowledgement · 3-month investigation deadline · Restricted access</p></div>
      <div class="topbar-actions"><button class="btn btn-primary editor-only" onclick="openModal('modal-wb')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log report</button></div></div>
      <div class="rag-strip" id="wb-rag"></div>
      <div class="section"><div id="wb-alerts"></div>
      <div class="table-wrap"><table>
        <thead><tr><th>Ref</th><th>Category</th><th>Reporter</th><th>Received</th><th>Acknowledge by</th><th>Outcome by</th><th>Handler</th><th>Status</th><th class="editor-only"></th></tr></thead>
        <tbody id="wb-tbody"><tr><td colspan="9"><div class="empty" style="padding:30px"><p>No cases recorded.</p></div></td></tr></tbody>
      </table></div></div>
    </div>
    <div class="view" id="view-wb-wb-annual">
      <div class="topbar"><div class="topbar-left"><h1>Annual Report</h1><p>EU Directive 2019/1937 · Statistical report (no individual case detail)</p></div>
      <div class="topbar-actions"><button class="btn btn-secondary" onclick="exportAudit('wb')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export report</button></div></div>
      <div class="section" style="padding-top:14px;"><div id="wb-annual-content"><div class="empty" style="padding:48px"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><h3>Annual statistics</h3><p>Loading…</p></div></div></div>
    </div>
    <div class="view" id="view-wb-wb-policies">
      <div class="topbar" style="padding-bottom:10px;"><div class="topbar-left"><h1>Policies &amp; Advice — Whistleblowing</h1><p>WB policies, handler guidance and advice notes</p></div>
      <div class="topbar-actions"><button class="btn btn-secondary editor-only" onclick="openModal('modal-upload-policy','wb')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Upload</button>
      <button class="btn btn-primary editor-only" onclick="openModal('modal-add-advice','wb')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add advice note</button></div></div>
      <div class="radar-banner" onclick="window.location.href='/legal-radar'"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><div class="radar-banner-text"><strong>Legal Radar — Whistleblowing</strong><span>View regulatory updates relevant to whistleblowing</span></div><span style="color:var(--amber);font-size:16px;">›</span></div>
      <div class="policy-grid" id="policies-wb"></div>
    </div>
  </div><!-- /wb-content -->
</div><!-- /module-wb -->

<!-- SETTINGS MODULE (Users tab) -->
<div id="module-settings" class="module" style="display:none;flex:1;overflow:hidden;">
  <div class="sub-nav">
    <div class="sub-title">Settings</div>
    <div class="sub-item active" data-view="settings-users" onclick="setView('settings','settings-users')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Users &amp; Access</div></div>
    <div class="sub-item" data-view="settings-compliance" onclick="setView('settings','settings-compliance')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Compliance settings</div></div>
  </div>
  <div class="content" id="settings-content">
    <!-- USERS VIEW -->
    <div class="view active" id="view-settings-settings-users">
      <div class="topbar"><div class="topbar-left"><h1>Users &amp; Access</h1><p>Manage team roles and module visibility · Maximum 5 users per firm</p></div>
      <div class="topbar-actions"><button class="btn btn-primary" onclick="openModal('modal-invite')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Invite user</button></div></div>
      <div class="section" style="padding-top:14px;">
        <div class="alert-bar alert-blue" style="margin-bottom:14px;">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <span><strong>Module access:</strong> Uncheck a module to hide it completely from that user's sidebar. Whistleblowing is hidden by default — enable only for designated handlers.</span>
        </div>
        <div id="users-table-wrap">
          <div class="empty" style="padding:30px"><p>Loading users…</p></div>
        </div>
      </div>
    </div>
    <!-- COMPLIANCE SETTINGS VIEW -->
    <div class="view" id="view-settings-settings-compliance">
      <div class="topbar"><div class="topbar-left"><h1>Compliance settings</h1><p>Jurisdiction, thresholds and firm-level defaults</p></div>
      <div class="topbar-actions"><button class="btn btn-primary" onclick="saveComplianceSettings()">Save settings</button></div></div>
      <div class="section" style="padding-top:14px;">
        <div class="info-card" style="margin-bottom:12px;">
          <div class="sec-divider" style="margin-top:0">Jurisdiction</div>
          <div class="form-row">
            <div class="form-group"><label>Primary jurisdiction</label><select class="form-control" id="setting-primary-jurisdiction"><option value="BE">Belgium</option><option value="FR">France</option><option value="DE">Germany</option><option value="NL">Netherlands</option><option value="LU">Luxembourg</option><option value="GB">United Kingdom</option><option value="IE">Ireland</option><option value="ES">Spain</option><option value="IT">Italy</option><option value="PL">Poland</option><option value="OTHER">Other EU</option></select><div class="form-hint">Determines supervisory authority and default notification thresholds</div></div>
            <div class="form-group"><label>Additional jurisdictions</label><input class="form-control" id="setting-extra-jurisdictions" placeholder="e.g. FR, NL, LU"><div class="form-hint">Comma-separated country codes where your firm operates</div></div>
          </div>
          <div class="sec-divider">Gift &amp; Hospitality thresholds</div>
          <div class="form-row">
            <div class="form-group"><label>Pre-clearance required above (€)</label><input class="form-control" type="number" id="setting-gift-threshold" placeholder="50"><div class="form-hint">Gifts above this value require approval before acceptance</div></div>
            <div class="form-group"><label>Auto-decline above (€)</label><input class="form-control" type="number" id="setting-gift-autodecline" placeholder="200"><div class="form-hint">Gifts above this value are automatically flagged for decline</div></div>
          </div>
          <div class="sec-divider">Whistleblowing defaults</div>
          <div class="form-row">
            <div class="form-group"><label>WB channel description</label><input class="form-control" id="setting-wb-channel" placeholder="e.g. Internal online form at wb@company.com"><div class="form-hint">Shown on the WB intake form</div></div>
            <div class="form-group"><label>Default handler</label><input class="form-control" id="setting-wb-handler" placeholder="Name of default case handler"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /app -->
<div id="toast"></div>

<!-- ═══════════════════════════════════════════════════════ MODALS ══ -->

<!-- DPO Modal -->
<div class="overlay" id="modal-dpo">
  <div class="modal">
    <div class="modal-title">DPO Record</div>
    <div class="modal-sub">Art. 37–39 GDPR · Data Protection Officer details and appointment rationale</div>
    <input type="hidden" id="dpo-id">
    <div class="form-row">
      <div class="form-group"><label>Full name</label><input class="form-control" id="dpo-name" placeholder="e.g. Jane Smith"></div>
      <div class="form-group"><label>Title / function</label><input class="form-control" id="dpo-title" placeholder="e.g. Data Protection Officer"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Internal or external</label><select class="form-control" id="dpo-type"><option value="internal">Internal employee</option><option value="external">External / contracted</option></select></div>
      <div class="form-group"><label>Appointment date</label><input class="form-control" type="date" id="dpo-appointed"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Contact email (public)</label><input class="form-control" id="dpo-email" placeholder="dpo@company.com"></div>
      <div class="form-group"><label>Contact phone</label><input class="form-control" id="dpo-phone" placeholder="+32 2 000 00 00"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>SA registration reference</label><input class="form-control" id="dpo-sa-ref" placeholder="e.g. GBA-2024-001"></div>
      <div class="form-group"><label>Next review date</label><input class="form-control" type="date" id="dpo-review"></div>
    </div>
    <div class="form-section-label">Art. 37(1) mandatory appointment checklist</div>
    <div class="info-card" style="margin-bottom:10px;">
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px;padding-bottom:7px;border-bottom:1px solid var(--cream-mid);">
          <span style="color:var(--text-mid);">Public authority or body (Art. 37(1)(a))</span>
          <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleDPOCheck(this,'art37a','yes')">Yes</button><button class="role-btn active" onclick="toggleDPOCheck(this,'art37a','no')">No</button></div>
          <input type="hidden" id="dpo-art37a" value="no">
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px;padding-bottom:7px;border-bottom:1px solid var(--cream-mid);">
          <span style="color:var(--text-mid);">Large-scale regular &amp; systematic monitoring (Art. 37(1)(b))</span>
          <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleDPOCheck(this,'art37b','yes')">Yes</button><button class="role-btn active" onclick="toggleDPOCheck(this,'art37b','no')">No</button></div>
          <input type="hidden" id="dpo-art37b" value="no">
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px;">
          <span style="color:var(--text-mid);">Large-scale special category / criminal data (Art. 37(1)(c))</span>
          <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleDPOCheck(this,'art37c','yes')">Yes</button><button class="role-btn active" onclick="toggleDPOCheck(this,'art37c','no')">No</button></div>
          <input type="hidden" id="dpo-art37c" value="no">
        </div>
      </div>
    </div>
    <div class="form-row"><div class="form-group"><label>Business justification</label><textarea class="form-control" id="dpo-justification" rows="3" placeholder="Explain why a DPO is appointed, especially if voluntary…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpo')">Cancel</button><button class="btn btn-primary" onclick="saveDPO()">Save DPO record</button></div>
  </div>
</div>

<!-- RoPA Modal -->
<div class="overlay" id="modal-ropa">
  <div class="modal modal-wide">
    <div class="modal-title">Add processing activity</div>
    <div class="modal-sub">Select your role first — controller and processor records have different required fields</div>
    <div style="margin-bottom:14px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Organisation's role for this processing activity</div>
      <div class="role-toggle"><button class="role-btn active" onclick="setRopaRole(this,'controller')">Controller (Art. 30(1))</button><button class="role-btn" onclick="setRopaRole(this,'processor')">Processor (Art. 30(2))</button><button class="role-btn" onclick="setRopaRole(this,'joint')">Joint controller</button></div>
      <input type="hidden" id="ropa-role" value="controller">
    </div>
    <div class="form-row"><div class="form-group"><label>Activity name *</label><input class="form-control" id="ropa-activity" placeholder="e.g. HR — Employee records"></div></div>
    <!-- Controller fields -->
    <div id="ropa-controller-fields">
      <div class="form-row">
        <div class="form-group"><label>Legal basis *</label><select class="form-control" id="ropa-legal-basis"><option value="">— Select —</option><option>Art. 6(1)(a) — Consent</option><option>Art. 6(1)(b) — Contract performance</option><option>Art. 6(1)(c) — Legal obligation</option><option>Art. 6(1)(d) — Vital interests</option><option>Art. 6(1)(e) — Public task</option><option>Art. 6(1)(f) — Legitimate interest</option></select></div>
        <div class="form-group"><label>Special category basis (if applicable)</label><select class="form-control" id="ropa-special-basis"><option value="">— None —</option><option>Art. 9(2)(a) — Explicit consent</option><option>Art. 9(2)(b) — Employment law obligation</option><option>Art. 9(2)(h) — Medical / health care</option><option>Art. 9(2)(j) — Research / statistics</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Processing purposes *</label><textarea class="form-control" id="ropa-purposes" rows="2" placeholder="What is the processing for…"></textarea></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Data subjects *</label><input class="form-control" id="ropa-subjects" placeholder="e.g. Employees, customers, visitors"></div>
        <div class="form-group"><label>Data categories *</label><input class="form-control" id="ropa-categories" placeholder="e.g. Contact data, financial, health"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Special category data?</label><select class="form-control" id="ropa-special"><option value="no">No</option><option value="yes">Yes</option></select></div>
        <div class="form-group"><label>Retention period *</label><input class="form-control" id="ropa-retention" placeholder="e.g. 7 years from contract end"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Recipients / categories of recipients</label><input class="form-control" id="ropa-recipients" placeholder="e.g. HR team, payroll processor, auditors"></div>
        <div class="form-group"><label>Third country transfers?</label><select class="form-control" id="ropa-transfers"><option value="no">No</option><option value="yes">Yes — TIA required</option></select></div>
      </div>
    </div>
    <!-- Processor-specific fields -->
    <div id="ropa-processor-fields" style="display:none;">
      <div class="alert-bar alert-blue" style="margin-bottom:12px;"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>Art. 30(2) processor record: you record the categories of processing you perform on each controller's behalf. Purposes, legal basis and retention are set by the controller — not recorded here.</span></div>
      <div class="form-row">
        <div class="form-group"><label>Controller name *</label><input class="form-control" id="ropa-controller-name" placeholder="Name of the data controller you act for"></div>
        <div class="form-group"><label>Controller contact / DPO</label><input class="form-control" id="ropa-controller-contact" placeholder="Contact email or name"></div>
      </div>
      <div class="form-row"><div class="form-group"><label>Categories of processing performed *</label><textarea class="form-control" id="ropa-proc-categories" rows="2" placeholder="e.g. Hosting and storage of HR data, payroll calculation, data analytics"></textarea></div></div>
      <div class="form-row">
        <div class="form-group"><label>DPA reference</label><input class="form-control" id="ropa-proc-dpa" placeholder="Reference to signed DPA"></div>
        <div class="form-group"><label>Sub-processors used</label><input class="form-control" id="ropa-proc-subprocessors" placeholder="e.g. AWS EU, Stripe"></div>
      </div>
      <div class="form-row"><div class="form-group"><label>Third country transfers?</label><select class="form-control" id="ropa-proc-transfers"><option value="no">No</option><option value="yes">Yes — TIA required</option></select></div></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Security measures</label><input class="form-control" id="ropa-security" placeholder="e.g. Encryption at rest, access controls, audit logs"></div>
      <div class="form-group"><label>Review date</label><input class="form-control" type="date" id="ropa-review"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>DPIA required?</label><select class="form-control" id="ropa-dpia"><option value="no">No</option><option value="yes">Yes — start DPIA</option><option value="in_progress">Yes — DPIA in progress</option><option value="completed">Yes — DPIA completed</option></select></div><div class="form-group"><label>Notes</label><input class="form-control" id="ropa-notes" placeholder="Any additional notes…"></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-ropa')">Cancel</button><button class="btn btn-primary" onclick="saveRopa()">Add activity</button></div>
  </div>
</div>

<!-- DSR Modal -->
<div class="overlay" id="modal-dsr">
  <div class="modal">
    <div class="modal-title">Log data subject request</div>
    <div class="modal-sub">Deadline clock starts from date of receipt — calendar days, not business days</div>
    <div style="margin-bottom:12px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Organisation's role for this request</div>
      <div class="role-toggle"><button class="role-btn active" onclick="setDSRRole(this,'controller')">Controller — respond directly</button><button class="role-btn" onclick="setDSRRole(this,'processor')">Processor — notify controller</button></div>
      <input type="hidden" id="dsr-role" value="controller">
      <div id="dsr-hint-controller" style="font-size:11px;color:var(--text-mid);padding:6px 10px;background:var(--blue-bg);border-radius:var(--r);border:1px solid var(--blue-border);margin-top:6px;">Handle the DSR directly and respond to the data subject within 1 calendar month.</div>
      <div id="dsr-hint-processor" style="display:none;font-size:11px;color:var(--text-mid);padding:6px 10px;background:var(--amber-bg);border-radius:var(--r);border:1px solid var(--amber-border);margin-top:6px;">You cannot respond directly. Notify the relevant controller without undue delay (max. 5 business days).</div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Requester name *</label><input class="form-control" id="dsr-requester" placeholder="Full name"></div>
      <div class="form-group"><label>Right exercised *</label><select class="form-control" id="dsr-right"><option value="">— Select —</option><option>Access (Art. 15)</option><option>Erasure (Art. 17)</option><option>Rectification (Art. 16)</option><option>Portability (Art. 20)</option><option>Restriction (Art. 18)</option><option>Object (Art. 21)</option><option>Automated decisions (Art. 22)</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date received *</label><input class="form-control" type="date" id="dsr-received"><div class="form-hint">Deadline = 1 calendar month from this date</div></div>
      <div class="form-group"><label>Channel received via</label><select class="form-control" id="dsr-channel"><option>Email</option><option>Contact form</option><option>Verbal (recorded)</option><option>Post</option><option>Privacy platform</option></select></div>
    </div>
    <div id="dsr-processor-field" style="display:none;">
      <div class="form-row"><div class="form-group"><label>Controller to notify *</label><input class="form-control" id="dsr-controller" placeholder="Controller name / company"><div class="form-hint">Notify within 5 business days</div></div></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Identity verified?</label><select class="form-control" id="dsr-verified"><option value="yes">Yes</option><option value="no">No — verification pending (pauses clock)</option></select></div>
      <div class="form-group"><label>Third party acting on behalf?</label><select class="form-control" id="dsr-third-party"><option value="no">No — direct request</option><option value="legal">Yes — legal representative</option><option value="guardian">Yes — parent / guardian</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="dsr-notes" rows="2" placeholder="Context, relevant background…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dsr')">Cancel</button><button class="btn btn-primary" onclick="saveDSR()">Log DSR</button></div>
  </div>
</div>

<!-- Breach Modal -->
<div class="overlay" id="modal-breach">
  <div class="modal">
    <div class="modal-title">Log data breach</div>
    <div class="modal-sub">72-hour SA notification clock starts from detection — act quickly</div>
    <div class="form-row">
      <div class="form-group"><label>Date &amp; time detected *</label><input class="form-control" type="datetime-local" id="breach-detected"></div>
      <div class="form-group"><label>Breach type *</label><select class="form-control" id="breach-type"><option value="">— Select —</option><option value="confidentiality">Confidentiality (unauthorised access)</option><option value="integrity">Integrity (data altered)</option><option value="availability">Availability (data lost/destroyed)</option><option value="multiple">Multiple types</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description *</label><textarea class="form-control" id="breach-description" rows="2" placeholder="What happened, how discovered…"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Estimated records affected</label><input class="form-control" type="number" id="breach-records" placeholder="0"></div>
      <div class="form-group"><label>Data categories involved</label><input class="form-control" id="breach-categories" placeholder="e.g. Contact data, financial, health"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Risk level *</label><select class="form-control" id="breach-risk"><option value="low">Low — no notification likely needed</option><option value="medium">Medium — SA notification likely</option><option value="high">High — SA notification required</option></select></div>
      <div class="form-group"><label>Our role</label><select class="form-control" id="breach-role"><option value="controller">Controller — notify SA directly</option><option value="processor">Processor — notify controller</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Containment measures taken</label><textarea class="form-control" id="breach-containment" rows="2" placeholder="Steps already taken to contain the breach…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-breach')">Cancel</button><button class="btn btn-primary" onclick="saveBreach()">Log breach</button></div>
  </div>
</div>

<!-- DPIA Modal -->
<div class="overlay" id="modal-dpia">
  <div class="modal">
    <div class="modal-title">Start DPIA</div>
    <div class="modal-sub">Art. 35 GDPR · Data Protection Impact Assessment · 7-stage workflow</div>
    <div class="form-row"><div class="form-group"><label>Processing activity *</label><input class="form-control" id="dpia-activity" placeholder="Name of the processing activity requiring a DPIA"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Trigger for DPIA</label><select class="form-control" id="dpia-trigger"><option value="">— Select —</option><option>Art. 35(3)(a) — Systematic profiling</option><option>Art. 35(3)(b) — Large-scale special category data</option><option>Art. 35(3)(c) — Systematic monitoring of public area</option><option>Supervisory authority list</option><option>Internal policy — precautionary</option></select></div>
      <div class="form-group"><label>Linked RoPA entry</label><select class="form-control" id="dpia-ropa-link"><option value="">— None —</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Initial risk assessment</label><select class="form-control" id="dpia-initial-risk"><option value="medium">Medium</option><option value="high">High</option><option value="very_high">Very high</option></select></div><div class="form-group"><label>Assigned to</label><input class="form-control" id="dpia-assigned" placeholder="Name of responsible person"></div></div>
    <div class="form-row"><div class="form-group"><label>Notes / context</label><textarea class="form-control" id="dpia-notes" rows="2" placeholder="Background, reason for DPIA…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpia')">Cancel</button><button class="btn btn-primary" onclick="saveDPIA()">Start DPIA</button></div>
  </div>
</div>

<!-- TIA Modal -->
<div class="overlay" id="modal-tia">
  <div class="modal">
    <div class="modal-title">New Transfer Impact Assessment</div>
    <div class="modal-sub">Art. 44+ GDPR · Required for transfers to countries without EU adequacy decision</div>
    <div class="form-row">
      <div class="form-group"><label>Importer name *</label><input class="form-control" id="tia-importer" placeholder="Company receiving the data"></div>
      <div class="form-group"><label>Destination country *</label><input class="form-control" id="tia-country" placeholder="e.g. US, IN, CN"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Transfer mechanism *</label><select class="form-control" id="tia-mechanism"><option value="">— Select —</option><option value="sccs_c2c">Standard Contractual Clauses — Controller to Controller</option><option value="sccs_c2p">Standard Contractual Clauses — Controller to Processor</option><option value="bcrs">Binding Corporate Rules</option><option value="adequacy">Adequacy decision</option><option value="derogation">Art. 49 derogation</option></select></div>
      <div class="form-group"><label>Risk level</label><select class="form-control" id="tia-risk"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Reassessment due</label><input class="form-control" type="date" id="tia-reassess"></div>
      <div class="form-group"><label>Linked DPA</label><input class="form-control" id="tia-dpa" placeholder="DPA reference"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Assessment notes / conclusion</label><textarea class="form-control" id="tia-notes" rows="3" placeholder="Key findings, supplementary measures applied…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-tia')">Cancel</button><button class="btn btn-primary" onclick="saveTIA()">Save TIA</button></div>
  </div>
</div>

<!-- DPA Modal -->
<div class="overlay" id="modal-dpa">
  <div class="modal">
    <div class="modal-title">Add Data Processing Agreement</div>
    <div class="modal-sub">Art. 28 GDPR · Record of signed DPAs with processors and controllers</div>
    <div class="form-row">
      <div class="form-group"><label>Counterparty *</label><input class="form-control" id="dpa-counterparty" placeholder="Company name"></div>
      <div class="form-group"><label>Our role *</label><select class="form-control" id="dpa-role"><option value="controller">Controller (they process for us)</option><option value="processor">Processor (we process for them)</option><option value="joint">Joint controller</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Purpose / description</label><input class="form-control" id="dpa-purpose" placeholder="e.g. Cloud hosting, payroll processing"></div>
      <div class="form-group"><label>TIA linked?</label><input class="form-control" id="dpa-tia" placeholder="TIA reference (if third country transfer)"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date signed</label><input class="form-control" type="date" id="dpa-signed"></div>
      <div class="form-group"><label>Review date</label><input class="form-control" type="date" id="dpa-review"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpa')">Cancel</button><button class="btn btn-primary" onclick="saveDPA()">Add DPA</button></div>
  </div>
</div>

<!-- Gift Modal -->
<div class="overlay" id="modal-gift">
  <div class="modal">
    <div class="modal-title">Log gift or hospitality</div>
    <div class="modal-sub">All gifts and entertainment must be recorded regardless of value</div>
    <div class="form-row">
      <div class="form-group"><label>Employee name *</label><input class="form-control" id="gift-employee" placeholder="Full name"></div>
      <div class="form-group"><label>Direction *</label><select class="form-control" id="gift-direction"><option value="received">Received from third party</option><option value="given">Given to third party</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Type *</label><select class="form-control" id="gift-type"><option value="gift">Gift</option><option value="meal">Meal / entertainment</option><option value="hospitality">Hospitality (event, travel)</option><option value="other">Other</option></select></div>
      <div class="form-group"><label>Third party *</label><input class="form-control" id="gift-third-party" placeholder="Company or person name"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Country *</label><input class="form-control" id="gift-country" placeholder="Country code e.g. BE, DE, US"></div>
      <div class="form-group"><label>Value (€) *</label><input class="form-control" type="number" id="gift-value" placeholder="0.00" step="0.01"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date *</label><input class="form-control" type="date" id="gift-date"></div>
      <div class="form-group"><label>Business justification</label><input class="form-control" id="gift-justification" placeholder="Brief reason"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-gift')">Cancel</button><button class="btn btn-primary" onclick="saveGift()">Log gift</button></div>
  </div>
</div>

<!-- COI Modal -->
<div class="overlay" id="modal-coi">
  <div class="modal">
    <div class="modal-title">Log COI declaration</div>
    <div class="modal-sub">Annual conflict of interest declaration · Employees and board members</div>
    <div class="form-row">
      <div class="form-group"><label>Name *</label><input class="form-control" id="coi-name" placeholder="Full name"></div>
      <div class="form-group"><label>Category *</label><select class="form-control" id="coi-category"><option value="employee">Employee</option><option value="board">Board member</option><option value="consultant">Consultant / advisor</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Role / title</label><input class="form-control" id="coi-role" placeholder="e.g. Head of Finance"></div>
      <div class="form-group"><label>Declaration year *</label><input class="form-control" type="number" id="coi-year" placeholder="2026"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Conflict disclosed?</label><select class="form-control" id="coi-conflict" onchange="toggleCOIConflict(this)"><option value="none">No conflict to declare</option><option value="disclosed">Yes — conflict disclosed</option></select></div>
      <div class="form-group"><label>Declaration date</label><input class="form-control" type="date" id="coi-date"></div>
    </div>
    <div id="coi-conflict-detail" style="display:none;">
      <div class="form-row"><div class="form-group"><label>Conflict description *</label><textarea class="form-control" id="coi-conflict-desc" rows="2" placeholder="Describe the nature of the conflict…"></textarea></div></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-coi')">Cancel</button><button class="btn btn-primary" onclick="saveCOI()">Save declaration</button></div>
  </div>
</div>

<!-- TPDD Modal -->
<div class="overlay" id="modal-tpdd">
  <div class="modal">
    <div class="modal-title">Add third party</div>
    <div class="modal-sub">Due diligence record for agents, intermediaries, JV partners and high-risk suppliers</div>
    <div class="alert-bar alert-blue" style="margin-bottom:12px;"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>High-risk country entries automatically require enhanced due diligence.</span></div>
    <div class="form-row">
      <div class="form-group"><label>Company name *</label><input class="form-control" id="tpdd-company" placeholder="Full legal name"></div>
      <div class="form-group"><label>Type *</label><select class="form-control" id="tpdd-type"><option value="agent">Commercial agent</option><option value="intermediary">Intermediary</option><option value="jv">JV partner</option><option value="supplier">High-risk supplier</option><option value="consultant">Consultant</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Country *</label><input class="form-control" id="tpdd-country" placeholder="Country code e.g. BE, NG, CN" oninput="checkTPDDCountryRisk(this.value)"><div class="form-hint" id="tpdd-risk-hint"></div></div>
      <div class="form-group"><label>DD level</label><select class="form-control" id="tpdd-level"><option value="standard">Standard</option><option value="enhanced">Enhanced</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Last DD completed</label><input class="form-control" type="date" id="tpdd-last-dd"></div>
      <div class="form-group"><label>Next review</label><input class="form-control" type="date" id="tpdd-review"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="tpdd-notes" rows="2" placeholder="Key findings, red flags, mitigations…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-tpdd')">Cancel</button><button class="btn btn-primary" onclick="saveTPDD()">Add third party</button></div>
  </div>
</div>

<!-- Donation Modal -->
<div class="overlay" id="modal-donation">
  <div class="modal">
    <div class="modal-title">Log donation or sponsorship</div>
    <div class="modal-sub">Corporate political donations, sponsorships and charitable contributions</div>
    <div class="form-row">
      <div class="form-group"><label>Recipient *</label><input class="form-control" id="don-recipient" placeholder="Organisation or individual name"></div>
      <div class="form-group"><label>Type *</label><select class="form-control" id="don-type"><option value="political">Political donation</option><option value="sponsorship">Sponsorship</option><option value="charitable">Charitable contribution</option><option value="other">Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Amount (€) *</label><input class="form-control" type="number" id="don-amount" placeholder="0.00" step="0.01"></div>
      <div class="form-group"><label>Date *</label><input class="form-control" type="date" id="don-date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Jurisdiction</label><input class="form-control" id="don-jurisdiction" placeholder="Country code"></div>
      <div class="form-group"><label>Board approval required?</label><select class="form-control" id="don-board"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Business justification</label><textarea class="form-control" id="don-justification" rows="2" placeholder="Why this donation/sponsorship is appropriate…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-donation')">Cancel</button><button class="btn btn-primary" onclick="saveDonation()">Log donation</button></div>
  </div>
</div>

<!-- Red Flag Modal -->
<div class="overlay" id="modal-flag">
  <div class="modal">
    <div class="modal-title">Log red flag concern</div>
    <div class="modal-sub">Confidential internal record · Restricted to editors and admin</div>
    <div class="form-row">
      <div class="form-group"><label>Date identified *</label><input class="form-control" type="date" id="flag-date"></div>
      <div class="form-group"><label>Severity *</label><select class="form-control" id="flag-severity"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description *</label><textarea class="form-control" id="flag-description" rows="3" placeholder="Describe the red flag concern in detail…"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Related party (if any)</label><input class="form-control" id="flag-party" placeholder="Company or person name"></div>
      <div class="form-group"><label>Country</label><input class="form-control" id="flag-country" placeholder="Country code"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Source</label><input class="form-control" id="flag-source" placeholder="e.g. Finance, Sales, External audit"></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-flag')">Cancel</button><button class="btn btn-primary" onclick="saveFlag()">Log concern</button></div>
  </div>
</div>

<!-- WB Modal -->
<div class="overlay" id="modal-wb">
  <div class="modal">
    <div class="modal-title">Log whistleblowing report</div>
    <div class="modal-sub">EU Directive 2019/1937 · Reporter identity stored separately if named · Access restricted to handler</div>
    <div class="form-row">
      <div class="form-group"><label>Reporter type</label><select class="form-control" id="wb-reporter-type" onchange="toggleWBReporter(this)"><option value="anonymous">Anonymous</option><option value="named">Named reporter</option></select></div>
      <div class="form-group"><label>Date received *</label><input class="form-control" type="date" id="wb-received"></div>
    </div>
    <div id="wb-reporter-fields" style="display:none;">
      <div class="form-row">
        <div class="form-group"><label>Reporter name</label><input class="form-control" id="wb-reporter-name" placeholder="Stored separately from case record"></div>
        <div class="form-group"><label>Reporter contact</label><input class="form-control" id="wb-reporter-contact" placeholder="Email or phone"></div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Category *</label><select class="form-control" id="wb-category"><option value="">— Select —</option><option value="financial">Financial irregularity</option><option value="corruption">Corruption / bribery</option><option value="health_safety">Health &amp; safety</option><option value="discrimination">Discrimination / harassment</option><option value="data_protection">Data protection</option><option value="environment">Environmental</option><option value="other">Other</option></select></div>
      <div class="form-group"><label>Channel received via *</label><select class="form-control" id="wb-channel"><option value="internal_form">Internal form</option><option value="email">Email</option><option value="phone">Phone / voicemail</option><option value="post">Post</option><option value="in_person">In person</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Summary *</label><textarea class="form-control" id="wb-summary" rows="3" placeholder="Brief factual summary of the report — no identifying details if anonymous…"></textarea></div></div>
    <div class="form-row"><div class="form-group"><label>Assigned handler</label><input class="form-control" id="wb-handler" placeholder="Name of case handler"></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-wb')">Cancel</button><button class="btn btn-primary" onclick="saveWB()">Log report</button></div>
  </div>
</div>

<!-- Policy Upload Modal -->
<div class="overlay" id="modal-upload-policy">
  <div class="modal">
    <div class="modal-title">Upload document</div>
    <div class="modal-sub">PDF, Word or text documents · Max 20MB · Stored and searchable in Knowledge Base</div>
    <input type="hidden" id="upload-module">
    <div class="form-row"><div class="form-group"><label>Document title *</label><input class="form-control" id="upload-title" placeholder="e.g. Data Protection Policy v3"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Type *</label><select class="form-control" id="upload-type"><option value="policy">Policy</option><option value="template">Template</option><option value="guidance">External guidance</option><option value="other">Other</option></select></div>
      <div class="form-group"><label>Jurisdictions (optional)</label><input class="form-control" id="upload-jurisdictions" placeholder="e.g. BE, FR, EU"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>File *</label><input class="form-control" type="file" id="upload-file" accept=".pdf,.docx,.doc,.xlsx,.txt,.md"><div class="form-hint">PDF, DOCX, XLSX, TXT, MD · Max 20MB</div></div></div>
    <div class="form-row"><div class="form-group" style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="upload-from-radar" style="width:14px;height:14px;accent-color:var(--green);"><label style="font-size:12px;color:var(--text-mid);text-transform:none;letter-spacing:0;font-weight:400;">This document was captured from Legal Radar</label></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-upload-policy')">Cancel</button><button class="btn btn-primary" onclick="uploadPolicy()">Upload &amp; save</button></div>
  </div>
</div>

<!-- Add Advice Note Modal -->
<div class="overlay" id="modal-add-advice">
  <div class="modal">
    <div class="modal-title">Add advice note</div>
    <div class="modal-sub">Internal legal note or Mickey-generated advice · Stored and searchable in Knowledge Base</div>
    <input type="hidden" id="advice-module">
    <div class="form-row"><div class="form-group"><label>Title *</label><input class="form-control" id="advice-title" placeholder="e.g. Analysis of legitimate interest for marketing"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Source</label><select class="form-control" id="advice-source"><option value="internal">Internal legal note</option><option value="mickey">Mickey-generated advice</option><option value="external">External counsel</option></select></div>
      <div class="form-group"><label>Jurisdictions (optional)</label><input class="form-control" id="advice-jurisdictions" placeholder="e.g. BE, EU"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Content *</label><textarea class="form-control" id="advice-content" rows="6" placeholder="Advice note content…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-add-advice')">Cancel</button><button class="btn btn-primary" onclick="saveAdvice()">Save advice note</button></div>
  </div>
</div>

<!-- Invite User Modal -->
<div class="overlay" id="modal-invite">
  <div class="modal">
    <div class="modal-title">Invite team member</div>
    <div class="modal-sub">They will receive an email to set their password · Roles and access can be changed after invitation</div>
    <div class="form-row">
      <div class="form-group"><label>Full name</label><input class="form-control" id="invite-name" placeholder="Full name"></div>
      <div class="form-group"><label>Email address *</label><input class="form-control" type="email" id="invite-email" placeholder="colleague@company.com"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Role *</label><select class="form-control" id="invite-role"><option value="viewer">Viewer — read only</option><option value="editor">Editor — can create and edit</option><option value="admin">Admin — full access including user management</option></select><div class="form-hint">You can change this after the invitation is sent</div></div></div>
    <div class="form-section-label">Module access</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);font-weight:400;text-transform:none;letter-spacing:0;cursor:pointer;"><input type="checkbox" class="invite-module" value="compliance" style="accent-color:var(--green);"> Compliance (GDPR, ABC)</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);font-weight:400;text-transform:none;letter-spacing:0;cursor:pointer;"><input type="checkbox" class="invite-module" value="whistleblowing" style="accent-color:var(--green);"> Whistleblowing <span style="font-size:10px;color:var(--text-muted);">— hidden by default, enable only for designated handlers</span></label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);font-weight:400;text-transform:none;letter-spacing:0;cursor:pointer;"><input type="checkbox" class="invite-module" value="documents" checked style="accent-color:var(--green);"> Documents</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);font-weight:400;text-transform:none;letter-spacing:0;cursor:pointer;"><input type="checkbox" class="invite-module" value="corporate" style="accent-color:var(--green);"> Corporate Housekeeping</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);font-weight:400;text-transform:none;letter-spacing:0;cursor:pointer;"><input type="checkbox" class="invite-module" value="radar" checked style="accent-color:var(--green);"> Legal Radar</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);font-weight:400;text-transform:none;letter-spacing:0;cursor:pointer;"><input type="checkbox" class="invite-module" value="knowledge" checked style="accent-color:var(--green);"> Knowledge Base</label>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-invite')">Cancel</button><button class="btn btn-primary" onclick="sendInvite()">Send invitation</button></div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="overlay" id="modal-confirm">
  <div class="modal" style="width:400px;">
    <div class="modal-title" id="confirm-title">Confirm action</div>
    <div style="font-size:13px;color:var(--text-mid);margin:10px 0 20px;" id="confirm-body">Are you sure?</div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-confirm')">Cancel</button><button class="btn btn-danger" id="confirm-ok-btn">Confirm</button></div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════ MODALS -->

<!-- DPO MODAL -->
<div class="overlay" id="modal-dpo">
  <div class="modal modal-wide">
    <div class="modal-title">DPO Record</div>
    <div class="modal-sub">Art. 37–39 GDPR · Appointment details and mandatory assessment</div>
    <div class="form-row">
      <div class="form-group"><label>Full name</label><input class="form-control" id="dpo-name" placeholder="e.g. Jane Smith"></div>
      <div class="form-group"><label>Title / Position</label><input class="form-control" id="dpo-title" placeholder="e.g. Data Protection Officer"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>DPO type</label><select class="form-control" id="dpo-type"><option value="internal">Internal employee</option><option value="external">External / contracted</option></select></div>
      <div class="form-group"><label>Contact email (public)</label><input class="form-control" id="dpo-email" type="email" placeholder="dpo@company.com"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Appointment date</label><input class="form-control" id="dpo-appointed" type="date"></div>
      <div class="form-group"><label>Next review date</label><input class="form-control" id="dpo-review" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>SA registration reference</label><input class="form-control" id="dpo-sa-ref" placeholder="e.g. GBA-2024-001"><div class="form-hint">Reference number from your national supervisory authority</div></div>
      <div class="form-group"><label>Contact phone</label><input class="form-control" id="dpo-phone" placeholder="+32 ..."></div>
    </div>
    <div class="form-section-label">Art. 37(1) mandatory appointment assessment</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:var(--r);padding:9px 13px;font-size:12px;">
        <span>Public authority or body (Art. 37(1)(a))</span>
        <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleAssessment(this,'yes')">Yes</button><button class="role-btn active" onclick="toggleAssessment(this,'no')">No</button></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:var(--r);padding:9px 13px;font-size:12px;">
        <span>Large-scale regular &amp; systematic monitoring (Art. 37(1)(b))</span>
        <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleAssessment(this,'yes')">Yes</button><button class="role-btn active" onclick="toggleAssessment(this,'no')">No</button></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:var(--r);padding:9px 13px;font-size:12px;">
        <span>Large-scale special category / criminal data (Art. 37(1)(c))</span>
        <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleAssessment(this,'yes')">Yes</button><button class="role-btn active" onclick="toggleAssessment(this,'no')">No</button></div>
      </div>
    </div>
    <div class="form-group"><label>Business justification</label><textarea class="form-control" id="dpo-justification" rows="3" placeholder="Why has the organisation appointed a DPO? What is the rationale for voluntary or mandatory appointment?"></textarea></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpo')">Cancel</button><button class="btn btn-primary" onclick="saveDPO()">Save DPO record</button></div>
  </div>
</div>

<!-- ROPA MODAL -->
<div class="overlay" id="modal-ropa">
  <div class="modal modal-wide">
    <div class="modal-title">Add processing activity</div>
    <div class="modal-sub">Art. 30 GDPR · Fields change based on your role (controller vs processor)</div>
    <div style="margin-bottom:14px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Your organisation's role for this activity</div>
      <div class="role-toggle">
        <button class="role-btn active" onclick="setRopaRole(this,'controller')">Controller — Art. 30(1)</button>
        <button class="role-btn" onclick="setRopaRole(this,'processor')">Processor — Art. 30(2)</button>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Activity name</label><input class="form-control" id="ropa-name" placeholder="e.g. HR — Employee records management"></div>
    </div>
    <!-- Controller fields -->
    <div id="ropa-controller-fields">
      <div class="form-row">
        <div class="form-group"><label>Purpose(s) of processing</label><input class="form-control" id="ropa-purposes" placeholder="e.g. HR administration, payroll, benefits management"></div>
        <div class="form-group"><label>Legal basis</label><select class="form-control" id="ropa-legal-basis"><option value="">Select…</option><option>Art. 6(1)(a) — Consent</option><option>Art. 6(1)(b) — Contract performance</option><option>Art. 6(1)(c) — Legal obligation</option><option>Art. 6(1)(d) — Vital interests</option><option>Art. 6(1)(e) — Public task</option><option>Art. 6(1)(f) — Legitimate interests</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Categories of data subjects</label><input class="form-control" id="ropa-subjects" placeholder="e.g. Employees, candidates, contractors"></div>
        <div class="form-group"><label>Categories of personal data</label><input class="form-control" id="ropa-categories" placeholder="e.g. Name, address, salary, health data"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Recipients / disclosures</label><input class="form-control" id="ropa-recipients" placeholder="e.g. Payroll processor, tax authority"></div>
        <div class="form-group"><label>Third country transfers?</label><select class="form-control" id="ropa-transfers"><option value="none">No transfers outside EEA</option><option value="adequacy">Adequacy decision</option><option value="sccs">Standard Contractual Clauses</option><option value="bcrs">Binding Corporate Rules</option><option value="other">Other safeguard</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Retention period</label><input class="form-control" id="ropa-retention" placeholder="e.g. 7 years after termination / Until consent withdrawn"></div>
        <div class="form-group"><label>Special category data?</label><select class="form-control" id="ropa-special"><option value="no">No</option><option value="yes">Yes — Art. 9 data</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Security measures (summary)</label><input class="form-control" id="ropa-security" placeholder="e.g. Encryption at rest, access controls, pseudonymisation"></div>
        <div class="form-group"><label>DPIA required?</label><select class="form-control" id="ropa-dpia-req"><option value="no">No</option><option value="yes">Yes — DPIA required</option><option value="done">Yes — DPIA completed</option></select></div>
      </div>
    </div>
    <!-- Processor fields (hidden by default) -->
    <div id="ropa-processor-fields" style="display:none;">
      <div class="alert-bar alert-blue" style="margin-bottom:10px;">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span>Art. 30(2) record. As processor, you record the <strong>controller's details</strong> and the <strong>categories of processing</strong> you perform on their behalf. Purposes, legal basis and retention are the controller's responsibility — do not record them here.</span>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Controller name</label><input class="form-control" id="ropa-controller-name" placeholder="Name of the data controller"></div>
        <div class="form-group"><label>Controller contact / DPO</label><input class="form-control" id="ropa-controller-contact" placeholder="Contact person or DPO at the controller"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Categories of processing performed</label><input class="form-control" id="ropa-proc-categories" placeholder="e.g. Storage, analysis, pseudonymisation, transmission"></div>
        <div class="form-group"><label>DPA reference (Art. 28)</label><input class="form-control" id="ropa-proc-dpa-ref" placeholder="Reference to your DPA with this controller"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Third country transfers?</label><select class="form-control" id="ropa-proc-transfers"><option value="none">No transfers outside EEA</option><option value="adequacy">Adequacy decision</option><option value="sccs">Standard Contractual Clauses</option><option value="bcrs">Binding Corporate Rules</option><option value="other">Other safeguard</option></select></div>
        <div class="form-group"><label>Security measures (summary)</label><input class="form-control" id="ropa-proc-security" placeholder="e.g. Encryption, access controls, audit logging"></div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Review date</label><input class="form-control" id="ropa-review-date" type="date"></div>
      <div class="form-group"><label>Notes</label><input class="form-control" id="ropa-notes" placeholder="Any additional notes"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-ropa')">Cancel</button><button class="btn btn-primary" onclick="saveRopa()">Save activity</button></div>
  </div>
</div>

<!-- DSR MODAL -->
<div class="overlay" id="modal-dsr">
  <div class="modal modal-wide">
    <div class="modal-title">Log data subject request</div>
    <div class="modal-sub">Deadline clock starts from date of receipt — calendar days, not business days</div>
    <div style="margin-bottom:12px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Organisation's role for this request</div>
      <div class="role-toggle">
        <button class="role-btn active" onclick="setDsrRole(this,'controller')">Controller — respond directly</button>
        <button class="role-btn" onclick="setDsrRole(this,'processor')">Processor — notify controller</button>
      </div>
      <div id="dsr-role-hint-ctrl" style="margin-top:6px;" class="alert-bar alert-blue"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>You respond directly to the data subject within <strong>1 calendar month</strong> of receipt.</span></div>
      <div id="dsr-role-hint-proc" style="display:none;margin-top:6px;" class="alert-bar alert-amber"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>You cannot respond to the data subject directly. <strong>Notify the controller without undue delay</strong> — maximum 5 business days.</span></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Requester name</label><input class="form-control" id="dsr-requester" placeholder="Full name of the data subject"></div>
      <div class="form-group"><label>Right exercised</label><select class="form-control" id="dsr-right"><option value="">Select…</option><option>Art. 15 — Access</option><option>Art. 16 — Rectification</option><option>Art. 17 — Erasure</option><option>Art. 18 — Restriction</option><option>Art. 20 — Portability</option><option>Art. 21 — Object</option><option>Art. 22 — Automated decisions</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date received</label><input class="form-control" id="dsr-received" type="date"><div class="form-hint">Deadline = 1 calendar month from this date</div></div>
      <div class="form-group"><label>Channel received via</label><select class="form-control" id="dsr-channel"><option>Email</option><option>Contact form</option><option>Post</option><option>Verbal (recorded)</option><option>Privacy platform</option><option>Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Identity verified?</label><select class="form-control" id="dsr-verified"><option value="yes">Yes — verified</option><option value="pending">No — verification pending (pauses clock)</option></select></div>
      <div class="form-group"><label>Third party acting on behalf?</label><select class="form-control" id="dsr-third-party"><option value="no">No — direct request</option><option value="legal-rep">Yes — legal representative</option><option value="parent">Yes — parent / guardian</option></select></div>
    </div>
    <div id="dsr-controller-notify-field" style="display:none;">
      <div class="form-row"><div class="form-group"><label>Data controller to notify</label><input class="form-control" id="dsr-controller-notify" placeholder="Controller name / company"><div class="form-hint">Notify within 5 business days of receipt</div></div></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes / context</label><textarea class="form-control" id="dsr-notes" rows="2" placeholder="Any relevant background, prior interactions, or context…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dsr')">Cancel</button><button class="btn btn-primary" onclick="saveDsr()">Log DSR</button></div>
  </div>
</div>

<!-- BREACH MODAL -->
<div class="overlay" id="modal-breach">
  <div class="modal modal-wide">
    <div class="modal-title">Log data breach</div>
    <div class="modal-sub">72-hour SA notification clock starts from detection — act quickly</div>
    <div class="alert-bar alert-red" style="margin-bottom:12px;">
      <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span>If notification to your supervisory authority is required, you have <strong>72 hours from detection</strong>. If in doubt, notify — you can supplement later.</span>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date &amp; time detected</label><input class="form-control" id="breach-detected" type="datetime-local"></div>
      <div class="form-group"><label>Breach type</label><select class="form-control" id="breach-type"><option value="confidentiality">Confidentiality — unauthorised access/disclosure</option><option value="integrity">Integrity — unauthorised alteration</option><option value="availability">Availability — loss/destruction</option><option value="multiple">Multiple types</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description of the breach</label><textarea class="form-control" id="breach-description" rows="2" placeholder="What happened? How was it discovered?"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Estimated records affected</label><input class="form-control" id="breach-records" type="number" placeholder="0"><div class="form-hint">Approximate number of data subjects affected</div></div>
      <div class="form-group"><label>Data categories involved</label><input class="form-control" id="breach-data-cats" placeholder="e.g. Contact data, financial, health…"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Risk level</label><select class="form-control" id="breach-risk"><option value="low">Low — no notification needed</option><option value="medium">Medium — SA notification likely</option><option value="high">High — SA notification required</option><option value="high_subjects">High + data subjects must be notified</option></select></div>
      <div class="form-group"><label>Your role</label><select class="form-control" id="breach-role"><option value="controller">Controller — notify SA directly</option><option value="processor">Processor — notify controller without delay</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Containment measures taken</label><textarea class="form-control" id="breach-containment" rows="2" placeholder="Steps taken to contain the breach…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-breach')">Cancel</button><button class="btn btn-primary" onclick="saveBreach()">Log breach</button></div>
  </div>
</div>

<!-- DPIA MODAL -->
<div class="overlay" id="modal-dpia">
  <div class="modal">
    <div class="modal-title">Start DPIA</div>
    <div class="modal-sub">Art. 35 GDPR · 7-stage process — DPO consultation is mandatory before completion</div>
    <div class="form-row"><div class="form-group"><label>Processing activity name</label><input class="form-control" id="dpia-name" placeholder="Processing activity subject to the DPIA"><div class="form-hint">Refer to the RoPA entry that triggered this DPIA</div></div></div>
    <div class="form-row">
      <div class="form-group"><label>Trigger for DPIA</label><select class="form-control" id="dpia-trigger"><option value="">Select reason…</option><option>Systematic monitoring of public area</option><option>Large-scale special category data</option><option>Large-scale criminal data</option><option>Automated decision-making with legal effect</option><option>New technology / innovative use</option><option>Profiling at scale</option><option>National DPA blacklist — mandatory</option><option>Internal policy — voluntary</option></select></div>
      <div class="form-group"><label>Risk level (initial)</label><select class="form-control" id="dpia-risk"><option value="medium">Medium</option><option value="high">High</option><option value="very_high">Very high</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Linked RoPA activity (optional)</label><input class="form-control" id="dpia-ropa-link" placeholder="Activity name from RoPA"></div>
      <div class="form-group"><label>Lead assessor</label><input class="form-control" id="dpia-assessor" placeholder="Name of person leading the DPIA"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Initial description</label><textarea class="form-control" id="dpia-description" rows="2" placeholder="Brief description of the processing and why a DPIA is needed…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpia')">Cancel</button><button class="btn btn-primary" onclick="saveDpia()">Start DPIA</button></div>
  </div>
</div>

<!-- TIA MODAL -->
<div class="overlay" id="modal-tia">
  <div class="modal modal-wide">
    <div class="modal-title">New Transfer Impact Assessment</div>
    <div class="modal-sub">Art. 44+ GDPR · Post-Schrems II · Assess the legal protection available in the destination country</div>
    <div class="form-row">
      <div class="form-group"><label>Exporter (your entity)</label><input class="form-control" id="tia-exporter" placeholder="Your company name / entity"></div>
      <div class="form-group"><label>Importer name</label><input class="form-control" id="tia-importer" placeholder="Name of the data importer"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Destination country</label><input class="form-control" id="tia-country" placeholder="e.g. US, IN, CN"><div class="form-hint">Country code — risk level will be auto-assessed</div></div>
      <div class="form-group"><label>Transfer mechanism</label><select class="form-control" id="tia-mechanism"><option value="">Select…</option><option value="adequacy">Adequacy decision</option><option value="sccs_c2c">SCCs — controller to controller</option><option value="sccs_c2p">SCCs — controller to processor</option><option value="sccs_p2p">SCCs — processor to processor</option><option value="bcrs">Binding Corporate Rules</option><option value="derogation">Art. 49 derogation</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Data categories transferred</label><input class="form-control" id="tia-data-cats" placeholder="e.g. Employee data, customer contact data"></div>
      <div class="form-group"><label>Purpose of transfer</label><input class="form-control" id="tia-purpose" placeholder="e.g. Cloud hosting, payroll processing"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Risk assessment outcome</label><select class="form-control" id="tia-risk"><option value="low">Low — transfer permitted</option><option value="medium">Medium — additional safeguards applied</option><option value="high">High — reassessment needed</option><option value="not_permitted">Not permitted</option></select></div>
      <div class="form-group"><label>Reassessment due date</label><input class="form-control" id="tia-reassess" type="date"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Supplementary measures (if any)</label><textarea class="form-control" id="tia-measures" rows="2" placeholder="e.g. Technical measures: end-to-end encryption. Contractual: enhanced audit rights. Organisational: access controls…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-tia')">Cancel</button><button class="btn btn-primary" onclick="saveTia()">Save TIA</button></div>
  </div>
</div>

<!-- DPA MODAL -->
<div class="overlay" id="modal-dpa">
  <div class="modal modal-wide">
    <div class="modal-title">Add Data Processing Agreement</div>
    <div class="modal-sub">Art. 28 GDPR · Agreements with processors (as controller) or controllers (as processor)</div>
    <div class="form-row">
      <div class="form-group"><label>Counterparty name</label><input class="form-control" id="dpa-counterparty" placeholder="Company name"></div>
      <div class="form-group"><label>Our role</label><select class="form-control" id="dpa-role"><option value="controller">Controller — counterparty is our processor</option><option value="processor">Processor — counterparty is our controller</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Purpose / scope of processing</label><input class="form-control" id="dpa-purpose" placeholder="e.g. Payroll processing, CRM hosting"></div>
      <div class="form-group"><label>Signed date</label><input class="form-control" id="dpa-signed" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Review date</label><input class="form-control" id="dpa-review" type="date"></div>
      <div class="form-group"><label>TIA linked?</label><input class="form-control" id="dpa-tia-ref" placeholder="TIA reference if third country transfer involved"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="dpa-notes" rows="2" placeholder="Any relevant notes about this agreement…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpa')">Cancel</button><button class="btn btn-primary" onclick="saveDpa()">Save DPA</button></div>
  </div>
</div>

<!-- GIFT MODAL -->
<div class="overlay" id="modal-gift">
  <div class="modal modal-wide">
    <div class="modal-title">Log gift or hospitality</div>
    <div class="modal-sub">All gifts and entertainment must be recorded · Pre-clearance required above the policy threshold</div>
    <div class="form-row">
      <div class="form-group"><label>Employee name</label><input class="form-control" id="gift-employee" placeholder="Full name"></div>
      <div class="form-group"><label>Direction</label><select class="form-control" id="gift-direction"><option value="received">Received — from third party</option><option value="given">Given — to third party</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Type</label><select class="form-control" id="gift-type"><option value="gift">Gift (physical)</option><option value="meal">Meal / entertainment</option><option value="hospitality">Hospitality (event, travel)</option><option value="cash_equiv">Cash equivalent</option><option value="other">Other</option></select></div>
      <div class="form-group"><label>Third party (company)</label><input class="form-control" id="gift-third-party" placeholder="Company name"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Country</label><input class="form-control" id="gift-country" placeholder="e.g. BE, FR, DRC" maxlength="3"><div class="form-hint">Country code — high-risk countries flagged automatically</div></div>
      <div class="form-group"><label>Estimated value (€)</label><input class="form-control" id="gift-value" type="number" placeholder="0.00"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date</label><input class="form-control" id="gift-date" type="date"></div>
      <div class="form-group"><label>Business context</label><input class="form-control" id="gift-context" placeholder="e.g. Contract signing dinner, conference"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="gift-notes" rows="2" placeholder="Any additional context or justification…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-gift')">Cancel</button><button class="btn btn-primary" onclick="saveGift()">Log gift</button></div>
  </div>
</div>

<!-- COI MODAL -->
<div class="overlay" id="modal-coi">
  <div class="modal modal-wide">
    <div class="modal-title">Log COI declaration</div>
    <div class="modal-sub">Annual conflict of interest declaration · All employees and board members</div>
    <div class="form-row">
      <div class="form-group"><label>Person name</label><input class="form-control" id="coi-name" placeholder="Full name"></div>
      <div class="form-group"><label>Category</label><select class="form-control" id="coi-category"><option value="employee">Employee</option><option value="board">Board member</option><option value="consultant">Consultant / contractor</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Role / position</label><input class="form-control" id="coi-role" placeholder="e.g. Sales Director, CFO"></div>
      <div class="form-group"><label>Declaration year</label><input class="form-control" id="coi-year" type="number" placeholder="2026"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Declaration date</label><input class="form-control" id="coi-date" type="date"></div>
      <div class="form-group"><label>Conflict disclosed?</label><select class="form-control" id="coi-conflict" onchange="toggleCoiConflict(this)"><option value="none">No — no conflict to declare</option><option value="yes">Yes — conflict disclosed</option><option value="not_submitted">Not yet submitted</option></select></div>
    </div>
    <div id="coi-conflict-detail" style="display:none;">
      <div class="form-row"><div class="form-group"><label>Description of conflict</label><textarea class="form-control" id="coi-conflict-desc" rows="2" placeholder="Describe the nature of the conflict of interest…"></textarea></div></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="coi-notes" rows="2" placeholder="Any additional notes…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-coi')">Cancel</button><button class="btn btn-primary" onclick="saveCoi()">Save declaration</button></div>
  </div>
</div>

<!-- TPDD MODAL -->
<div class="overlay" id="modal-tpdd">
  <div class="modal modal-wide">
    <div class="modal-title">Add third party</div>
    <div class="modal-sub">Agents, intermediaries, JV partners, high-risk suppliers · DD level auto-set for high-risk countries</div>
    <div class="form-row">
      <div class="form-group"><label>Company name</label><input class="form-control" id="tpdd-company" placeholder="Full legal name"></div>
      <div class="form-group"><label>Type</label><select class="form-control" id="tpdd-type"><option value="agent">Commercial agent</option><option value="intermediary">Intermediary / broker</option><option value="jv_partner">JV partner</option><option value="supplier">High-risk supplier</option><option value="consultant">Consultant</option><option value="other">Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Country</label><input class="form-control" id="tpdd-country" placeholder="e.g. BE, DRC, US" maxlength="3"><div class="form-hint">Country code — risk auto-assessed, enhanced DD required for high-risk</div></div>
      <div class="form-group"><label>DD level</label><select class="form-control" id="tpdd-dd-level"><option value="standard">Standard</option><option value="enhanced">Enhanced</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Last DD completed</label><input class="form-control" id="tpdd-last-dd" type="date"></div>
      <div class="form-group"><label>Next review date</label><input class="form-control" id="tpdd-next-review" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Relationship description</label><textarea class="form-control" id="tpdd-description" rows="2" placeholder="Nature of the business relationship…"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-tpdd')">Cancel</button><button class="btn btn-primary" onclick="saveTpdd()">Add third party</button></div>
  </div>
</div>

<!-- DONATION MODAL -->
<div class="overlay" id="modal-donation">
  <div class="modal modal-wide">
    <div class="modal-title">Log donation or sponsorship</div>
    <div class="modal-sub">All corporate political donations, sponsorships and charitable contributions</div>
    <div class="form-row">
      <div class="form-group"><label>Recipient</label><input class="form-control" id="don-recipient" placeholder="Name of recipient organisation"></div>
      <div class="form-group"><label>Type</label><select class="form-control" id="don-type"><option value="political">Political donation</option><option value="sponsorship">Sponsorship</option><option value="charitable">Charitable contribution</option><option value="cultural">Cultural / arts</option><option value="sports">Sports sponsorship</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Amount (€)</label><input class="form-control" id="don-amount" type="number" placeholder="0.00"></div>
      <div class="form-group"><label>Date</label><input class="form-control" id="don-date" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Jurisdiction</label><input class="form-control" id="don-jurisdiction" placeholder="e.g. Belgium, France"></div>
      <div class="form-group"><label>Board approval required?</label><select class="form-control" id="don-board-approval"><option value="yes">Yes — board approval required</option><option value="no">No — below threshold</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Business justification</label><textarea class="form-control" id="don-justification" rows="2" placeholder="Reason for the donation or sponsorship…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-donation')">Cancel</button><button class="btn btn-primary" onclick="saveDonation()">Log donation</button></div>
  </div>
</div>

<!-- RED FLAG MODAL -->
<div class="overlay" id="modal-flag">
  <div class="modal">
    <div class="modal-title">Log red flag concern</div>
    <div class="modal-sub">Confidential — restricted to editors and admin · For internal legal review</div>
    <div class="form-row">
      <div class="form-group"><label>Date identified</label><input class="form-control" id="flag-date" type="date"></div>
      <div class="form-group"><label>Severity</label><select class="form-control" id="flag-severity"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description</label><textarea class="form-control" id="flag-description" rows="2" placeholder="What was observed? Why is it a concern?"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Related party (if any)</label><input class="form-control" id="flag-party" placeholder="Company or person name"></div>
      <div class="form-group"><label>Country (if relevant)</label><input class="form-control" id="flag-country" placeholder="Country code" maxlength="3"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Source of concern</label><input class="form-control" id="flag-source" placeholder="e.g. Finance team, external audit, management"></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-flag')">Cancel</button><button class="btn btn-primary" onclick="saveFlag()">Log concern</button></div>
  </div>
</div>

<!-- WB MODAL -->
<div class="overlay" id="modal-wb">
  <div class="modal modal-wide">
    <div class="modal-title">Log whistleblowing report</div>
    <div class="modal-sub">EU Directive 2019/1937 · Reporter identity kept strictly separate from case record</div>
    <div class="form-row">
      <div class="form-group"><label>Category</label><select class="form-control" id="wb-category"><option value="">Select…</option><option value="financial_irregularity">Financial irregularity</option><option value="fraud">Fraud</option><option value="corruption">Bribery / corruption</option><option value="safety">Health &amp; safety violation</option><option value="environment">Environmental violation</option><option value="data_protection">Data protection breach</option><option value="harassment">Harassment / discrimination</option><option value="competition">Competition law violation</option><option value="other">Other</option></select></div>
      <div class="form-group"><label>Date received</label><input class="form-control" id="wb-received" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Channel</label><select class="form-control" id="wb-channel"><option value="internal_form">Internal online form</option><option value="email">Email</option><option value="verbal">Verbal (in person)</option><option value="post">Post</option><option value="external">External reporting channel</option></select></div>
      <div class="form-group"><label>Reporter type</label><select class="form-control" id="wb-reporter-type" onchange="toggleWbReporter(this)"><option value="anonymous">Anonymous</option><option value="named">Named — identity recorded separately</option></select></div>
    </div>
    <div id="wb-named-fields" style="display:none;">
      <div class="alert-bar alert-amber" style="margin-bottom:8px;"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Reporter identity is stored in a <strong>separate secure record</strong> and is not visible in the main case register. Only the assigned handler can access it.</span></div>
      <div class="form-row">
        <div class="form-group"><label>Reporter name</label><input class="form-control" id="wb-reporter-name" placeholder="Full name"></div>
        <div class="form-group"><label>Reporter contact</label><input class="form-control" id="wb-reporter-contact" placeholder="Email or phone"></div>
      </div>
    </div>
    <div class="form-row"><div class="form-group"><label>Case summary (do not include identifying details)</label><textarea class="form-control" id="wb-summary" rows="3" placeholder="Factual summary of the report — keep identity-neutral…"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Assigned handler</label><input class="form-control" id="wb-handler" placeholder="Name of the case handler"></div>
      <div class="form-group"><label>Alleged persons / entities involved</label><input class="form-control" id="wb-alleged" placeholder="Names / departments (if known)"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-wb')">Cancel</button><button class="btn btn-primary" onclick="saveWb()">Log report</button></div>
  </div>
</div>

<!-- UPLOAD POLICY MODAL -->
<div class="overlay" id="modal-upload-policy">
  <div class="modal">
    <div class="modal-title">Upload document</div>
    <div class="modal-sub">PDF, Word, Excel or text files · Max 20MB · Stored securely on your server</div>
    <input type="hidden" id="upload-module-target" value="">
    <div class="form-row"><div class="form-group"><label>Document title</label><input class="form-control" id="upload-title" placeholder="e.g. Data Protection Policy v2.1"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Document type</label><select class="form-control" id="upload-doc-type"><option value="policy">Policy</option><option value="template">Template</option><option value="procedure">Procedure</option><option value="guidance">Guidance</option><option value="external">External reference</option></select></div>
      <div class="form-group"><label>Jurisdictions (optional)</label><input class="form-control" id="upload-jurisdictions" placeholder="e.g. BE, FR — or leave blank for all"></div>
    </div>
    <div class="form-group" style="margin-bottom:10px;"><label>File</label>
      <div style="border:2px dashed var(--cream-dark);border-radius:var(--r-lg);padding:20px;text-align:center;cursor:pointer;background:var(--cream);" onclick="document.getElementById('upload-file-input').click()">
        <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:var(--text-faint);fill:none;stroke-width:1.85;margin-bottom:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <div style="font-size:12px;color:var(--text-muted);" id="upload-file-label">Click to choose file</div>
      </div>
      <input type="file" id="upload-file-input" style="display:none" accept=".pdf,.docx,.doc,.xlsx,.txt,.md" onchange="document.getElementById('upload-file-label').textContent=this.files[0]?.name||'Click to choose file'">
    </div>
    <div class="form-row"><div class="form-group"><label>Add to Knowledge Base?</label><select class="form-control" id="upload-kb"><option value="yes">Yes — make searchable in Knowledge Base</option><option value="no">No — compliance module only</option></select></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-upload-policy')">Cancel</button><button class="btn btn-primary" onclick="uploadPolicy()">Upload document</button></div>
  </div>
</div>

<!-- ADD ADVICE NOTE MODAL -->
<div class="overlay" id="modal-add-advice">
  <div class="modal modal-wide">
    <div class="modal-title">Add advice note</div>
    <div class="modal-sub">Record internal guidance, legal analysis or Mickey-generated advice</div>
    <input type="hidden" id="advice-module-target" value="">
    <div class="form-row"><div class="form-group"><label>Title</label><input class="form-control" id="advice-title" placeholder="e.g. Analysis: legitimate interest for direct marketing"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Type</label><select class="form-control" id="advice-type"><option value="advice">Advice note</option><option value="analysis">Legal analysis</option><option value="position">Legal position</option><option value="ai_output">Mickey-generated guidance</option></select></div>
      <div class="form-group"><label>Date</label><input class="form-control" id="advice-date" type="date"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Content</label><textarea class="form-control" id="advice-content" rows="6" placeholder="The advice, analysis or guidance…"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Jurisdictions (optional)</label><input class="form-control" id="advice-jurisdictions" placeholder="e.g. BE, FR — or leave blank for all"></div>
      <div class="form-group"><label>Add to Knowledge Base?</label><select class="form-control" id="advice-kb"><option value="yes">Yes — make searchable in Knowledge Base</option><option value="no">No — compliance module only</option></select></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-add-advice')">Cancel</button><button class="btn btn-primary" onclick="saveAdviceNote()">Save note</button></div>
  </div>
</div>

<!-- INVITE USER MODAL -->
<div class="overlay" id="modal-invite">
  <div class="modal">
    <div class="modal-title">Invite team member</div>
    <div class="modal-sub">They will receive an email invitation to set their password and join your firm</div>
    <div class="form-row">
      <div class="form-group"><label>Full name</label><input class="form-control" id="invite-name" placeholder="Full name"></div>
      <div class="form-group"><label>Email address</label><input class="form-control" id="invite-email" type="email" placeholder="name@company.com"></div>
    </div>
    <div class="form-group" style="margin-bottom:12px;"><label>Role</label>
      <select class="form-control" id="invite-role">
        <option value="viewer">Viewer — read-only access to assigned modules</option>
        <option value="editor">Editor — can create and edit records</option>
        <option value="admin">Admin — full access including user management</option>
      </select>
    </div>
    <div class="form-section-label">Module access</div>
    <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Select which modules this user can see. Unselected modules are hidden entirely from their sidebar.</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:4px;">
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-compliance" value="compliance"> Compliance (GDPR / ABC)</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-wb" value="whistleblowing"> Whistleblowing</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-documents" value="documents" checked> Documents</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-corporate" value="corporate" checked> Corporate</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-radar" value="radar" checked> Legal Radar</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-knowledge" value="knowledge" checked> Knowledge Base</label>
    </div>
    <div class="alert-bar alert-amber" style="margin-top:10px;">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span>Whistleblowing is hidden by default. Only enable for designated case handlers.</span>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-invite')">Cancel</button><button class="btn btn-primary" onclick="inviteUser()">Send invitation</button></div>
  </div>
</div>

<script>
// ── State ─────────────────────────────────────────────────────────────────
const STATE = {
  role: '{{ role }}',
  firmId: '{{ firm_id }}',
  modules: {{ modules | tojson }},
  currentModule: 'gdpr',
  currentView: { gdpr:'dpo', abc:'gifts', wb:'wb-cases', settings:'settings-users' },
  data: { ropa:[], dsrs:[], breaches:[], dpias:[], tias:[], dpas:[], gifts:[], coi:[], tpdd:[], donations:[], flags:[], wb:[], policies:{gdpr:[],abc:[],wb:[]} },
  settings: {{ settings | tojson }},
  dashboard: {{ dashboard | tojson }}
};

// ── Init ──────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  applyRoleVisibility();
  applyModuleVisibility();
  loadSidebarUser();
  setModule('gdpr');
  loadDashboardBadges();
});

function applyRoleVisibility() {
  const isEditor = STATE.role === 'admin' || STATE.role === 'editor';
  document.querySelectorAll('.editor-only').forEach(el => {
    if (!isEditor) el.style.display = 'none';
  });
  // Red flag log hidden from viewers
  if (!isEditor) {
    const flagItem = document.querySelector('[data-view="flags"]');
    if (flagItem) flagItem.style.display = 'none';
  }
}

function applyModuleVisibility() {
  // Hide WB links if user doesn't have whistleblowing module
  if (!STATE.modules.includes('whistleblowing')) {
    document.querySelectorAll('#sub-wb-link,#abc-wb-link').forEach(el => {
      if (el) el.style.display = 'none';
    });
  }
}

function loadSidebarUser() {
  // Will be populated by session data passed from Flask
  const name = '{{ session.get("display_name","") }}' || '{{ session.get("email","") }}';
  const role = STATE.role;
  const av = document.getElementById('sb-avatar');
  const nm = document.getElementById('sb-name');
  const rl = document.getElementById('sb-role');
  if (av && name) av.textContent = name.substring(0,2).toUpperCase();
  if (nm) nm.textContent = name;
  if (rl) rl.textContent = role.charAt(0).toUpperCase() + role.slice(1);
}

// ── Module / View switching ───────────────────────────────────────────────
function setModule(m) {
  STATE.currentModule = m;
  document.querySelectorAll('.module').forEach(el => el.style.display = 'none');
  const mod = document.getElementById('module-' + m);
  if (mod) { mod.style.display = 'flex'; mod.style.flex = '1'; }
  const v = STATE.currentView[m] || '';
  if (v) setView(m, v);
  // Load data for this module
  loadModuleData(m);
}

function setView(module, view) {
  STATE.currentView[module] = view;
  const contentId = module + '-content';
  const content = document.getElementById(contentId);
  if (!content) return;
  content.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  const target = document.getElementById('view-' + module + '-' + view);
  if (target) target.classList.add('active');
  // Update sub-nav active state
  const modEl = document.getElementById('module-' + module);
  if (modEl) {
    modEl.querySelectorAll('.sub-item').forEach(el => {
      el.classList.toggle('active', el.dataset.view === view);
    });
  }
}

// ── Data loading ──────────────────────────────────────────────────────────
async function loadModuleData(m) {
  if (m === 'gdpr') {
    await Promise.all([loadRopa(), loadDsrs(), loadBreaches(), loadDpias(), loadTias(), loadDpas(), loadDpo()]);
    loadPolicies('gdpr');
  } else if (m === 'abc') {
    await Promise.all([loadGifts(), loadCoi(), loadTpdd(), loadDonations(), loadFlags()]);
    loadPolicies('abc');
  } else if (m === 'wb') {
    await Promise.all([loadWb(), loadWbStats()]);
    loadPolicies('wb');
  } else if (m === 'settings') {
    loadUsers();
    loadComplianceSettings();
  }
}

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(path, opts);
  const json = await r.json();
  if (!json.ok && !r.ok) throw new Error(json.error || 'Request failed');
  return json.data !== undefined ? json.data : json;
}

// ── DPO ──────────────────────────────────────────────────────────────────
async function loadDpo() {
  try {
    const d = await api('GET', '/api/compliance/dpo');
    renderDpo(d);
  } catch(e) { console.error(e); }
}

function renderDpo(d) {
  const content = document.getElementById('dpo-content');
  if (!d || !d.dpo_name) return; // show empty state
  const sa = d.supervisory_authority || '';
  content.innerHTML = `
    <div style="padding:0 0 14px;">
      <div class="dpo-hero">
        <div style="display:flex;align-items:center;gap:14px;">
          <div class="dpo-avatar">${(d.dpo_name||'?').split(' ').map(w=>w[0]).join('').substring(0,2)}</div>
          <div>
            <div style="font-family:var(--font-serif);font-size:16px;font-weight:500;">${d.dpo_name}</div>
            <div style="font-size:11.5px;color:var(--text-mid);">${d.dpo_title||''} · ${d.dpo_type==='external'?'External / contracted':'Internal employee'}</div>
          </div>
        </div>
        <div class="dpo-stats">
          <div class="dpo-stat"><div class="dpo-stat-num" style="color:var(--blue);">${STATE.data.dsrs.filter(x=>x.status==='open').length}</div><div class="dpo-stat-lbl">Open DSRs</div></div>
          <div class="dpo-stat"><div class="dpo-stat-num" style="color:var(--amber);">${STATE.data.dpias.filter(x=>x.status!=='completed').length}</div><div class="dpo-stat-lbl">DPIAs active</div></div>
          <div class="dpo-stat"><div class="dpo-stat-num" style="color:var(--success);">${STATE.data.ropa.length}</div><div class="dpo-stat-lbl">RoPA activities</div></div>
        </div>
      </div>
      <div class="info-grid" style="margin-bottom:12px;">
        <div class="info-card"><div class="info-label">Contact email (public)</div><div class="info-val">${d.dpo_email||'—'}</div></div>
        <div class="info-card"><div class="info-label">Contact phone</div><div class="info-val">${d.dpo_phone||'—'}</div></div>
        <div class="info-card"><div class="info-label">Date of appointment</div><div class="info-val">${fmtDate(d.dpo_appointed)||'—'}</div></div>
        <div class="info-card"><div class="info-label">Supervisory authority</div><div class="info-val">${sa}</div></div>
        <div class="info-card"><div class="info-label">SA registration reference</div><div class="info-val">${d.dpo_sa_ref||'—'}</div></div>
        <div class="info-card"><div class="info-label">Next review</div><div class="info-val ${reviewClass(d.dpo_review)}">${fmtDate(d.dpo_review)||'—'}</div></div>
      </div>
      ${d.dpo_justification ? `<div class="info-card"><div class="info-label" style="margin-bottom:5px;">Business justification</div><div style="font-size:12px;color:var(--text-mid);line-height:1.75;">${d.dpo_justification}</div></div>` : ''}
    </div>`;
}

async function saveDPO() {
  const d = {
    dpo_name: v('dpo-name'), dpo_title: v('dpo-title'), dpo_type: v('dpo-type'),
    dpo_email: v('dpo-email'), dpo_phone: v('dpo-phone'),
    dpo_appointed: v('dpo-appointed'), dpo_review: v('dpo-review'),
    dpo_sa_ref: v('dpo-sa-ref'), dpo_justification: v('dpo-justification')
  };
  try {
    await api('POST', '/api/compliance/dpo', d);
    closeModal('modal-dpo');
    toast('DPO record saved', 'ok');
    loadDpo();
  } catch(e) { toast(e.message, 'err'); }
}

// ── RoPA ─────────────────────────────────────────────────────────────────
async function loadRopa() {
  try {
    const data = await api('GET', '/api/compliance/ropa');
    STATE.data.ropa = data;
    renderRopa(data);
    updateBadge('badge-ropa', data.filter(r=>r._rag==='red'||r._rag==='amber').length);
  } catch(e) { console.error(e); }
}

function renderRopa(data) {
  const rag = ragCounts(data, '_rag');
  document.getElementById('ropa-rag').innerHTML = `
    ${ragCard(rag.red,'Overdue review','red')}${ragCard(rag.amber,'Due <30 days','amber')}${ragCard(rag.green,'Up to date','green')}
    <div class="rag-card" style="flex:.8;background:var(--blue-bg);border-color:var(--blue-border)"><div><div class="rag-num" style="color:var(--blue)">${data.filter(r=>r.dpia_required==='yes').length}</div><div class="rag-label" style="color:var(--blue)">DPIA required</div></div></div>`;
  const tbody = document.getElementById('ropa-tbody');
  if (!data.length) { tbody.innerHTML = `<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No activities recorded yet.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r => `
    <tr class="${rowClass(r._rag)}" onclick="editRopa('${r.id}')">
      <td><div class="td-main">${r.activity_name}</div>${r.role==='processor'?'<div class="td-sub">For: '+esc(r.controller_name||'')+'</div>':''}</td>
      <td><span class="badge-tag ${r.role==='controller'?'badge-blue':'badge-muted'}">${r.role==='controller'?'Controller':'Processor'}</span></td>
      <td style="font-size:11px;color:var(--text-muted)">${r.role==='controller'?esc(r.legal_basis||'—'):'N/A (processor)'}</td>
      <td style="font-size:11px;color:var(--text-muted)">${r.role==='controller'?esc(trunc(r.data_categories,40)||'—'):esc(trunc(r.proc_categories,40)||'—')}</td>
      <td style="font-size:11px;color:var(--text-muted)">${r.role==='controller'?esc(r.retention||'—'):'Set by controller'}</td>
      <td>${dlBadge(r._days_remaining, r.review_date)}</td>
      <td><span class="pill pill-${r._rag==='red'?'red':r._rag==='amber'?'amber':'green'}">${r._rag==='red'?'Overdue':r._rag==='amber'?'Due soon':'Up to date'}</span></td>
      <td><span class="chevron">›</span></td>
    </tr>`).join('');
}

function setRopaRole(btn, role) {
  btn.closest('.role-toggle').querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('ropa-controller-fields').style.display = role==='controller' ? 'block' : 'none';
  document.getElementById('ropa-processor-fields').style.display = role==='processor' ? 'block' : 'none';
}

async function saveRopa() {
  const isCtrl = document.querySelector('#modal-ropa .role-btn.active')?.textContent?.includes('Controller');
  const d = {
    activity_name: v('ropa-name'), role: isCtrl ? 'controller' : 'processor',
    review_date: v('ropa-review-date'), notes: v('ropa-notes')
  };
  if (isCtrl) {
    Object.assign(d, { purposes: v('ropa-purposes'), legal_basis: v('ropa-legal-basis'),
      data_subjects: v('ropa-subjects'), data_categories: v('ropa-categories'),
      recipients: v('ropa-recipients'), transfers: v('ropa-transfers'),
      retention: v('ropa-retention'), special_category: v('ropa-special'),
      security_measures: v('ropa-security'), dpia_required: v('ropa-dpia-req') });
  } else {
    Object.assign(d, { controller_name: v('ropa-controller-name'), controller_contact: v('ropa-controller-contact'),
      proc_categories: v('ropa-proc-categories'), dpa_ref: v('ropa-proc-dpa-ref'),
      transfers: v('ropa-proc-transfers'), security_measures: v('ropa-proc-security') });
  }
  if (!d.activity_name) { toast('Activity name required','err'); return; }
  try {
    await api('POST','/api/compliance/ropa',d);
    closeModal('modal-ropa'); resetForm('modal-ropa'); toast('Activity saved','ok'); loadRopa();
  } catch(e) { toast(e.message,'err'); }
}

// ── DSR ──────────────────────────────────────────────────────────────────
async function loadDsrs() {
  try {
    const data = await api('GET','/api/compliance/dsrs');
    STATE.data.dsrs = data;
    renderDsrs(data);
    const urgent = data.filter(d=>d.status==='open'&&(d._rag==='red'||d._rag==='amber')).length;
    updateBadge('badge-dsr', urgent);
  } catch(e) { console.error(e); }
}

function renderDsrs(data) {
  const open = data.filter(d=>d.status==='open');
  const rag = ragCounts(open,'_rag');
  document.getElementById('dsr-rag').innerHTML =
    `${ragCard(rag.red,'Overdue','red')}${ragCard(rag.amber,'Due <14 days','amber')}${ragCard(rag.green,'On track','green')}${ragCard(data.filter(d=>d.status==='closed').length,'Closed','muted')}`;
  const alerts = document.getElementById('dsr-alerts');
  const overdue = open.filter(d=>d._rag==='red');
  alerts.innerHTML = overdue.map(d=>`<div class="alert-bar alert-red"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span><strong>${esc(d.requester_name)}</strong> — ${esc(d.right)} — Deadline ${fmtDate(d.deadline)} — <strong>${Math.abs(d._days_remaining)} days overdue</strong></span></div>`).join('');
  const tbody = document.getElementById('dsr-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DSRs recorded yet.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${rowClass(r._rag)}" data-status="${r.status}" data-role="${r.role}">
      <td><div class="td-main">${esc(r.requester_name)}</div></td>
      <td style="font-size:11.5px">${esc(r.right)}</td>
      <td><span class="badge-tag ${r.role==='controller'?'badge-blue':'badge-muted'}">${r.role==='controller'?'Controller':'Processor'}</span></td>
      <td style="font-size:11.5px">${fmtDate(r.received_date)}</td>
      <td style="font-size:11.5px">${r.deadline?fmtDate(r.deadline):'Clock paused'}</td>
      <td>${r.status==='closed'?'<span style="color:var(--text-muted);font-size:11px">Closed</span>':daysLeft(r._days_remaining)}</td>
      <td><span class="pill pill-${r.status==='closed'?'muted':r._rag==='red'?'red':r._rag==='amber'?'amber':'green'}">${r.status==='closed'?'Closed':r._rag==='red'?'Overdue':r._rag==='amber'?'Due soon':'On track'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="closeDsr('${r.id}',event)" ${r.status==='closed'?'disabled':''}>Close</button></td>
    </tr>`).join('');
}

function setDsrRole(btn, role) {
  btn.closest('.role-toggle').querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('dsr-role-hint-ctrl').style.display = role==='controller'?'flex':'none';
  document.getElementById('dsr-role-hint-proc').style.display = role==='processor'?'flex':'none';
  document.getElementById('dsr-controller-notify-field').style.display = role==='processor'?'block':'none';
}

async function saveDsr() {
  const isCtrl = document.querySelector('#modal-dsr .role-btn.active')?.textContent?.includes('Controller');
  const d = {
    requester_name: v('dsr-requester'), right: v('dsr-right'),
    received_date: v('dsr-received'), channel: v('dsr-channel'),
    identity_verified: v('dsr-verified'), third_party: v('dsr-third-party'),
    notes: v('dsr-notes'), role: isCtrl ? 'controller' : 'processor',
    controller_notify: v('dsr-controller-notify')
  };
  if (!d.requester_name||!d.right||!d.received_date) { toast('Requester, right and date required','err'); return; }
  try {
    await api('POST','/api/compliance/dsrs',d);
    closeModal('modal-dsr'); resetForm('modal-dsr'); toast('DSR logged','ok'); loadDsrs();
  } catch(e) { toast(e.message,'err'); }
}

async function closeDsr(id, e) {
  e.stopPropagation();
  const outcome = prompt('Brief outcome summary:');
  if (outcome === null) return;
  try { await api('POST',`/api/compliance/dsrs/${id}/close`,{outcome}); toast('DSR closed','ok'); loadDsrs(); } catch(e){toast(e.message,'err');}
}

// ── Breach ────────────────────────────────────────────────────────────────
async function loadBreaches() {
  try {
    const data = await api('GET','/api/compliance/breaches');
    STATE.data.breaches = data;
    renderBreaches(data);
    updateBadge('badge-breach', data.filter(b=>b.status==='open').length);
  } catch(e) { console.error(e); }
}

function renderBreaches(data) {
  const open = data.filter(b=>b.status==='open');
  document.getElementById('breach-rag').innerHTML =
    `${ragCard(open.length,'Active','red')}${ragCard(data.filter(b=>b.sa_notified_at).length,'Notified to SA','green')}${ragCard(data.filter(b=>b.risk==='low'&&b.status!=='open').length,'No notification needed','muted')}`;
  const alerts = document.getElementById('breach-alerts');
  alerts.innerHTML = open.filter(b=>b._72h_rag==='red'||b._72h_rag==='amber').map(b=>`
    <div class="alert-bar alert-red"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    <span><strong>${esc(b.ref)}</strong> — 72h SA notification clock: <strong>${b._hours_remaining > 0 ? b._hours_remaining+'h remaining' : 'OVERDUE'}</strong>. ${b.risk==='high'||b.risk==='high_subjects'?'Notify your supervisory authority immediately.':''}</span></div>`).join('');
  const tbody = document.getElementById('breach-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No breaches recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.status==='open'&&r._72h_rag==='red'?'row-red':r.status==='open'&&r._72h_rag==='amber'?'row-amber':''}">
      <td class="mono">${esc(r.ref)}</td>
      <td><div class="td-main">${esc(trunc(r.description,50))}</div></td>
      <td style="font-size:11px">${esc(r.breach_type)}</td>
      <td style="font-size:11.5px">${fmtDateTime(r.detected_at)}</td>
      <td>${r.status==='open'&&r._hours_remaining!=null?`<div class="dl dl-${r._72h_rag}">${clockIcon()}${r._hours_remaining>0?r._hours_remaining+'h left':'OVERDUE'}</div>`:r.sa_notified_at?'<span class="pill pill-green">SA notified</span>':'<span class="pill pill-muted">Not required</span>'}</td>
      <td><span class="risk-box risk-${r.risk==='high'||r.risk==='high_subjects'?'high':r.risk==='medium'?'medium':'low'}">${r.risk}</span></td>
      <td><span class="pill pill-${r.status==='open'?'red':'green'}">${r.status==='open'?'Open':'Resolved'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="resolveBreachPrompt('${r.id}',event)">Update</button></td>
    </tr>`).join('');
}

async function saveBreach() {
  const d = {
    description: v('breach-description'), detected_at: v('breach-detected'),
    breach_type: v('breach-type'), records_affected: v('breach-records'),
    data_categories: v('breach-data-cats'), risk: v('breach-risk'),
    role: v('breach-role'), containment: v('breach-containment')
  };
  if (!d.description||!d.detected_at) { toast('Description and detection time required','err'); return; }
  try { await api('POST','/api/compliance/breaches',d); closeModal('modal-breach'); resetForm('modal-breach'); toast('Breach logged','ok'); loadBreaches(); } catch(e){toast(e.message,'err');}
}

async function resolveBreachPrompt(id, e) {
  e.stopPropagation();
  const action = prompt('Enter update (e.g. "SA notified", "Resolved", "No notification needed"):');
  if (!action) return;
  try { await api('PUT',`/api/compliance/breaches/${id}`,{status:'resolved',resolution_note:action,resolved_at:new Date().toISOString()}); toast('Breach updated','ok'); loadBreaches(); } catch(e){toast(e.message,'err');}
}

// ── DPIA ─────────────────────────────────────────────────────────────────
async function loadDpias() {
  try {
    const data = await api('GET','/api/compliance/dpias');
    STATE.data.dpias = data;
    renderDpias(data);
    updateBadge('badge-dpia', data.filter(d=>d.status!=='completed').length);
  } catch(e) { console.error(e); }
}

const DPIA_STAGES = ['Screening','Necessity','Risk ID','Risk Assessment','Mitigation','DPO Consultation','Final Review'];

function renderDpias(data) {
  const inProg = data.filter(d=>d.status!=='completed').length;
  document.getElementById('dpia-rag').innerHTML =
    `${ragCard(inProg,'In progress','amber')}${ragCard(data.filter(d=>d.status==='completed').length,'Completed','green')}${ragCard(data.filter(d=>d.risk==='very_high').length,'SA consultation may be needed','red')}`;
  const tbody = document.getElementById('dpia-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="7"><div class="empty" style="padding:30px"><p>No DPIAs started.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>{
    const pct = Math.round(((r.stage||0)+1)/7*100);
    const pbClass = r.status==='completed'?'pb-green':r.risk==='very_high'?'pb-red':'pb-amber';
    return `<tr>
      <td><div class="td-main">${esc(r.activity_name)}</div><div class="td-sub">${esc(r.trigger||'')}</div></td>
      <td>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">${DPIA_STAGES[r.stage||0]}</div>
        <div class="progress-wrap"><div class="progress-bar ${pbClass}" style="width:${pct}%"></div></div>
      </td>
      <td style="font-size:11.5px">${esc(r.assessor||'—')}</td>
      <td>${r.stage>=5?'<span class="pill pill-green">Consulted</span>':'<span class="pill pill-muted">Pending</span>'}</td>
      <td><span class="risk-box risk-${r.risk==='very_high'||r.risk==='high'?'high':r.risk==='medium'?'medium':'low'}">${r.risk||'medium'}</span></td>
      <td><span class="pill pill-${r.status==='completed'?'green':'amber'}">${r.status==='completed'?'Completed':'In progress'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="advanceDpia('${r.id}',event)" ${r.status==='completed'?'disabled':''}>Advance</button></td>
    </tr>`;}).join('');
}

async function saveDpia() {
  const d = { activity_name:v('dpia-name'), trigger:v('dpia-trigger'), risk:v('dpia-risk'), ropa_link:v('dpia-ropa-link'), assessor:v('dpia-assessor'), description:v('dpia-description') };
  if (!d.activity_name) { toast('Activity name required','err'); return; }
  try { await api('POST','/api/compliance/dpias',d); closeModal('modal-dpia'); resetForm('modal-dpia'); toast('DPIA started','ok'); loadDpias(); } catch(e){toast(e.message,'err');}
}

async function advanceDpia(id, e) {
  e.stopPropagation();
  if (!confirm('Advance this DPIA to the next stage?')) return;
  try { await api('POST',`/api/compliance/dpias/${id}/advance`,{}); toast('DPIA advanced','ok'); loadDpias(); } catch(e){toast(e.message,'err');}
}

// ── TIA ──────────────────────────────────────────────────────────────────
async function loadTias() {
  try {
    const data = await api('GET','/api/compliance/tias');
    STATE.data.tias = data;
    renderTias(data);
    updateBadge('badge-tia', data.length, 'nb-muted');
  } catch(e) { console.error(e); }
}

function renderTias(data) {
  const rag = ragCounts(data,'_rag');
  document.getElementById('tia-rag').innerHTML =
    `${ragCard(data.filter(r=>r.risk==='not_permitted').length,'Transfer not permitted','red')}${ragCard(rag.amber,'Reassessment due','amber')}${ragCard(rag.green,'Permitted','green')}`;
  const tbody = document.getElementById('tia-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No TIAs recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${rowClass(r._rag)}">
      <td><div class="td-main">${esc(r.importer_name)}</div><div class="td-sub">${esc(r.exporter||'')}</div></td>
      <td><span style="font-size:10px;background:var(--cream-mid);color:var(--text-mid);padding:2px 6px;border-radius:4px;font-weight:600;">${esc(r.destination_country)}</span></td>
      <td style="font-size:11px;color:var(--text-muted)">${esc(r.transfer_mechanism)}</td>
      <td><span class="risk-box risk-${r.risk==='high'||r.risk==='not_permitted'?'high':r.risk==='medium'?'medium':'low'}">${r.risk}</span></td>
      <td>${dlBadge(r._days_remaining, r.reassess_by)}</td>
      <td>${r.dpa_ref?'<span class="pill pill-green">Yes</span>':'<span class="pill pill-muted">No</span>'}</td>
      <td><span class="pill pill-${r.risk==='not_permitted'?'red':r._rag==='amber'?'amber':'green'}">${r.risk==='not_permitted'?'Not permitted':r._rag==='amber'?'Reassess due':'Permitted'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="deleteTia('${r.id}',event)">Remove</button></td>
    </tr>`).join('');
}

async function saveTia() {
  const d = { exporter:v('tia-exporter'), importer_name:v('tia-importer'), destination_country:v('tia-country').toUpperCase(), transfer_mechanism:v('tia-mechanism'), data_categories:v('tia-data-cats'), purpose:v('tia-purpose'), risk:v('tia-risk'), reassess_by:v('tia-reassess'), supplementary_measures:v('tia-measures') };
  if (!d.importer_name||!d.destination_country||!d.transfer_mechanism) { toast('Importer, country and mechanism required','err'); return; }
  try { await api('POST','/api/compliance/tias',d); closeModal('modal-tia'); resetForm('modal-tia'); toast('TIA saved','ok'); loadTias(); } catch(e){toast(e.message,'err');}
}

async function deleteTia(id, e) {
  e.stopPropagation();
  if (!confirm('Remove this TIA?')) return;
  try { await api('DELETE',`/api/compliance/tias/${id}`); toast('TIA removed','ok'); loadTias(); } catch(e){toast(e.message,'err');}
}

// ── DPA ──────────────────────────────────────────────────────────────────
async function loadDpas() {
  try {
    const data = await api('GET','/api/compliance/dpas');
    STATE.data.dpas = data;
    renderDpas(data);
    updateBadge('badge-dpa', data.length, 'nb-muted');
  } catch(e) { console.error(e); }
}

function renderDpas(data) {
  const tbody = document.getElementById('dpa-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DPAs recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${rowClass(r._rag)}">
      <td><div class="td-main">${esc(r.counterparty)}</div></td>
      <td><span class="badge-tag ${r.our_role==='controller'?'badge-blue':'badge-muted'}">${r.our_role==='controller'?'Controller':'Processor'}</span></td>
      <td style="font-size:11px;color:var(--text-muted)">${esc(trunc(r.purpose,35)||'—')}</td>
      <td>${r.tia_ref?'<span class="pill pill-green">Linked</span>':'<span class="pill pill-muted">N/A</span>'}</td>
      <td style="font-size:11.5px">${fmtDate(r.signed)||'—'}</td>
      <td>${dlBadge(r._days_remaining, r.review_date)}</td>
      <td><span class="pill pill-${r._rag==='red'?'red':r._rag==='amber'?'amber':'green'}">${r._rag==='red'?'Overdue':r._rag==='amber'?'Review soon':'Current'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="deleteDpa('${r.id}',event)">Remove</button></td>
    </tr>`).join('');
}

async function saveDpa() {
  const d = { counterparty:v('dpa-counterparty'), our_role:v('dpa-role'), purpose:v('dpa-purpose'), signed:v('dpa-signed'), review_date:v('dpa-review'), tia_ref:v('dpa-tia-ref'), notes:v('dpa-notes') };
  if (!d.counterparty) { toast('Counterparty name required','err'); return; }
  try { await api('POST','/api/compliance/dpas',d); closeModal('modal-dpa'); resetForm('modal-dpa'); toast('DPA saved','ok'); loadDpas(); } catch(e){toast(e.message,'err');}
}

async function deleteDpa(id, e) {
  e.stopPropagation();
  if (!confirm('Remove this DPA?')) return;
  try { await api('DELETE',`/api/compliance/dpas/${id}`); toast('DPA removed','ok'); loadDpas(); } catch(e){toast(e.message,'err');}
}

// ── Gifts ─────────────────────────────────────────────────────────────────
async function loadGifts() {
  try {
    const data = await api('GET','/api/compliance/gifts');
    STATE.data.gifts = data;
    renderGifts(data);
    updateBadge('badge-gifts', data.filter(g=>g.status==='pending').length);
  } catch(e) { console.error(e); }
}

function renderGifts(data) {
  const pending = data.filter(g=>g.status==='pending').length;
  const totalYtd = data.filter(g=>g.status!=='declined').reduce((s,g)=>s+(parseFloat(g.value)||0),0);
  document.getElementById('gifts-rag').innerHTML =
    `${ragCard(pending,'Awaiting approval','amber')}${ragCard(data.filter(g=>g.status==='approved').length,'Approved','green')}${ragCard(data.filter(g=>g.status==='declined').length,'Declined','red')}
    <div class="rag-card" style="flex:.8;background:var(--cream)"><div><div class="rag-num" style="font-size:16px">€ ${totalYtd.toLocaleString()}</div><div class="rag-label">Total value YTD</div></div></div>`;
  const tbody = document.getElementById('gifts-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="9"><div class="empty" style="padding:30px"><p>No gifts recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.status==='pending'?'row-amber':''}" data-direction="${r.direction}" data-status="${r.status}">
      <td><div class="td-main">${esc(r.employee_name)}</div></td>
      <td><span class="badge-tag ${r.direction==='received'?'badge-blue':'badge-muted'}">${r.direction}</span></td>
      <td style="font-size:11.5px">${esc(r.gift_type)}</td>
      <td style="font-size:11.5px">${esc(r.third_party)}</td>
      <td><span class="${r._country_risk==='high'?'country-risk-high':r._country_risk==='medium'?'country-risk-medium':'country-risk-low'}">${esc(r.country||'—')}</span></td>
      <td style="font-size:12px;font-weight:600">€ ${parseFloat(r.value||0).toFixed(2)}</td>
      <td style="font-size:11.5px">${fmtDate(r.gift_date)}</td>
      <td><span class="pill pill-${r.status==='approved'?'green':r.status==='declined'?'red':'amber'}">${r.status}</span></td>
      <td class="editor-only" style="display:flex;gap:4px;padding:6px;">${r.status==='pending'?`<button class="btn btn-ghost btn-sm" onclick="approveGift('${r.id}',event)">Approve</button><button class="btn btn-ghost btn-sm" onclick="declineGift('${r.id}',event)">Decline</button>`:'—'}</td>
    </tr>`).join('');
}

async function saveGift() {
  const d = { employee_name:v('gift-employee'), direction:v('gift-direction'), gift_type:v('gift-type'), third_party:v('gift-third-party'), country:v('gift-country').toUpperCase(), value:v('gift-value'), gift_date:v('gift-date'), context:v('gift-context'), notes:v('gift-notes') };
  if (!d.employee_name||!d.third_party||!d.value||!d.gift_date) { toast('Employee, third party, value and date required','err'); return; }
  try { await api('POST','/api/compliance/gifts',d); closeModal('modal-gift'); resetForm('modal-gift'); toast('Gift logged','ok'); loadGifts(); } catch(e){toast(e.message,'err');}
}

async function approveGift(id, e) { e.stopPropagation(); try { await api('POST',`/api/compliance/gifts/${id}/approve`,{}); toast('Gift approved','ok'); loadGifts(); } catch(e){toast(e.message,'err');} }
async function declineGift(id, e) { e.stopPropagation(); const note=prompt('Reason for decline:'); if(!note)return; try { await api('POST',`/api/compliance/gifts/${id}/decline`,{note}); toast('Gift declined','ok'); loadGifts(); } catch(e){toast(e.message,'err');} }

// ── COI ──────────────────────────────────────────────────────────────────
async function loadCoi() {
  try {
    const data = await api('GET','/api/compliance/coi');
    STATE.data.coi = data;
    renderCoi(data);
    updateBadge('badge-coi', data.filter(c=>c.conflict_status==='not_submitted').length);
  } catch(e) { console.error(e); }
}

function renderCoi(data) {
  const year = new Date().getFullYear();
  const thisYear = data.filter(c=>c.declaration_year==year);
  const missing = thisYear.filter(c=>c.conflict_status==='not_submitted').length;
  document.getElementById('coi-rag').innerHTML =
    `${ragCard(data.filter(c=>c.conflict_status==='yes').length,'Active conflicts','red')}${ragCard(missing,'Declaration missing','amber')}${ragCard(thisYear.filter(c=>c.conflict_status==='none').length,'Declared — no conflict','green')}`;
  const alerts = document.getElementById('coi-alerts');
  alerts.innerHTML = missing > 0 ? `<div class="alert-bar alert-amber"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span><strong>${missing} declaration${missing>1?'s':''} outstanding</strong> for ${year}.</span></div>` : '';
  const tbody = document.getElementById('coi-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No COI declarations recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.conflict_status==='not_submitted'?'row-amber':r.conflict_status==='yes'?'row-red':''}">
      <td><div class="td-main">${esc(r.person_name)}</div><div class="td-sub">${esc(r.person_role||'')}</div></td>
      <td><span class="badge-tag ${r.coi_category==='board'?'badge-blue':'badge-muted'}">${esc(r.coi_category||'employee')}</span></td>
      <td style="font-size:11.5px">${r.declaration_year}</td>
      <td style="font-size:11.5px">${r.declaration_date?fmtDate(r.declaration_date):'Not submitted'}</td>
      <td><span class="pill pill-${r.conflict_status==='yes'?'red':r.conflict_status==='none'?'green':'amber'}">${r.conflict_status==='yes'?'Conflict':r.conflict_status==='none'?'None':'Not submitted'}</span></td>
      <td style="font-size:11.5px">${esc(r.approved_by||'—')}</td>
      <td><span class="pill pill-${r.conflict_status==='not_submitted'?'amber':r.conflict_status==='yes'?'red':'green'}">${r.conflict_status==='not_submitted'?'Missing':r.conflict_status==='yes'?'Conflict disclosed':'Complete'}</span></td>
      <td></td>
    </tr>`).join('');
}

function toggleCoiConflict(sel) {
  document.getElementById('coi-conflict-detail').style.display = sel.value==='yes' ? 'block' : 'none';
}

async function saveCoi() {
  const d = { person_name:v('coi-name'), coi_category:v('coi-category'), person_role:v('coi-role'), declaration_year:v('coi-year'), declaration_date:v('coi-date'), conflict_status:v('coi-conflict'), conflict_description:v('coi-conflict-desc'), notes:v('coi-notes') };
  if (!d.person_name||!d.declaration_year) { toast('Name and year required','err'); return; }
  try { await api('POST','/api/compliance/coi',d); closeModal('modal-coi'); resetForm('modal-coi'); toast('Declaration saved','ok'); loadCoi(); } catch(e){toast(e.message,'err');}
}

// ── TPDD ─────────────────────────────────────────────────────────────────
async function loadTpdd() {
  try {
    const data = await api('GET','/api/compliance/tpdd');
    STATE.data.tpdd = data;
    renderTpdd(data);
    updateBadge('badge-tpdd', data.filter(t=>t._country_risk==='high'&&t.status!=='cleared').length);
  } catch(e) { console.error(e); }
}

function renderTpdd(data) {
  document.getElementById('tpdd-rag').innerHTML =
    `${ragCard(data.filter(t=>t._country_risk==='high'&&t.status!=='cleared').length,'High-risk — action needed','red')}${ragCard(data.filter(t=>t._rag==='amber').length,'Review due','amber')}${ragCard(data.filter(t=>t.status==='cleared').length,'Cleared','green')}`;
  const tbody = document.getElementById('tpdd-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="9"><div class="empty" style="padding:30px"><p>No third parties recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r._country_risk==='high'?'row-red':r._rag==='amber'?'row-amber':''}">
      <td><div class="td-main">${esc(r.company_name)}</div></td>
      <td style="font-size:11px;color:var(--text-muted)">${esc(r.third_party_type)}</td>
      <td><span class="${r._country_risk==='high'?'country-risk-high':r._country_risk==='medium'?'country-risk-medium':'country-risk-low'}">${esc(r.country||'—')}</span></td>
      <td><span style="font-size:10.5px;background:${r.dd_level==='enhanced'?'var(--red-bg)':'var(--cream-mid)'};color:${r.dd_level==='enhanced'?'var(--red)':'var(--text-mid)'};padding:2px 7px;border-radius:4px;font-weight:600;">${r.dd_level||'standard'}</span></td>
      <td style="font-size:11.5px">${r.last_dd?fmtDate(r.last_dd):'Never'}</td>
      <td>${dlBadge(r._days_remaining, r.next_review)}</td>
      <td><span class="risk-box risk-${r._country_risk==='high'?'high':r._country_risk==='medium'?'medium':'low'}">${r._country_risk}</span></td>
      <td><span class="pill pill-${r._country_risk==='high'&&r.status!=='cleared'?'red':r._rag==='amber'?'amber':'green'}">${r._country_risk==='high'&&r.status!=='cleared'?'Action needed':r._rag==='amber'?'Review due':'Cleared'}</span></td>
      <td></td>
    </tr>`).join('');
}

async function saveTpdd() {
  const d = { company_name:v('tpdd-company'), third_party_type:v('tpdd-type'), country:v('tpdd-country').toUpperCase(), dd_level:v('tpdd-dd-level'), last_dd:v('tpdd-last-dd'), next_review:v('tpdd-next-review'), description:v('tpdd-description') };
  if (!d.company_name||!d.country) { toast('Company name and country required','err'); return; }
  try { await api('POST','/api/compliance/tpdd',d); closeModal('modal-tpdd'); resetForm('modal-tpdd'); toast('Third party added','ok'); loadTpdd(); } catch(e){toast(e.message,'err');}
}

// ── Donations ─────────────────────────────────────────────────────────────
async function loadDonations() {
  try {
    const data = await api('GET','/api/compliance/donations');
    STATE.data.donations = data;
    renderDonations(data);
  } catch(e) { console.error(e); }
}

function renderDonations(data) {
  const tbody = document.getElementById('donations-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No donations recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.status==='pending_board'?'row-amber':''}">
      <td><div class="td-main">${esc(r.recipient)}</div></td>
      <td style="font-size:11.5px">${esc(r.donation_type)}</td>
      <td style="font-size:12px;font-weight:600">€ ${parseFloat(r.amount||0).toFixed(2)}</td>
      <td style="font-size:11.5px">${fmtDate(r.donation_date)}</td>
      <td style="font-size:11.5px">${esc(r.jurisdiction||'—')}</td>
      <td>${r.board_approval_required==='yes'?'<span class="pill pill-amber">Required</span>':'<span class="pill pill-muted">Below threshold</span>'}</td>
      <td><span class="pill pill-${r.status==='approved'?'green':r.status==='declined'?'red':'amber'}">${r.status}</span></td>
      <td></td>
    </tr>`).join('');
}

async function saveDonation() {
  const d = { recipient:v('don-recipient'), donation_type:v('don-type'), amount:v('don-amount'), donation_date:v('don-date'), jurisdiction:v('don-jurisdiction'), board_approval_required:v('don-board-approval'), justification:v('don-justification') };
  if (!d.recipient||!d.amount||!d.donation_date) { toast('Recipient, amount and date required','err'); return; }
  try { await api('POST','/api/compliance/donations',d); closeModal('modal-donation'); resetForm('modal-donation'); toast('Donation logged','ok'); loadDonations(); } catch(e){toast(e.message,'err');}
}

// ── Red Flags ─────────────────────────────────────────────────────────────
async function loadFlags() {
  if (STATE.role==='viewer') return;
  try {
    const data = await api('GET','/api/compliance/flags');
    renderFlags(data);
  } catch(e) { console.error(e); }
}

function renderFlags(data) {
  const tbody = document.getElementById('flags-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="7"><div class="empty" style="padding:30px"><p>No red flags recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.severity==='high'?'row-red':r.severity==='medium'?'row-amber':''}">
      <td style="font-size:11.5px">${fmtDate(r.identified_date)}</td>
      <td><div class="td-main">${esc(trunc(r.description,60))}</div></td>
      <td style="font-size:11.5px">${esc(r.related_party||'—')}</td>
      <td>${r.country?`<span class="country-risk-${r._country_risk||'low'}">${esc(r.country)}</span>`:'—'}</td>
      <td><span class="risk-box risk-${r.severity==='high'?'high':r.severity==='medium'?'medium':'low'}">${r.severity}</span></td>
      <td><span class="pill pill-${r.status==='open'?'amber':'muted'}">${r.status}</span></td>
      <td></td>
    </tr>`).join('');
}

async function saveFlag() {
  const d = { description:v('flag-description'), identified_date:v('flag-date'), severity:v('flag-severity'), related_party:v('flag-party'), country:v('flag-country').toUpperCase(), source:v('flag-source') };
  if (!d.description||!d.identified_date) { toast('Description and date required','err'); return; }
  try { await api('POST','/api/compliance/flags',d); closeModal('modal-flag'); resetForm('modal-flag'); toast('Concern logged','ok'); loadFlags(); } catch(e){toast(e.message,'err');}
}

// ── Whistleblowing ────────────────────────────────────────────────────────
async function loadWb() {
  try {
    const data = await api('GET','/api/compliance/wb');
    STATE.data.wb = data;
    renderWb(data);
    updateBadge('badge-wb', data.filter(w=>!['closed','no_action'].includes(w.status)).length);
  } catch(e) { console.error(e); }
}

function renderWb(data) {
  const open = data.filter(w=>!['closed','no_action'].includes(w.status));
  document.getElementById('wb-rag').innerHTML =
    `${ragCard(open.length,'Open — action needed','amber')}${ragCard(data.filter(w=>['closed','no_action'].includes(w.status)).length,'Closed YTD','green')}`;
  const alerts = document.getElementById('wb-alerts');
  alerts.innerHTML = open.filter(w=>w._ack_days!==null&&w._ack_days<=3&&w.status==='received').map(w=>`
    <div class="alert-bar alert-amber"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <span><strong>${esc(w.ref)}</strong> — Acknowledgement due by ${fmtDate(w.acknowledge_by)} (${w._ack_days<=0?'overdue':w._ack_days+' days'}). Access restricted to assigned handler.</span></div>`).join('');
  const tbody = document.getElementById('wb-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="9"><div class="empty" style="padding:30px"><p>No cases recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r._ack_days!==null&&r._ack_days<=3&&r.status==='received'?'row-amber':''}">
      <td class="mono">${esc(r.ref)}</td>
      <td style="font-size:11.5px">${esc(r.category)}</td>
      <td><span class="pill pill-${r.reporter_type==='anonymous'?'muted':'blue'}">${r.reporter_type==='anonymous'?'Anonymous':'Named'}</span></td>
      <td style="font-size:11.5px">${fmtDate(r.received_date)}</td>
      <td>${dlBadge(r._ack_days, r.acknowledge_by, 3)}</td>
      <td>${dlBadge(r._outcome_days, r.outcome_by, 14)}</td>
      <td><span class="av">${(r.handler||'?').substring(0,2).toUpperCase()}</span></td>
      <td><span class="pill pill-${r.status==='investigating'?'amber':r.status==='received'?'blue':r.status==='acknowledged'?'amber':'muted'}">${r.status}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="updateWbStatus('${r.id}',event)">Update</button></td>
    </tr>`).join('');
}

async function saveWb() {
  const isNamed = v('wb-reporter-type')==='named';
  const d = { category:v('wb-category'), received_date:v('wb-received'), channel:v('wb-channel'), reporter_type:v('wb-reporter-type'), summary:v('wb-summary'), handler:v('wb-handler'), alleged:v('wb-alleged') };
  if (isNamed) { d.reporter_name=v('wb-reporter-name'); d.reporter_contact=v('wb-reporter-contact'); }
  if (!d.category||!d.received_date||!d.summary) { toast('Category, date and summary required','err'); return; }
  try { await api('POST','/api/compliance/wb',d); closeModal('modal-wb'); resetForm('modal-wb'); toast('Report logged','ok'); loadWb(); } catch(e){toast(e.message,'err');}
}

async function updateWbStatus(id, e) {
  e.stopPropagation();
  const status = prompt('New status (acknowledged / investigating / closed / no_action):');
  if (!status) return;
  const note = prompt('Update note (optional):') || '';
  try { await api('POST',`/api/compliance/wb/${id}/status`,{status,note}); toast('Status updated','ok'); loadWb(); } catch(e){toast(e.message,'err');}
}

function toggleWbReporter(sel) {
  document.getElementById('wb-named-fields').style.display = sel.value==='named' ? 'block' : 'none';
}

async function loadWbStats() {
  try {
    const stats = await api('GET','/api/compliance/wb/stats');
    renderWbAnnual(stats);
  } catch(e) { console.error(e); }
}

function renderWbAnnual(stats) {
  const el = document.getElementById('wb-annual-content');
  if (!el) return;
  const cats = Object.entries(stats.by_category||{}).map(([k,v])=>`<tr><td style="font-size:12px">${k}</td><td style="font-size:12px;font-weight:600">${v}</td></tr>`).join('');
  el.innerHTML = `<div class="info-grid" style="padding:0 22px 14px;">
    <div class="info-card"><div class="info-label">Total reports ${stats.year}</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;">${stats.total}</div></div>
    <div class="info-card"><div class="info-label">Open</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;color:var(--amber)">${stats.open}</div></div>
    <div class="info-card"><div class="info-label">Closed</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;color:var(--success)">${stats.closed}</div></div>
    <div class="info-card"><div class="info-label">Anonymous reports</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;">${stats.anonymous}</div></div>
  </div>
  ${cats?`<div class="section"><div class="table-wrap"><table><thead><tr><th>Category</th><th>Count</th></tr></thead><tbody>${cats}</tbody></table></div></div>`:''}`;
}

// ── Policies ──────────────────────────────────────────────────────────────
async function loadPolicies(module) {
  try {
    const data = await api('GET',`/api/compliance/policies?module=${module}`);
    STATE.data.policies[module] = data;
    renderPolicies(module, data);
  } catch(e) { console.error(e); }
}

function renderPolicies(module, data) {
  const grid = document.getElementById('policies-' + module);
  if (!grid) return;
  const isEditor = STATE.role==='admin'||STATE.role==='editor';
  const cards = data.map(p=>`
    <div class="policy-card" onclick="openPolicy('${p.id}')">
      <div class="policy-card-top">
        <div class="p-icon ${p.from_radar?'p-icon-radar':p.doc_type==='advice'||p.doc_type==='ai_output'?'p-icon-advice':p.doc_type==='template'?'p-icon-template':'p-icon-doc'}">
          ${p.from_radar?radarIconSvg():p.doc_type==='advice'||p.doc_type==='ai_output'?infoIconSvg():docIconSvg()}
        </div>
        <div><div class="policy-name">${esc(p.title)}</div><div class="policy-meta">${p.doc_type}${p.created_at?' · '+fmtDate(p.created_at):''}${p.file_ext?' · '+p.file_ext.toUpperCase():''}</div></div>
      </div>
      <div class="policy-footer">
        ${p.in_kb!==false?'<span class="p-tag p-tag-kb">'+bookIconSvg()+' Knowledge Base</span>':''}
        ${p.from_radar?'<span class="p-tag p-tag-radar">'+radarIconSvg()+' From Radar</span>':''}
        <span class="p-tag p-tag-module">${module.toUpperCase()} · ${p.doc_type}</span>
      </div>
    </div>`).join('');
  const addCard = isEditor ? `<div class="policy-add-card" onclick="openModal('modal-upload-policy','${module}')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span style="font-size:11.5px">Upload or add note</span></div>` : '';
  grid.innerHTML = cards + addCard;
}

function openModal(id, moduleTarget) {
  const overlay = document.getElementById(id);
  if (!overlay) return;
  if (moduleTarget) {
    const t1 = document.getElementById('upload-module-target');
    const t2 = document.getElementById('advice-module-target');
    if (t1) t1.value = moduleTarget;
    if (t2) t2.value = moduleTarget;
  }
  overlay.classList.add('open');
}

async function uploadPolicy() {
  const moduleTarget = v('upload-module-target');
  const file = document.getElementById('upload-file-input').files[0];
  if (!file) { toast('Please select a file','err'); return; }
  const fd = new FormData();
  fd.append('file', file);
  fd.append('title', v('upload-title') || file.name);
  fd.append('doc_type', v('upload-doc-type'));
  fd.append('module', moduleTarget);
  fd.append('jurisdictions', v('upload-jurisdictions'));
  try {
    const r = await fetch('/api/compliance/policies/upload', { method:'POST', body:fd });
    const json = await r.json();
    if (!json.ok) throw new Error(json.error);
    closeModal('modal-upload-policy');
    document.getElementById('upload-file-input').value='';
    document.getElementById('upload-file-label').textContent='Click to choose file';
    toast('Document uploaded','ok');
    loadPolicies(moduleTarget);
  } catch(e) { toast(e.message,'err'); }
}

async function saveAdviceNote() {
  const moduleTarget = v('advice-module-target');
  const d = { title:v('advice-title'), doc_type:v('advice-type'), module:moduleTarget, content:v('advice-content'), note_date:v('advice-date'), jurisdictions:v('advice-jurisdictions'), in_kb:v('advice-kb')==='yes' };
  if (!d.title||!d.content) { toast('Title and content required','err'); return; }
  try { await api('POST','/api/compliance/policies',d); closeModal('modal-add-advice'); resetForm('modal-add-advice'); toast('Advice note saved','ok'); loadPolicies(moduleTarget); } catch(e){toast(e.message,'err');}
}

function openPolicy(id) {
  // TODO: open a detail/view modal or download file
  toast('Opening document…');
}

function filterPolicies(module, search, type) {
  const data = STATE.data.policies[module] || [];
  let filtered = data;
  if (search) filtered = filtered.filter(p=>p.title.toLowerCase().includes(search.toLowerCase()));
  if (type) filtered = filtered.filter(p=>p.doc_type===type);
  renderPolicies(module, filtered);
}

// ── Settings: Users ───────────────────────────────────────────────────────
async function loadUsers() {
  try {
    const users = await api('GET','/api/settings/users');
    renderUsers(users);
  } catch(e) { console.error(e); }
}

const ALL_MODULES = ['compliance','whistleblowing','documents','corporate','radar','knowledge'];
const MODULE_LABELS = {compliance:'Compliance',whistleblowing:'Whistleblowing',documents:'Documents',corporate:'Corporate',radar:'Legal Radar',knowledge:'Knowledge Base'};

function renderUsers(users) {
  const wrap = document.getElementById('users-table-wrap');
  const isAdmin = STATE.role==='admin';
  wrap.innerHTML = `<div class="table-wrap"><table class="user-matrix">
    <thead><tr><th>Name</th><th>Email</th><th>Role</th>${ALL_MODULES.map(m=>`<th style="text-align:center;font-size:9px">${MODULE_LABELS[m]}</th>`).join('')}<th>Status</th>${isAdmin?'<th></th>':''}</tr></thead>
    <tbody>${users.map(u=>`
      <tr>
        <td><div style="font-weight:500">${esc(u.display_name||'—')}</div>${u.user_id===STATE.firmId?'<div class="td-sub">You</div>':''}</td>
        <td style="font-size:11.5px;color:var(--text-muted)">${esc(u.email)}</td>
        <td>${isAdmin?`<select class="form-control" style="padding:4px 7px;font-size:11.5px;" onchange="updateUserRole('${u.user_id}',this.value)"><option ${u.compliance_role==='admin'?'selected':''} value="admin">Admin</option><option ${u.compliance_role==='editor'?'selected':''} value="editor">Editor</option><option ${u.compliance_role==='viewer'?'selected':''} value="viewer">Viewer</option></select>`:`<span class="badge-tag badge-muted">${u.compliance_role}</span>`}</td>
        ${ALL_MODULES.map(m=>`<td style="text-align:center">${isAdmin?`<input type="checkbox" ${u.modules?.includes(m)?'checked':''} onchange="updateUserModule('${u.user_id}','${m}',this.checked)" ${m==='whistleblowing'?'title="Whistleblowing: enable only for designated handlers"':''}>`:u.modules?.includes(m)?'✓':'—'}</td>`).join('')}
        <td><span class="pill pill-${u.status==='active'?'green':u.status==='pending_invite'?'amber':'muted'}">${u.status}</span></td>
        ${isAdmin?`<td><button class="btn btn-ghost btn-sm" onclick="deactivateUser('${u.user_id}')" ${u.status==='inactive'?'disabled':''}>Deactivate</button></td>`:''}
      </tr>`).join('')}
    </tbody>
  </table></div>`;
}

async function updateUserRole(userId, role) {
  try { await api('PUT',`/api/settings/users/${userId}`,{compliance_role:role}); toast('Role updated','ok'); loadUsers(); } catch(e){toast(e.message,'err');}
}

async function updateUserModule(userId, module, enabled) {
  try {
    const users = await api('GET','/api/settings/users');
    const user = users.find(u=>u.user_id===userId);
    if (!user) return;
    let mods = user.modules || [];
    if (enabled) { if (!mods.includes(module)) mods.push(module); }
    else { mods = mods.filter(m=>m!==module); }
    await api('PUT',`/api/settings/users/${userId}`,{modules:mods});
    toast('Access updated','ok');
  } catch(e){toast(e.message,'err');}
}

async function deactivateUser(userId) {
  if (!confirm('Deactivate this user? They will lose all access immediately.')) return;
  try { await api('POST',`/api/settings/users/${userId}/deactivate`,{}); toast('User deactivated','ok'); loadUsers(); } catch(e){toast(e.message,'err');}
}

async function inviteUser() {
  const mods = ALL_MODULES.filter(m=>document.getElementById('inv-mod-'+m)?.checked);
  const d = { display_name:v('invite-name'), email:v('invite-email'), compliance_role:v('invite-role'), modules:mods };
  if (!d.email) { toast('Email required','err'); return; }
  try { await api('POST','/api/settings/users/invite',d); closeModal('modal-invite'); resetForm('modal-invite'); toast('Invitation sent','ok'); loadUsers(); } catch(e){toast(e.message,'err');}
}

// ── Compliance settings ───────────────────────────────────────────────────
async function loadComplianceSettings() {
  try {
    const s = await api('GET','/api/compliance/settings');
    if (s.primary_jurisdiction) document.getElementById('setting-primary-jurisdiction').value = s.primary_jurisdiction;
    if (s.extra_jurisdictions) document.getElementById('setting-extra-jurisdictions').value = s.extra_jurisdictions;
    if (s.gift_threshold) document.getElementById('setting-gift-threshold').value = s.gift_threshold;
    if (s.gift_autodecline) document.getElementById('setting-gift-autodecline').value = s.gift_autodecline;
    if (s.wb_channel) document.getElementById('setting-wb-channel').value = s.wb_channel;
    if (s.wb_handler) document.getElementById('setting-wb-handler').value = s.wb_handler;
  } catch(e) { console.error(e); }
}

async function saveComplianceSettings() {
  const d = { primary_jurisdiction:v('setting-primary-jurisdiction'), extra_jurisdictions:v('setting-extra-jurisdictions'), gift_threshold:v('setting-gift-threshold'), gift_autodecline:v('setting-gift-autodecline'), wb_channel:v('setting-wb-channel'), wb_handler:v('setting-wb-handler') };
  try { await api('POST','/api/compliance/settings',d); toast('Settings saved','ok'); } catch(e){toast(e.message,'err');}
}

// ── Dashboard badges ──────────────────────────────────────────────────────
function loadDashboardBadges() {
  const d = STATE.dashboard;
  if (!d) return;
  const gdprUrgent = (d.gdpr?.dsr_overdue||0)+(d.gdpr?.breach_active||0)+(d.gdpr?.ropa_overdue||0);
  updateBadge('sb-compliance-badge', gdprUrgent);
}

// ── Export (stub) ─────────────────────────────────────────────────────────
async function exportRegister(type) {
  try {
    const data = STATE.data[type];
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `mickey-${type}-export-${new Date().toISOString().slice(0,10)}.json`;
    a.click(); URL.revokeObjectURL(a.href);
    toast('Export downloaded');
  } catch(e) { toast('Export failed','err'); }
}

function exportAudit(module) { exportRegister(module); }

// ── Utilities ─────────────────────────────────────────────────────────────
function v(id) { const el=document.getElementById(id); return el?el.value.trim():''; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function trunc(s,n) { return s&&s.length>n?s.substring(0,n)+'…':s; }
function fmtDate(d) { if(!d)return'—'; try{return new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});}catch{return d;} }
function fmtDateTime(d) { if(!d)return'—'; try{return new Date(d).toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});}catch{return d;} }
function reviewClass(d) { const days=daysUntil(d); return days!==null&&days<0?'color:var(--red)':days!==null&&days<30?'color:var(--amber)':''; }
function daysUntil(d) { if(!d)return null; try{return Math.round((new Date(d)-new Date())/86400000);}catch{return null;} }
function ragCounts(arr, field) { return {red:arr.filter(r=>r[field]==='red').length,amber:arr.filter(r=>r[field]==='amber').length,green:arr.filter(r=>r[field]==='green').length}; }
function rowClass(rag) { return rag==='red'?'row-red':rag==='amber'?'row-amber':''; }
function ragCard(num,label,colour) {
  const cols = {red:'var(--red)',amber:'var(--amber)',green:'var(--success)',muted:'var(--text-muted)',blue:'var(--blue)'};
  const bgs = {red:'',amber:'',green:'',muted:'background:var(--cream);',blue:'background:var(--blue-bg);border-color:var(--blue-border);'};
  return `<div class="rag-card" style="${bgs[colour]||''}"><div class="rag-dot" style="background:${cols[colour]||cols.muted}"></div><div><div class="rag-num" style="color:${cols[colour]||cols.muted}">${num}</div><div class="rag-label">${label}</div></div></div>`;
}
function daysLeft(days) {
  if (days===null||days===undefined) return '—';
  if (days<0) return `<span style="color:var(--red);font-size:11px;font-weight:600">${Math.abs(days)}d overdue</span>`;
  if (days===0) return `<span style="color:var(--red);font-size:11px;font-weight:600">Due today</span>`;
  return `<span style="color:${days<=7?'var(--red)':days<=14?'var(--amber)':'var(--text-muted)'};font-size:11.5px">${days}d</span>`;
}
function dlBadge(days, date, warn=30) {
  if (!date) return '—';
  const cls = days===null?'dl-ok':days<0?'dl-red':days<=warn?'dl-amber':'dl-ok';
  const label = days===null?fmtDate(date):days<0?Math.abs(days)+'d overdue':days===0?'Today':days+'d · '+fmtDate(date);
  return `<div class="dl ${cls}">${clockIcon()}${label}</div>`;
}
function clockIcon() { return `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`; }
function docIconSvg() { return `<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`; }
function infoIconSvg() { return `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`; }
function radarIconSvg() { return `<svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`; }
function bookIconSvg() { return `<svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>`; }
function updateBadge(id, count, cls) {
  const el = document.getElementById(id);
  if (!el) return;
  if (count > 0) { el.textContent=count; el.style.display='inline-block'; if(cls) el.className='nav-badge '+cls; }
  else { el.style.display='none'; }
}
function filterTable(tableId, search) {
  const rows = document.querySelectorAll('#'+tableId+' tbody tr');
  rows.forEach(r=>{ r.style.display=r.textContent.toLowerCase().includes(search.toLowerCase())?'':'none'; });
}
function filterChip(chip, tableId, value, attr) {
  chip.closest('.filter-bar').querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  if (!value) { document.querySelectorAll('#'+tableId+' tbody tr').forEach(r=>r.style.display=''); return; }
  document.querySelectorAll('#'+tableId+' tbody tr').forEach(r=>{ r.style.display=(r.dataset[attr]||'').toLowerCase()===value?'':'none'; });
}
function resetForm(modalId) {
  document.querySelectorAll('#'+modalId+' input:not([type=hidden]),#'+modalId+' textarea').forEach(el=>el.value='');
  document.querySelectorAll('#'+modalId+' select').forEach(el=>el.selectedIndex=0);
}
function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// Toast
function toast(msg, type) {
  const el = document.createElement('div');
  el.className = 'toast-item'+(type==='ok'?' toast-ok':type==='err'?' toast-err':'');
  el.textContent = msg;
  document.getElementById('toast').appendChild(el);
  setTimeout(()=>el.remove(), 3200);
}

// Sidebar nav to settings
document.getElementById('sb-settings')?.addEventListener('click', e=>{ e.preventDefault(); setModule('settings'); });
</script>
</body>
</html>
