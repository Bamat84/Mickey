{% extends "auth/base.html" %}
{% block title %}Reset password — Mickey{% endblock %}

{% block head %}
<style>
  .pw-wrap { position: relative; }
  .pw-toggle {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    background: none; border: none; cursor: pointer; padding: 4px;
    color: var(--text-muted); display: flex; align-items: center;
    border-radius: 4px; transition: color .12s;
  }
  .pw-toggle:hover { color: var(--text); }
  .pw-toggle svg { width: 15px; height: 15px; stroke: currentColor; fill: none; stroke-width: 1.85; stroke-linecap: round; stroke-linejoin: round; }
  .pw-input { padding-right: 42px !important; }
</style>
{% endblock %}

{% block body %}
<div class="auth-page">
  <div class="auth-card">

    <div class="auth-logo">
      <div class="auth-logomark">m</div>
      <div class="auth-wordmark">Mickey<span>Legal Intelligence</span></div>
    </div>

    {% if invalid %}
    <!-- Invalid token -->
    <div class="alert alert-red">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <div>
        <strong>Invalid reset link</strong><br>
        This link has already been used or is invalid. Please request a new one.
      </div>
    </div>
    <a href="/forgot-password" class="btn btn-primary btn-full" style="margin-top:8px;">Request new reset link</a>

    {% elif expired %}
    <!-- Expired token -->
    <div class="alert alert-amber">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <div>
        <strong>Reset link expired</strong><br>
        Password reset links expire after 1 hour. Please request a new one.
      </div>
    </div>
    <a href="/forgot-password" class="btn btn-primary btn-full" style="margin-top:8px;">Request new reset link</a>

    {% else %}
    <!-- Valid token — show form -->

    <!-- Success state -->
    <div id="state-success" style="display:none;text-align:center;">
      <div style="width:52px;height:52px;background:var(--green-light);border:1.5px solid var(--green-border);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <h1 class="auth-title">Password updated</h1>
      <p class="auth-sub">Your password has been changed successfully.</p>
      <a href="/signin" class="btn btn-primary btn-full" style="margin-top:8px;">Sign in</a>
    </div>

    <!-- Form state -->
    <div id="state-form">
      <h1 class="auth-title">Choose a new password</h1>
      <p class="auth-sub">This link expires in 1 hour and can only be used once.</p>

      <div id="alert-error" class="alert alert-red" style="display:none;">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="alert-error-msg"></span>
      </div>

      <div class="form-group">
        <label class="form-label" for="password">New password</label>
        <div class="pw-wrap">
          <input class="form-input pw-input" type="password" id="password" autocomplete="new-password" oninput="checkPwStrength(this.value)">
          <button type="button" class="pw-toggle" onclick="togglePw('password','eye-pw')" tabindex="-1" title="Show / hide password">
            <svg id="eye-pw" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <!-- Strength indicator -->
        <div id="pw-strength-bar" style="display:none;margin-top:6px;">
          <div style="height:3px;background:var(--cream-dark);border-radius:2px;overflow:hidden;">
            <div id="pw-strength-fill" style="height:100%;width:0%;border-radius:2px;transition:width .2s,background .2s;"></div>
          </div>
          <div id="pw-strength-rules" style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;"></div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="confirm">Confirm new password</label>
        <div class="pw-wrap">
          <input class="form-input pw-input" type="password" id="confirm" autocomplete="new-password">
          <button type="button" class="pw-toggle" onclick="togglePw('confirm','eye-confirm')" tabindex="-1" title="Show / hide password">
            <svg id="eye-confirm" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
      </div>

      <div style="margin-top:24px;">
        <button class="btn btn-primary btn-full" id="btn-reset" onclick="doReset()">
          Set new password
        </button>
      </div>
    </div>

    {% endif %}

  </div>

  <div class="auth-footer">
    <a href="/signin">Back to sign in</a>
  </div>
</div>

<script>
const TOKEN = "{{ token }}";

function togglePw(inputId, iconId) {
  const input = document.getElementById(inputId);
  const icon  = document.getElementById(iconId);
  const show  = input.type === 'password';
  input.type  = show ? 'text' : 'password';
  icon.innerHTML = show
    ? `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/>
       <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/>
       <line x1="1" y1="1" x2="23" y2="23"/>`
    : `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
       <circle cx="12" cy="12" r="3"/>`;
}

function checkPwStrength(pw) {
  const bar   = document.getElementById('pw-strength-bar');
  const fill  = document.getElementById('pw-strength-fill');
  const rules = document.getElementById('pw-strength-rules');
  if (!pw) { bar.style.display = 'none'; return; }
  bar.style.display = 'block';
  const checks = [
    { label: '8+ characters',     ok: pw.length >= 8 },
    { label: 'Uppercase letter',  ok: /[A-Z]/.test(pw) },
    { label: 'Number',            ok: /[0-9]/.test(pw) },
    { label: 'Special character', ok: /[!@#$%^&*()\-_=+\[\]{};:\'",.<>\/?`~\\|]/.test(pw) },
  ];
  const score = checks.filter(c => c.ok).length;
  const colours = ['#C0392B','#E67E22','#C8A030','#27AE60'];
  fill.style.width      = (score * 25) + '%';
  fill.style.background = colours[score - 1] || '#C0392B';
  rules.innerHTML = checks.map(c =>
    `<span style="font-size:11px;color:${c.ok ? 'var(--green)' : 'var(--text-faint)'};">
      ${c.ok ? '✓' : '○'} ${c.label}
    </span>`
  ).join('');
}

async function doReset() {
  const password = document.getElementById('password').value;
  const confirm  = document.getElementById('confirm').value;
  const btn      = document.getElementById('btn-reset');

  if (!password)            return showError('Please enter a new password.');
  if (password !== confirm) return showError('Passwords do not match.');

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Updating…';

  try {
    const r = await fetch('/auth/reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: TOKEN, password, confirm })
    });
    const d = await r.json();
    if (d.ok) {
      document.getElementById('state-form').style.display    = 'none';
      document.getElementById('state-success').style.display = 'block';
    } else {
      showError(d.error || 'Could not reset password. Please request a new link.');
      btn.disabled = false;
      btn.innerHTML = 'Set new password';
    }
  } catch(e) {
    showError('Connection error. Please try again.');
    btn.disabled = false;
    btn.innerHTML = 'Set new password';
  }
}

function showError(msg) {
  const el = document.getElementById('alert-error');
  document.getElementById('alert-error-msg').textContent = msg;
  el.style.display = 'flex';
}
</script>
{% endblock %}
