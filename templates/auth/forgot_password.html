{% extends "auth/base.html" %}
{% block title %}Forgot password — Mickey{% endblock %}

{% block body %}
<div class="auth-page">
  <div class="auth-card">

    <div class="auth-logo">
      <div class="auth-logomark">m</div>
      <div class="auth-wordmark">Mickey<span>Legal Intelligence</span></div>
    </div>

    <!-- Success state -->
    <div id="state-sent" style="display:none;text-align:center;">
      <div style="width:52px;height:52px;background:var(--green-light);border:1.5px solid var(--green-border);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
        </svg>
      </div>
      <h1 class="auth-title">Check your email</h1>
      <p class="auth-sub">
        If an account exists for that email address, you'll receive a password reset link shortly.
        The link expires in <strong>1 hour</strong>.
      </p>
      <p class="text-muted text-small">Check your spam folder if you don't see it.</p>
    </div>

    <!-- Request state -->
    <div id="state-form">
      <h1 class="auth-title">Forgot your password?</h1>
      <p class="auth-sub">Enter your work email address and we'll send you a reset link.</p>

      <div id="alert-error" class="alert alert-red" style="display:none;">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="alert-error-msg"></span>
      </div>

      <div class="form-group">
        <label class="form-label" for="email">Work email address</label>
        <input class="form-input" type="email" id="email" autocomplete="email" autofocus>
      </div>

      <div style="margin-top:24px;">
        <button class="btn btn-primary btn-full" id="btn-reset" onclick="doRequest()">
          Send reset link
        </button>
      </div>
    </div>

  </div>

  <div class="auth-footer">
    <a href="/signin">Back to sign in</a>
  </div>
</div>

<script>
async function doRequest() {
  const email = document.getElementById('email').value.trim().toLowerCase();
  const btn   = document.getElementById('btn-reset');

  if (!email) { showError('Please enter your email address.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending…';

  try {
    await fetch('/auth/forgot-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    // Always show success — never reveal if email exists (principle 1)
    document.getElementById('state-form').style.display = 'none';
    document.getElementById('state-sent').style.display = 'block';
  } catch(e) {
    showError('Connection error. Please try again.');
    btn.disabled = false;
    btn.innerHTML = 'Send reset link';
  }
}

function showError(msg) {
  const el = document.getElementById('alert-error');
  document.getElementById('alert-error-msg').textContent = msg;
  el.style.display = 'flex';
}

document.addEventListener('keydown', e => { if (e.key === 'Enter') doRequest(); });
</script>
{% endblock %}
