{% extends "auth/base.html" %}
{% block title %}Register your firm — Mickey{% endblock %}
{% block head %}
<style>
  .pw-wrap { position: relative; }
  .pw-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-muted); display: flex; align-items: center; border-radius: 4px; transition: color .12s; }
  .pw-toggle:hover { color: var(--text); }
  .pw-toggle svg { width: 15px; height: 15px; stroke: currentColor; fill: none; stroke-width: 1.85; stroke-linecap: round; stroke-linejoin: round; }
  .pw-input { padding-right: 42px !important; }
</style>
{% endblock %}

{% block body %}
<div class="auth-page" style="padding-bottom:100px;">
  <div class="auth-card auth-card-wide">

    <div class="auth-logo">
      <div class="auth-logomark">m</div>
      <div class="auth-wordmark">Mickey<span>Legal Intelligence</span></div>
    </div>

    <h1 class="auth-title">Register your firm</h1>
    <p class="auth-sub">Create your firm's Mickey account. You'll be the account admin and can invite your team after approval.</p>

    <!-- Error alert -->
    <div id="alert-error" class="alert alert-red" style="display:none;">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span id="alert-error-msg"></span>
    </div>

    <!-- Domain blocked alert -->
    <div id="alert-domain" class="alert alert-amber" style="display:none;">
      <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span>Your firm's email domain is already registered on Mickey. Ask your firm's account admin to invite you instead.</span>
    </div>

    <!-- Firm details -->
    <div style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:14px;">Firm details</div>

    <div class="form-group">
      <label class="form-label" for="firm_name">Firm name</label>
      <input class="form-input" type="text" id="firm_name" placeholder="" autocomplete="off">
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
      <div class="form-group">
        <label class="form-label" for="country">Country</label>
        <select class="form-input" id="country">
          <option value="">— select —</option>
          <option value="BE">Belgium</option>
          <option value="NL">Netherlands</option>
          <option value="LU">Luxembourg</option>
          <option value="FR">France</option>
          <option value="DE">Germany</option>
          <option value="GB">United Kingdom</option>
          <option value="OTHER">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="vat">VAT number <span class="optional">(optional)</span></label>
        <input class="form-input" type="text" id="vat" placeholder="" autocomplete="off">
      </div>
    </div>

    <div class="form-divider"></div>

    <!-- Account admin -->
    <div style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:14px;">Your account</div>

    <div class="form-group">
      <label class="form-label" for="display_name">Your full name</label>
      <input class="form-input" type="text" id="display_name" placeholder="" autocomplete="off">
    </div>

    <div class="form-group">
      <label class="form-label" for="email">Work email address</label>
      <input class="form-input" type="email" id="email" placeholder=""
             autocomplete="off" oninput="checkDomain(this.value)">
      <span class="form-hint">Use your firm email address. This becomes your login.</span>
    </div>

    <div class="form-group">
      <label class="form-label" for="password">Password</label>
      <div class="pw-wrap">
        <input class="form-input pw-input" type="password" id="password" autocomplete="new-password" oninput="checkPwStrength(this.value)">
        <button type="button" class="pw-toggle" onclick="togglePw('password','eye-pw')" tabindex="-1" title="Show / hide password">
          <svg id="eye-pw" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
      <!-- Password strength indicator -->
      <div id="pw-strength-bar" style="display:none;margin-top:6px;">
        <div style="height:3px;background:var(--cream-dark);border-radius:2px;overflow:hidden;">
          <div id="pw-strength-fill" style="height:100%;width:0%;border-radius:2px;transition:width .2s,background .2s;"></div>
        </div>
        <div id="pw-strength-rules" style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;"></div>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <label class="form-label" for="confirm">Confirm password</label>
      <div class="pw-wrap">
        <input class="form-input pw-input" type="password" id="confirm" autocomplete="new-password">
        <button type="button" class="pw-toggle" onclick="togglePw('confirm','eye-confirm')" tabindex="-1" title="Show / hide password">
          <svg id="eye-confirm" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>

    <div class="form-divider"></div>

    <!-- T&C acceptance -->
    <div style="margin-bottom:20px;">
      <label class="form-check">
        <input type="checkbox" id="tc_accept">
        <span class="form-check-label">
          I have read and accept the
          <a href="/terms" target="_blank">Terms of Service</a>
          and
          <a href="/privacy" target="_blank">Privacy Policy</a>,
          including the processing of personal data as described therein.
        </span>
      </label>

      <div style="display:flex;gap:8px;margin-top:12px;padding-left:25px;">
        <button class="btn btn-secondary btn-sm" onclick="downloadTC()">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download PDF
        </button>
        <button class="btn btn-ghost btn-sm" onclick="sendTCEmail()">
          <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Send to my email
        </button>
      </div>
      <div id="tc-email-sent" style="display:none;padding-left:25px;margin-top:8px;">
        <span class="form-hint" style="color:var(--green);">✓ T&amp;Cs sent to your email address.</span>
      </div>
    </div>

    <!-- Submit -->
    <button class="btn btn-primary btn-full" id="btn-register" onclick="doRegister()" style="padding:11px;">
      Register firm
    </button>

    <p style="margin-top:14px;font-size:11.5px;color:var(--text-faint);text-align:center;line-height:1.6;">
      Your registration will be reviewed before your account is activated.
      You'll receive an email once approved.
    </p>

  </div>

  <div class="auth-footer">
    Already have an account? <a href="/signin">Sign in</a>
  </div>
</div>

<!-- Cookie banner -->
<div id="cookie-banner" style="display:none;position:fixed;bottom:0;left:0;right:0;background:var(--green);padding:20px 28px;z-index:1000;border-top:1px solid rgba(255,255,255,0.1);">
  <div style="max-width:860px;margin:0 auto;">
    <p style="font-family:var(--font-serif);font-size:15px;font-weight:500;color:#fff;margin-bottom:6px;">Cookie notice</p>
    <p style="font-size:12.5px;color:rgba(255,255,255,0.75);line-height:1.6;margin-bottom:14px;">
      Mickey uses <strong style="color:#fff;">one session cookie</strong> to keep you signed in while you use the platform.
      No tracking, analytics, advertising or third-party cookies are used. This cookie is strictly necessary
      for the service to function and is deleted when you sign out or close your browser.
      <a href="/privacy" target="_blank" style="color:rgba(255,255,255,0.6);text-decoration:underline;margin-left:6px;">Full privacy policy</a>
    </p>
    <div style="display:flex;gap:10px;">
      <button onclick="acceptCookies()" style="background:#fff;color:var(--green);border:none;padding:9px 20px;border-radius:var(--r);font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font-sans);">
        Understood
      </button>
    </div>
  </div>
</div>

<script>
// ── Cookie banner ─────────────────────────────────────────────
(function() {
  if (!localStorage.getItem('mickey_cookie_consent')) {
    document.getElementById('cookie-banner').style.display = 'block';
  }
})();

function acceptCookies() {
  localStorage.setItem('mickey_cookie_consent', 'accepted');
  document.getElementById('cookie-banner').style.display = 'none';
}

// ── Show / hide password ──────────────────────────────────────
function togglePw(inputId, iconId) {
  const input = document.getElementById(inputId);
  const icon  = document.getElementById(iconId);
  const show  = input.type === 'password';
  input.type  = show ? 'text' : 'password';
  icon.innerHTML = show
    ? `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/>
       <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/>
       <line x1="1" y1="1" x2="23" y2="23"/>`
    : `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
       <circle cx="12" cy="12" r="3"/>`;
}

// ── Password strength ─────────────────────────────────────────
function checkPwStrength(pw) {
  const bar   = document.getElementById('pw-strength-bar');
  const fill  = document.getElementById('pw-strength-fill');
  const rules = document.getElementById('pw-strength-rules');
  if (!pw) { bar.style.display = 'none'; return; }
  bar.style.display = 'block';

  const checks = [
    { label: '8+ characters',    ok: pw.length >= 8 },
    { label: 'Uppercase letter', ok: /[A-Z]/.test(pw) },
    { label: 'Number',           ok: /[0-9]/.test(pw) },
    { label: 'Special character',ok: /[!@#$%^&*()\-_=+\[\]{};:\'",.<>\/?`~\\|]/.test(pw) },
  ];
  const score = checks.filter(c => c.ok).length;
  const colours = ['#C0392B','#E67E22','#C8A030','#27AE60'];
  fill.style.width  = (score * 25) + '%';
  fill.style.background = colours[score - 1] || '#C0392B';

  rules.innerHTML = checks.map(c =>
    `<span style="font-size:11px;color:${c.ok ? 'var(--green)' : 'var(--text-faint)'};">
      ${c.ok ? '✓' : '○'} ${c.label}
    </span>`
  ).join('');
}

// ── Domain blocking ───────────────────────────────────────────
let domainCheckTimer;
function checkDomain(email) {
  clearTimeout(domainCheckTimer);
  const domain = email.split('@')[1];
  if (!domain || domain.indexOf('.') === -1) return hideDomainAlert();
  domainCheckTimer = setTimeout(async () => {
    try {
      const r = await fetch('/auth/check-domain?domain=' + encodeURIComponent(domain));
      const d = await r.json();
      if (d.taken) showDomainAlert();
      else hideDomainAlert();
    } catch(e) {}
  }, 500);
}
function showDomainAlert() {
  document.getElementById('alert-domain').style.display = 'flex';
  document.getElementById('btn-register').disabled = true;
}
function hideDomainAlert() {
  document.getElementById('alert-domain').style.display = 'none';
  document.getElementById('btn-register').disabled = false;
}

// ── T&C helpers ───────────────────────────────────────────────
function downloadTC() {
  window.open('/terms', '_blank');
}
async function sendTCEmail() {
  const email = document.getElementById('email').value.trim();
  if (!email) { showError('Enter your email address first.'); return; }
  try {
    await fetch('/auth/send-tc-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    document.getElementById('tc-email-sent').style.display = 'block';
  } catch(e) {}
}

// ── Registration ──────────────────────────────────────────────
async function doRegister() {
  hideError();
  const firm_name    = document.getElementById('firm_name').value.trim();
  const country      = document.getElementById('country').value;
  const vat          = document.getElementById('vat').value.trim();
  const display_name = document.getElementById('display_name').value.trim();
  const email        = document.getElementById('email').value.trim();
  const password     = document.getElementById('password').value;
  const confirm      = document.getElementById('confirm').value;
  const tc_accept    = document.getElementById('tc_accept').checked;
  const cookie       = localStorage.getItem('mickey_cookie_consent') || 'not_set';

  if (!firm_name)    return showError('Please enter your firm name.');
  if (!display_name) return showError('Please enter your full name.');
  if (!email)        return showError('Please enter your work email address.');
  if (!password)     return showError('Please choose a password.');
  if (password !== confirm) return showError('Passwords do not match.');
  if (!tc_accept)    return showError('Please accept the Terms of Service to continue.');

  const btn = document.getElementById('btn-register');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Registering…';

  try {
    const r = await fetch('/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ firm_name, country, vat, display_name, email, password, confirm, tc_accept, cookie_consent: cookie })
    });
    const d = await r.json();
    if (d.ok) {
      window.location.href = '/verify-pending';
    } else {
      showError(d.error || 'Registration failed. Please try again.');
      btn.disabled = false;
      btn.innerHTML = 'Register firm';
    }
  } catch(e) {
    showError('Connection error. Please try again.');
    btn.disabled = false;
    btn.innerHTML = 'Register firm';
  }
}

function showError(msg) {
  const el = document.getElementById('alert-error');
  document.getElementById('alert-error-msg').textContent = msg;
  el.style.display = 'flex';
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function hideError() {
  document.getElementById('alert-error').style.display = 'none';
}
</script>
{% endblock %}
