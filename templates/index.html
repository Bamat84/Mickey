<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mickey — Legal Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#F5F3EE; --cream-mid:#EAE6DF; --cream-dark:#D8D4CC;
  --white:#FFFFFF;
  --green:#1B4F40; --green-light:#EAF1ED; --green-border:#C4DACE;
  --text:#1A1916; --text-mid:#706C65; --text-muted:#A8A49D; --text-faint:#C4BFB6;
  --amber:#C8A030; --amber-bg:#FFFBF0; --amber-border:#F0E8CC;
  --red:#C0392B; --red-bg:#FAEAE8; --red-border:#E8BCBC;
  --blue:#3A5BBF; --blue-bg:#EEF2FF;
  --font-serif:'Lora',Georgia,serif;
  --font-sans:'Inter',sans-serif;
  --r:8px; --r-lg:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;font-family:var(--font-sans);background:var(--cream);color:var(--text);font-size:13px;line-height:1.5;}
#auth-screen{position:fixed;inset:0;background:var(--green);display:flex;align-items:center;justify-content:center;z-index:1000;}
.auth-card{width:400px;background:var(--white);border-radius:16px;padding:40px 44px;box-shadow:0 20px 60px rgba(0,0,0,.25);animation:fadeUp .3s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.auth-logo{text-align:center;margin-bottom:30px;}
.auth-logomark{width:44px;height:44px;background:var(--green);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:var(--font-serif);font-size:24px;font-style:italic;color:#fff;margin:0 auto 10px;}
.auth-logo-text{font-family:var(--font-serif);font-size:24px;color:var(--text);}
.auth-logo-sub{font-size:10.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-top:2px;}
.auth-mode-label{font-size:10.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:16px;text-align:center;}
.auth-field{margin-bottom:12px;}
.auth-field label{display:block;font-size:10px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text-muted);margin-bottom:5px;}
.auth-field input{width:100%;border:1px solid var(--cream-dark);border-radius:var(--r);padding:9px 12px;font-family:var(--font-sans);font-size:13px;color:var(--text);background:var(--cream);outline:none;transition:border-color .15s;}
.auth-field input:focus{border-color:var(--green);background:#fff;}
.auth-btn{width:100%;background:var(--green);color:#fff;border:none;border-radius:var(--r);padding:11px;font-family:var(--font-sans);font-size:11px;font-weight:600;letter-spacing:.07em;text-transform:uppercase;cursor:pointer;margin-top:6px;transition:background .15s;}
.auth-btn:hover{background:#153D31;}
.auth-error{background:var(--red-bg);border:1px solid var(--red-border);border-radius:var(--r);padding:8px 12px;font-size:12px;color:var(--red);margin-top:10px;display:none;}
.auth-switch{text-align:center;margin-top:14px;font-size:12px;color:var(--text-muted);}
.auth-switch a{color:var(--green);cursor:pointer;font-weight:500;}
#app{display:none;height:100vh;flex-direction:row;}
#app.visible{display:flex;}
.sidebar{width:220px;min-width:220px;background:var(--white);border-right:1px solid var(--cream-mid);display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;transition:width .2s,min-width .2s;position:relative;flex-shrink:0;}
.sidebar.collapsed{width:56px;min-width:56px;}
.sidebar.collapsed .sb-logotext,.sidebar.collapsed .sb-profile-text,.sidebar.collapsed .nav-sec,
.sidebar.collapsed .nav-item span,.sidebar.collapsed .sb-badge,.sidebar.collapsed .sb-bottom-inner{display:none;}
.sidebar.collapsed .nav-item{justify-content:center;padding:9px 0;}
.sidebar.collapsed .sb-logo{justify-content:center;padding:18px 0 14px;}
.sidebar.collapsed .sb-profile{justify-content:center;padding:9px 0;}
.sb-logo{padding:18px 18px 14px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:10px;flex-shrink:0;}
.sb-logomark{width:32px;height:32px;background:var(--green);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:var(--font-serif);font-size:18px;font-style:italic;color:#fff;flex-shrink:0;}
.sb-logotext{font-family:var(--font-serif);font-size:18px;color:var(--text);white-space:nowrap;}
.sb-profile{padding:9px 14px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:9px;flex-shrink:0;}
.sb-avatar{width:28px;height:28px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.sb-profile-text strong{display:block;font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;}
.sb-profile-text span{font-size:11px;color:var(--text-muted);}
.sb-admin-chip{display:inline-block;font-size:9px;letter-spacing:.07em;text-transform:uppercase;background:var(--green-light);color:var(--green);padding:2px 6px;border-radius:4px;margin-top:2px;font-weight:600;}
.nav-sec{font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text-faint);padding:14px 18px 4px;white-space:nowrap;flex-shrink:0;}
.nav-item{display:flex;align-items:center;gap:9px;padding:7px 18px;cursor:pointer;color:var(--text-mid);font-size:12.5px;transition:all .12s;border-left:2px solid transparent;user-select:none;flex-shrink:0;}
.nav-item:hover{background:var(--cream);color:var(--text);}
.nav-item.active{background:var(--green-light);color:var(--green);border-left-color:var(--green);font-weight:600;}
.nav-item svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.sb-badge{margin-left:auto;min-width:18px;height:18px;padding:0 5px;border-radius:9px;background:#E85D4A;color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.nav-item.active .sb-badge{background:var(--green);}
.sidebar-toggle{width:24px;height:24px;border-radius:50%;background:var(--cream);border:1px solid var(--cream-dark);cursor:pointer;display:flex;align-items:center;justify-content:center;position:absolute;top:20px;right:-12px;z-index:20;flex-shrink:0;}
.sidebar-toggle:hover{background:var(--cream-mid);}
.sidebar-toggle svg{width:12px;height:12px;stroke:var(--text-mid);fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;}
.sb-bottom{margin-top:auto;border-top:1px solid var(--cream-mid);padding:12px 18px;flex-shrink:0;}
.sb-bottom-inner{margin-bottom:8px;}
.kb-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:7px;}
.kb-row{display:flex;align-items:center;gap:7px;margin-bottom:3px;}
.kb-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.kb-text{font-size:11px;color:var(--text-muted);flex:1;}
.kb-num{font-size:11px;color:var(--text-faint);}
.signout-btn{display:flex;align-items:center;gap:7px;padding:5px 0;cursor:pointer;color:var(--text-faint);font-size:12px;transition:color .15s;}
.signout-btn:hover{color:var(--red);}
.signout-btn svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:1.9;stroke-linecap:round;stroke-linejoin:round;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.topbar{background:var(--white);border-bottom:1px solid var(--cream-mid);padding:0 28px;height:52px;display:flex;align-items:center;gap:14px;flex-shrink:0;}
.topbar-title{font-family:var(--font-serif);font-size:20px;font-weight:400;color:var(--text);}
.topbar-divider{width:1px;height:18px;background:var(--cream-mid);}
.topbar-sub{font-size:12px;color:var(--text-muted);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.web-toggle{display:flex;align-items:center;gap:6px;font-size:11.5px;color:var(--text-muted);cursor:pointer;user-select:none;}
.web-toggle input{accent-color:var(--green);}
.topbar-chip{font-size:9.5px;letter-spacing:.1em;text-transform:uppercase;background:var(--green);color:#fff;padding:4px 10px;border-radius:20px;white-space:nowrap;font-weight:600;}
.content{flex:1;overflow-y:auto;padding:28px;background:var(--cream);}#mod-compliance .content{padding:0;}
.module{display:none;}.module.active{display:block;}#mod-compliance.active{display:flex;flex:1;overflow:hidden;padding:0;height:100%;}
.section-label{font-size:9.5px;letter-spacing:.12em;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px;margin-top:22px;font-weight:600;}
.section-label:first-child{margin-top:0;}
.dash-greeting{margin-bottom:20px;}
.dash-greeting h2{font-family:var(--font-serif);font-size:28px;font-weight:400;margin-bottom:3px;}
.dash-greeting p{font-size:12.5px;color:var(--text-muted);}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:16px 18px;border-top:3px solid var(--cream-dark);}
.stat-card.c-green{border-top-color:var(--green);}.stat-card.c-amber{border-top-color:var(--amber);}
.stat-card.c-blue{border-top-color:var(--blue);}.stat-card.c-purple{border-top-color:#8A5AB0;}
.stat-label{font-size:10px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px;}
.stat-num{font-family:var(--font-serif);font-size:30px;font-weight:400;color:var(--text);margin-bottom:4px;line-height:1;}
.stat-sub{font-size:11.5px;color:var(--text-muted);}
.dash-cols{display:grid;grid-template-columns:1fr 300px;gap:16px;}
.dash-left{display:flex;flex-direction:column;gap:14px;}
.dash-right{display:flex;flex-direction:column;gap:14px;}
.card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);overflow:hidden;}
.card-head{padding:13px 18px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;justify-content:space-between;}
.card-head h3{font-size:13.5px;font-weight:600;color:var(--text);}
.card-view-all{font-size:12px;color:var(--green);font-weight:500;cursor:pointer;}
.matter-item{display:flex;align-items:center;gap:12px;padding:11px 18px;border-bottom:1px solid var(--cream);cursor:pointer;transition:background .1s;}
.matter-item:last-child{border-bottom:none;}.matter-item:hover{background:#FAFAF8;}
.matter-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.dot-urgent{background:#E85D4A;}.dot-active{background:var(--green);}.dot-info{background:var(--blue);}.dot-hold{background:var(--text-faint);}
.matter-text{flex:1;min-width:0;}
.matter-title{font-size:13px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.matter-sub{font-size:11.5px;color:var(--text-muted);}
.mtag{font-size:11px;padding:3px 9px;border-radius:5px;font-weight:600;white-space:nowrap;flex-shrink:0;}
.mtag-urgent{background:var(--red-bg);color:var(--red);}.mtag-ongoing{background:var(--green-light);color:var(--green);}.mtag-hold{background:var(--cream);color:var(--text-muted);}
.mtag-date{font-size:11.5px;color:var(--text-muted);}
.query-item{display:flex;align-items:center;gap:10px;padding:9px 18px;border-bottom:1px solid var(--cream);cursor:pointer;transition:background .1s;}
.query-item:last-child{border-bottom:none;}.query-item:hover{background:#FAFAF8;}
.query-item svg{width:12px;height:12px;stroke:var(--text-faint);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}
.query-text{font-size:12.5px;color:var(--text-mid);}
.radar-card-s{padding:13px 16px;border-left:3px solid transparent;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--cream);}
.radar-card-s:last-child{border-bottom:none;}.radar-card-s:hover{background:#FAFAF8;}
.radar-card-s.high{border-left-color:#E85D4A;}.radar-card-s.medium{border-left-color:var(--amber);}.radar-card-s.info{border-left-color:var(--blue);}
.rc-tags{display:flex;gap:5px;margin-bottom:5px;flex-wrap:wrap;align-items:center;}
.rc-tag{font-size:10px;padding:1px 7px;border-radius:4px;font-weight:700;}
.rc-tag-eu{background:var(--blue-bg);color:var(--blue);}.rc-tag-be{background:var(--green-light);color:var(--green);}
.rc-tag-ai{background:#F3EEF9;color:#6B3FA0;}.rc-tag-req{background:var(--red-bg);color:var(--red);}
.rc-date{font-size:10.5px;color:var(--text-faint);margin-left:auto;}
.rc-title{font-size:12.5px;font-weight:600;margin-bottom:3px;}
.rc-desc{font-size:11.5px;color:var(--text-muted);line-height:1.45;}
.qa-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:13px 16px;}
.qa-btn{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:var(--r);border:1px solid var(--cream-mid);background:var(--cream);cursor:pointer;transition:all .15s;}
.qa-btn:hover{border-color:var(--green);background:var(--green-light);}
.qa-btn svg{width:13px;height:13px;stroke:var(--text-mid);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}
.qa-btn:hover svg{stroke:var(--green);}
.qa-btn span{font-size:12px;color:var(--text-mid);font-weight:500;}
.qa-btn:hover span{color:var(--green);}
.sug-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:4px;}
.sug-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r);padding:13px 15px;cursor:pointer;transition:all .15s;}
.sug-card:hover{border-color:var(--green);box-shadow:0 2px 10px rgba(27,79,64,.08);transform:translateY(-1px);}
.sug-tag{font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--green);margin-bottom:5px;font-weight:600;}
.sug-text{font-size:11.5px;color:var(--text-mid);line-height:1.5;}
.chat-area{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
.chat-user{display:flex;justify-content:flex-end;}
.bubble-user{background:var(--green);color:#fff;font-family:var(--font-serif);font-size:15px;padding:11px 16px;border-radius:12px 12px 2px 12px;max-width:78%;line-height:1.5;}
.chat-mickey{display:flex;align-items:flex-start;gap:9px;}
.mickey-av{width:28px;height:28px;background:var(--green);border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:var(--font-serif);font-size:14px;font-style:italic;color:#fff;flex-shrink:0;}
.bubble-mickey{background:var(--white);border:1px solid var(--cream-mid);font-family:var(--font-serif);font-size:15px;color:var(--text);padding:12px 16px;border-radius:2px 12px 12px 12px;max-width:88%;line-height:1.6;}
.bubble-thinking{background:var(--white);border:1px solid var(--cream-mid);padding:12px 16px;border-radius:2px 12px 12px 12px;display:flex;align-items:center;gap:8px;}
.thinking-dots{display:flex;gap:4px;}
.thinking-dots span{width:5px;height:5px;border-radius:50%;background:var(--cream-dark);animation:thinking 1.2s infinite;}
.thinking-dots span:nth-child(2){animation-delay:.2s;}.thinking-dots span:nth-child(3){animation-delay:.4s;}
@keyframes thinking{0%,60%,100%{opacity:.3;transform:scale(.8)}30%{opacity:1;transform:scale(1)}}
.md h1{font-family:var(--font-sans);font-size:13.5px;font-weight:700;margin:14px 0 5px;color:var(--text);}
.md h2{font-family:var(--font-sans);font-size:13px;font-weight:600;margin:12px 0 4px;color:var(--text);}
.md h3{font-family:var(--font-sans);font-size:12.5px;font-weight:600;margin:10px 0 3px;color:var(--text-mid);}
.md p{margin:4px 0;}.md ul{margin:4px 0 4px 18px;}.md li{margin:2px 0;}
.md strong{font-weight:600;}.md em{font-style:italic;}
.md .finding{display:flex;gap:8px;margin:5px 0;align-items:flex-start;}
.md .finding-icon{flex-shrink:0;margin-top:1px;}
.two-col{display:grid;grid-template-columns:1fr 2fr;gap:20px;}
.panel{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:20px;}
.panel-title{font-family:var(--font-serif);font-size:16px;font-weight:500;color:var(--text);margin-bottom:3px;}
.panel-sub{font-size:11.5px;color:var(--text-muted);margin-bottom:14px;line-height:1.4;}
.form-row{display:flex;gap:10px;margin-bottom:12px;}
.form-group{flex:1;margin-bottom:12px;}
.form-group label{display:block;font-size:10px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text-muted);margin-bottom:5px;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px 11px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:13px;color:var(--text);background:var(--cream);outline:none;transition:border-color .15s;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--green);background:#fff;}
.form-group textarea{resize:vertical;min-height:70px;}
.btn{padding:8px 18px;border-radius:var(--r);font-family:var(--font-sans);font-size:11.5px;font-weight:500;cursor:pointer;transition:all .15s;border:1px solid var(--cream-dark);background:var(--white);color:var(--text);display:inline-flex;align-items:center;gap:6px;}
.btn:hover{border-color:var(--text-mid);box-shadow:0 1px 6px rgba(0,0,0,.08);}
.btn-primary{background:var(--green);color:#fff;border-color:var(--green);}
.btn-primary:hover{background:#153D31;border-color:#153D31;}
.btn-danger{color:var(--red);border-color:var(--red-border);}
.btn-danger:hover{background:var(--red-bg);border-color:var(--red);}
.btn-sm{padding:5px 12px;font-size:11px;}
.btn-full{width:100%;justify-content:center;}
.result-box{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:22px;font-family:var(--font-serif);font-size:15px;line-height:1.65;color:var(--text);min-height:180px;}
.result-box.empty{display:flex;align-items:center;justify-content:center;color:var(--text-faint);font-style:italic;font-size:13px;}
.file-drop{border:1.5px dashed var(--cream-dark);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--cream);margin-bottom:12px;}
.file-drop:hover,.file-drop.over{border-color:var(--green);background:var(--green-light);}
.file-drop-icon{font-size:22px;margin-bottom:6px;opacity:.5;}
.file-drop-text{font-size:11.5px;color:var(--text-muted);}
.file-drop-text strong{color:var(--text);}
.file-name{background:var(--cream);border:1px solid var(--cream-mid);border-radius:6px;padding:6px 11px;font-size:11.5px;color:var(--text-mid);margin-top:7px;display:none;align-items:center;gap:5px;}
.file-name.visible{display:flex;}
.tag-row{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px;}
.tag{font-size:9.5px;letter-spacing:.07em;text-transform:uppercase;padding:4px 9px;border-radius:20px;border:1px solid var(--cream-dark);color:var(--text-muted);cursor:pointer;transition:all .13s;user-select:none;}
.tag.on{border-color:var(--green);color:var(--green);background:var(--green-light);}
.folder-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:15px 18px;margin-bottom:8px;display:flex;align-items:center;gap:14px;}
.folder-info{flex:1;}
.folder-label{font-family:var(--font-serif);font-size:15px;font-weight:500;color:var(--text);}
.folder-path{font-size:10.5px;color:var(--text-muted);margin-top:2px;}
.folder-count{text-align:center;min-width:50px;}
.folder-count-n{font-family:var(--font-serif);font-size:24px;font-weight:400;color:var(--text);line-height:1;}
.folder-count-l{font-size:8.5px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;}
.folder-actions{display:flex;gap:7px;}
.pb-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.pb-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:18px;transition:border-color .15s;}
.pb-card:hover{border-color:var(--green);}
.pb-name{font-family:var(--font-serif);font-size:15px;font-weight:500;color:var(--text);margin-bottom:5px;}
.pb-desc{font-size:11.5px;color:var(--text-mid);line-height:1.5;margin-bottom:10px;}
.pb-meta{font-size:10px;color:var(--text-muted);margin-bottom:12px;}
.admin-table{width:100%;border-collapse:collapse;background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);overflow:hidden;}
.admin-table th{background:var(--cream);font-size:9.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);padding:10px 14px;text-align:left;border-bottom:1px solid var(--cream-mid);}
.admin-table td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--cream);}
.admin-table tr:last-child td{border-bottom:none;}
.admin-badge{font-size:9px;letter-spacing:.08em;text-transform:uppercase;padding:2px 8px;border-radius:4px;}
.badge-admin{background:var(--green-light);color:var(--green);}.badge-user{background:var(--cream);color:var(--text-muted);}
.toast{position:fixed;bottom:24px;right:24px;z-index:999;background:var(--text);color:#fff;padding:10px 16px;border-radius:var(--r);font-size:13px;opacity:0;transform:translateY(8px);transition:all .25s;pointer-events:none;}
.toast.show{opacity:1;transform:none;}.toast.error{background:var(--red);}.toast.success{background:var(--green);}
.spinner{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.info-box{background:var(--blue-bg);border:1px solid #C8D8F0;border-radius:var(--r);padding:12px 16px;font-size:12px;color:#2a4a80;line-height:1.6;margin-top:12px;}
/* Vault */
.vault-layout{display:grid;grid-template-columns:200px 1fr;gap:14px;height:560px;}
.tree-pane,.docs-pane,.meetings-list,.minutes-detail{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);overflow:hidden;display:flex;flex-direction:column;}
.tree-head,.ml-head,.docs-head{padding:11px 14px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:var(--text-mid);flex-shrink:0;}
.tree-head svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;}
.tree-body{flex:1;overflow-y:auto;}
.tree-item{display:flex;align-items:center;gap:8px;padding:7px 14px;font-size:12px;color:var(--text-mid);cursor:pointer;transition:all .12s;border-left:2px solid transparent;}
.tree-item:hover{background:var(--cream);color:var(--text);}
.tree-item.active{background:var(--green-light);color:var(--green);border-left-color:var(--green);font-weight:600;}
.tree-item svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}
.tree-count{margin-left:auto;font-size:10px;color:var(--text-faint);}
.tree-item.active .tree-count{color:var(--green);}
.tree-indent{padding-left:28px;}
.tree-sec-label{padding:10px 14px 3px;font-size:9.5px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-faint);}
.docs-head{padding:11px 18px;}
.docs-head h3{font-size:13px;font-weight:600;flex:1;color:var(--text);}
.ask-folder-btn{display:inline-flex;align-items:center;gap:5px;font-size:11.5px;color:var(--green);border:1px solid var(--green-border);background:var(--green-light);padding:5px 10px;border-radius:6px;cursor:pointer;font-weight:500;}
.ask-folder-btn svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;}
.vault-doc-list{flex:1;overflow-y:auto;}
.vault-doc-item{display:flex;align-items:center;gap:12px;padding:11px 18px;border-bottom:1px solid var(--cream);cursor:pointer;transition:background .1s;}
.vault-doc-item:hover{background:#FAFAF8;}.vault-doc-item:last-child{border-bottom:none;}
.doc-badge{width:34px;height:40px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;letter-spacing:.04em;flex-shrink:0;}
.db-pdf{background:var(--red-bg);color:var(--red);}.db-doc{background:var(--blue-bg);color:var(--blue);}.db-xls{background:#E8F5E9;color:#2E7D32;}
.vault-doc-meta{flex:1;min-width:0;}
.vault-doc-name{font-size:12.5px;font-weight:500;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.vault-doc-info{font-size:11.5px;color:var(--text-muted);}
.vault-doc-date{font-size:11.5px;color:var(--text-faint);flex-shrink:0;}
.vault-upload-panel{padding:14px 18px;border-top:1px solid var(--cream-mid);flex-shrink:0;}
.vault-upload-panel summary{font-size:12px;color:var(--green);cursor:pointer;font-weight:500;}
/* Minutes */
.minutes-layout{display:grid;grid-template-columns:220px 1fr;gap:14px;height:560px;}
.ml-head{justify-content:space-between;}
.ml-add{width:22px;height:22px;border-radius:6px;background:var(--green);color:#fff;border:none;cursor:pointer;font-size:15px;font-weight:600;display:flex;align-items:center;justify-content:center;}
.meeting-item{padding:10px 16px;border-bottom:1px solid var(--cream);cursor:pointer;transition:background .1s;border-left:2px solid transparent;}
.meeting-item:hover{background:#FAFAF8;}.meeting-item.active{background:var(--green-light);border-left-color:var(--green);}
.meeting-item:last-child{border-bottom:none;}
.m-date{font-size:10.5px;color:var(--text-faint);margin-bottom:3px;}
.m-title{font-size:12.5px;font-weight:600;color:var(--text);margin-bottom:2px;}
.m-sub{font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:4px;}
.m-open-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--green);margin-right:3px;}
.minutes-detail{flex:1;}
.md-top{padding:13px 20px;border-bottom:1px solid var(--cream-mid);flex-shrink:0;}
.md-top h3{font-family:var(--font-serif);font-size:17px;font-weight:400;color:var(--text);margin-bottom:3px;}
.md-top p{font-size:11.5px;color:var(--text-muted);}
.md-tabs-row{display:flex;border-bottom:1px solid var(--cream-mid);flex-shrink:0;}
.md-tab{padding:8px 16px;font-size:12px;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;background:none;border-top:none;border-left:none;border-right:none;font-family:var(--font-sans);font-weight:500;transition:all .12s;}
.md-tab.active{color:var(--green);border-bottom-color:var(--green);font-weight:700;}
.md-body{flex:1;overflow-y:auto;padding:16px 20px;}
.ai-banner{font-size:11.5px;color:#7A6020;margin-bottom:12px;padding:8px 12px;background:var(--amber-bg);border:1px solid var(--amber-border);border-radius:var(--r);display:flex;align-items:center;gap:7px;}
.ai-banner svg{width:12px;height:12px;stroke:var(--amber);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}
.actions-label{font-size:9.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px;margin-top:14px;}
.actions-label:first-child{margin-top:0;}
.action-row{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--cream);}
.action-row:last-child{border-bottom:none;}
.action-check{width:16px;height:16px;border-radius:4px;border:1.5px solid var(--cream-dark);flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;}
.action-check.done{background:var(--green);border-color:var(--green);}
.action-check.done::after{content:'checkmark';font-size:9px;color:#fff;font-weight:700;}
.action-body{flex:1;}
.action-title{font-size:12.5px;font-weight:600;color:var(--text);margin-bottom:2px;}
.action-sub{font-size:11.5px;color:var(--text-muted);}
.action-owner{font-size:11px;padding:2px 9px;border-radius:12px;border:1px solid var(--cream-mid);color:var(--text-mid);background:var(--cream);flex-shrink:0;white-space:nowrap;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--cream-dark);border-radius:10px;}
@media(max-width:900px){.sug-grid{grid-template-columns:1fr 1fr;}.two-col{grid-template-columns:1fr;}.pb-grid{grid-template-columns:1fr;}.stats-row{grid-template-columns:1fr 1fr;}.dash-cols{grid-template-columns:1fr;}.vault-layout,.minutes-layout{grid-template-columns:1fr;height:auto;}}

/* ── CORPORATE HOUSEKEEPING ─────────────────────────────────── */
:root{--green-mid:#2D6B59;--green-border:#C4DACE;--amber-border:#F0E8CC;--red-border:#E8BCBC;--blue-border:#C4D0F0;--font-mono:'DM Mono','Courier New',monospace;--r-xl:16px;}
.ch-layout{display:grid;grid-template-columns:272px 1fr;height:calc(100vh - 52px);overflow:hidden;}
.ch-panel{background:var(--white);border-right:1px solid var(--cream-mid);display:flex;flex-direction:column;}
.ch-panel-head{padding:14px 16px;border-bottom:1px solid var(--cream-mid);flex-shrink:0;}
.ch-panel-head h2{font-family:var(--font-serif);font-size:15px;font-weight:500;margin-bottom:9px;}
.ch-search{display:flex;align-items:center;gap:7px;background:var(--cream);border:1px solid var(--cream-mid);border-radius:var(--r);padding:6px 10px;}
.ch-search svg{width:12px;height:12px;stroke:var(--text-muted);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}
.ch-search input{background:none;border:none;outline:none;font-family:var(--font-sans);font-size:12px;color:var(--text);width:100%;}
.ch-search input::placeholder{color:var(--text-faint);}
.ch-list{flex:1;overflow-y:auto;}
.ch-group-label{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);padding:10px 14px 3px;background:var(--cream);border-bottom:1px solid var(--cream-mid);}
.entity-item{padding:10px 14px;border-bottom:1px solid var(--cream);cursor:pointer;transition:background .1s;border-left:3px solid transparent;position:relative;}
.entity-item:hover{background:#FAFAF8;}
.entity-item.active{background:var(--green-light);border-left-color:var(--green);}
.ei-name{font-size:12.5px;font-weight:600;color:var(--text);margin-bottom:2px;}
.entity-item.active .ei-name{color:var(--green);}
.ei-meta{display:flex;align-items:center;gap:6px;}
.ei-form{font-size:10px;color:var(--text-muted);}
.ei-country{font-size:9.5px;padding:1px 5px;border-radius:3px;background:var(--cream);color:var(--text-muted);font-weight:700;}
.ei-alerts{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:3px;}
.alert-dot{width:6px;height:6px;border-radius:50%;}
.alert-red{background:#E85D4A;}.alert-amber{background:var(--amber);}
.ch-add-btn{margin:10px 14px;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border-radius:var(--r);border:1.5px dashed var(--green-border);color:var(--green);font-size:12px;font-weight:500;cursor:pointer;background:var(--green-light);transition:all .15s;}
.ch-add-btn:hover{border-style:solid;}
.ch-add-btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;}
/* Entity detail */
.ch-detail{display:flex;flex-direction:column;overflow:hidden;background:var(--cream);}
.ch-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-faint);}
.ch-empty svg{width:44px;height:44px;stroke:var(--cream-dark);fill:none;stroke-width:1.2;stroke-linecap:round;margin-bottom:14px;}
.ch-empty p{font-size:13px;font-style:italic;}
/* Entity header */
.ch-header{background:var(--white);border-bottom:1px solid var(--cream-mid);padding:16px 22px;display:flex;align-items:flex-start;gap:14px;flex-shrink:0;}
.ch-flag{width:40px;height:40px;border-radius:9px;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.ch-title{flex:1;min-width:0;}
.ch-title h1{font-family:var(--font-serif);font-size:20px;font-weight:400;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ch-badges{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.cbadge{font-size:9px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;padding:2px 8px;border-radius:4px;}
.cbadge-form{background:var(--cream);color:var(--text-mid);}
.cbadge-country{background:var(--blue-bg);color:var(--blue);}
.cbadge-active{background:var(--green-light);color:var(--green);}
.cbadge-alert{background:#FFF3E0;color:#E65100;}
.cbadge-inactive{background:var(--red-bg);color:var(--red);}
.ch-actions{display:flex;gap:6px;flex-shrink:0;}
/* Tabs */
.ch-tabs{background:var(--white);border-bottom:2px solid var(--cream-mid);padding:0 22px;display:flex;gap:0;flex-shrink:0;overflow-x:auto;}
.ch-tab{padding:9px 14px;font-size:11.5px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .12s;white-space:nowrap;background:none;border-top:none;border-left:none;border-right:none;font-family:var(--font-sans);}
.ch-tab:hover{color:var(--text);}
.ch-tab.active{color:var(--green);border-bottom-color:var(--green);font-weight:600;}
.ch-tab .tab-alert{display:inline-block;width:5px;height:5px;border-radius:50%;background:#E85D4A;margin-left:4px;vertical-align:middle;}
/* Content */
.ch-content{flex:1;overflow-y:auto;padding:20px 22px;}
/* Summary cards */
.ch-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
.ch-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:12px 14px;border-top:3px solid var(--cream-dark);}
.ch-card.c-green{border-top-color:var(--green);}.ch-card.c-amber{border-top-color:var(--amber);}
.ch-card.c-red{border-top-color:var(--red);}.ch-card.c-blue{border-top-color:var(--blue);}
.ch-card-label{font-size:9px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-faint);margin-bottom:5px;}
.ch-card-val{font-family:var(--font-serif);font-size:24px;font-weight:400;color:var(--text);line-height:1;margin-bottom:2px;}
.ch-card-sub{font-size:11px;color:var(--text-muted);}
/* Section cards */
.ch-section{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);margin-bottom:14px;overflow:hidden;}
.ch-section-head{padding:12px 18px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;justify-content:space-between;}
.ch-section-head h3{font-family:var(--font-serif);font-size:14px;font-weight:500;color:var(--text);}
.ch-section-body{padding:18px;}
.ch-section-body.np{padding:0;}
/* Mickey AI panel */
.ch-mickey{background:var(--green);border-radius:var(--r-lg);padding:14px 18px;margin-bottom:14px;position:relative;overflow:hidden;}
.ch-mickey::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 75% 30%,rgba(255,255,255,.07),transparent 55%);pointer-events:none;}
.ch-mickey-label{font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:5px;}
.ch-mickey-row{display:flex;gap:7px;position:relative;}
.ch-mickey-input{flex:1;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:var(--r);padding:8px 12px;font-family:var(--font-serif);font-size:13px;color:#fff;outline:none;}
.ch-mickey-input::placeholder{color:rgba(255,255,255,.3);}
.ch-mickey-btn{background:#fff;color:var(--green);border:none;border-radius:var(--r);padding:8px 14px;font-family:var(--font-sans);font-size:11px;font-weight:600;cursor:pointer;flex-shrink:0;}
.ch-sugs{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;position:relative;}
.ch-sug{font-size:10.5px;padding:3px 9px;border-radius:16px;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.6);cursor:pointer;transition:all .12s;}
.ch-sug:hover{border-color:rgba(255,255,255,.5);color:#fff;}
.ch-mickey-result{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:var(--r);padding:12px 14px;margin-top:10px;color:rgba(255,255,255,.9);font-size:12.5px;line-height:1.6;display:none;position:relative;max-height:200px;overflow-y:auto;}
/* Form grids */
.fg{display:grid;gap:12px;}
.fg-2{grid-template-columns:1fr 1fr;}
.fg-3{grid-template-columns:1fr 1fr 1fr;}
.fg-4{grid-template-columns:1fr 1fr 1fr 1fr;}
.fg .s2{grid-column:span 2;}.fg .s3{grid-column:span 3;}.fg .s4{grid-column:span 4;}
.cf-group{display:flex;flex-direction:column;gap:4px;}
.cf-group label{font-size:9.5px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text-muted);}
.cf-group input,.cf-group select,.cf-group textarea{width:100%;padding:7px 10px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:12.5px;color:var(--text);background:var(--cream);outline:none;transition:border-color .15s;}
.cf-group input:focus,.cf-group select:focus,.cf-group textarea:focus{border-color:var(--green);background:#fff;}
.cf-group textarea{resize:vertical;min-height:60px;}
.cf-prefix{display:flex;align-items:center;border:1px solid var(--cream-dark);border-radius:var(--r);overflow:hidden;}
.cf-prefix-text{padding:7px 9px;font-size:11px;color:var(--text-muted);background:var(--cream-mid);border-right:1px solid var(--cream-dark);white-space:nowrap;font-family:var(--font-mono);flex-shrink:0;}
.cf-prefix input{border:none;border-radius:0;background:var(--cream);}
.cf-prefix:focus-within{border-color:var(--green);}
/* Person rows */
.ch-person-head{display:grid;grid-template-columns:24px 1fr 130px 100px 100px 80px;gap:0;padding:7px 16px;background:var(--cream);border-bottom:1px solid var(--cream-mid);}
.ch-person-head span{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);}
.ch-person-row{display:grid;grid-template-columns:24px 1fr 130px 100px 100px 80px;gap:0;align-items:center;padding:9px 16px;border-bottom:1px solid var(--cream);font-size:12px;}
.ch-person-row:last-child{border-bottom:none;}
.ch-person-row.ended{opacity:.45;}
.ch-pnum{font-family:var(--font-mono);font-size:10.5px;color:var(--text-faint);}
.ch-pname{font-weight:600;}.ch-pname .psub{font-size:10.5px;color:var(--text-muted);font-weight:400;display:block;margin-top:1px;}
.ch-prole{color:var(--text-mid);font-size:11.5px;}
.ch-pdate{font-family:var(--font-mono);font-size:11px;color:var(--text-muted);}
.ch-pdate.expiring{color:var(--red);}
.ch-pstatus{display:flex;align-items:center;gap:4px;}
.sdot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.s-active{background:#4CAF50;}.s-expiring{background:var(--amber);}.s-expired{background:var(--red);}
.ch-row-actions{display:flex;gap:4px;justify-content:flex-end;}
.icon-btn{width:24px;height:24px;border-radius:5px;border:1px solid var(--cream-mid);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;}
.icon-btn:hover{border-color:var(--text-mid);}
.icon-btn svg{width:11px;height:11px;stroke:var(--text-muted);fill:none;stroke-width:2;stroke-linecap:round;}
.icon-btn.danger:hover{border-color:var(--red);background:var(--red-bg);}
.icon-btn.danger:hover svg{stroke:var(--red);}
.ch-add-row{display:flex;align-items:center;gap:6px;padding:9px 16px;color:var(--green);font-size:11.5px;font-weight:500;cursor:pointer;border-top:1px solid var(--cream-mid);transition:background .1s;}
.ch-add-row:hover{background:var(--green-light);}
.ch-add-row svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;}
/* Share table */
.sh-table{width:100%;border-collapse:collapse;}
.sh-table th{background:var(--cream);font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);padding:8px 12px;text-align:left;border-bottom:1px solid var(--cream-mid);}
.sh-table td{padding:9px 12px;font-size:12px;border-bottom:1px solid var(--cream);}
.sh-table tr:last-child td{border-bottom:none;}
.sh-table tr:hover td{background:#FAFAF8;}
.mono{font-family:var(--font-mono);font-size:11.5px;}
.pct-bar{display:flex;align-items:center;gap:6px;}
.pct-track{flex:1;height:3px;background:var(--cream-mid);border-radius:2px;overflow:hidden;}
.pct-fill{height:100%;border-radius:2px;background:var(--green);}
/* Deadline items */
.dl-item{display:flex;align-items:center;gap:10px;padding:10px 18px;border-bottom:1px solid var(--cream);}
.dl-item:last-child{border-bottom:none;}
.dl-icon{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.dl-icon svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;}
.dl-red{background:var(--red-bg);color:var(--red);}.dl-amber{background:var(--amber-bg);color:var(--amber);}.dl-green{background:var(--green-light);color:var(--green);}
.dl-text{flex:1;}
.dl-title{font-size:12px;font-weight:600;margin-bottom:1px;}
.dl-sub{font-size:11px;color:var(--text-muted);}
.dl-right{text-align:right;}
.dl-date{font-family:var(--font-mono);font-size:10.5px;color:var(--text-muted);}
.days-badge{font-size:9.5px;font-weight:700;padding:1px 7px;border-radius:4px;margin-top:3px;display:inline-block;}
.days-red{background:var(--red-bg);color:var(--red);}
.days-amber{background:var(--amber-bg);color:var(--amber);}
.days-green{background:var(--green-light);color:var(--green);}
/* History */
.hist-item{display:flex;gap:12px;padding:11px 18px;border-bottom:1px solid var(--cream);}
.hist-item:last-child{border-bottom:none;}
.hist-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.hist-date{font-family:var(--font-mono);font-size:10px;color:var(--text-muted);white-space:nowrap;min-width:72px;}
.hist-body{flex:1;font-size:12px;line-height:1.5;}
.hist-body strong{font-weight:600;}
.hist-source{font-size:10px;color:var(--text-faint);margin-top:3px;}
/* POA */
.poa-item{padding:12px 18px;border-bottom:1px solid var(--cream);}
.poa-item:last-child{border-bottom:none;}
.poa-head{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.poa-name{font-size:13px;font-weight:600;flex:1;}
.poa-powers{font-size:11.5px;color:var(--text-muted);line-height:1.7;padding-left:10px;border-left:2px solid var(--cream-mid);margin-bottom:5px;}
.poa-meta{font-size:10px;color:var(--text-faint);display:flex;gap:10px;flex-wrap:wrap;}
/* Compliance table */
.comp-table{width:100%;border-collapse:collapse;}
.comp-table th{background:var(--cream);font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);padding:8px 12px;text-align:left;border-bottom:1px solid var(--cream-mid);}
.comp-table td{padding:9px 12px;font-size:12px;border-bottom:1px solid var(--cream);vertical-align:middle;}
.comp-table tr:last-child td{border-bottom:none;}
/* Status badges */
.st-badge{font-size:9.5px;font-weight:700;padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap;}
.st-filed{background:var(--green-light);color:var(--green);}
.st-pending{background:var(--amber-bg);color:var(--amber);}
.st-overdue{background:var(--red-bg);color:var(--red);}
.st-exempt{background:var(--cream);color:var(--text-muted);}
/* UBO */
.ubo-item{display:flex;align-items:center;gap:12px;padding:11px 18px;border-bottom:1px solid var(--cream);}
.ubo-item:last-child{border-bottom:none;}
.ubo-av{width:32px;height:32px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.ubo-info{flex:1;}
.ubo-name{font-size:13px;font-weight:600;margin-bottom:1px;}
.ubo-sub{font-size:11px;color:var(--text-muted);}
.ubo-pct{font-family:var(--font-mono);font-size:18px;font-weight:500;color:var(--green);}
/* Modal */
.ch-modal{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:800;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.ch-modal-box{background:var(--white);border-radius:var(--r-xl);width:600px;max-width:94vw;max-height:88vh;overflow-y:auto;box-shadow:0 4px 30px rgba(0,0,0,.12);animation:fadeUp .2s ease;}
.ch-modal-head{padding:18px 22px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:10px;}
.ch-modal-head h2{font-family:var(--font-serif);font-size:17px;font-weight:400;flex:1;}
.ch-modal-close{width:26px;height:26px;border-radius:6px;border:1px solid var(--cream-mid);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--text-muted);flex-shrink:0;}
.ch-modal-close:hover{background:var(--cream);}
.ch-modal-body{padding:20px 22px;}
.ch-modal-foot{padding:14px 22px;border-top:1px solid var(--cream-mid);display:flex;justify-content:flex-end;gap:8px;}
/* doc list */
.ch-doc-cat{width:140px;border-right:1px solid var(--cream-mid);background:var(--cream);overflow-y:auto;}
.ch-doc-cat-item{padding:6px 12px;font-size:11.5px;color:var(--text-mid);cursor:pointer;border-left:2px solid transparent;}
.ch-doc-cat-item:hover{background:var(--cream-mid);}
.ch-doc-cat-item.active{background:var(--green-light);color:var(--green);border-left-color:var(--green);font-weight:600;}
.ch-doc-item{display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid var(--cream);cursor:pointer;}
.ch-doc-item:hover{background:#FAFAF8;}.ch-doc-item:last-child{border-bottom:none;}
.ch-doc-badge{width:32px;height:38px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:8.5px;font-weight:800;flex-shrink:0;}
.ch-doc-info{flex:1;}
.ch-doc-name{font-size:12px;font-weight:500;margin-bottom:1px;}
.ch-doc-sub{font-size:10.5px;color:var(--text-muted);}
.ch-doc-date{font-size:10.5px;color:var(--text-faint);flex-shrink:0;}
/* Info box */
.ch-info-box{background:var(--amber-bg);border:1px solid var(--amber-border);border-radius:var(--r);padding:9px 13px;font-size:11.5px;color:#7A6020;line-height:1.5;}
/* divider label */
.sub-label{font-size:9.5px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-faint);margin-bottom:9px;margin-top:14px;}
.sub-label:first-child{margin-top:0;}
@media(max-width:1100px){.ch-cards{grid-template-columns:1fr 1fr;}.fg-4{grid-template-columns:1fr 1fr;}.fg-3{grid-template-columns:1fr 1fr;}}
@media(max-width:860px){.ch-layout{grid-template-columns:1fr;}.ch-panel{display:none;}.ch-cards{grid-template-columns:1fr 1fr;}}

/* ── Corporate sub-module tabs ─────────────────────────── */
.corp-mod-tabs{display:flex;border-bottom:1px solid var(--cream-mid);padding:0 0;background:var(--white);flex-shrink:0;overflow-x:auto;}
.corp-mod-tab{padding:11px 16px 10px;font-size:12.5px;font-weight:500;color:var(--text-muted);cursor:pointer;border:none;border-bottom:2px solid transparent;margin-bottom:-1px;background:none;font-family:var(--font-sans);transition:all .12s;white-space:nowrap;}
.corp-mod-tab:hover{color:var(--text);}
.corp-mod-tab.active{color:var(--green);border-bottom-color:var(--green);}
.corp-mod-tab.corp-mod-soon{opacity:.38;cursor:default;font-style:italic;}
.corp-mod-tab.corp-mod-soon:hover{color:var(--text-muted);}
/* ch-layout needs to account for sub-tab bar height */
.ch-layout{height:calc(100vh - 52px - 44px) !important;}

/* ── Entity list refinements ────────────────────────────── */
.ch-panel-head{gap:8px;display:flex;flex-direction:column;}
.ch-filter-pills{display:flex;gap:5px;flex-wrap:wrap;}
.ch-fpill{padding:3px 10px;font-size:10.5px;border:1px solid var(--cream-mid);border-radius:20px;background:var(--cream);color:var(--text-muted);cursor:pointer;font-family:var(--font-sans);font-weight:500;transition:all .12s;white-space:nowrap;}
.ch-fpill:hover{border-color:var(--green);color:var(--green);}
.ch-fpill.active{background:var(--green);color:#fff;border-color:var(--green);}
/* Entity item: avatar + name + status dot */
.entity-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--cream);cursor:pointer;transition:background .1s;border-left:3px solid transparent;position:relative;}
.ei-avatar{width:32px;height:32px;border-radius:8px;background:var(--cream-mid);display:flex;align-items:center;justify-content:center;font-family:var(--font-serif);font-size:13px;font-weight:500;color:var(--text-mid);flex-shrink:0;transition:all .15s;}
.entity-item.active .ei-avatar{background:var(--green);color:#fff;}
.ei-body{flex:1;min-width:0;}
.ei-status{flex-shrink:0;}
.ei-sdot{width:7px;height:7px;border-radius:50%;}
.ei-sdot.s-red{background:#E85D4A;}
.ei-sdot.s-amber{background:var(--amber);}
.ei-sdot.s-green{background:#4CAF50;}
/* remove old absolute-positioned alert dots */
.ei-alerts{display:none;}

/* ── Alert strip ────────────────────────────────────────── */
.ch-alert-strip{background:var(--amber-bg);border-bottom:1px solid var(--amber-border);padding:8px 22px;font-size:11.5px;color:#7A6020;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.ch-alert-strip svg{width:13px;height:13px;stroke:#C8A030;fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}
.ch-alert-strip .cas-actions{margin-left:auto;display:flex;gap:6px;}
.ch-alert-strip button{padding:3px 9px;font-size:11px;font-weight:500;background:rgba(200,160,48,.15);border:1px solid var(--amber-border);border-radius:5px;color:#7A6020;cursor:pointer;font-family:var(--font-sans);}
.ch-alert-strip button:hover{background:rgba(200,160,48,.28);}

/* ── Topbar: no subtitle ────────────────────────────────── */
.topbar-divider{display:none;}
.topbar-sub{display:none;}

/* ── Widget infrastructure ──────────────────────────────── */
/* Widgets are rendered on the dashboard — this is the data layer CSS */
.widget-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;padding:20px 28px;}
.widget{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);overflow:hidden;}
.widget-head{padding:12px 16px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:8px;}
.widget-head h4{font-size:12px;font-weight:600;flex:1;color:var(--text-mid);}
.widget-head .wh-icon{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;}
.widget-head .wh-icon svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;}
.widget-body{padding:0;}
.widget-item{display:flex;align-items:center;gap:10px;padding:9px 16px;border-bottom:1px solid var(--cream);font-size:12px;}
.widget-item:last-child{border-bottom:none;}
.widget-empty{padding:18px 16px;font-size:12px;color:var(--text-faint);font-style:italic;text-align:center;}

/* ══════════════════════════════════════════════════════════════
   DOCUMENTS MODULE
   ══════════════════════════════════════════════════════════════ */

/* Sub-module tab bar */
.docs-mod-tabs{display:flex;border-bottom:1px solid var(--cream-mid);padding:0;background:var(--white);flex-shrink:0;overflow-x:auto;}
.docs-mod-tab{padding:11px 20px 10px;font-size:12.5px;font-weight:500;color:var(--text-muted);cursor:pointer;border:none;border-bottom:2px solid transparent;margin-bottom:-1px;background:none;font-family:var(--font-sans);transition:all .12s;white-space:nowrap;}
.docs-mod-tab:hover{color:var(--text);}
.docs-mod-tab.active{color:var(--green);border-bottom-color:var(--green);}
.docs-tab-anon{color:var(--blue) !important;}
.docs-tab-anon.active{border-bottom-color:var(--blue) !important;}

/* OCR banner */
.docs-ocr-banner{background:var(--amber-bg);border-bottom:1px solid var(--amber-border);padding:8px 28px;font-size:11.5px;color:#7A6020;display:flex;align-items:center;gap:8px;}
.docs-ocr-banner svg{width:13px;height:13px;stroke:#C8A030;fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}

/* Tab content panels */
.docs-tab-content{display:none;flex:1;overflow-y:auto;}
.docs-tab-content.active{display:flex;flex-direction:column;}

/* Two-panel layout */
.docs-layout{display:grid;grid-template-columns:320px 1fr;flex:1;overflow:hidden;}
.docs-left{padding:20px 22px;overflow-y:auto;border-right:1px solid var(--cream-mid);background:var(--white);}
.docs-right{padding:24px 28px;overflow-y:auto;background:var(--cream);}

/* Upload zone */
.docs-upload-zone{border:1.5px dashed var(--green-border);border-radius:var(--r-lg);padding:20px;text-align:center;cursor:pointer;transition:all .15s;background:var(--green-light);margin-bottom:14px;}
.docs-upload-zone:hover{border-color:var(--green);background:#E0EDE7;}
.docs-upload-zone svg{width:22px;height:22px;stroke:var(--green);fill:none;stroke-width:1.5;stroke-linecap:round;margin-bottom:6px;}
.docs-upload-zone-secondary{background:var(--cream);border-color:var(--cream-dark);}
.docs-upload-zone-secondary:hover{border-color:var(--text-mid);}
.docs-upload-zone-secondary svg{stroke:var(--text-muted);}
.docs-upload-text{font-size:13px;font-weight:500;color:var(--green);margin-bottom:2px;}
.docs-upload-zone-secondary .docs-upload-text{color:var(--text-mid);}
.docs-upload-sub{font-size:11px;color:var(--text-muted);}
.docs-fname{display:flex;align-items:center;gap:7px;background:var(--green-light);border:1px solid var(--green-border);border-radius:var(--r);padding:6px 10px;font-size:11.5px;color:var(--green);margin-bottom:14px;}
.docs-fname svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;}

/* Field labels */
.docs-field-label{font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text-faint);margin-bottom:7px;margin-top:14px;}
.docs-field-label:first-child,.docs-upload-zone + .docs-field-label{margin-top:0;}
.docs-field-row{display:flex;gap:10px;}
.docs-field-row > *{flex:1;}

/* Audience cards */
.docs-audience{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:2px;}
.docs-aud-card{display:flex;flex-direction:column;align-items:center;gap:5px;padding:9px 7px;border:1.5px solid var(--cream-dark);border-radius:var(--r);cursor:pointer;transition:all .12s;background:var(--white);flex:1;min-width:52px;font-size:10.5px;font-weight:500;color:var(--text-muted);}
.docs-aud-card svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;}
.docs-aud-card:hover{border-color:var(--green);color:var(--green);}
.docs-aud-card.active{border-color:var(--green);background:var(--green-light);color:var(--green);}

/* Focus chips */
.docs-chips{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:2px;}
.docs-chip{padding:4px 10px;font-size:11px;border:1.5px solid var(--cream-dark);border-radius:20px;cursor:pointer;background:var(--white);color:var(--text-muted);transition:all .12s;font-weight:500;}
.docs-chip:hover{border-color:var(--green);color:var(--green);}
.docs-chip.active{background:var(--green);color:#fff;border-color:var(--green);}

/* Form controls */
.docs-select{width:100%;padding:7px 10px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:12.5px;color:var(--text);background:var(--white);outline:none;cursor:pointer;transition:border-color .15s;}
.docs-select:focus{border-color:var(--green);}
.docs-input{width:100%;padding:7px 10px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:12.5px;color:var(--text);background:var(--white);outline:none;transition:border-color .15s;}
.docs-input:focus{border-color:var(--green);}
.docs-textarea{width:100%;padding:8px 10px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:12.5px;color:var(--text);background:var(--white);outline:none;resize:vertical;min-height:60px;transition:border-color .15s;line-height:1.5;}
.docs-textarea:focus{border-color:var(--green);}

/* Segmented control */
.docs-seg{display:flex;background:var(--cream);border:1px solid var(--cream-dark);border-radius:var(--r);padding:3px;gap:2px;margin-bottom:2px;}
.docs-seg-btn{flex:1;padding:5px 8px;font-size:11px;font-weight:500;font-family:var(--font-sans);border:none;border-radius:5px;background:transparent;color:var(--text-muted);cursor:pointer;transition:all .12s;white-space:nowrap;}
.docs-seg-btn:hover{color:var(--text);}
.docs-seg-btn.active{background:var(--white);color:var(--green);box-shadow:0 1px 4px rgba(0,0,0,.08);}

/* Mode cards (compare / anonymise) */
.docs-mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:2px;}
.docs-mode-grid-4{grid-template-columns:1fr 1fr;}
.docs-mode-card{padding:10px 9px;border:1.5px solid var(--cream-dark);border-radius:var(--r);cursor:pointer;transition:all .12s;background:var(--white);text-align:center;}
.docs-mode-card svg{width:16px;height:16px;stroke:var(--text-muted);fill:none;stroke-width:1.8;stroke-linecap:round;margin-bottom:4px;}
.docs-mode-card:hover{border-color:var(--green);}
.docs-mode-card.active{border-color:var(--green);background:var(--green-light);}
.docs-mode-card.active svg{stroke:var(--green);}
.docs-mode-label{font-size:11.5px;font-weight:600;color:var(--text-mid);}
.docs-mode-card.active .docs-mode-label{color:var(--green);}
.docs-mode-sub{font-size:10px;color:var(--text-muted);margin-top:2px;}

/* Run button */
.docs-run-btn{width:100%;margin-top:16px;padding:11px;background:var(--green);color:#fff;border:none;border-radius:var(--r);font-family:var(--font-sans);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background .12s;}
.docs-run-btn:hover{background:var(--green-mid);}
.docs-run-btn svg{width:13px;height:13px;stroke:currentColor;fill:currentColor;stroke-width:0;}
.docs-run-btn-purple{background:var(--blue);}
.docs-run-btn-purple:hover{background:#2a4db0;}

/* Checkbox row */
.docs-checkbox-row{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--text-mid);cursor:pointer;margin-bottom:4px;}
.docs-checkbox-row input{accent-color:var(--green);}

/* Add custom field button */
.docs-add-btn{display:flex;align-items:center;gap:6px;font-size:11.5px;font-weight:500;color:var(--green);border:1.5px dashed var(--green-border);background:var(--green-light);border-radius:var(--r);padding:7px 12px;cursor:pointer;width:100%;margin-top:4px;transition:all .12s;font-family:var(--font-sans);}
.docs-add-btn:hover{border-style:solid;}
.docs-add-btn svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;}

/* Custom field row */
.docs-custom-row{display:flex;gap:6px;align-items:center;margin-bottom:5px;}
.docs-custom-row input{flex:1;padding:6px 8px;border:1px solid var(--cream-dark);border-radius:var(--r);font-size:11.5px;font-family:var(--font-sans);outline:none;}
.docs-custom-row input:focus{border-color:var(--green);}
.docs-custom-row .docs-custom-del{width:24px;height:24px;border-radius:5px;border:1px solid var(--cream-mid);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;color:var(--text-faint);transition:all .12s;}
.docs-custom-row .docs-custom-del:hover{border-color:var(--red);color:var(--red);}

/* Result panel */
.docs-result-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:300px;color:var(--text-faint);text-align:center;gap:12px;}
.docs-result-empty svg{width:40px;height:40px;stroke:var(--cream-dark);fill:none;stroke-width:1.2;stroke-linecap:round;}
.docs-result-empty{font-size:13px;font-style:italic;}

/* Result content */
.docs-result-content{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:22px 26px;line-height:1.7;font-size:13px;}
.docs-result-content h2{font-family:var(--font-serif);font-size:18px;font-weight:500;margin-bottom:10px;margin-top:18px;color:var(--text);}
.docs-result-content h2:first-child{margin-top:0;}
.docs-result-content h3{font-size:13px;font-weight:700;margin:14px 0 7px;color:var(--text);}
.docs-result-content p{margin-bottom:9px;}
.docs-result-content ul,
.docs-result-content ol{padding-left:18px;margin-bottom:9px;}
.docs-result-content li{margin-bottom:4px;}
.docs-result-content strong{font-weight:600;}
.docs-result-content table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:12px;}
.docs-result-content th{background:var(--cream);padding:7px 10px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);border-bottom:2px solid var(--cream-mid);}
.docs-result-content td{padding:8px 10px;border-bottom:1px solid var(--cream);vertical-align:top;}
.docs-result-content tr:last-child td{border-bottom:none;}

/* Severity badges in results */
.docs-result-content h3:has(+ *){}
.sev-high{color:var(--red);}
.sev-med{color:var(--amber);}
.sev-low{color:#27AE60;}

/* Meta chips on results */
.docs-result-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;}
.docs-result-meta .dmeta{padding:2px 8px;border-radius:4px;font-size:10.5px;font-weight:500;}
.dmeta-green{background:var(--green-light);color:var(--green);}
.dmeta-amber{background:var(--amber-bg);color:var(--amber);}
.dmeta-blue{background:var(--blue-bg);color:var(--blue);}
.dmeta-red{background:var(--red-bg);color:var(--red);}

/* Result actions bar */
.docs-result-actions{display:flex;gap:7px;margin-top:12px;flex-wrap:wrap;}
.docs-result-actions .btn{font-size:11px;padding:5px 11px;}

/* Obligations strip */
.docs-obligations{background:var(--amber-bg);border:1px solid var(--amber-border);border-radius:var(--r);padding:10px 14px;margin-top:12px;}
.docs-obligations h4{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--amber);margin-bottom:7px;}
.docs-obl-item{font-size:11.5px;color:#7A6020;padding:4px 0;border-bottom:1px solid var(--amber-border);display:flex;gap:7px;align-items:flex-start;}
.docs-obl-item:last-child{border-bottom:none;padding-bottom:0;}
.docs-obl-item::before{content:"→";color:var(--amber);flex-shrink:0;}

/* Redaction map */
.docs-redaction-map{margin-top:12px;}
.docs-redaction-map h4{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px;}
.docs-red-table{width:100%;border-collapse:collapse;font-size:11.5px;}
.docs-red-table th{background:var(--cream);padding:6px 10px;text-align:left;font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);}
.docs-red-table td{padding:6px 10px;border-bottom:1px solid var(--cream);font-family:var(--font-mono);}
.docs-red-table tr:last-child td{border-bottom:none;}

/* Loading state */
.docs-loading{display:flex;align-items:center;gap:10px;padding:24px;color:var(--text-muted);font-size:13px;}
.docs-loading .spinner{border-color:rgba(27,79,64,.2);border-top-color:var(--green);}

/* Responsive */
@media(max-width:900px){.docs-layout{grid-template-columns:1fr;}.docs-right{border-top:1px solid var(--cream-mid);}}

/* ── COMPLIANCE MODULE ─────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --green:#1B4F40;--green-light:#EAF1ED;--green-border:#C4DACE;--green-mid:#153D31;
  --cream:#F5F3EE;--cream-mid:#EAE6DF;--cream-dark:#D8D4CC;
  --white:#FFFFFF;--text:#1A1916;--text-mid:#706C65;--text-muted:#A8A49D;--text-faint:#C4BFB6;
  --amber:#C8A030;--amber-bg:#FFFBF0;--amber-border:#F0E8CC;
  --red:#C0392B;--red-bg:#FAEAE8;--red-border:#E8BCBC;
  --blue:#3A5BBF;--blue-bg:#EEF2FF;--blue-border:#C8D4F5;
  --success:#2D7A4F;--success-bg:#EAF4EE;--success-border:#B8DEC8;
  --purple:#6B3FA0;--purple-bg:#F3EEFF;--purple-border:#D4C2F0;
  --font-serif:'Lora',Georgia,serif;--font-sans:'Inter',sans-serif;--font-mono:'JetBrains Mono',monospace;
  --r:8px;--r-lg:12px;--r-xl:16px;
}
html,body{height:100%;font-family:var(--font-sans);font-size:13px;color:var(--text);background:var(--cream);line-height:1.5;-webkit-font-smoothing:antialiased;}
.app{display:flex;height:100vh;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:196px;flex-shrink:0;background:var(--white);border-right:1px solid var(--cream-mid);display:flex;flex-direction:column;overflow-y:auto;}
.sidebar-logo{padding:15px 15px 13px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:9px;}
.logo-mark{width:27px;height:27px;background:var(--green);border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:var(--font-serif);font-style:italic;color:#fff;font-size:15px;font-weight:600;text-decoration:none;}
.logo-text{font-family:var(--font-serif);font-size:17px;font-weight:600;color:var(--green);letter-spacing:-.3px;}
.user-row{padding:9px 13px;border-bottom:1px solid var(--cream-mid);display:flex;align-items:center;gap:8px;}
.user-avatar{width:26px;height:26px;border-radius:50%;background:var(--green);color:#fff;font-size:9.5px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.user-name{font-size:11.5px;font-weight:500;color:var(--text);line-height:1.2;}
.user-role{font-size:10px;color:var(--text-muted);}
.nav-group-label{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);padding:13px 13px 3px;}
.nav-item{display:flex;align-items:center;gap:7px;padding:6px 13px;cursor:pointer;color:var(--text-mid);font-size:12px;border-left:2px solid transparent;transition:all .12s;text-decoration:none;}
.nav-item:hover{background:var(--cream);color:var(--text);}
.nav-item.active{background:var(--green-light);color:var(--green);border-left-color:var(--green);font-weight:600;}
.nav-item svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.nav-badge{margin-left:auto;font-size:9.5px;font-weight:700;padding:1px 5px;border-radius:10px;line-height:1.6;}
.nb-red{background:var(--red-bg);color:var(--red);}
.nb-amber{background:var(--amber-bg);color:var(--amber);}
.nb-muted{background:var(--cream-mid);color:var(--text-muted);}

/* MAIN */
.main{flex:1;display:flex;overflow:hidden;}

/* SUB NAV */
.sub-nav{width:182px;flex-shrink:0;background:var(--cream);border-right:1px solid var(--cream-dark);overflow-y:auto;padding:14px 0;}
.sub-title{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);padding:0 13px 8px;}
.sub-item{display:flex;align-items:center;justify-content:space-between;padding:6px 13px;cursor:pointer;color:var(--text-mid);font-size:12px;border-left:2px solid transparent;transition:all .1s;user-select:none;}
.sub-item:hover{background:var(--cream-mid);color:var(--text);}
.sub-item.active{background:var(--white);color:var(--green);border-left-color:var(--green);font-weight:600;}
.sub-item-inner{display:flex;align-items:center;gap:6px;}
.sub-item svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.sub-divider{height:1px;background:var(--cream-dark);margin:7px 13px;}
.sub-section-label{font-size:8.5px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);padding:8px 13px 3px;}

/* CONTENT AREA */
.content{flex:1;overflow-y:auto;display:flex;flex-direction:column;background:var(--cream);}

/* TOPBAR */
.topbar{padding:18px 22px 0;display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0;background:var(--cream);}
.topbar-left h1{font-family:var(--font-serif);font-size:18px;font-weight:500;margin-bottom:2px;}
.topbar-left p{font-size:11px;color:var(--text-muted);}
.topbar-actions{display:flex;gap:6px;align-items:center;padding-top:2px;flex-wrap:wrap;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--r);font-size:12px;font-weight:500;cursor:pointer;border:none;font-family:var(--font-sans);transition:all .12s;white-space:nowrap;}
.btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.btn-primary{background:var(--green);color:#fff;}
.btn-primary:hover{background:var(--green-mid);}
.btn-primary:disabled{background:var(--cream-dark);color:var(--text-muted);cursor:not-allowed;}
.btn-secondary{background:var(--white);color:var(--text-mid);border:1px solid var(--cream-dark);}
.btn-secondary:hover{background:var(--cream);}
.btn-danger{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.btn-danger:hover{background:var(--red-border);}
.btn-sm{padding:4px 9px;font-size:11px;}
.btn-ghost{background:transparent;color:var(--text-muted);padding:4px 9px;border:1px solid var(--cream-dark);border-radius:var(--r);font-size:11px;cursor:pointer;font-family:var(--font-sans);}
/* EXPORT DROPDOWN */
.export-menu-wrap{position:relative;display:inline-flex;}
.export-dd{display:none;position:absolute;right:0;top:calc(100% + 4px);background:var(--white);border:1px solid var(--cream-dark);border-radius:var(--r);box-shadow:0 4px 16px rgba(0,0,0,.1);z-index:300;min-width:148px;overflow:hidden;}
.export-dd button{display:block;width:100%;text-align:left;padding:8px 14px;font-size:12px;font-family:var(--font-sans);cursor:pointer;border:none;background:transparent;color:var(--text);line-height:1.4;}
.export-dd button:hover{background:var(--cream);}

/* RAG STRIP */
.rag-strip{display:flex;gap:7px;padding:12px 22px;flex-shrink:0;}
.rag-card{display:flex;align-items:center;gap:9px;background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:9px 13px;flex:1;}
.rag-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.rag-num{font-family:var(--font-serif);font-size:20px;font-weight:500;line-height:1;}
.rag-label{font-size:10px;color:var(--text-muted);margin-top:1px;}

/* FILTER BAR */
.filter-bar{display:flex;align-items:center;gap:6px;padding:0 22px 10px;flex-wrap:wrap;}
.search-wrap{display:flex;align-items:center;gap:6px;background:var(--white);border:1px solid var(--cream-dark);border-radius:var(--r);padding:6px 10px;font-size:12px;color:var(--text-muted);min-width:200px;}
.search-wrap input{border:none;outline:none;background:transparent;font-size:12px;font-family:var(--font-sans);color:var(--text);width:100%;}
.search-wrap svg{width:11px;height:11px;stroke:var(--text-muted);fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.chip{display:inline-flex;align-items:center;gap:4px;background:var(--white);border:1px solid var(--cream-dark);border-radius:20px;padding:3px 10px;font-size:11px;color:var(--text-mid);cursor:pointer;transition:all .1s;}
.chip:hover{background:var(--cream);}
.chip.active{background:var(--green-light);border-color:var(--green-border);color:var(--green);font-weight:500;}

/* TABLE */
.section{padding:0 22px 22px;}
.table-wrap{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{font-size:9.5px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-faint);background:var(--cream);padding:8px 13px;text-align:left;border-bottom:1px solid var(--cream-mid);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--cream-mid);transition:background .1s;cursor:pointer;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:#FAFAF8;}
tbody tr.row-red{background:var(--red-bg);}
tbody tr.row-red:hover{background:#F5DDD9;}
tbody tr.row-amber{background:var(--amber-bg);}
tbody tr.row-amber:hover{background:#FFF6E0;}
tbody td{padding:9px 13px;font-size:12px;color:var(--text);vertical-align:middle;}
.td-main{font-weight:500;line-height:1.3;}
.td-sub{font-size:10px;color:var(--text-muted);margin-top:2px;}

/* PILLS */
.pill{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:500;white-space:nowrap;}
.pill::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.pill-red{background:var(--red-bg);color:var(--red);}.pill-red::before{background:var(--red);}
.pill-amber{background:var(--amber-bg);color:var(--amber);}.pill-amber::before{background:var(--amber);}
.pill-green{background:var(--success-bg);color:var(--success);}.pill-green::before{background:var(--success);}
.pill-blue{background:var(--blue-bg);color:var(--blue);}.pill-blue::before{background:var(--blue);}
.pill-muted{background:var(--cream-mid);color:var(--text-muted);}.pill-muted::before{background:var(--text-faint);}
.pill-purple{background:var(--purple-bg);color:var(--purple);}.pill-purple::before{background:var(--purple);}

/* DEADLINE */
.dl{display:inline-flex;align-items:center;gap:4px;font-size:11px;}
.dl svg{width:11px;height:11px;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.dl-red{color:var(--red);}.dl-red svg{stroke:var(--red);}
.dl-amber{color:var(--amber);}.dl-amber svg{stroke:var(--amber);}
.dl-ok{color:var(--text-muted);}.dl-ok svg{stroke:var(--text-muted);}

/* AVATARS */
.av{width:22px;height:22px;border-radius:50%;background:var(--green-light);color:var(--green);font-size:9px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;}

/* ALERTS */
.alert-bar{display:flex;align-items:flex-start;gap:8px;border-radius:var(--r);padding:9px 12px;font-size:11.5px;margin-bottom:10px;line-height:1.5;}
.alert-bar svg{width:13px;height:13px;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;margin-top:1px;}
.alert-red{background:var(--red-bg);border:1px solid var(--red-border);color:var(--red);}.alert-red svg{stroke:var(--red);}
.alert-amber{background:var(--amber-bg);border:1px solid var(--amber-border);color:#7a5a10;}.alert-amber svg{stroke:var(--amber);}
.alert-blue{background:var(--blue-bg);border:1px solid var(--blue-border);color:var(--blue);}.alert-blue svg{stroke:var(--blue);}

/* EMPTY STATE */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 22px;text-align:center;color:var(--text-muted);}
.empty svg{width:34px;height:34px;stroke:var(--cream-dark);fill:none;stroke-width:1.4;margin-bottom:12px;}
.empty h3{font-family:var(--font-serif);font-size:15px;color:var(--text-mid);margin-bottom:5px;font-weight:500;}
.empty p{font-size:11.5px;max-width:240px;line-height:1.7;}

/* INFO GRID */
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.info-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:12px 15px;}
.info-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:4px;}
.info-val{font-size:12.5px;color:var(--text);}

/* RISK BADGES */
.risk-box{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:10.5px;font-weight:600;}
.risk-high{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.risk-medium{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-border);}
.risk-low{background:var(--success-bg);color:var(--success);border:1px solid var(--success-border);}

/* DEADLINE BAR */
.deadline-bar{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:12px 16px;display:flex;align-items:center;gap:14px;margin-bottom:10px;}
.deadline-bar.urgent{background:var(--red-bg);border-color:var(--red-border);}
.deadline-bar.warn{background:var(--amber-bg);border-color:var(--amber-border);}
.dl-days{font-family:var(--font-serif);font-size:28px;font-weight:500;line-height:1;width:50px;text-align:center;flex-shrink:0;}
.dl-days.urgent{color:var(--red);}
.dl-days.warn{color:var(--amber);}
.dl-body{flex:1;}
.dl-body strong{display:block;font-size:12.5px;font-weight:600;}
.dl-body span{font-size:11px;color:var(--text-muted);}

/* PROGRESS */
.progress-wrap{background:var(--cream-mid);border-radius:4px;height:4px;overflow:hidden;width:90px;}
.progress-bar{height:100%;border-radius:4px;}
.pb-green{background:var(--success);}.pb-amber{background:var(--amber);}.pb-red{background:var(--red);}

/* DPO CARD */
.dpo-hero{background:var(--white);border:1px solid var(--green-border);border-radius:var(--r-lg);padding:16px 20px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:16px;}
.dpo-avatar{width:40px;height:40px;border-radius:50%;background:var(--green);color:#fff;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.dpo-stats{display:flex;gap:22px;}
.dpo-stat{text-align:center;}
.dpo-stat-num{font-family:var(--font-serif);font-size:18px;font-weight:500;}
.dpo-stat-lbl{font-size:9.5px;color:var(--text-muted);}

/* DASHBOARD WIDGETS */
.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px 22px 22px;}
.dash-widget{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:16px 18px;cursor:pointer;transition:border-color .12s;}
.dash-widget:hover{border-color:var(--green-border);}
.dash-widget-title{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-bottom:12px;}
.dash-rag-row{display:flex;gap:8px;margin-bottom:14px;}
.dash-rag-item{flex:1;text-align:center;}
.dash-rag-num{font-family:var(--font-serif);font-size:22px;font-weight:500;line-height:1;}
.dash-rag-lbl{font-size:9.5px;color:var(--text-muted);margin-top:2px;}
.dash-actions{display:flex;flex-direction:column;gap:0;}
.dash-action{display:flex;align-items:center;gap:8px;font-size:11.5px;padding:6px 0;border-bottom:1px solid var(--cream-mid);}
.dash-action:last-child{border-bottom:none;}
.dash-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.dash-action-text{flex:1;color:var(--text);}
.dash-action-tag{font-size:10px;color:var(--text-muted);white-space:nowrap;}
.dash-empty{font-size:11.5px;color:var(--text-muted);text-align:center;padding:12px 0;font-style:italic;}

/* POLICY CARDS */
.policy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;padding:0 22px 22px;}
.policy-card{background:var(--white);border:1px solid var(--cream-mid);border-radius:var(--r-lg);padding:14px 16px;cursor:pointer;transition:border-color .12s;}
.policy-card:hover{border-color:var(--green-border);}
.policy-card-top{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;}
.p-icon{width:34px;height:34px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.p-icon svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}
.p-icon-doc{background:var(--blue-bg);color:var(--blue);}
.p-icon-advice{background:var(--green-light);color:var(--green);}
.p-icon-template{background:var(--purple-bg);color:var(--purple);}
.p-icon-radar{background:var(--amber-bg);color:var(--amber);}
.policy-name{font-size:12.5px;font-weight:500;line-height:1.3;}
.policy-meta{font-size:10.5px;color:var(--text-muted);margin-top:2px;}
.policy-footer{display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
.p-tag{display:inline-flex;align-items:center;gap:3px;font-size:9.5px;font-weight:600;padding:2px 7px;border-radius:20px;white-space:nowrap;}
.p-tag-kb{background:var(--success-bg);color:var(--success);}
.p-tag-radar{background:var(--amber-bg);color:var(--amber);}
.p-tag-module{background:var(--cream-mid);color:var(--text-mid);}
.policy-add-card{border:1px dashed var(--cream-dark);border-radius:var(--r-lg);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:110px;gap:6px;color:var(--text-muted);cursor:pointer;transition:border-color .12s;}
.policy-add-card:hover{border-color:var(--green);color:var(--green);}
.policy-add-card svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;}

/* RADAR BANNER */
.radar-banner{display:flex;align-items:center;gap:10px;background:var(--amber-bg);border:1px solid var(--amber-border);border-radius:var(--r-lg);padding:11px 16px;margin:0 22px 12px;cursor:pointer;transition:border-color .12s;}
.radar-banner:hover{border-color:var(--amber);}
.radar-banner svg{width:14px;height:14px;stroke:var(--amber);fill:none;stroke-width:1.85;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.radar-banner-text{flex:1;font-size:11.5px;color:#7a5a10;}
.radar-banner-text strong{display:block;font-size:12px;font-weight:600;color:#5a3f00;margin-bottom:1px;}

/* ROLE TOGGLE */
.role-toggle{display:flex;background:var(--cream);border-radius:var(--r);padding:3px;gap:3px;}
.role-btn{flex:1;padding:5px 10px;border-radius:6px;border:none;font-size:11.5px;font-weight:500;cursor:pointer;font-family:var(--font-sans);color:var(--text-muted);background:transparent;transition:all .12s;}
.role-btn.active{background:var(--white);color:var(--green);font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.08);}

/* FORM */
.form-row{display:flex;gap:10px;margin-bottom:10px;}
.form-group{flex:1;}
.form-group label{display:block;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;}
.form-control{width:100%;background:var(--white);border:1px solid var(--cream-dark);border-radius:var(--r);padding:7px 10px;font-size:12px;font-family:var(--font-sans);color:var(--text);outline:none;transition:border-color .1s;}
.form-control:focus{border-color:var(--green);}
.form-control:disabled{background:var(--cream);color:var(--text-muted);}
.form-hint{font-size:10px;color:var(--text-muted);margin-top:3px;line-height:1.5;}
.form-section-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-faint);margin-top:16px;margin-bottom:8px;padding-top:12px;border-top:1px solid var(--cream-mid);}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(26,25,22,.38);z-index:200;align-items:center;justify-content:center;}
.overlay.open{display:flex;}
.modal{background:var(--white);border-radius:var(--r-xl);padding:26px;width:540px;max-height:86vh;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.16);}
.modal-wide{width:680px;}
.modal-title{font-family:var(--font-serif);font-size:17px;font-weight:500;margin-bottom:3px;}
.modal-sub{font-size:11px;color:var(--text-muted);margin-bottom:18px;line-height:1.6;}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:18px;padding-top:14px;border-top:1px solid var(--cream-mid);}

/* VIEWS */
.view{display:none;flex-direction:column;min-height:100%;}
.view.active{display:flex;}

/* STAGE PROGRESS */
.stage-track{display:flex;gap:3px;margin-bottom:4px;}
.stage-pip{flex:1;height:4px;border-radius:2px;background:var(--cream-mid);}
.stage-pip.done{background:var(--success);}
.stage-pip.current{background:var(--amber);}

/* SECTION DIVIDER */
.sec-divider{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-faint);margin:18px 0 12px;display:flex;align-items:center;gap:8px;}
.sec-divider::after{content:'';flex:1;height:1px;background:var(--cream-mid);}

/* USER MATRIX */
.user-matrix{width:100%;border-collapse:collapse;}
.user-matrix th{font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-faint);padding:8px 10px;text-align:left;border-bottom:1px solid var(--cream-mid);}
.user-matrix td{padding:10px;border-bottom:1px solid var(--cream-mid);font-size:12px;vertical-align:middle;}
.user-matrix tr:last-child td{border-bottom:none;}
.user-matrix input[type=checkbox]{width:15px;height:15px;accent-color:var(--green);}

/* TOAST */
#toast{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:6px;}
.toast-item{background:var(--text);color:#fff;padding:10px 16px;border-radius:var(--r-lg);font-size:12.5px;box-shadow:0 4px 16px rgba(0,0,0,.2);animation:slide-in .2s ease;max-width:320px;}
.toast-item.toast-ok{background:var(--success);}
.toast-item.toast-err{background:var(--red);}
@keyframes slide-in{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--cream-dark);border-radius:10px;}

/* MISC */
.chevron{color:var(--text-faint);font-size:15px;}
.badge-tag{display:inline-flex;font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;}
.badge-blue{background:var(--blue-bg);color:var(--blue);}
.badge-muted{background:var(--cream-mid);color:var(--text-mid);}
.badge-green{background:var(--success-bg);color:var(--success);}
.badge-amber{background:var(--amber-bg);color:var(--amber);}
.badge-red{background:var(--red-bg);color:var(--red);}
.badge-purple{background:var(--purple-bg);color:var(--purple);}
.country-risk-high{font-size:10px;background:var(--red-bg);color:var(--red);padding:2px 5px;border-radius:4px;font-weight:600;}
.country-risk-medium{font-size:10px;background:var(--amber-bg);color:var(--amber);padding:2px 5px;border-radius:4px;font-weight:600;}
.country-risk-low{font-size:10px;background:var(--cream-mid);color:var(--text-mid);padding:2px 5px;border-radius:4px;font-weight:600;}
.mono{font-family:var(--font-mono);font-size:10.5px;color:var(--text-muted);}
.viewer-hidden{display:none !important;}

</style>
</head>
<body>
<!-- TRIAL BANNER -->
<div id="trial-banner" style="display:none;background:#FEF3C7;border-bottom:1px solid #FCD34D;padding:10px 24px;align-items:center;justify-content:space-between;font-size:12px;color:#92400E;">
  <span id="trial-banner-text"></span>
  <a href="mailto:hello@askmickey.io?subject=Mickey subscription" style="background:#92400E;color:#fff;padding:5px 14px;border-radius:6px;text-decoration:none;font-size:11px;font-weight:600;margin-left:16px;white-space:nowrap;">Upgrade now</a>
</div>
<script>
(async function() {
  try {
    const r = await fetch('/api/firm/trial-status');
    if (!r.ok) return;
    const d = await r.json();
    if (d.show_banner) {
      const banner = document.getElementById('trial-banner');
      const text   = document.getElementById('trial-banner-text');
      text.textContent = d.days_left === 0
        ? 'Your trial expires today. Contact us to continue using Mickey.'
        : `Your trial ends in ${d.days_left} day${d.days_left === 1 ? '' : 's'}. Contact us to continue.`;
      banner.style.display = 'flex';
    }
  } catch(e) {}
})();
</script>


<!-- APP -->
<div id="app">
  <nav class="sidebar">
    <div class="sb-logo">
      <div class="sb-logomark">M</div>
      <div class="sb-logotext">Mickey</div>
    </div>
    <div class="sb-profile">
      <div class="sb-avatar" id="sb-avatar-initials">—</div>
      <div class="sb-profile-text">
        <strong id="sidebar-user">—</strong>
        <span id="sidebar-role">Legal</span>
        <div class="sb-admin-chip" id="sidebar-admin" style="display:none">Admin</div>
      </div>
    </div>

    <div class="nav-sec">Workspace</div>
    <div class="nav-item active" data-mod="dashboard" onclick="go('dashboard',this)">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg><span>Dashboard</span>
    </div>
    <div class="nav-item" data-mod="discovery" onclick="go('discovery',this)">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 8v4l3 3"/></svg><span>Matters</span>
    </div>

    <div class="nav-sec">Tools</div>
    <div class="nav-item" data-mod="radar" onclick="go('radar',this)">
      <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Legal Radar</span>
      <span class="sb-badge" id="radar-badge" style="display:none">3</span>
    </div>
    <div class="nav-item" data-mod="review" onclick="go('review',this)">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="12" y2="17"/></svg><span>Documents</span>
    </div>
    <div class="nav-item" data-mod="vault" onclick="go('vault',this)">
      <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg><span>Corporate</span>
    </div>
    <div class="nav-item" data-mod="minutes" onclick="go('minutes',this)">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="11" y2="17"/></svg><span>Board &amp; Minutes</span>
    </div>
    <div class="nav-item" data-mod="playbooks" onclick="go('playbooks',this)">
      <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Playbooks</span>
    </div>
    <div class="nav-item" data-mod="compliance" onclick="go('compliance',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.85" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Compliance</span>
    </div>

    <div class="nav-sec">Knowledge</div>
    <div class="nav-item" data-mod="collections" onclick="go('collections',this)">
      <svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg><span>Collections</span>
    </div>
    <div class="nav-item" data-mod="knowledge" onclick="go('knowledge',this)">
      <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg><span>Knowledge Base</span>
    </div>
    <div class="nav-sec">System</div>
    <div class="nav-item" data-mod="settings" onclick="go('settings',this)">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Info &amp; Settings</span>
    </div>

    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
      <svg id="toggle-icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
    </button>

    <div class="sb-bottom">
      <div class="signout-btn" onclick="doSignout()">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign out
      </div>
    </div>
  </nav>

  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div class="topbar-right">
        <label class="web-toggle" title="Enable live web search for current regulatory updates">
          <input type="checkbox" id="web-toggle" checked> Web search
        </label>
        <div class="topbar-chip">mickey · claude</div>
      </div>
    </div>
    <div id="disclaimer-bar" style="display:none;padding:7px 28px;background:var(--amber-bg);border-bottom:1px solid var(--amber-border);font-size:11.5px;color:#7A6020;align-items:center;gap:8px;flex-shrink:0;">
      <span>&#9888; <strong>AI outputs are not legal advice.</strong> All answers must be verified by a qualified legal professional before reliance.</span>
      <button onclick="document.getElementById('disclaimer-bar').style.display='none'" style="margin-left:auto;background:none;border:none;cursor:pointer;color:#7A6020;font-size:15px;">&#215;</button>
    </div>
    <div class="content" id="main-content">

      <!-- DASHBOARD -->
      <div class="module active" id="mod-dashboard">
        <div class="dash-greeting">
          <h2 id="dash-greeting-text">Good morning</h2>
          <p id="dash-date-text">Loading...</p>
        </div>
        <div class="stats-row">
          <div class="stat-card c-green"><div class="stat-label">Active Matters</div><div class="stat-num" id="dash-matters-count">—</div><div class="stat-sub" id="dash-matters-sub">Loading…</div></div>
          <div class="stat-card c-amber"><div class="stat-label">Radar Alerts</div><div class="stat-num" id="dash-radar-count">—</div><div class="stat-sub" id="dash-radar-sub">Loading…</div></div>
          <div class="stat-card c-blue"><div class="stat-label">Queries this month</div><div class="stat-num" id="dash-query-count">—</div><div class="stat-sub">AI-assisted research</div></div>
          <div class="stat-card c-purple"><div class="stat-label">Documents reviewed</div><div class="stat-num" id="dash-docs-count">—</div><div class="stat-sub">This month</div></div>
        </div>
        <div class="dash-cols">
          <div class="dash-left">
            <div class="card">
              <div class="card-head"><h3>Active matters</h3><span class="card-view-all" onclick="go('vault',document.querySelector('[data-mod=vault]'))">View all</span></div>
              <div class="matter-item"><div class="matter-dot dot-urgent"></div><div class="matter-text"><div class="matter-title">MickeyLaw BV — Shareholder dispute</div><div class="matter-sub">Governance · Board composition issue</div></div><span class="mtag mtag-urgent">Urgent</span></div>
              <div class="matter-item"><div class="matter-dot dot-active"></div><div class="matter-text"><div class="matter-title">Mick &amp; Co GmbH</div><div class="matter-sub">Shareholder agreement · €8.5M put option</div></div><span class="mtag-date">7 Mar</span></div>
              <div class="matter-item"><div class="matter-dot dot-info"></div><div class="matter-text"><div class="matter-title">AI Contracts — Clause update</div><div class="matter-sub">EU AI Act compliance provisions</div></div><span class="mtag mtag-ongoing">Ongoing</span></div>
              <div class="matter-item"><div class="matter-dot dot-hold"></div><div class="matter-text"><div class="matter-title">Senior Facilities Agreement</div><div class="matter-sub">Francisco Partners · Change of control</div></div><span class="mtag mtag-hold">On hold</span></div>
            </div>
            <div class="card">
              <div class="card-head"><h3>Recent queries</h3><span class="card-view-all" onclick="go('discovery',document.querySelector('[data-mod=discovery]'))">Open Discovery</span></div>
              <div class="query-item"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><span class="query-text">Article 28 GDPR — processor obligations and mandatory DPA terms</span></div>
              <div class="query-item"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><span class="query-text">Belgian corporate law — conflict of interest director abstention</span></div>
              <div class="query-item"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><span class="query-text">Belgian Takeover Act — 30% threshold mandatory bid</span></div>
            </div>
          </div>
          <div class="dash-right">
            <div class="card">
              <div class="card-head"><h3>Legal Radar</h3><span class="card-view-all" onclick="go('radar',document.querySelector('[data-mod=radar]'))">View all</span></div>
              <div class="radar-card-s high"><div class="rc-tags"><span class="rc-tag rc-tag-eu">EU</span><span class="rc-tag rc-tag-ai">AI Act</span><span class="rc-tag rc-tag-req">Action req.</span><span class="rc-date">15 Feb</span></div><div class="rc-title">EU AI Act — GPAI model obligations</div><div class="rc-desc">Deadline for GPAI providers approaching. Assess your company's exposure.</div></div>
              <div class="radar-card-s medium"><div class="rc-tags"><span class="rc-tag rc-tag-be">BE</span><span class="rc-tag rc-tag-eu">EU</span><span class="rc-date">12 Feb</span></div><div class="rc-title">Belgian FSM Act — Takeover threshold</div><div class="rc-desc">Consultation open on Art. 513 amendments. Relevant to sale process.</div></div>
              <div class="radar-card-s info"><div class="rc-tags"><span class="rc-tag rc-tag-eu">EU</span><span class="rc-date">8 Feb</span></div><div class="rc-title">GBA enforcement — Processor liability</div><div class="rc-desc">&#8364;180k fine issued. Relevant to Mickey DPA and Anthropic sub-processor.</div></div>
            </div>
            <div class="card">
              <div class="card-head"><h3>Quick actions</h3></div>
              <div class="qa-grid">
                <div class="qa-btn" onclick="go('review',document.querySelector('[data-mod=review]'))"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg><span>Review contract</span></div>
                <div class="qa-btn" onclick="go('draft',document.querySelector('[data-mod=draft]'))"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg><span>Draft document</span></div>
                <div class="qa-btn" onclick="go('vault',document.querySelector('[data-mod=vault]'))"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg><span>Corporate files</span></div>
                <div class="qa-btn" onclick="go('minutes',document.querySelector('[data-mod=minutes]'))"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>New meeting</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DISCOVERY -->
      <div class="module" id="mod-discovery">
        <div style="background:var(--green);border-radius:var(--r-lg);padding:26px 30px;margin-bottom:20px;position:relative;overflow:hidden;">
          <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 80% 50%,rgba(255,255,255,.06),transparent 55%);pointer-events:none;"></div>
          <div style="font-family:var(--font-serif);font-size:24px;font-weight:400;color:#fff;margin-bottom:3px;position:relative;">What's on your mind, <strong id="hero-name" style="font-weight:500;">—</strong></div>
          <div style="font-size:12px;color:rgba(255,255,255,.5);margin-bottom:18px;position:relative;" id="hero-sub">Ask any legal question across any jurisdiction.</div>
          <div style="display:flex;gap:8px;position:relative;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:var(--r);padding:10px 14px;">
            <input type="text" id="hero-input" placeholder="Ask Mickey anything…" onkeydown="if(event.key==='Enter')heroAsk()" style="flex:1;background:transparent;border:none;outline:none;font-family:var(--font-serif);font-size:16px;color:#fff;">
            <button onclick="heroAsk()" style="background:#fff;color:var(--green);border:none;border-radius:6px;padding:7px 16px;font-family:var(--font-sans);font-size:11px;font-weight:600;letter-spacing:.05em;cursor:pointer;flex-shrink:0;">Ask &#8594;</button>
          </div>
        </div>
        <div id="chat-area" class="chat-area" style="display:none"></div>
        <div id="sug-wrap">
          <div class="section-label">Suggested questions</div>
          <div class="sug-grid">
            <div class="sug-card" onclick="askSug(this)"><div class="sug-tag">GDPR · Art. 28</div><div class="sug-text">Processor obligations and mandatory DPA contract terms</div></div>
            <div class="sug-card" onclick="askSug(this)"><div class="sug-tag">AI Act · Belgium</div><div class="sug-text">High-risk AI provider obligations before market placement</div></div>
            <div class="sug-card" onclick="askSug(this)"><div class="sug-tag">Belgian Corporate</div><div class="sug-text">Director conflict of interest rules under Art. 7:96 WVV</div></div>
            <div class="sug-card" onclick="askSug(this)"><div class="sug-tag">Telemarketing</div><div class="sug-text">Belgian consent requirements for automated marketing calls</div></div>
            <div class="sug-card" onclick="askSug(this)"><div class="sug-tag">NIS2 · Belgium</div><div class="sug-text">Incident reporting deadlines and notification authority</div></div>
            <div class="sug-card" onclick="askSug(this)"><div class="sug-tag">M&amp;A · WVV</div><div class="sug-text">Change of control provisions and drag-along rights under Belgian law</div></div>
          </div>
          <div style="margin-top:12px;text-align:center;"><button class="btn btn-sm" onclick="clearChat()" id="clear-btn" style="display:none">Clear conversation</button></div>
        </div>
      </div>

      <!-- LEGAL RADAR -->
      <div class="module" id="mod-radar">
        <div class="sug-grid" style="margin-bottom:20px;">
          <div class="sug-card" onclick="radarAsk(this)"><div class="sug-tag">AI Act</div><div class="sug-text">Key AI Act deadlines and obligations in 2025–2026</div></div>
          <div class="sug-card" onclick="radarAsk(this)"><div class="sug-tag">NIS2</div><div class="sug-text">NIS2 compliance obligations for Belgian essential entities</div></div>
          <div class="sug-card" onclick="radarAsk(this)"><div class="sug-tag">GDPR</div><div class="sug-text">Recent GDPR enforcement decisions — Belgian DPA and EDPB</div></div>
          <div class="sug-card" onclick="radarAsk(this)"><div class="sug-tag">WVV</div><div class="sug-text">Belgian Companies Code developments 2025–2026</div></div>
          <div class="sug-card" onclick="radarAsk(this)"><div class="sug-tag">GPAI</div><div class="sug-text">GPAI Code of Practice — obligations for model providers</div></div>
          <div class="sug-card" onclick="radarAsk(this)"><div class="sug-tag">eIDAS 2.0</div><div class="sug-text">European Digital Identity Wallet implementation timeline</div></div>
        </div>
        <div class="section-label">Custom query</div>
        <div style="display:flex;gap:10px;margin-bottom:16px;">
          <input type="text" id="radar-input" style="flex:1;padding:9px 12px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:13px;color:var(--text);background:var(--white);outline:none;" placeholder="Ask about any regulatory development…" onkeydown="if(event.key==='Enter')radarCustom()">
          <button class="btn btn-primary" onclick="radarCustom()">Ask Mickey</button>
        </div>
        <div class="result-box empty" id="radar-result">Results will appear here</div>
      </div>

      <!-- DOCUMENTS MODULE — unified with internal tab bar -->
      <div class="module" id="mod-review">

        <!-- Sub-module tab bar -->
        <div class="docs-mod-tabs">
          <button class="docs-mod-tab active" onclick="docsTab('review',this)" style="padding-left:28px;">Review</button>
          <button class="docs-mod-tab" onclick="docsTab('compare',this)">Compare</button>
          <button class="docs-mod-tab" onclick="docsTab('draft',this)">Draft</button>
          <button class="docs-mod-tab" onclick="docsTab('summarise',this)">Summarise</button>
          <button class="docs-mod-tab" onclick="docsTab('translate',this)">Translate</button>
          <button class="docs-mod-tab docs-tab-anon" onclick="docsTab('anonymise',this)">Anonymise</button>
        </div>

        <!-- OCR warning banner (hidden by default) -->
        <div class="docs-ocr-banner" id="docs-ocr-banner" style="display:none;">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Scanned document detected — text was extracted via OCR. Accuracy may vary for poor-quality scans.
        </div>

        <!-- ══ REVIEW ══════════════════════════════════════════ -->
        <div class="docs-tab-content active" id="dtab-review">
          <div class="docs-layout">
            <div class="docs-left">
              <!-- Upload -->
              <div class="docs-upload-zone" onclick="document.getElementById('review-file').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'review-file',this)">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <div class="docs-upload-text">Upload document to review</div>
                <div class="docs-upload-sub">PDF or Word · Scanned PDFs supported via OCR</div>
              </div>
              <input type="file" id="review-file" accept=".pdf,.docx" style="display:none" onchange="docsShowFile('review-file','review-fname')">
              <div class="docs-fname" id="review-fname" style="display:none"></div>

              <!-- For whom -->
              <div class="docs-field-label">FOR WHOM</div>
              <div class="docs-audience" id="review-audience">
                <div class="docs-aud-card active" onclick="docsAudience(this,'review-audience')">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>Myself
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'review-audience')">
                  <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>Board
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'review-audience')">
                  <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Management
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'review-audience')">
                  <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>Other party
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'review-audience')">
                  <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>File record
                </div>
              </div>

              <!-- Focus areas -->
              <div class="docs-field-label">FOCUS AREAS — SELECT ALL THAT APPLY</div>
              <div class="docs-chips" id="review-tags">
                <div class="docs-chip active" onclick="docsChip(this)">GDPR</div>
                <div class="docs-chip active" onclick="docsChip(this)">EU AI Act</div>
                <div class="docs-chip" onclick="docsChip(this)">NIS2</div>
                <div class="docs-chip" onclick="docsChip(this)">WVV</div>
                <div class="docs-chip" onclick="docsChip(this)">DSA</div>
                <div class="docs-chip" onclick="docsChip(this)">eIDAS 2.0</div>
                <div class="docs-chip" onclick="docsChip(this)">Liability</div>
                <div class="docs-chip" onclick="docsChip(this)">IP</div>
              </div>

              <!-- Playbook + instructions -->
              <div class="docs-field-label">APPLY PLAYBOOK</div>
              <select class="docs-select" id="review-pb">
                <option value="">None</option>
                <option>AI Act Compliance</option>
                <option>GDPR + DPA Standard</option>
                <option>Freelance Services (Belgian)</option>
                <option>M&amp;A Due Diligence (WVV)</option>
              </select>

              <div class="docs-field-label">ADDITIONAL INSTRUCTIONS</div>
              <textarea class="docs-textarea" id="review-extra" placeholder="e.g. Focus on limitation of liability and IP ownership clauses…"></textarea>

              <button class="docs-run-btn" onclick="docsRunReview()">
                <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                Run Review
              </button>
            </div>
            <div class="docs-right" id="review-result-panel">
              <div class="docs-result-empty">
                <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Upload a document and click Run Review
              </div>
            </div>
          </div>
        </div>

        <!-- ══ COMPARE ═════════════════════════════════════════ -->
        <div class="docs-tab-content" id="dtab-compare">
          <div class="docs-layout">
            <div class="docs-left">
              <!-- Mode selector -->
              <div class="docs-field-label">COMPARE AGAINST</div>
              <div class="docs-mode-grid" id="cmp-mode-grid">
                <div class="docs-mode-card active" data-mode="draft" onclick="docsCmpMode(this)">
                  <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                  <div class="docs-mode-label">Own draft</div>
                  <div class="docs-mode-sub">Compare two versions</div>
                </div>
                <div class="docs-mode-card" data-mode="playbook" onclick="docsCmpMode(this)">
                  <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                  <div class="docs-mode-label">Your playbook</div>
                  <div class="docs-mode-sub">Check against rules</div>
                </div>
                <div class="docs-mode-card" data-mode="contracts" onclick="docsCmpMode(this)">
                  <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                  <div class="docs-mode-label">Signed contracts</div>
                  <div class="docs-mode-sub">Your precedent library</div>
                </div>
                <div class="docs-mode-card" data-mode="market" onclick="docsCmpMode(this)">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                  <div class="docs-mode-label">Market standard</div>
                  <div class="docs-mode-sub">Mickey's knowledge</div>
                </div>
              </div>

              <!-- Primary upload -->
              <div class="docs-upload-zone" style="margin-top:12px;" onclick="document.getElementById('cmp-file').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'cmp-file',this)">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <div class="docs-upload-text">Upload your document</div>
                <div class="docs-upload-sub">PDF or Word</div>
              </div>
              <input type="file" id="cmp-file" accept=".pdf,.docx" style="display:none" onchange="docsShowFile('cmp-file','cmp-fname')">
              <div class="docs-fname" id="cmp-fname" style="display:none"></div>

              <!-- Second upload (draft mode only) -->
              <div id="cmp-file2-zone" style="margin-top:8px;">
                <div class="docs-upload-zone docs-upload-zone-secondary" onclick="document.getElementById('cmp-file2').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'cmp-file2',this)">
                  <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  <div class="docs-upload-text">Upload reference document</div>
                  <div class="docs-upload-sub">The version to compare against</div>
                </div>
                <input type="file" id="cmp-file2" accept=".pdf,.docx" style="display:none" onchange="docsShowFile('cmp-file2','cmp-fname2')">
                <div class="docs-fname" id="cmp-fname2" style="display:none"></div>
              </div>

              <!-- Playbook select (playbook mode only) -->
              <div id="cmp-playbook-zone" style="display:none;margin-top:8px;">
                <div class="docs-field-label">PLAYBOOK</div>
                <select class="docs-select" id="cmp-playbook">
                  <option>AI Act Compliance</option>
                  <option>GDPR + DPA Standard</option>
                  <option>Freelance Services (Belgian)</option>
                  <option>M&amp;A Due Diligence (WVV)</option>
                </select>
              </div>

              <div class="docs-field-label" style="margin-top:12px;">FOCUS AREAS</div>
              <div class="docs-chips" id="cmp-tags">
                <div class="docs-chip active" onclick="docsChip(this)">All clauses</div>
                <div class="docs-chip" onclick="docsChip(this)">Liability</div>
                <div class="docs-chip" onclick="docsChip(this)">IP</div>
                <div class="docs-chip" onclick="docsChip(this)">Data protection</div>
                <div class="docs-chip" onclick="docsChip(this)">Termination</div>
                <div class="docs-chip" onclick="docsChip(this)">Payment</div>
              </div>

              <button class="docs-run-btn" onclick="docsRunCompare()">
                <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                Run Comparison
              </button>
            </div>
            <div class="docs-right" id="compare-result-panel">
              <div class="docs-result-empty">
                <svg viewBox="0 0 24 24"><rect x="2" y="3" width="9" height="18" rx="1"/><rect x="13" y="3" width="9" height="18" rx="1"/></svg>
                Upload a document and choose a comparison mode
              </div>
            </div>
          </div>
        </div>

        <!-- ══ DRAFT ════════════════════════════════════════════ -->
        <div class="docs-tab-content" id="dtab-draft">
          <div class="docs-layout">
            <div class="docs-left">
              <!-- Mode -->
              <div class="docs-field-label">MODE</div>
              <div class="docs-seg" id="draft-mode-seg">
                <button class="docs-seg-btn active" onclick="docsDraftMode('new',this)">New document</button>
                <button class="docs-seg-btn" onclick="docsDraftMode('improve',this)">Improve clause</button>
                <button class="docs-seg-btn" onclick="docsDraftMode('counter',this)">Counter-proposal</button>
              </div>

              <!-- Upload zone (improve/counter modes) -->
              <div id="draft-upload-zone" style="display:none;margin-top:12px;">
                <div class="docs-upload-zone docs-upload-zone-secondary" onclick="document.getElementById('draft-file').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'draft-file',this)">
                  <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  <div class="docs-upload-text" id="draft-upload-label">Upload clause to improve</div>
                  <div class="docs-upload-sub">PDF or Word</div>
                </div>
                <input type="file" id="draft-file" accept=".pdf,.docx" style="display:none" onchange="docsShowFile('draft-file','draft-fname')">
                <div class="docs-fname" id="draft-fname" style="display:none"></div>
              </div>

              <div class="docs-field-label" style="margin-top:12px;">DOCUMENT TYPE</div>
              <select class="docs-select" id="draft-type">
                <option>Contract clause</option>
                <option>Full agreement</option>
                <option>Legal memo</option>
                <option>Board resolution</option>
                <option>Regulatory checklist</option>
                <option>Legal opinion</option>
                <option>NDA</option>
                <option>Data Processing Agreement</option>
              </select>

              <div class="docs-field-label">CLAUSE / TOPIC</div>
              <input class="docs-input" type="text" id="draft-clause" placeholder="e.g. Limitation of liability, IP ownership, Change of control…">

              <div class="docs-field-row">
                <div style="flex:1">
                  <div class="docs-field-label">GOVERNING LAW</div>
                  <select class="docs-select" id="draft-law">
                    <option>Belgian law</option>
                    <option>English law</option>
                    <option>French law</option>
                    <option>Dutch law</option>
                    <option>Luxembourg law</option>
                  </select>
                </div>
                <div style="flex:1">
                  <div class="docs-field-label">PERSPECTIVE</div>
                  <select class="docs-select" id="draft-persp">
                    <option>Service provider</option>
                    <option>Client</option>
                    <option>Neutral / balanced</option>
                    <option>Seller</option>
                    <option>Buyer</option>
                  </select>
                </div>
              </div>

              <div class="docs-field-label">ADDITIONAL INSTRUCTIONS</div>
              <textarea class="docs-textarea" id="draft-inst" placeholder="e.g. Include AI Act Art. 25 obligations, 30-day sub-processor notice, cap at 12 months fees…"></textarea>

              <button class="docs-run-btn" onclick="docsRunDraft()">
                <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                Generate with Mickey
              </button>
            </div>
            <div class="docs-right" id="draft-result-panel">
              <div class="docs-result-empty">
                <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                Configure on the left and click Generate
              </div>
            </div>
          </div>
        </div>

        <!-- ══ SUMMARISE ════════════════════════════════════════ -->
        <div class="docs-tab-content" id="dtab-summarise">
          <div class="docs-layout">
            <div class="docs-left">
              <div class="docs-upload-zone" onclick="document.getElementById('sum-file').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'sum-file',this)">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <div class="docs-upload-text">Upload document to summarise</div>
                <div class="docs-upload-sub">Commercial contract · M&amp;A · Employment · Board minutes · Regulatory text · Any legal document</div>
              </div>
              <input type="file" id="sum-file" accept=".pdf,.docx" style="display:none" onchange="docsShowFile('sum-file','sum-fname')">
              <div class="docs-fname" id="sum-fname" style="display:none"></div>

              <div class="docs-field-label">FOR WHOM</div>
              <div class="docs-audience" id="sum-audience">
                <div class="docs-aud-card active" onclick="docsAudience(this,'sum-audience')">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>Myself
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'sum-audience')">
                  <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>Board
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'sum-audience')">
                  <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Management
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'sum-audience')">
                  <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>Other party
                </div>
                <div class="docs-aud-card" onclick="docsAudience(this,'sum-audience')">
                  <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>File record
                </div>
              </div>

              <div class="docs-field-label">OUTPUT FORMAT</div>
              <div class="docs-seg" id="sum-format-seg">
                <button class="docs-seg-btn active" onclick="docsSegSelect(this,'sum-format-seg')">Structured</button>
                <button class="docs-seg-btn" onclick="docsSegSelect(this,'sum-format-seg')">Executive</button>
                <button class="docs-seg-btn" onclick="docsSegSelect(this,'sum-format-seg')">Bullet points</button>
                <button class="docs-seg-btn" onclick="docsSegSelect(this,'sum-format-seg')">Table</button>
              </div>

              <div class="docs-field-label">FOCUS AREAS (OPTIONAL)</div>
              <input class="docs-input" type="text" id="sum-focus" placeholder="e.g. obligations, key dates, liability…">

              <button class="docs-run-btn" onclick="docsRunSummarise()">
                <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                Summarise
              </button>
            </div>
            <div class="docs-right" id="summarise-result-panel">
              <div class="docs-result-empty">
                <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                Upload a document and click Summarise
              </div>
            </div>
          </div>
        </div>

        <!-- ══ TRANSLATE ════════════════════════════════════════ -->
        <div class="docs-tab-content" id="dtab-translate">
          <div class="docs-layout">
            <div class="docs-left">
              <div class="docs-upload-zone" onclick="document.getElementById('trans-file').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'trans-file',this)">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <div class="docs-upload-text">Upload document to translate</div>
                <div class="docs-upload-sub">PDF or Word · Legal structure and numbering preserved</div>
              </div>
              <input type="file" id="trans-file" accept=".pdf,.docx" style="display:none" onchange="docsShowFile('trans-file','trans-fname')">
              <div class="docs-fname" id="trans-fname" style="display:none"></div>

              <div class="docs-field-row" style="margin-top:12px;">
                <div style="flex:1">
                  <div class="docs-field-label">FROM</div>
                  <select class="docs-select" id="trans-src">
                    <option>Dutch (NL)</option>
                    <option>French (FR)</option>
                    <option>English (EN)</option>
                    <option>German (DE)</option>
                    <option>Italian (IT)</option>
                    <option>Spanish (ES)</option>
                    <option>Portuguese (PT)</option>
                  </select>
                </div>
                <div style="flex:1">
                  <div class="docs-field-label">TO</div>
                  <select class="docs-select" id="trans-tgt">
                    <option>English (EN)</option>
                    <option>French (FR)</option>
                    <option>Dutch (NL)</option>
                    <option>German (DE)</option>
                    <option>Italian (IT)</option>
                    <option>Spanish (ES)</option>
                  </select>
                </div>
              </div>

              <div class="docs-field-label">TRANSLATION STYLE</div>
              <div class="docs-seg" id="trans-style-seg">
                <button class="docs-seg-btn active" onclick="docsSegSelect(this,'trans-style-seg')">Legal / formal</button>
                <button class="docs-seg-btn" onclick="docsSegSelect(this,'trans-style-seg')">Plain language</button>
                <button class="docs-seg-btn" onclick="docsSegSelect(this,'trans-style-seg')">Simplified</button>
              </div>

              <div class="docs-field-label">NOTES</div>
              <textarea class="docs-textarea" id="trans-notes" placeholder="e.g. Preserve article numbering, use UK English for EN, keep Dutch defined terms…"></textarea>

              <button class="docs-run-btn" onclick="docsRunTranslate()">
                <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                Translate
              </button>
            </div>
            <div class="docs-right" id="translate-result-panel">
              <div class="docs-result-empty">
                <svg viewBox="0 0 24 24"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                Upload a document and click Translate
              </div>
            </div>
          </div>
        </div>

        <!-- ══ ANONYMISE ════════════════════════════════════════ -->
        <div class="docs-tab-content" id="dtab-anonymise">
          <div class="docs-layout">
            <div class="docs-left">
              <div class="docs-upload-zone" onclick="document.getElementById('anon-file').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'anon-file',this)">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <div class="docs-upload-text">Upload document to anonymise</div>
                <div class="docs-upload-sub">Names · Addresses · KBO numbers · IBANs · Emails · Phone numbers</div>
              </div>
              <input type="file" id="anon-file" accept=".pdf,.docx" style="display:none" onchange="docsShowFile('anon-file','anon-fname')">
              <div class="docs-fname" id="anon-fname" style="display:none"></div>

              <div class="docs-field-label">DOMAIN PRESET</div>
              <div class="docs-mode-grid docs-mode-grid-4" id="anon-preset-grid">
                <div class="docs-mode-card active" data-preset="" onclick="docsAnonPreset(this)">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  <div class="docs-mode-label">Standard</div>
                  <div class="docs-mode-sub">Names, addresses, IDs</div>
                </div>
                <div class="docs-mode-card" data-preset="commercial" onclick="docsAnonPreset(this)">
                  <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                  <div class="docs-mode-label">Commercial</div>
                  <div class="docs-mode-sub">+ Prices, products</div>
                </div>
                <div class="docs-mode-card" data-preset="manda" onclick="docsAnonPreset(this)">
                  <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                  <div class="docs-mode-label">M&amp;A</div>
                  <div class="docs-mode-sub">+ Valuations, advisors</div>
                </div>
                <div class="docs-mode-card" data-preset="employment" onclick="docsAnonPreset(this)">
                  <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                  <div class="docs-mode-label">Employment</div>
                  <div class="docs-mode-sub">+ Salary, HR data</div>
                </div>
              </div>

              <div class="docs-field-label">CUSTOM FIELDS</div>
              <div id="anon-custom-list"></div>
              <button class="docs-add-btn" onclick="docsAddCustomField()">
                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add custom replacement
              </button>

              <div class="docs-field-label" style="margin-top:12px;">OPTIONS</div>
              <label class="docs-checkbox-row">
                <input type="checkbox" id="anon-include-map" checked>
                <span>Generate redaction map</span>
              </label>

              <button class="docs-run-btn docs-run-btn-purple" onclick="docsRunAnonymise()">
                <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                Anonymise document
              </button>
            </div>
            <div class="docs-right" id="anonymise-result-panel">
              <div class="docs-result-empty">
                <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                Upload a document and click Anonymise
              </div>
            </div>
          </div>
        </div>

      </div><!-- /mod-review (Documents module) -->

      <!-- CORPORATE HOUSEKEEPING -->
      <div class="module" id="mod-vault">
        <!-- Sub-module tabs -->
        <div class="corp-mod-tabs">
          <button class="corp-mod-tab active" onclick="corpTab('housekeeping',this)" style="padding-left:28px;">Housekeeping</button>
          <button class="corp-mod-tab corp-mod-soon" title="Coming soon">Board &amp; Minutes</button>
          <button class="corp-mod-tab corp-mod-soon" title="Coming soon">Due Diligence</button>
        </div>
        <div id="corp-housekeeping" class="ch-layout">

          <!-- ── LEFT: Entity list ── -->
          <div class="ch-panel">
            <div class="ch-panel-head">
              <div class="ch-search">
                <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" placeholder="Search entities…" id="ch-search-input" oninput="chFilterEntities(this.value)">
              </div>
              <div class="ch-filter-pills" id="ch-filter-pills">
                <button class="ch-fpill active" onclick="chSetFilter('all',this)">All</button>
                <button class="ch-fpill" onclick="chSetFilter('alert',this)">Alerts</button>
                <button class="ch-fpill" onclick="chSetFilter('be',this)">Belgium</button>
                <button class="ch-fpill" onclick="chSetFilter('de',this)">Germany</button>
              </div>
            </div>
            <div class="ch-list" id="ch-entity-list">
              <div style="padding:20px;text-align:center;color:var(--text-faint);font-size:12px;font-style:italic;">Loading entities…</div>
            </div>
            <div class="ch-add-btn" onclick="chOpenNewEntity()">
              <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add entity
            </div>
          </div>

          <!-- ── RIGHT: Entity detail ── -->
          <div class="ch-detail" id="ch-detail">
            <div class="ch-empty" id="ch-empty">
              <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
              <p>Select an entity to view its corporate file</p>
            </div>

            <!-- Entity header (hidden until entity selected) -->
            <div id="ch-entity-view" style="display:none;flex:1;display:none;flex-direction:column;overflow:hidden;">
              <div class="ch-header">
                <div class="ch-flag" id="ch-flag">🏢</div>
                <div class="ch-title">
                  <h1 id="ch-entity-name">—</h1>
                  <div class="ch-badges" id="ch-entity-badges"></div>
                </div>
                <div class="ch-actions">
                  <button class="btn btn-sm" onclick="chAskMickeyFocus()">Ask Mickey</button>
                  <button class="btn btn-sm btn-primary" onclick="chOpenEditEntity()">Edit</button>
                </div>
              </div>

              <!-- Alert strip — shown only when entity has alerts -->
              <div class="ch-alert-strip" id="ch-alert-strip" style="display:none;"></div>

              <!-- Tabs -->
              <div class="ch-tabs" id="ch-tabs">
                <button class="ch-tab active" onclick="chTab('overview',this)">Overview</button>
                <button class="ch-tab" onclick="chTab('identity',this)">Identity</button>
                <button class="ch-tab" onclick="chTab('capital',this)">Capital &amp; Shares</button>
                <button class="ch-tab" onclick="chTab('governance',this)" id="ch-tab-gov">Governance</button>
                <button class="ch-tab" onclick="chTab('poa',this)">Powers of Attorney</button>
                <button class="ch-tab" onclick="chTab('compliance',this)" id="ch-tab-comp">Compliance</button>
                <button class="ch-tab" onclick="chTab('history',this)">History</button>
                <button class="ch-tab" onclick="chTab('documents',this)">Documents</button>
              </div>

              <!-- Tab content container -->
              <div class="ch-content" id="ch-tab-content">
                <!-- Overview -->
                <div id="cht-overview">
                  <div class="ch-mickey">
                    <div class="ch-mickey-label">Ask Mickey about this entity</div>
                    <div class="ch-mickey-row">
                      <input class="ch-mickey-input" type="text" id="ch-mickey-q" placeholder="Which director mandates expire in the next 90 days?" onkeydown="if(event.key==='Enter')chAskEntity()">
                      <button class="ch-mickey-btn" onclick="chAskEntity()">Ask →</button>
                    </div>
                    <div class="ch-sugs" id="ch-sugs">
                      <div class="ch-sug" onclick="chSugAsk(this)">Draft board resolution to renew director mandate</div>
                      <div class="ch-sug" onclick="chSugAsk(this)">Summarise governance structure</div>
                      <div class="ch-sug" onclick="chSugAsk(this)">UBO filing obligations for this entity</div>
                      <div class="ch-sug" onclick="chSugAsk(this)">Generate AGM convening notice</div>
                    </div>
                    <div class="ch-mickey-result" id="ch-mickey-result"></div>
                  </div>
                  <div class="ch-cards" id="ch-overview-cards"></div>
                  <div class="ch-section" id="ch-deadlines-section">
                    <div class="ch-section-head"><h3>Upcoming deadlines &amp; alerts</h3></div>
                    <div class="ch-section-body np" id="ch-deadlines-body"><div style="padding:16px;color:var(--text-faint);font-size:12px;font-style:italic;">No deadlines recorded.</div></div>
                  </div>
                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Key data</h3><button class="btn btn-sm" style="font-size:10px;padding:4px 10px;" onclick="chTab('identity',document.querySelector('.ch-tab:nth-child(2)'))">View full identity →</button></div>
                    <div class="ch-section-body"><div class="fg fg-3" id="ch-overview-key"></div></div>
                  </div>
                </div>

                <!-- Identity -->
                <div id="cht-identity" style="display:none">
                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Corporate identity</h3></div>
                    <div class="ch-section-body">
                      <div class="fg fg-2" style="margin-bottom:14px;">
                        <div class="cf-group s2"><label>Full legal name</label><input type="text" id="fi-name"></div>
                        <div class="cf-group"><label>Trade / commercial name</label><input type="text" id="fi-trade-name"></div>
                        <div class="cf-group"><label>Previous names</label><input type="text" id="fi-prev-names" placeholder="e.g. Mickey Holdings BV (until 2024)"></div>
                        <div class="cf-group"><label>Legal form</label>
                          <select id="fi-legal-form">
                            <option>NV — Naamloze Vennootschap</option><option>BV — Besloten Vennootschap</option>
                            <option>SA — Société Anonyme</option><option>SRL — Société à Resp. Limitée</option>
                            <option>GmbH</option><option>Ltd</option><option>LLC</option><option>SAS</option>
                            <option>BV (NL)</option><option>D.O.O.</option><option>AB</option><option>Oy</option>
                          </select>
                        </div>
                        <div class="cf-group"><label>Jurisdiction</label>
                          <select id="fi-jurisdiction" onchange="chUpdateCompanyNumLabel()">
                            <option>Belgium</option><option>Netherlands</option><option>Germany</option>
                            <option>France</option><option>Luxembourg</option><option>Serbia</option>
                            <option>United Kingdom</option><option>Other</option>
                          </select>
                        </div>
                        <div class="cf-group"><label>Status</label>
                          <select id="fi-status"><option>active</option><option>dormant</option><option>in_liquidation</option><option>dissolved</option></select>
                        </div>
                        <div class="cf-group"><label>Listed</label>
                          <select id="fi-listed"><option value="false">Unlisted</option><option value="true">Listed (Euronext / other)</option></select>
                        </div>
                      </div>
                      <div class="fg fg-3" style="margin-bottom:14px;">
                        <div class="cf-group"><label id="fi-reg-number-label">Company number (KBO/BCE)</label>
                          <div class="cf-prefix"><span class="cf-prefix-text">BE</span><input type="text" id="fi-reg-number" placeholder="0123.456.789"></div>
                        </div>
                        <div class="cf-group"><label>VAT number</label>
                          <div class="cf-prefix"><span class="cf-prefix-text">BE</span><input type="text" id="fi-vat-number" placeholder="0123.456.789"></div>
                        </div>
                        <div class="cf-group"><label>LEI code</label><input type="text" id="fi-lei-code" placeholder="20-char LEI" style="font-family:var(--font-mono);font-size:11.5px;"></div>
                        <div class="cf-group"><label>Court of registration (RPR)</label><input type="text" id="fi-court" placeholder="RPR Leuven"></div>
                        <div class="cf-group"><label>Incorporation date</label><input type="date" id="fi-inc-date"></div>
                        <div class="cf-group"><label>Duration</label>
                          <select id="fi-duration"><option>Unlimited</option><option>Fixed term</option></select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Registered office</h3></div>
                    <div class="ch-section-body">
                      <div class="fg fg-2">
                        <div class="cf-group s2"><label>Street + number</label><input type="text" id="fi-street"></div>
                        <div class="cf-group"><label>Postal code</label><input type="text" id="fi-postcode"></div>
                        <div class="cf-group"><label>City</label><input type="text" id="fi-city"></div>
                        <div class="cf-group"><label>Country</label>
                          <select id="fi-country"><option>Belgium</option><option>Netherlands</option><option>Germany</option><option>France</option><option>Luxembourg</option><option>Serbia</option><option>United Kingdom</option></select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Financial year &amp; AGM</h3></div>
                    <div class="ch-section-body">
                      <div class="fg fg-4">
                        <div class="cf-group"><label>Financial year end</label><input type="text" id="fi-fy-end" placeholder="31 December"></div>
                        <div class="cf-group"><label>AGM statutory date rule</label><input type="text" id="fi-agm-rule" placeholder="Second Tuesday of June"></div>
                        <div class="cf-group"><label>AGM notice period (days)</label><input type="number" id="fi-agm-notice" value="30"></div>
                        <div class="cf-group"><label>Statutory auditor</label>
                          <div style="display:flex;flex-direction:column;gap:5px;">
                            <div style="display:flex;align-items:center;gap:6px;">
                              <input type="checkbox" id="fi-auditor-na" onchange="chToggleAuditorFields()" style="accent-color:var(--green);width:13px;height:13px;cursor:pointer;flex-shrink:0;">
                              <label for="fi-auditor-na" style="font-size:11.5px;color:var(--text-mid);text-transform:none;letter-spacing:0;font-weight:400;cursor:pointer;margin:0;">N/A — no statutory auditor</label>
                            </div>
                            <input type="text" id="fi-auditor-firm" placeholder="Auditor firm name" style="display:block;" oninput="chToggleAuditorFields()">
                          </div>
                        </div>
                      </div>
                      <div id="fi-auditor-detail-fields" style="display:none;">
                        <div class="fg fg-3" style="margin-top:12px;">
                          <div class="cf-group"><label>Audit partner</label><input type="text" id="fi-auditor-partner"></div>
                          <div class="cf-group"><label>Auditor IRE/IBR number</label><input type="text" id="fi-auditor-ire" style="font-family:var(--font-mono);font-size:11.5px;"></div>
                          <div class="cf-group"><label>Auditor mandate end</label><input type="date" id="fi-auditor-end"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Extract from articles of association</h3></div>
                    <div class="ch-section-body">
                      <div class="ch-info-box" style="margin-bottom:12px;">📄 Upload the bylaws / articles of association and Mickey will extract key corporate data automatically — legal name, registered office, share capital, governance rules, AGM date, auditor, and more.</div>
                      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
                        <div style="flex:1;min-width:220px;">
                          <div class="cf-group" style="margin-bottom:0;">
                            <label>Articles of association (PDF or DOCX)</label>
                            <input type="file" id="fi-aoa-file" accept=".pdf,.docx" style="width:100%;padding:6px;border:1px solid var(--cream-dark);border-radius:var(--r);font-size:12px;background:var(--cream);">
                          </div>
                        </div>
                        <button class="btn btn-primary" onclick="chExtractFromAoA()" style="flex-shrink:0;white-space:nowrap;">✦ Extract with Mickey</button>
                      </div>
                      <div id="fi-aoa-result" style="display:none;margin-top:12px;background:var(--green);color:#fff;border-radius:var(--r);padding:13px 16px;font-size:12.5px;line-height:1.6;"></div>
                    </div>
                  </div>

                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Notes</h3></div>
                    <div class="ch-section-body">
                      <textarea id="fi-notes" style="width:100%;min-height:80px;padding:8px 10px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:12.5px;background:var(--cream);outline:none;resize:vertical;" placeholder="Additional notes on this entity…"></textarea>
                    </div>
                  </div>

                  <div style="display:flex;justify-content:flex-end;gap:8px;padding-bottom:8px;">
                    <button class="btn" onclick="chLoadIdentityFields()">Discard</button>
                    <button class="btn btn-primary" onclick="chSaveIdentity()">Save changes</button>
                  </div>
                </div>

                <!-- Capital & Shares -->
                <div id="cht-capital" style="display:none">
                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Share capital</h3></div>
                    <div class="ch-section-body">
                      <div class="fg fg-4">
                        <div class="cf-group"><label>Share capital</label>
                          <div class="cf-prefix"><span class="cf-prefix-text" id="fc-currency-label">EUR</span><input type="text" id="fc-capital"></div>
                        </div>
                        <div class="cf-group"><label>Currency</label><select id="fc-currency"><option>EUR</option><option>USD</option><option>GBP</option><option>CHF</option></select></div>
                        <div class="cf-group"><label>Total shares issued</label><input type="text" id="fc-shares" style="font-family:var(--font-mono);font-size:11.5px;"></div>
                        <div class="cf-group"><label>Nominal value</label><select id="fc-nominal"><option>No par value</option><option>Par value</option></select></div>
                      </div>
                    </div>
                  </div>

                  <div class="ch-section">
                    <div class="ch-section-head">
                      <h3>Share register</h3>
                      <button class="btn btn-sm" onclick="chOpenAddShareholder()">+ Add shareholder</button>
                    </div>
                    <div class="ch-section-body np">
                      <table class="sh-table">
                        <thead><tr><th>Shareholder</th><th>Type</th><th>Shares</th><th>%</th><th>Since</th><th>Encumbrance</th><th></th></tr></thead>
                        <tbody id="ch-shareholders-body"><tr><td colspan="7" style="text-align:center;color:var(--text-faint);font-style:italic;padding:16px;">No shareholders recorded</td></tr></tbody>
                      </table>
                    </div>
                  </div>

                  <div class="ch-section">
                    <div class="ch-section-head">
                      <h3>UBO Register</h3>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span id="ch-ubo-alert" style="display:none;font-size:11px;color:var(--red);font-weight:500;">⚠ Confirmation overdue</span>
                      </div>
                    </div>
                    <div class="ch-section-body np" id="ch-ubo-body">
                      <div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">UBOs are derived from shareholders marked as beneficial owners (≥25% or control).</div>
                    </div>
                  </div>
                </div>

                <!-- Governance -->
                <div id="cht-governance" style="display:none">
                  <div class="ch-section">
                    <div class="ch-section-head">
                      <h3>Board of Directors</h3>
                      <button class="btn btn-sm" onclick="chOpenAddDirector()">+ Add director</button>
                    </div>
                    <div class="ch-section-body np">
                      <div class="ch-person-head">
                        <span></span><span>Name / Representative</span><span>Role</span><span>Appointed</span><span>Mandate end</span><span>Status</span>
                      </div>
                      <div id="ch-directors-body">
                        <div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No directors recorded.</div>
                      </div>
                      <div class="ch-add-row" onclick="chOpenAddDirector()">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add director
                      </div>
                    </div>
                  </div>

                  <div class="ch-section">
                    <div class="ch-section-head"><h3>Governance settings</h3></div>
                    <div class="ch-section-body">
                      <div class="fg fg-3">
                        <div class="cf-group"><label>Board model</label><select id="fg-model"><option>One-tier (Board of Directors)</option><option>Two-tier (Supervisory + Management)</option></select></div>
                        <div class="cf-group"><label>Signature rule</label><select id="fg-sig"><option>Joint (2 directors)</option><option>Sole (any director)</option><option>As per board resolution</option></select></div>
                        <div class="cf-group"><label>Daily management delegate</label><input type="text" id="fg-ceo" placeholder="e.g. CEO — Claude Verbrugge"></div>
                        <div class="cf-group"><label>Min. directors</label><input type="number" id="fg-min-dir" value="1"></div>
                        <div class="cf-group"><label>Max. directors</label><input type="number" id="fg-max-dir" value="12"></div>
                        <div class="cf-group"><label>Quorum rule</label><input type="text" id="fg-quorum" placeholder="Majority present or represented"></div>
                      </div>
                      <div style="display:flex;justify-content:flex-end;margin-top:12px;">
                        <button class="btn btn-primary btn-sm" onclick="chSaveGovernance()">Save governance settings</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Powers of Attorney -->
                <div id="cht-poa" style="display:none">
                  <div class="ch-section">
                    <div class="ch-section-head">
                      <h3>Powers of attorney &amp; delegations</h3>
                      <button class="btn btn-sm btn-primary" onclick="chOpenAddPOA()">+ New POA</button>
                    </div>
                    <div class="ch-section-body np" id="ch-poa-body">
                      <div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No powers of attorney recorded.</div>
                    </div>
                  </div>
                </div>

                <!-- Compliance -->
                <div id="cht-compliance" style="display:none">
                  <div class="ch-section">
                    <div class="ch-section-head">
                      <h3>Annual filings &amp; compliance</h3>
                      <button class="btn btn-sm" onclick="chOpenAddCompliance()">+ Add obligation</button>
                    </div>
                    <div class="ch-section-body np">
                      <table class="comp-table">
                        <thead><tr><th>Obligation</th><th>Period</th><th>Authority</th><th>Deadline</th><th>Filed</th><th>Status</th><th></th></tr></thead>
                        <tbody id="ch-compliance-body"><tr><td colspan="7" style="text-align:center;color:var(--text-faint);font-style:italic;padding:16px;">No compliance obligations recorded</td></tr></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- History -->
                <div id="cht-history" style="display:none">
                  <div class="ch-section">
                    <div class="ch-section-head">
                      <h3>Corporate history log</h3>
                      <button class="btn btn-sm" onclick="chOpenAddHistory()">+ Manual entry</button>
                    </div>
                    <div class="ch-section-body np" id="ch-history-body">
                      <div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No history recorded.</div>
                    </div>
                  </div>
                </div>

                <!-- Documents -->
                <div id="cht-documents" style="display:none">
                  <div class="ch-section">
                    <div class="ch-section-head">
                      <h3>Corporate documents</h3>
                      <button class="btn btn-sm btn-primary" onclick="chOpenUploadDoc()">+ Upload</button>
                    </div>
                    <div class="ch-section-body np" style="display:flex;min-height:360px;">
                      <div class="ch-doc-cat">
                        <div style="padding:8px 12px 4px;font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text-faint);">Categories</div>
                        <div class="ch-doc-cat-item active" onclick="chFilterDocs('all',this)">All documents</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('constitutional',this)">Constitutional</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('resolutions',this)">Resolutions</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('agm_minutes',this)">AGM minutes</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('share_register',this)">Share register</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('poa',this)">POA</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('regulatory',this)">Regulatory</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('agreements',this)">Agreements</div>
                        <div class="ch-doc-cat-item" onclick="chFilterDocs('other',this)">Other</div>
                      </div>
                      <div style="flex:1;overflow-y:auto;" id="ch-doc-body">
                        <div style="padding:20px;text-align:center;color:var(--text-faint);font-size:12px;font-style:italic;">No documents yet. Upload your first document above.</div>
                      </div>
                    </div>
                  </div>
                </div>

              </div><!-- /ch-tab-content -->
            </div><!-- /ch-entity-view -->
          </div><!-- /ch-detail -->

        </div><!-- /ch-layout -->

        <!-- ── MODALS ── -->

        <!-- New / Edit entity modal -->
        <div class="ch-modal" id="ch-modal-entity" style="display:none;" onclick="if(event.target===this)chCloseModal('ch-modal-entity')">
          <div class="ch-modal-box">
            <div class="ch-modal-head">
              <h2 id="ch-modal-entity-title">New entity</h2>
              <div class="ch-modal-close" onclick="chCloseModal('ch-modal-entity')">✕</div>
            </div>
            <div class="ch-modal-body">
              <div class="fg fg-2">
                <div class="cf-group s2"><label>Full legal name *</label><input type="text" id="cm-name" placeholder="e.g. MickeyLaw BV"></div>
                <div class="cf-group"><label>Legal form</label>
                  <select id="cm-legal-form">
                    <option>NV — Naamloze Vennootschap</option><option>BV — Besloten Vennootschap</option>
                    <option>SA — Société Anonyme</option><option>SRL — Société à Resp. Limitée</option><option>CV — Coöperatieve Vennootschap</option>
                    <option>GmbH</option><option>Ltd</option><option>LLC</option><option>BV (NL)</option><option>D.O.O.</option><option>SAS</option><option>AB</option><option>Oy</option>
                  </select>
                </div>
                <div class="cf-group"><label>Jurisdiction</label>
                  <select id="cm-jurisdiction" onchange="chUpdateCompanyNumLabel()">
                    <option>Belgium</option><option>Netherlands</option><option>Luxembourg</option>
                    <option>Germany</option><option>France</option><option>United Kingdom</option><option>Serbia</option><option>Other</option>
                  </select>
                </div>
                <div class="cf-group"><label id="cm-reg-number-label">Company number (KBO/BCE)</label><input type="text" id="cm-reg-number" style="font-family:var(--font-mono);font-size:11.5px;" placeholder="0 123.456.789"></div>
                <div class="cf-group"><label>Incorporation date</label><input type="date" id="cm-inc-date"></div>
                <div class="cf-group"><label>Relationship to portfolio</label>
                  <select id="cm-relationship">
                    <option>100% subsidiary</option><option>Majority subsidiary</option><option>Minority holding</option>
                    <option>Sister entity</option><option>Parent / holding</option><option>Joint venture</option>
                    <option>Management company (standalone)</option><option>Client entity</option><option>Other / standalone</option>
                  </select>
                </div>
                <div class="cf-group"><label>Status</label>
                  <select id="cm-status"><option>active</option><option>dormant</option><option>in_liquidation</option><option>dissolved</option></select>
                </div>
              </div>
            </div>
            <div class="ch-modal-foot">
              <button class="btn" onclick="chCloseModal('ch-modal-entity')">Cancel</button>
              <button class="btn btn-primary" onclick="chSaveEntity()">Create entity</button>
            </div>
          </div>
        </div>

        <!-- Add director modal -->
        <div class="ch-modal" id="ch-modal-director" style="display:none;" onclick="if(event.target===this)chCloseModal('ch-modal-director')">
          <div class="ch-modal-box">
            <div class="ch-modal-head">
              <h2>Add director</h2>
              <div class="ch-modal-close" onclick="chCloseModal('ch-modal-director')">✕</div>
            </div>
            <div class="ch-modal-body">
              <div class="fg fg-2" style="margin-bottom:12px;">
                <div class="cf-group"><label>Director type</label>
                  <select id="cd-type" onchange="chToggleDirType()"><option value="natural_person">Natural person</option><option value="legal_entity">Legal entity (rechtspersoon)</option></select>
                </div>
                <div class="cf-group"><label>Title / Function</label>
                  <select id="cd-role">
                    <optgroup label="Belgium — CommV / VOF">
                      <option>Zaakvoerder / Gérant (CommV/VOF)</option>
                      <option>Beherend vennoot / Associé gérant</option>
                    </optgroup>
                    <optgroup label="Belgium — BV/SRL">
                      <option>Bestuurder / Administrateur (BV)</option>
                      <option>Enig bestuurder / Administrateur unique (BV)</option>
                      <option>Gedelegeerd bestuurder / Administrateur délégué</option>
                      <option>Voorzitter van de raad van bestuur / Président</option>
                    </optgroup>
                    <optgroup label="Belgium — NV/SA (one-tier)">
                      <option>Bestuurder / Administrateur (NV)</option>
                      <option>Enig bestuurder / Administrateur unique (NV)</option>
                      <option>Gedelegeerd bestuurder / Administrateur délégué (NV)</option>
                      <option>Voorzitter raad van bestuur / Président CA (NV)</option>
                    </optgroup>
                    <optgroup label="Belgium — NV/SA (two-tier)">
                      <option>Lid raad van toezicht / Membre conseil de surveillance</option>
                      <option>Voorzitter raad van toezicht / Président conseil de surveillance</option>
                      <option>Lid directieraad / Membre conseil de direction</option>
                      <option>Voorzitter directieraad / Président conseil de direction</option>
                    </optgroup>
                    <optgroup label="Netherlands — BV/NV">
                      <option>Bestuurder / Directeur (NL)</option>
                      <option>Algemeen directeur / CEO (NL)</option>
                      <option>Commissaris (NL)</option>
                    </optgroup>
                    <optgroup label="Luxembourg — SA/SRL">
                      <option>Administrateur (LU)</option>
                      <option>Administrateur-délégué (LU)</option>
                      <option>Gérant (LU SRL)</option>
                    </optgroup>
                    <optgroup label="Germany — GmbH/AG">
                      <option>Geschäftsführer (GmbH)</option>
                      <option>Vorstandsmitglied (AG)</option>
                      <option>Aufsichtsratsmitglied (AG)</option>
                    </optgroup>
                    <optgroup label="France — SAS/SA/SARL">
                      <option>Président (SAS)</option>
                      <option>Directeur Général (SA)</option>
                      <option>Administrateur (SA)</option>
                      <option>Gérant (SARL/SNC)</option>
                    </optgroup>
                    <optgroup label="Serbia — D.O.O./A.D.">
                      <option>Direktor (D.O.O.)</option>
                      <option>Član upravnog odbora (A.D.)</option>
                    </optgroup>
                    <optgroup label="Other">
                      <option>Director (Ltd / LLC)</option>
                      <option>Managing Director</option>
                      <option>Company Secretary</option>
                      <option>Other</option>
                    </optgroup>
                  </select>
                </div>
              </div>
              <div id="cd-person-fields">
                <div class="fg fg-2" style="margin-bottom:12px;">
                  <div class="cf-group"><label>First name</label><input type="text" id="cd-first-name"></div>
                  <div class="cf-group"><label>Last name</label><input type="text" id="cd-last-name"></div>
                  <div class="cf-group"><label>Nationality</label><input type="text" id="cd-nationality"></div>
                  <div class="cf-group s2"><label>Address</label><input type="text" id="cd-address" placeholder="Street, number, postal code, city, country"></div>
                </div>
              </div>
              <div id="cd-entity-fields" style="display:none">
                <div class="fg fg-2" style="margin-bottom:12px;">
                  <div class="cf-group"><label>Legal entity name</label><input type="text" id="cd-entity-name"></div>
                  <div class="cf-group"><label>Permanent representative</label><input type="text" id="cd-representative"></div>
                  <div class="cf-group s2"><label>Address</label><input type="text" id="cd-address-entity"></div>
                </div>
              </div>
              <div class="fg fg-3">
                <div class="cf-group"><label>Appointment date</label><input type="date" id="cd-appoint-date"></div>
                <div class="cf-group">
                  <label>Mandate end date</label>
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                    <input type="checkbox" id="cd-unlimited" onchange="chToggleUnlimited()" style="accent-color:var(--green);width:14px;height:14px;cursor:pointer;">
                    <label for="cd-unlimited" style="font-size:11.5px;color:var(--text-mid);text-transform:none;letter-spacing:0;font-weight:400;cursor:pointer;">Unlimited duration (BV default)</label>
                  </div>
                  <input type="date" id="cd-mandate-end">
                </div>
                <div class="cf-group"><label>Appointment authority</label>
                  <select id="cd-auth"><option>AGM resolution</option><option>Board resolution (co-optation)</option><option>Founders / Articles of association</option><option>Notarial deed</option><option>Shareholders' resolution</option></select>
                </div>
                <div class="cf-group"><label>Deed / resolution reference</label><input type="text" id="cd-deed" style="font-family:var(--font-mono);font-size:11.5px;" placeholder="BR-2024-003"></div>
                <div class="cf-group"><label>Remuneration</label>
                  <select id="cd-remuneration"><option>Unpaid</option><option>Fixed fee</option><option>Variable</option><option>Fixed + variable</option></select>
                </div>
                <div class="cf-group"><label>Signature authority</label>
                  <select id="cd-sig"><option>Joint (with other director)</option><option>Sole</option><option>As per board resolution</option></select>
                </div>
              </div>
              <div class="cf-group" style="margin-top:12px;"><label>Notes</label><textarea id="cd-notes" placeholder="Additional notes on this appointment…"></textarea></div>
            </div>
            <div class="ch-modal-foot">
              <button class="btn" onclick="chCloseModal('ch-modal-director')">Cancel</button>
              <button class="btn btn-primary" onclick="chSaveDirector()">Add to board</button>
            </div>
          </div>
        </div>

        <!-- Add shareholder modal -->
        <div class="ch-modal" id="ch-modal-shareholder" style="display:none;" onclick="if(event.target===this)chCloseModal('ch-modal-shareholder')">
          <div class="ch-modal-box">
            <div class="ch-modal-head">
              <h2>Add shareholder</h2>
              <div class="ch-modal-close" onclick="chCloseModal('ch-modal-shareholder')">✕</div>
            </div>
            <div class="ch-modal-body">
              <div class="fg fg-2">
                <div class="cf-group"><label>Name</label><input type="text" id="cs-name" placeholder="e.g. Mickey Mouse BVBA"></div>
                <div class="cf-group"><label>Type</label>
                  <select id="cs-type"><option value="natural_person">Natural person</option><option value="legal_entity">Legal entity</option><option value="public_float">Public float</option></select>
                </div>
                <div class="cf-group"><label>Shareholder category</label>
                  <select id="cs-sh-type"><option value="">—</option><option>Founder</option><option>Investor</option><option>Management</option><option>Employee</option><option>Market</option></select>
                </div>
                <div class="cf-group"><label>Nationality / Jurisdiction</label><input type="text" id="cs-nationality"></div>
                <div class="cf-group"><label>Number of shares</label><input type="text" id="cs-shares" style="font-family:var(--font-mono);" placeholder="4,200,000"></div>
                <div class="cf-group"><label>% ownership</label>
                  <div class="cf-prefix"><input type="number" id="cs-pct" step="0.01" min="0" max="100" placeholder="23.0"><span class="cf-prefix-text" style="border-left:1px solid var(--cream-dark);border-right:none;">%</span></div>
                </div>
                <div class="cf-group"><label>Acquisition date</label><input type="date" id="cs-acq-date"></div>
                <div class="cf-group"><label>Ownership type</label>
                  <select id="cs-ownership"><option>Direct</option><option>Indirect</option></select>
                </div>
                <div class="cf-group"><label>Encumbrance</label><input type="text" id="cs-encumbrance" placeholder="None / Pledge / Usufruct…"></div>
                <div class="cf-group"><label>Is UBO (≥25% or control)?</label>
                  <select id="cs-ubo"><option value="false">No</option><option value="true">Yes</option></select>
                </div>
              </div>
            </div>
            <div class="ch-modal-foot">
              <button class="btn" onclick="chCloseModal('ch-modal-shareholder')">Cancel</button>
              <button class="btn btn-primary" onclick="chSaveShareholder()">Add shareholder</button>
            </div>
          </div>
        </div>

        <!-- Add POA modal -->
        <div class="ch-modal" id="ch-modal-poa" style="display:none;" onclick="if(event.target===this)chCloseModal('ch-modal-poa')">
          <div class="ch-modal-box">
            <div class="ch-modal-head"><h2>New Power of Attorney</h2><div class="ch-modal-close" onclick="chCloseModal('ch-modal-poa')">✕</div></div>
            <div class="ch-modal-body">
              <div class="fg fg-2" style="margin-bottom:12px;">
                <div class="cf-group"><label>Grantee name *</label><input type="text" id="cp-grantee"></div>
                <div class="cf-group"><label>Signature</label><select id="cp-sig"><option>Sole</option><option>Joint</option></select></div>
                <div class="cf-group"><label>Granted by (board resolution ref)</label><input type="text" id="cp-granted-by" style="font-family:var(--font-mono);font-size:11.5px;" placeholder="BR-2024-001"></div>
                <div class="cf-group"><label>Grant date</label><input type="date" id="cp-grant-date"></div>
                <div class="cf-group"><label>Duration</label><select id="cp-duration"><option>Unlimited</option><option>Fixed term</option></select></div>
                <div class="cf-group"><label>Expiry date (if fixed)</label><input type="date" id="cp-expiry"></div>
              </div>
              <div class="cf-group" style="margin-bottom:12px;"><label>Scope of powers (one per line)</label>
                <textarea id="cp-powers" style="min-height:100px;" placeholder="Sign daily correspondence and represent before all authorities&#10;Execute contracts up to € 500,000&#10;Hire and dismiss personnel (excluding management team)&#10;Represent in all legal proceedings"></textarea>
              </div>
              <div class="fg fg-2">
                <div class="cf-group"><label>Contract threshold (€)</label><input type="number" id="cp-thr-contracts" placeholder="500000"></div>
                <div class="cf-group"><label>Lease / services threshold (€)</label><input type="number" id="cp-thr-leases" placeholder="250000"></div>
              </div>
            </div>
            <div class="ch-modal-foot">
              <button class="btn" onclick="chCloseModal('ch-modal-poa')">Cancel</button>
              <button class="btn btn-primary" onclick="chSavePOA()">Create POA</button>
            </div>
          </div>
        </div>

        <!-- Add compliance modal -->
        <div class="ch-modal" id="ch-modal-compliance" style="display:none;" onclick="if(event.target===this)chCloseModal('ch-modal-compliance')">
          <div class="ch-modal-box">
            <div class="ch-modal-head"><h2>Add compliance obligation</h2><div class="ch-modal-close" onclick="chCloseModal('ch-modal-compliance')">✕</div></div>
            <div class="ch-modal-body">
              <div class="fg fg-2">
                <div class="cf-group s2"><label>Obligation *</label><input type="text" id="cc-obligation" placeholder="Annual accounts — BNB"></div>
                <div class="cf-group"><label>Period / year</label><input type="text" id="cc-period" placeholder="FY 2025"></div>
                <div class="cf-group"><label>Authority</label><input type="text" id="cc-authority" placeholder="BNB · CBE · FSMA · Tax administration"></div>
                <div class="cf-group"><label>Deadline</label><input type="date" id="cc-deadline"></div>
                <div class="cf-group"><label>Filed date (leave blank if not yet)</label><input type="date" id="cc-filed"></div>
                <div class="cf-group"><label>Status</label><select id="cc-status"><option>pending</option><option>filed</option><option>overdue</option><option>exempt</option></select></div>
                <div class="cf-group s2"><label>Notes</label><textarea id="cc-notes" style="min-height:50px;"></textarea></div>
              </div>
            </div>
            <div class="ch-modal-foot">
              <button class="btn" onclick="chCloseModal('ch-modal-compliance')">Cancel</button>
              <button class="btn btn-primary" onclick="chSaveCompliance()">Add obligation</button>
            </div>
          </div>
        </div>

        <!-- Add history modal -->
        <div class="ch-modal" id="ch-modal-history" style="display:none;" onclick="if(event.target===this)chCloseModal('ch-modal-history')">
          <div class="ch-modal-box" style="width:480px;">
            <div class="ch-modal-head"><h2>Manual history entry</h2><div class="ch-modal-close" onclick="chCloseModal('ch-modal-history')">✕</div></div>
            <div class="ch-modal-body">
              <div class="fg fg-2" style="margin-bottom:12px;">
                <div class="cf-group"><label>Event type</label><select id="ch-hist-type"><option value="governance">Governance</option><option value="capital">Capital</option><option value="compliance">Compliance</option><option value="document">Document</option><option value="other">Other</option></select></div>
                <div class="cf-group"><label>Source / reference</label><input type="text" id="ch-hist-source" placeholder="e.g. Notarial deed / Board resolution"></div>
              </div>
              <div class="cf-group"><label>Description *</label><textarea id="ch-hist-desc" style="min-height:80px;" placeholder="Describe the corporate event…"></textarea></div>
            </div>
            <div class="ch-modal-foot">
              <button class="btn" onclick="chCloseModal('ch-modal-history')">Cancel</button>
              <button class="btn btn-primary" onclick="chSaveHistory()">Add entry</button>
            </div>
          </div>
        </div>

        <!-- Upload document modal -->
        <div class="ch-modal" id="ch-modal-upload-doc" style="display:none;" onclick="if(event.target===this)chCloseModal('ch-modal-upload-doc')">
          <div class="ch-modal-box" style="max-width:520px;">
            <div class="ch-modal-head">
              <h2>Upload document</h2>
              <div class="ch-modal-close" onclick="chCloseModal('ch-modal-upload-doc')">✕</div>
            </div>
            <div class="ch-modal-body">
              <div class="cf-group">
                <label>File (PDF or DOCX) *</label>
                <input type="file" id="doc-file" accept=".pdf,.docx,.xlsx,.xls,.doc,.txt"
                  style="width:100%;padding:6px;border:1px solid var(--cream-dark);border-radius:var(--r);font-size:12px;background:var(--cream);"
                  onchange="chDocFileSelected(this)">
              </div>
              <div class="cf-group">
                <label>Document name *</label>
                <input type="text" id="doc-name" placeholder="e.g. Articles of Association — Coordinated 2024">
              </div>
              <div class="fg fg-2">
                <div class="cf-group">
                  <label>Category</label>
                  <select id="doc-category">
                    <option value="constitutional">Constitutional</option>
                    <option value="resolutions">Resolutions</option>
                    <option value="agm_minutes">AGM minutes</option>
                    <option value="share_register">Share register</option>
                    <option value="poa">POA</option>
                    <option value="regulatory">Regulatory</option>
                    <option value="agreements">Agreements</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="cf-group">
                  <label>Date / period</label>
                  <input type="text" id="doc-date" placeholder="e.g. Mar 2024 or 2024">
                </div>
              </div>
              <div class="cf-group">
                <label>Notes (optional)</label>
                <input type="text" id="doc-notes" placeholder="e.g. Coordinated version · Notary Van den Berg">
              </div>
              <div id="doc-upload-progress" style="display:none;margin-top:8px;">
                <div style="height:4px;background:var(--cream-mid);border-radius:2px;overflow:hidden;">
                  <div id="doc-progress-bar" style="height:100%;background:var(--green);width:0%;transition:width .3s;"></div>
                </div>
                <div id="doc-upload-status" style="font-size:11.5px;color:var(--text-muted);margin-top:5px;"></div>
              </div>
            </div>
            <div class="ch-modal-foot">
              <button class="btn" onclick="chCloseModal('ch-modal-upload-doc')">Cancel</button>
              <button class="btn btn-primary" id="doc-upload-btn" onclick="chDoUploadDoc()">Upload</button>
            </div>
          </div>
        </div>

      </div><!-- /mod-vault -->

      <!-- BOARD & MINUTES -->
      <div class="module" id="mod-minutes">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
          <div style="flex:1;"><div style="font-family:var(--font-serif);font-size:22px;font-weight:400;margin-bottom:3px;">Board &amp; Minutes</div><div style="font-size:12.5px;color:var(--text-muted);">Meeting records, AI summaries, action items and decisions</div></div>
          <input type="file" id="trans-file2" accept=".pdf,.docx,.txt,.mp3,.mp4,.m4a" style="display:none" onchange="minutesTranscriptSelected(this)">
          <button class="btn" onclick="document.getElementById('trans-file2').click()">&#128206; Upload transcript</button>
          <button class="btn btn-primary" onclick="newMeetingDialog()">+ New meeting</button>
        </div>
        <div id="new-meeting-form" style="display:none;margin-bottom:16px;">
          <div class="panel" style="max-width:700px;">
            <div class="panel-title" style="margin-bottom:12px;">New meeting</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
              <div class="form-group"><label>Meeting type</label><select id="nm-type"><option>Board of Directors</option><option>Audit Committee</option><option>Executive Committee</option><option>Remuneration Committee</option><option>Shareholder Meeting</option><option>Other</option></select></div>
              <div class="form-group"><label>Date</label><input type="date" id="nm-date"></div>
              <div class="form-group"><label>Location</label><input type="text" id="nm-location" placeholder="Brussels / Remote"></div>
            </div>
            <div class="form-group"><label>Attendees</label><input type="text" id="nm-attendees" placeholder="e.g. Verbrugge (Chair), Claes, Hoffman, Mathias V. (Secretary)"></div>
            <div class="form-group"><label>Paste transcript / notes</label><textarea id="nm-transcript" style="min-height:90px;" placeholder="Paste meeting transcript or raw notes — Mickey will summarise, extract actions and decisions…"></textarea></div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-primary" onclick="createMeeting()">Create &amp; Summarise with Mickey</button>
              <button class="btn" onclick="document.getElementById('new-meeting-form').style.display='none'">Cancel</button>
            </div>
          </div>
        </div>
        <div class="minutes-layout">
          <div class="meetings-list">
            <div class="ml-head">Meetings <button class="ml-add" onclick="newMeetingDialog()">+</button></div>
            <div id="meetings-list-body">
              <div id="meetings-empty" style="padding:16px 12px;font-size:12px;color:var(--text-muted);">No meetings yet. Click + to create your first meeting.</div>
            </div>
          </div>
          <div class="minutes-detail" id="minutes-detail">
            <div id="minutes-detail-empty" style="display:flex;align-items:center;justify-content:center;height:220px;color:var(--text-muted);font-size:13px;">Select a meeting or create your first one.</div>
            <div id="minutes-detail-content" style="display:none">
              <div class="md-top"><h3 id="minutes-detail-title"></h3><p id="minutes-detail-sub"></p></div>
              <div class="md-tabs-row">
                <button class="md-tab active" onclick="switchMinTab(this,'summary')">Summary</button>
                <button class="md-tab" onclick="switchMinTab(this,'actions')">Action items</button>
                <button class="md-tab" onclick="switchMinTab(this,'decisions')">Decisions</button>
                <button class="md-tab" onclick="switchMinTab(this,'full')">Full minutes</button>
              </div>
              <div class="md-body">
                <div id="mintab-summary"></div>
                <div id="mintab-actions" style="display:none"></div>
                <div id="mintab-decisions" style="display:none"></div>
                <div id="mintab-full" style="display:none">
                  <div class="actions-label">Full minutes</div>
                  <div style="font-family:var(--font-serif);font-size:14px;line-height:1.8;color:var(--text-mid);font-style:italic;">Upload signed minutes PDF to attach to this record.</div>
                  <div style="margin-top:12px;"><input type="file" id="minutes-pdf-upload" accept=".pdf" style="display:none"><button class="btn btn-sm" onclick="document.getElementById('minutes-pdf-upload').click()">&#128206; Attach signed minutes</button></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DUE DILIGENCE -->
      <div class="module" id="mod-duediligence">
        <div class="two-col">
          <div>
            <div class="panel">
              <div class="panel-title">Documents</div><div class="panel-sub">Upload one or more documents for in-depth analysis</div>
              <div class="file-drop" onclick="document.getElementById('dd-file').click()" ondragover="dragOver(event,this)" ondragleave="dragLeave(this)" ondrop="dropFile(event,'dd-file',this)"><div class="file-drop-icon">&#128218;</div><div class="file-drop-text"><strong>Click to upload</strong> — multiple files allowed</div></div>
              <input type="file" id="dd-file" accept=".pdf,.docx" multiple style="display:none" onchange="showFNames('dd-file','dd-fnames')">
              <div id="dd-fnames"></div>
              <div style="margin-top:14px;">
                <div class="form-group"><label>Check against</label><div class="tag-row" id="dd-tags"><div class="tag on" onclick="toggleTag(this)">GDPR</div><div class="tag on" onclick="toggleTag(this)">EU AI Act</div><div class="tag on" onclick="toggleTag(this)">My Workspace</div><div class="tag" onclick="toggleTag(this)">NIS2</div><div class="tag" onclick="toggleTag(this)">WVV</div></div></div>
                <div class="form-group"><label>Apply playbook</label><select id="dd-pb"><option value="">None</option><option>AI Act Compliance</option><option>GDPR + DPA Standard</option><option>M&amp;A Due Diligence (WVV)</option></select></div>
                <div class="form-group"><label>Instructions</label><textarea id="dd-extra" placeholder="e.g. Focus on data protection and IP…"></textarea></div>
                <button class="btn btn-primary btn-full" onclick="runDD()">Run Due Diligence</button>
              </div>
            </div>
          </div>
          <div id="dd-results"><div class="result-box empty">Upload documents and click Run Due Diligence</div></div>
        </div>
      </div>

      <!-- COLLECTIONS -->
      <div class="module" id="mod-collections">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
          <div style="flex:1;"><div style="font-family:var(--font-serif);font-size:22px;font-weight:400;">My Collections</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Save and organise answers, documents and drafts</div></div>
          <button class="btn btn-primary" onclick="showNewCollection()">+ New collection</button>
        </div>
        <div id="new-col-form" style="display:none;margin-bottom:16px;">
          <div class="panel" style="max-width:460px;padding:16px;">
            <div style="display:flex;gap:10px;">
              <input type="text" id="new-col-name" style="flex:1;padding:8px 11px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:13px;outline:none;background:var(--cream);" placeholder="Collection name (e.g. GDPR DPA Prep)">
              <button class="btn btn-primary" onclick="createCollection()">Create</button>
              <button class="btn" onclick="hideNewCollection()">Cancel</button>
            </div>
          </div>
        </div>
        <div id="collections-list"></div>
        <div id="collection-detail" style="display:none;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
            <button class="btn btn-sm" onclick="backToCollections()">&#8592; Back</button>
            <div id="col-detail-name" style="font-family:var(--font-serif);font-size:20px;font-weight:400;flex:1;"></div>
            <button class="btn btn-sm btn-danger" onclick="deleteCurrentCollection()">Delete collection</button>
          </div>
          <div id="col-items-list"></div>
        </div>
      </div>

      <!-- KNOWLEDGE BASE -->
      <div class="module" id="mod-knowledge">
        <div style="margin-bottom:18px;"><div style="font-family:var(--font-serif);font-size:22px;font-weight:400;">Knowledge Base</div><div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Legal Library (shared) and My Workspace (private) — both searched on every query</div></div>
        <div style="display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--cream-mid);">
          <button id="kb-tab-library" onclick="showKbTab('library')" style="padding:8px 18px;background:none;border:none;border-bottom:2px solid var(--green);color:var(--green);font-size:13px;cursor:pointer;margin-bottom:-2px;font-weight:600;font-family:var(--font-sans);">&#128218; Legal Library <span id="kb-lib-count" style="font-size:11px;opacity:.6;margin-left:4px;"></span></button>
          <button id="kb-tab-workspace" onclick="showKbTab('workspace')" style="padding:8px 18px;background:none;border:none;border-bottom:2px solid transparent;color:var(--text-muted);font-size:13px;cursor:pointer;margin-bottom:-2px;font-weight:500;font-family:var(--font-sans);">&#128193; My Workspace <span id="kb-ws-count" style="font-size:11px;opacity:.6;margin-left:4px;"></span></button>
        </div>
        <div id="kb-panel-library">
          <div class="info-box" style="margin-bottom:14px;margin-top:0;"><strong>Legal Library</strong> is shared across all users. Admins can add and remove documents. Only upload documents you are authorised to share with the full team.</div>
          <div id="library-list" style="margin-bottom:16px;"></div>
          <div id="nav-admin-library" style="display:none;">
            <div class="section-label">Add to Legal Library (Admin only)</div>
            <div class="panel" style="max-width:520px;">
              <div class="file-drop" onclick="document.getElementById('lib-file').click()"><input type="file" id="lib-file" accept=".pdf,.docx" style="display:none" onchange="libFileSelected(this)"><div class="file-drop-icon">&#128196;</div><div class="file-drop-text">Click or drag a PDF / DOCX</div><div id="lib-filename" style="margin-top:8px;font-size:12px;color:var(--green);"></div></div>
              <div class="form-group" style="margin-top:12px;"><label>Document name</label><input type="text" id="lib-name" placeholder="e.g. GDPR Regulation (EU) 2016/679"></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><div class="form-group"><label>Jurisdiction</label><input type="text" id="lib-jurisdiction" placeholder="e.g. EU, Belgium"></div><div class="form-group"><label>Topic</label><input type="text" id="lib-topic" placeholder="e.g. Data Protection"></div></div>
              <div class="info-box" style="margin-bottom:10px;">&#9888;&#65039; Do not upload confidential client documents to the shared library.</div>
              <button class="btn btn-primary" onclick="addLibDoc()">Add to Library</button>
            </div>
          </div>
        </div>
        <div id="kb-panel-workspace" style="display:none;">
          <div class="info-box" style="margin-bottom:14px;margin-top:0;"><strong>My Workspace</strong> is private to you only. Upload working documents, templates, and personal references. Content is sent to AI services when queried — do not upload documents containing personal data you are not authorised to process.</div>
          <div id="workspace-list" style="margin-bottom:16px;"></div>
          <div class="section-label">Add to My Workspace</div>
          <div class="panel" style="max-width:520px;">
            <div class="file-drop" onclick="document.getElementById('ws-file').click()"><input type="file" id="ws-file" accept=".pdf,.docx" style="display:none" onchange="wsFileSelected(this)"><div class="file-drop-icon">&#128196;</div><div class="file-drop-text">Click or drag a PDF / DOCX</div><div id="ws-filename" style="font-size:12px;color:var(--green);margin-top:8px;"></div></div>
            <div class="form-group" style="margin-top:12px;"><label>Document name</label><input type="text" id="ws-name" placeholder="e.g. NDA Template v3"></div>
            <div class="info-box" style="margin-bottom:10px;">&#9888;&#65039; Only upload documents you are authorised to process.</div>
            <button class="btn btn-primary" onclick="addWsDoc()">Add to Workspace</button>
          </div>
        </div>
      </div>

      <!-- PLAYBOOKS -->
      <div class="module" id="mod-playbooks">
        <div class="pb-grid" id="pb-grid">
          <div class="pb-card"><div class="pb-name">AI Act Compliance</div><div class="pb-desc">High-risk classification, transparency disclosures, data minimisation, conformity obligations, Art. 50 notices.</div><div class="pb-meta">&#128203; 14 checks</div><button class="btn btn-sm" onclick="go('duediligence',document.querySelector('[data-mod=duediligence]'))">Use in Due Diligence &#8594;</button></div>
          <div class="pb-card"><div class="pb-name">GDPR + DPA Standard</div><div class="pb-desc">Lawful basis, sub-processor notice (30 days), retention schedules, DPIA triggers, deletion obligations.</div><div class="pb-meta">&#128203; 11 checks</div><button class="btn btn-sm" onclick="go('duediligence',document.querySelector('[data-mod=duediligence]'))">Use in Due Diligence &#8594;</button></div>
          <div class="pb-card"><div class="pb-name">Freelance Services (Belgian)</div><div class="pb-desc">Payment terms, IP ownership, non-solicitation, liability caps, AI tool usage rights, Belgian governing law.</div><div class="pb-meta">&#128203; 9 checks</div><button class="btn btn-sm" onclick="go('duediligence',document.querySelector('[data-mod=duediligence]'))">Use in Due Diligence &#8594;</button></div>
          <div class="pb-card"><div class="pb-name">M&amp;A Due Diligence (WVV)</div><div class="pb-desc">Conflict of interest Art. 7:96 WVV, change of control, drag-along/tag-along, director liability, board composition.</div><div class="pb-meta">&#128203; 17 checks</div><button class="btn btn-sm" onclick="go('duediligence',document.querySelector('[data-mod=duediligence]'))">Use in Due Diligence &#8594;</button></div>
        </div>
        <div class="section-label">Create new playbook</div>
        <div class="panel" style="max-width:560px;"><div class="form-group"><label>Name</label><input type="text" id="pb-name" placeholder="e.g. SaaS Agreement Review"></div><div class="form-group"><label>What should Mickey check for?</label><textarea id="pb-desc-input" style="min-height:90px;" placeholder="Describe rules, fallback positions, risk thresholds, preferred clause language…"></textarea></div><button class="btn btn-primary" onclick="createPB()">Create Playbook</button></div>
      </div>



      <div class="module" id="mod-compliance">

        <!-- GDPR MODULE -->
        <div id="module-gdpr" style="display:none;flex:1;overflow:hidden;">
          <div class="sub-nav">
            <div class="sub-title">GDPR</div>
            <div class="sub-item active" data-view="dpo" onclick="setView('gdpr','dpo')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>DPO</div></div>
            <div class="sub-item" data-view="ropa" onclick="setView('gdpr','ropa')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/></svg>RoPA</div><span class="nav-badge nb-amber" id="badge-ropa" style="display:none"></span></div>
            <div class="sub-item" data-view="dsr" onclick="setView('gdpr','dsr')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>DSRs</div><span class="nav-badge nb-red" id="badge-dsr" style="display:none"></span></div>
            <div class="sub-item" data-view="breach" onclick="setView('gdpr','breach')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Data Breaches</div><span class="nav-badge nb-red" id="badge-breach" style="display:none"></span></div>
            <div class="sub-item" data-view="dpia" onclick="setView('gdpr','dpia')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>DPIAs</div><span class="nav-badge nb-amber" id="badge-dpia" style="display:none"></span></div>
            <div class="sub-item" data-view="tia" onclick="setView('gdpr','tia')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>TIAs</div><span class="nav-badge nb-muted" id="badge-tia" style="display:none"></span></div>
            <div class="sub-item" data-view="dpa" onclick="setView('gdpr','dpa')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"/><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"/></svg>DPAs</div><span class="nav-badge nb-muted" id="badge-dpa" style="display:none"></span></div>
            <div class="sub-divider"></div>
            <div class="sub-item" data-view="gdpr-policies" onclick="setView('gdpr','gdpr-policies')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Policies &amp; Advice</div></div>
            <div class="sub-divider"></div>
            <div class="sub-section-label">Other modules</div>
            <div class="sub-item" onclick="setModule('abc')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>Anti-Bribery</div></div>
            <div class="sub-item" id="sub-wb-link" onclick="setModule('wb')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg>Whistleblowing</div></div>
            <div class="sub-divider"></div>
            <div class="sub-section-label">Export</div>
            <div class="sub-item" onclick="exportAudit('gdpr')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Audit report</div></div>
          </div>
          <div class="content" id="gdpr-content">
            <div class="view active" id="view-gdpr-dpo">
              <div class="topbar"><div class="topbar-left"><h1>Data Protection Officer</h1><p id="dpo-subtitle">Art. 37–39 GDPR · Appointment, rationale &amp; supervisory authority</p></div><div class="topbar-actions"><button class="btn btn-secondary editor-only" onclick="openModal('modal-dpo')"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>Edit DPO record</button></div></div>
              <div style="padding:14px 22px;overflow-y:auto;flex:1;" id="dpo-content"><div class="empty"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><h3>No DPO record</h3><p>Add your Data Protection Officer details to get started.</p><button class="btn btn-primary editor-only" style="margin-top:12px;" onclick="openModal('modal-dpo')">Add DPO record</button></div></div>
            </div>
            <div class="view" id="view-gdpr-ropa">
              <div class="topbar"><div class="topbar-left"><h1>Record of Processing Activities</h1><p>Art. 30 GDPR · Controller (Art. 30(1)) and processor (Art. 30(2)) records</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('ropa','docx')">Word (.docx)</button><button onclick="dlExport('ropa','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('ropa','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('ropa')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-ropa')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add activity</button></div></div>
              <div class="rag-strip" id="ropa-rag"></div>
              <div class="filter-bar"><div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search activities…" oninput="filterTable('ropa-table',this.value)"></div><span class="chip active" onclick="filterChip(this,'ropa-table','','role')">All</span><span class="chip" onclick="filterChip(this,'ropa-table','controller','role')">Controller</span><span class="chip" onclick="filterChip(this,'ropa-table','processor','role')">Processor</span></div>
              <div class="section"><div class="table-wrap"><table id="ropa-table"><thead><tr><th style="width:26%">Processing activity</th><th>Role</th><th>Legal basis</th><th>Data categories</th><th>Retention</th><th>Review due</th><th>Status</th><th></th></tr></thead><tbody id="ropa-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No activities recorded yet.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-gdpr-dsr">
              <div class="topbar"><div class="topbar-left"><h1>Data Subject Requests</h1><p>Art. 15–22 GDPR · 1 calendar month deadline</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('dsrs','docx')">Word (.docx)</button><button onclick="dlExport('dsrs','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('dsrs','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('dsrs')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-dsr')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log DSR</button></div></div>
              <div class="rag-strip" id="dsr-rag"></div>
              <div class="filter-bar"><div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search requests…" oninput="filterTable('dsr-table',this.value)"></div><span class="chip active" onclick="filterChip(this,'dsr-table','','status')">Open</span><span class="chip" onclick="filterChip(this,'dsr-table','closed','status')">Closed</span><span class="chip" onclick="filterChip(this,'dsr-table','controller','role')">Controller</span><span class="chip" onclick="filterChip(this,'dsr-table','processor','role')">Processor</span></div>
              <div class="section"><div id="dsr-alerts"></div><div class="table-wrap"><table id="dsr-table"><thead><tr><th>Requester</th><th>Right</th><th>Role</th><th>Received</th><th>Deadline</th><th>Days left</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="dsr-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DSRs recorded yet.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-gdpr-breach">
              <div class="topbar"><div class="topbar-left"><h1>Data Breaches</h1><p>Art. 33–34 GDPR · 72-hour SA notification clock from detection</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('breaches','docx')">Word (.docx)</button><button onclick="dlExport('breaches','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('breaches','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('breaches')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-breach')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log breach</button></div></div>
              <div class="rag-strip" id="breach-rag"></div>
              <div class="section" style="padding-top:8px;"><div id="breach-alerts"></div><div class="table-wrap"><table><thead><tr><th>Ref</th><th style="width:28%">Description</th><th>Type</th><th>Detected</th><th>72h deadline</th><th>Risk</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="breach-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No breaches recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-gdpr-dpia">
              <div class="topbar"><div class="topbar-left"><h1>Data Protection Impact Assessments</h1><p>Art. 35 GDPR · 7-stage workflow · DPO consultation mandatory</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('dpias','docx')">Word (.docx)</button><button onclick="dlExport('dpias','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('dpias','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('dpias')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-dpia')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Start DPIA</button></div></div>
              <div class="rag-strip" id="dpia-rag"></div>
              <div class="section"><div class="table-wrap"><table><thead><tr><th style="width:28%">Processing activity</th><th>Stage</th><th>Role</th><th>DPO consulted</th><th>Risk level</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="dpia-tbody"><tr><td colspan="7"><div class="empty" style="padding:30px"><p>No DPIAs started.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-gdpr-tia">
              <div class="topbar"><div class="topbar-left"><h1>Transfer Impact Assessments</h1><p>Art. 44+ GDPR · Post-Schrems II · One TIA per exporter–importer–country combination</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('tias','docx')">Word (.docx)</button><button onclick="dlExport('tias','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('tias','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('tias')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-tia')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New TIA</button></div></div>
              <div class="rag-strip" id="tia-rag"></div>
              <div class="section"><div class="table-wrap"><table><thead><tr><th>Importer</th><th>Country</th><th>Mechanism</th><th>Risk</th><th>Reassess by</th><th>DPA linked</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="tia-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No TIAs recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-gdpr-dpa">
              <div class="topbar"><div class="topbar-left"><h1>Data Processing Agreements</h1><p>Art. 28 GDPR · Agreements with processors and controllers</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('dpas','docx')">Word (.docx)</button><button onclick="dlExport('dpas','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('dpas','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('dpas')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-dpa')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add DPA</button></div></div>
              <div class="section" style="padding-top:14px;"><div class="table-wrap"><table><thead><tr><th style="width:25%">Counterparty</th><th>Our role</th><th>Purpose</th><th>TIA linked</th><th>Signed</th><th>Review</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="dpa-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DPAs recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-gdpr-gdpr-policies">
              <div class="topbar" style="padding-bottom:10px;"><div class="topbar-left"><h1>Policies &amp; Advice — GDPR</h1><p>Policies, guidance notes and Mickey-generated advice</p></div><div class="topbar-actions"><button class="btn btn-secondary editor-only" onclick="openModal('modal-upload-policy','gdpr')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Upload document</button><button class="btn btn-primary editor-only" onclick="openModal('modal-add-advice','gdpr')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add advice note</button></div></div>
              <div class="filter-bar"><div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search…" oninput="filterPolicies('gdpr',this.value)"></div><span class="chip active">All</span><span class="chip" onclick="filterPolicies('gdpr','','policy')">Policy</span><span class="chip" onclick="filterPolicies('gdpr','','advice')">Advice</span><span class="chip" onclick="filterPolicies('gdpr','','template')">Template</span></div>
              <div class="policy-grid" id="policies-gdpr"></div>
            </div>
          </div><!-- /gdpr-content -->
        </div><!-- /module-gdpr -->

        <!-- ABC MODULE -->
        <div id="module-abc" style="display:none;flex:1;overflow:hidden;">
          <div class="sub-nav">
            <div class="sub-title">Anti-Bribery</div>
            <div class="sub-item active" data-view="gifts" onclick="setView('abc','gifts')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/></svg>Gifts &amp; Hospitality</div><span class="nav-badge nb-amber" id="badge-gifts" style="display:none"></span></div>
            <div class="sub-item" data-view="coi" onclick="setView('abc','coi')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/><line x1="20" y1="8" x2="20" y2="14"/></svg>Conflicts of Interest</div><span class="nav-badge nb-amber" id="badge-coi" style="display:none"></span></div>
            <div class="sub-item" data-view="tpdd" onclick="setView('abc','tpdd')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Third-Party DD</div><span class="nav-badge nb-red" id="badge-tpdd" style="display:none"></span></div>
            <div class="sub-item" data-view="donations" onclick="setView('abc','donations')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Political Donations</div></div>
            <div class="sub-item editor-only" data-view="flags" onclick="setView('abc','flags')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>Red Flag Log</div></div>
            <div class="sub-divider"></div>
            <div class="sub-item" data-view="abc-policies" onclick="setView('abc','abc-policies')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Policies &amp; Advice</div></div>
            <div class="sub-divider"></div>
            <div class="sub-section-label">Other modules</div>
            <div class="sub-item" onclick="setModule('gdpr')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>GDPR</div></div>
            <div class="sub-item" id="abc-wb-link" onclick="setModule('wb')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg>Whistleblowing</div></div>
          </div>
          <div class="content" id="abc-content">
            <div class="view active" id="view-abc-gifts">
              <div class="topbar"><div class="topbar-left"><h1>Gifts &amp; Hospitality</h1><p>All gifts and entertainment must be logged · Pre-clearance above policy threshold</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('gifts','docx')">Word (.docx)</button><button onclick="dlExport('gifts','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('gifts','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('gifts')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-gift')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log gift</button></div></div>
              <div class="rag-strip" id="gifts-rag"></div>
              <div class="filter-bar"><div class="search-wrap"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search…" oninput="filterTable('gifts-table',this.value)"></div><span class="chip active">All</span><span class="chip" onclick="filterChip(this,'gifts-table','received','direction')">Received</span><span class="chip" onclick="filterChip(this,'gifts-table','given','direction')">Given</span><span class="chip" onclick="filterChip(this,'gifts-table','pending','status')">Pending</span></div>
              <div class="section"><div class="table-wrap"><table id="gifts-table"><thead><tr><th>Employee</th><th>Direction</th><th>Type</th><th>Third party</th><th>Country</th><th>Value</th><th>Date</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="gifts-tbody"><tr><td colspan="9"><div class="empty" style="padding:30px"><p>No gifts recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-abc-coi">
              <div class="topbar"><div class="topbar-left"><h1>Conflicts of Interest</h1><p>Annual declaration · All employees and board members</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('coi','docx')">Word (.docx)</button><button onclick="dlExport('coi','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('coi','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" id="btn-send-coi-reminders">Send reminders</button><button class="btn btn-secondary editor-only" onclick="openImport('coi')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-coi')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log declaration</button></div></div>
              <div class="rag-strip" id="coi-rag"></div>
              <div class="section"><div id="coi-alerts"></div><div class="table-wrap"><table><thead><tr><th style="width:22%">Person</th><th>Category</th><th>Year</th><th>Declaration date</th><th>Conflict</th><th>Approved by</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="coi-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No COI declarations recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-abc-tpdd">
              <div class="topbar"><div class="topbar-left"><h1>Third-Party Due Diligence</h1><p>Agents, intermediaries, JV partners, high-risk suppliers · Country risk auto-detected</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('tpdd','docx')">Word (.docx)</button><button onclick="dlExport('tpdd','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('tpdd','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('tpdd')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-tpdd')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add third party</button></div></div>
              <div class="rag-strip" id="tpdd-rag"></div>
              <div class="section"><div class="table-wrap"><table><thead><tr><th style="width:22%">Company</th><th>Type</th><th>Country</th><th>DD level</th><th>Last DD</th><th>Next review</th><th>Country risk</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="tpdd-tbody"><tr><td colspan="9"><div class="empty" style="padding:30px"><p>No third parties recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-abc-donations">
              <div class="topbar"><div class="topbar-left"><h1>Political Donations &amp; Sponsorships</h1><p>Corporate donations, sponsorships, charitable contributions · Board approval required</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('donations','docx')">Word (.docx)</button><button onclick="dlExport('donations','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('donations','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('donations')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-donation')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log donation</button></div></div>
              <div class="section" style="padding-top:14px;"><div class="table-wrap"><table><thead><tr><th>Recipient</th><th>Type</th><th>Amount</th><th>Date</th><th>Jurisdiction</th><th>Board approval</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="donations-tbody"><tr><td colspan="8"><div class="empty" style="padding:30px"><p>No donations recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-abc-flags">
              <div class="topbar"><div class="topbar-left"><h1>Red Flag Log</h1><p>Internal record for legal review · Restricted to editors and admin</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('flags','docx')">Word (.docx)</button><button onclick="dlExport('flags','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('flags','pdf')">PDF</button></div></div><button class="btn btn-secondary editor-only" onclick="openImport('flags')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button><button class="btn btn-primary editor-only" onclick="openModal('modal-flag')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log concern</button></div></div>
              <div class="section" style="padding-top:14px;"><div class="table-wrap"><table><thead><tr><th>Date</th><th style="width:30%">Description</th><th>Related party</th><th>Country</th><th>Severity</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="flags-tbody"><tr><td colspan="7"><div class="empty" style="padding:30px"><p>No red flags recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-abc-abc-policies">
              <div class="topbar" style="padding-bottom:10px;"><div class="topbar-left"><h1>Policies &amp; Advice — Anti-Bribery</h1><p>ABC policies, guidance and advice notes</p></div><div class="topbar-actions"><button class="btn btn-secondary editor-only" onclick="openModal('modal-upload-policy','abc')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Upload</button><button class="btn btn-primary editor-only" onclick="openModal('modal-add-advice','abc')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add advice note</button></div></div>
              <div class="policy-grid" id="policies-abc"></div>
            </div>
          </div><!-- /abc-content -->
        </div><!-- /module-abc -->

        <!-- WHISTLEBLOWING MODULE -->
        <div id="module-wb" style="display:none;flex:1;overflow:hidden;">
          <div class="sub-nav">
            <div class="sub-title">Whistleblowing</div>
            <div class="sub-item active" data-view="wb-cases" onclick="setView('wb','wb-cases')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Cases</div><span class="nav-badge nb-amber" id="badge-wb" style="display:none"></span></div>
            <div class="sub-item" data-view="wb-annual" onclick="setView('wb','wb-annual')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Annual report</div></div>
            <div class="sub-divider"></div>
            <div class="sub-item" data-view="wb-policies" onclick="setView('wb','wb-policies')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Policies &amp; Advice</div></div>
            <div class="sub-divider"></div>
            <div class="sub-section-label">Other modules</div>
            <div class="sub-item" onclick="setModule('gdpr')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>GDPR</div></div>
            <div class="sub-item" onclick="setModule('abc')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/></svg>Anti-Bribery</div></div>
          </div>
          <div class="content" id="wb-content">
            <div class="view active" id="view-wb-wb-cases">
              <div class="topbar"><div class="topbar-left"><h1>Whistleblowing Cases</h1><p>EU Directive 2019/1937 · 7-day acknowledgement · 3-month investigation deadline</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="export-dd"><button onclick="dlExport('wb','docx')">Word (.docx)</button><button onclick="dlExport('wb','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('wb','pdf')">PDF</button></div></div><button class="btn btn-primary editor-only" onclick="openModal('modal-wb')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Log report</button></div></div>
              <div class="rag-strip" id="wb-rag"></div>
              <div class="section"><div id="wb-alerts"></div><div class="table-wrap"><table><thead><tr><th>Ref</th><th>Category</th><th>Reporter</th><th>Received</th><th>Acknowledge by</th><th>Outcome by</th><th>Handler</th><th>Status</th><th class="editor-only"></th></tr></thead><tbody id="wb-tbody"><tr><td colspan="9"><div class="empty" style="padding:30px"><p>No cases recorded.</p></div></td></tr></tbody></table></div></div>
            </div>
            <div class="view" id="view-wb-wb-annual">
              <div class="topbar"><div class="topbar-left"><h1>Annual Report</h1><p>EU Directive 2019/1937 · Statistical report (no individual case detail)</p></div><div class="topbar-actions"><div class="export-menu-wrap"><button class="btn btn-secondary" onclick="toggleExportMenu(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export cases</button><div class="export-dd"><button onclick="dlExport('wb','docx')">Word (.docx)</button><button onclick="dlExport('wb','xlsx')">Excel (.xlsx)</button><button onclick="dlExport('wb','pdf')">PDF</button></div></div></div></div>
              <div class="section" style="padding-top:14px;"><div id="wb-annual-content"><div class="empty" style="padding:48px"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/></svg><h3>Annual statistics</h3><p>Loading…</p></div></div></div>
            </div>
            <div class="view" id="view-wb-wb-policies">
              <div class="topbar" style="padding-bottom:10px;"><div class="topbar-left"><h1>Policies &amp; Advice — Whistleblowing</h1><p>WB policies, handler guidance and advice notes</p></div><div class="topbar-actions"><button class="btn btn-secondary editor-only" onclick="openModal('modal-upload-policy','wb')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Upload</button><button class="btn btn-primary editor-only" onclick="openModal('modal-add-advice','wb')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add advice note</button></div></div>
              <div class="policy-grid" id="policies-wb"></div>
            </div>
          </div><!-- /wb-content -->
        </div><!-- /module-wb -->

        <!-- COMPLIANCE SETTINGS MODULE -->
        <div id="module-settings" style="display:none;flex:1;overflow:hidden;">
          <div class="sub-nav">
            <div class="sub-title">Settings</div>
            <div class="sub-item active" data-view="settings-users" onclick="setView('settings','settings-users')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Users &amp; Access</div></div>
            <div class="sub-item" data-view="settings-compliance" onclick="setView('settings','settings-compliance')"><div class="sub-item-inner"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Compliance settings</div></div>
          </div>
          <div class="content" id="settings-content">
            <div class="view active" id="view-settings-settings-users">
              <div class="topbar"><div class="topbar-left"><h1>Users &amp; Access</h1><p>Manage team roles and module visibility · Maximum 5 users per firm</p></div><div class="topbar-actions"><button class="btn btn-primary" onclick="openModal('modal-invite')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Invite user</button></div></div>
              <div class="section" style="padding-top:14px;">
                <div class="alert-bar alert-blue" style="margin-bottom:14px;"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span><strong>Module access:</strong> Uncheck a module to hide it completely from that user's sidebar. Whistleblowing is hidden by default — enable only for designated handlers.</span></div>
                <div id="users-table-wrap"><div class="empty" style="padding:30px"><p>Loading users…</p></div></div>
              </div>
            </div>
            <div class="view" id="view-settings-settings-compliance">
              <div class="topbar"><div class="topbar-left"><h1>Compliance settings</h1><p>Jurisdiction, thresholds and firm-level defaults</p></div><div class="topbar-actions"><button class="btn btn-primary" onclick="saveComplianceSettings()">Save settings</button></div></div>
              <div class="section" style="padding-top:14px;">
                <div class="info-card" style="margin-bottom:12px;">
                  <div class="sec-divider" style="margin-top:0">Jurisdiction</div>
                  <div class="form-row"><div class="form-group"><label>Primary jurisdiction</label><select class="form-control" id="setting-primary-jurisdiction"><option value="BE">Belgium</option><option value="FR">France</option><option value="DE">Germany</option><option value="NL">Netherlands</option><option value="LU">Luxembourg</option><option value="GB">United Kingdom</option><option value="IE">Ireland</option><option value="ES">Spain</option><option value="IT">Italy</option><option value="PL">Poland</option><option value="OTHER">Other EU</option></select><div class="form-hint">Determines supervisory authority and default notification thresholds</div></div><div class="form-group"><label>Additional jurisdictions</label><input class="form-control" id="setting-extra-jurisdictions" placeholder="e.g. FR, NL, LU"><div class="form-hint">Comma-separated country codes where your firm operates</div></div></div>
                  <div class="sec-divider">Gift &amp; Hospitality thresholds</div>
                  <div class="form-row"><div class="form-group"><label>Pre-clearance required above (€)</label><input class="form-control" type="number" id="setting-gift-threshold" placeholder="50"><div class="form-hint">Gifts above this value require approval before acceptance</div></div><div class="form-group"><label>Auto-decline above (€)</label><input class="form-control" type="number" id="setting-gift-autodecline" placeholder="200"><div class="form-hint">Gifts above this value are automatically flagged for decline</div></div></div>
                  <div class="sec-divider">Whistleblowing defaults</div>
                  <div class="form-row"><div class="form-group"><label>WB channel description</label><input class="form-control" id="setting-wb-channel" placeholder="e.g. Internal online form at wb@company.com"><div class="form-hint">Shown on the WB intake form</div></div><div class="form-group"><label>Default handler</label><input class="form-control" id="setting-wb-handler" placeholder="Name of default case handler"></div></div>
                </div>
              </div>
            </div>
          </div><!-- /settings-content -->
        </div><!-- /module-settings -->

      </div><!-- /mod-compliance -->

<!-- Confirm Modal -->
<div class="overlay" id="modal-confirm">
  <div class="modal" style="width:400px;">
    <div class="modal-title" id="confirm-title">Confirm action</div>
    <div style="font-size:13px;color:var(--text-mid);margin:10px 0 20px;" id="confirm-body">Are you sure?</div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-confirm')">Cancel</button><button class="btn btn-danger" id="confirm-ok-btn">Confirm</button></div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════ MODALS -->

<!-- DPO MODAL -->
<div class="overlay" id="modal-dpo">
  <div class="modal modal-wide">
    <div class="modal-title">DPO Record</div>
    <div class="modal-sub">Art. 37–39 GDPR · Appointment details and mandatory assessment</div>
    <div class="form-row">
      <div class="form-group"><label>Full name</label><input class="form-control" id="dpo-name" placeholder="e.g. Jane Smith"></div>
      <div class="form-group"><label>Title / Position</label><input class="form-control" id="dpo-title" placeholder="e.g. Data Protection Officer"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>DPO type</label><select class="form-control" id="dpo-type"><option value="internal">Internal employee</option><option value="external">External / contracted</option></select></div>
      <div class="form-group"><label>Contact email (public)</label><input class="form-control" id="dpo-email" type="email" placeholder="dpo@company.com"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Appointment date</label><input class="form-control" id="dpo-appointed" type="date"></div>
      <div class="form-group"><label>Next review date</label><input class="form-control" id="dpo-review" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>SA registration reference</label><input class="form-control" id="dpo-sa-ref" placeholder="e.g. GBA-2024-001"><div class="form-hint">Reference number from your national supervisory authority</div></div>
      <div class="form-group"><label>Contact phone</label><input class="form-control" id="dpo-phone" placeholder="+32 ..."></div>
    </div>
    <div class="form-section-label">Art. 37(1) mandatory appointment assessment</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:var(--r);padding:9px 13px;font-size:12px;">
        <span>Public authority or body (Art. 37(1)(a))</span>
        <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleAssessment(this,'yes')">Yes</button><button class="role-btn active" onclick="toggleAssessment(this,'no')">No</button></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:var(--r);padding:9px 13px;font-size:12px;">
        <span>Large-scale regular &amp; systematic monitoring (Art. 37(1)(b))</span>
        <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleAssessment(this,'yes')">Yes</button><button class="role-btn active" onclick="toggleAssessment(this,'no')">No</button></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:var(--r);padding:9px 13px;font-size:12px;">
        <span>Large-scale special category / criminal data (Art. 37(1)(c))</span>
        <div class="role-toggle" style="width:160px;"><button class="role-btn" onclick="toggleAssessment(this,'yes')">Yes</button><button class="role-btn active" onclick="toggleAssessment(this,'no')">No</button></div>
      </div>
    </div>
    <div class="form-group"><label>Business justification</label><textarea class="form-control" id="dpo-justification" rows="3" placeholder="Why has the organisation appointed a DPO? What is the rationale for voluntary or mandatory appointment?"></textarea></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpo')">Cancel</button><button class="btn btn-primary" onclick="saveDPO()">Save DPO record</button></div>
  </div>
</div>

<!-- ROPA MODAL -->
<div class="overlay" id="modal-ropa">
  <div class="modal modal-wide">
    <div class="modal-title">Add processing activity</div>
    <div class="modal-sub">Art. 30 GDPR · Fields change based on your role (controller vs processor)</div>
    <div style="margin-bottom:14px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Your organisation's role for this activity</div>
      <div class="role-toggle">
        <button class="role-btn active" onclick="setRopaRole(this,'controller')">Controller — Art. 30(1)</button>
        <button class="role-btn" onclick="setRopaRole(this,'processor')">Processor — Art. 30(2)</button>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Activity name</label><input class="form-control" id="ropa-name" placeholder="e.g. HR — Employee records management"></div>
    </div>
    <!-- Controller fields -->
    <div id="ropa-controller-fields">
      <div class="form-row">
        <div class="form-group"><label>Purpose(s) of processing</label><input class="form-control" id="ropa-purposes" placeholder="e.g. HR administration, payroll, benefits management"></div>
        <div class="form-group"><label>Legal basis</label><select class="form-control" id="ropa-legal-basis"><option value="">Select…</option><option>Art. 6(1)(a) — Consent</option><option>Art. 6(1)(b) — Contract performance</option><option>Art. 6(1)(c) — Legal obligation</option><option>Art. 6(1)(d) — Vital interests</option><option>Art. 6(1)(e) — Public task</option><option>Art. 6(1)(f) — Legitimate interests</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Categories of data subjects</label><input class="form-control" id="ropa-subjects" placeholder="e.g. Employees, candidates, contractors"></div>
        <div class="form-group"><label>Categories of personal data</label><input class="form-control" id="ropa-categories" placeholder="e.g. Name, address, salary, health data"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Recipients / disclosures</label><input class="form-control" id="ropa-recipients" placeholder="e.g. Payroll processor, tax authority"></div>
        <div class="form-group"><label>Third country transfers?</label><select class="form-control" id="ropa-transfers"><option value="none">No transfers outside EEA</option><option value="adequacy">Adequacy decision</option><option value="sccs">Standard Contractual Clauses</option><option value="bcrs">Binding Corporate Rules</option><option value="other">Other safeguard</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Retention period</label><input class="form-control" id="ropa-retention" placeholder="e.g. 7 years after termination / Until consent withdrawn"></div>
        <div class="form-group"><label>Special category data?</label><select class="form-control" id="ropa-special"><option value="no">No</option><option value="yes">Yes — Art. 9 data</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Security measures (summary)</label><input class="form-control" id="ropa-security" placeholder="e.g. Encryption at rest, access controls, pseudonymisation"></div>
        <div class="form-group"><label>DPIA required?</label><select class="form-control" id="ropa-dpia-req"><option value="no">No</option><option value="yes">Yes — DPIA required</option><option value="done">Yes — DPIA completed</option></select></div>
      </div>
    </div>
    <!-- Processor fields (hidden by default) -->
    <div id="ropa-processor-fields" style="display:none;">
      <div class="alert-bar alert-blue" style="margin-bottom:10px;">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span>Art. 30(2) record. As processor, you record the <strong>controller's details</strong> and the <strong>categories of processing</strong> you perform on their behalf. Purposes, legal basis and retention are the controller's responsibility — do not record them here.</span>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Controller name</label><input class="form-control" id="ropa-controller-name" placeholder="Name of the data controller"></div>
        <div class="form-group"><label>Controller contact / DPO</label><input class="form-control" id="ropa-controller-contact" placeholder="Contact person or DPO at the controller"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Categories of processing performed</label><input class="form-control" id="ropa-proc-categories" placeholder="e.g. Storage, analysis, pseudonymisation, transmission"></div>
        <div class="form-group"><label>DPA reference (Art. 28)</label><input class="form-control" id="ropa-proc-dpa-ref" placeholder="Reference to your DPA with this controller"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Third country transfers?</label><select class="form-control" id="ropa-proc-transfers"><option value="none">No transfers outside EEA</option><option value="adequacy">Adequacy decision</option><option value="sccs">Standard Contractual Clauses</option><option value="bcrs">Binding Corporate Rules</option><option value="other">Other safeguard</option></select></div>
        <div class="form-group"><label>Security measures (summary)</label><input class="form-control" id="ropa-proc-security" placeholder="e.g. Encryption, access controls, audit logging"></div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Review date</label><input class="form-control" id="ropa-review-date" type="date"></div>
      <div class="form-group"><label>Notes</label><input class="form-control" id="ropa-notes" placeholder="Any additional notes"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-ropa')">Cancel</button><button class="btn btn-primary" onclick="saveRopa()">Save activity</button></div>
  </div>
</div>

<!-- DSR MODAL -->
<div class="overlay" id="modal-dsr">
  <div class="modal modal-wide">
    <div class="modal-title">Log data subject request</div>
    <div class="modal-sub">Deadline clock starts from date of receipt — calendar days, not business days</div>
    <div style="margin-bottom:12px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Organisation's role for this request</div>
      <div class="role-toggle">
        <button class="role-btn active" onclick="setDsrRole(this,'controller')">Controller — respond directly</button>
        <button class="role-btn" onclick="setDsrRole(this,'processor')">Processor — notify controller</button>
      </div>
      <div id="dsr-role-hint-ctrl" style="margin-top:6px;" class="alert-bar alert-blue"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>You respond directly to the data subject within <strong>1 calendar month</strong> of receipt.</span></div>
      <div id="dsr-role-hint-proc" style="display:none;margin-top:6px;" class="alert-bar alert-amber"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>You cannot respond to the data subject directly. <strong>Notify the controller without undue delay</strong> — maximum 5 business days.</span></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Requester name</label><input class="form-control" id="dsr-requester" placeholder="Full name of the data subject"></div>
      <div class="form-group"><label>Right exercised</label><select class="form-control" id="dsr-right"><option value="">Select…</option><option>Art. 15 — Access</option><option>Art. 16 — Rectification</option><option>Art. 17 — Erasure</option><option>Art. 18 — Restriction</option><option>Art. 20 — Portability</option><option>Art. 21 — Object</option><option>Art. 22 — Automated decisions</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date received</label><input class="form-control" id="dsr-received" type="date"><div class="form-hint">Deadline = 1 calendar month from this date</div></div>
      <div class="form-group"><label>Channel received via</label><select class="form-control" id="dsr-channel"><option>Email</option><option>Contact form</option><option>Post</option><option>Verbal (recorded)</option><option>Privacy platform</option><option>Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Identity verified?</label><select class="form-control" id="dsr-verified"><option value="yes">Yes — verified</option><option value="pending">No — verification pending (pauses clock)</option></select></div>
      <div class="form-group"><label>Third party acting on behalf?</label><select class="form-control" id="dsr-third-party"><option value="no">No — direct request</option><option value="legal-rep">Yes — legal representative</option><option value="parent">Yes — parent / guardian</option></select></div>
    </div>
    <div id="dsr-controller-notify-field" style="display:none;">
      <div class="form-row"><div class="form-group"><label>Data controller to notify</label><input class="form-control" id="dsr-controller-notify" placeholder="Controller name / company"><div class="form-hint">Notify within 5 business days of receipt</div></div></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes / context</label><textarea class="form-control" id="dsr-notes" rows="2" placeholder="Any relevant background, prior interactions, or context…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dsr')">Cancel</button><button class="btn btn-primary" onclick="saveDsr()">Log DSR</button></div>
  </div>
</div>

<!-- BREACH MODAL -->
<div class="overlay" id="modal-breach">
  <div class="modal modal-wide">
    <div class="modal-title">Log data breach</div>
    <div class="modal-sub">72-hour SA notification clock starts from detection — act quickly</div>
    <div class="alert-bar alert-red" style="margin-bottom:12px;">
      <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span>If notification to your supervisory authority is required, you have <strong>72 hours from detection</strong>. If in doubt, notify — you can supplement later.</span>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date &amp; time detected</label><input class="form-control" id="breach-detected" type="datetime-local"></div>
      <div class="form-group"><label>Breach type</label><select class="form-control" id="breach-type"><option value="confidentiality">Confidentiality — unauthorised access/disclosure</option><option value="integrity">Integrity — unauthorised alteration</option><option value="availability">Availability — loss/destruction</option><option value="multiple">Multiple types</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description of the breach</label><textarea class="form-control" id="breach-description" rows="2" placeholder="What happened? How was it discovered?"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Estimated records affected</label><input class="form-control" id="breach-records" type="number" placeholder="0"><div class="form-hint">Approximate number of data subjects affected</div></div>
      <div class="form-group"><label>Data categories involved</label><input class="form-control" id="breach-data-cats" placeholder="e.g. Contact data, financial, health…"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Risk level</label><select class="form-control" id="breach-risk"><option value="low">Low — no notification needed</option><option value="medium">Medium — SA notification likely</option><option value="high">High — SA notification required</option><option value="high_subjects">High + data subjects must be notified</option></select></div>
      <div class="form-group"><label>Your role</label><select class="form-control" id="breach-role"><option value="controller">Controller — notify SA directly</option><option value="processor">Processor — notify controller without delay</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Containment measures taken</label><textarea class="form-control" id="breach-containment" rows="2" placeholder="Steps taken to contain the breach…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-breach')">Cancel</button><button class="btn btn-primary" onclick="saveBreach()">Log breach</button></div>
  </div>
</div>

<!-- DPIA MODAL -->
<div class="overlay" id="modal-dpia">
  <div class="modal">
    <div class="modal-title">Start DPIA</div>
    <div class="modal-sub">Art. 35 GDPR · 7-stage process — DPO consultation is mandatory before completion</div>
    <div class="form-row"><div class="form-group"><label>Processing activity name</label><input class="form-control" id="dpia-name" placeholder="Processing activity subject to the DPIA"><div class="form-hint">Refer to the RoPA entry that triggered this DPIA</div></div></div>
    <div class="form-row">
      <div class="form-group"><label>Trigger for DPIA</label><select class="form-control" id="dpia-trigger"><option value="">Select reason…</option><option>Systematic monitoring of public area</option><option>Large-scale special category data</option><option>Large-scale criminal data</option><option>Automated decision-making with legal effect</option><option>New technology / innovative use</option><option>Profiling at scale</option><option>National DPA blacklist — mandatory</option><option>Internal policy — voluntary</option></select></div>
      <div class="form-group"><label>Risk level (initial)</label><select class="form-control" id="dpia-risk"><option value="medium">Medium</option><option value="high">High</option><option value="very_high">Very high</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Linked RoPA activity (optional)</label><input class="form-control" id="dpia-ropa-link" placeholder="Activity name from RoPA"></div>
      <div class="form-group"><label>Lead assessor</label><input class="form-control" id="dpia-assessor" placeholder="Name of person leading the DPIA"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Initial description</label><textarea class="form-control" id="dpia-description" rows="2" placeholder="Brief description of the processing and why a DPIA is needed…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpia')">Cancel</button><button class="btn btn-primary" onclick="saveDpia()">Start DPIA</button></div>
  </div>
</div>

<!-- TIA MODAL -->
<div class="overlay" id="modal-tia">
  <div class="modal modal-wide">
    <div class="modal-title">New Transfer Impact Assessment</div>
    <div class="modal-sub">Art. 44+ GDPR · Post-Schrems II · Assess the legal protection available in the destination country</div>
    <div class="form-row">
      <div class="form-group"><label>Exporter (your entity)</label><input class="form-control" id="tia-exporter" placeholder="Your company name / entity"></div>
      <div class="form-group"><label>Importer name</label><input class="form-control" id="tia-importer" placeholder="Name of the data importer"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Destination country</label><input class="form-control" id="tia-country" placeholder="e.g. US, IN, CN"><div class="form-hint">Country code — risk level will be auto-assessed</div></div>
      <div class="form-group"><label>Transfer mechanism</label><select class="form-control" id="tia-mechanism"><option value="">Select…</option><option value="adequacy">Adequacy decision</option><option value="sccs_c2c">SCCs — controller to controller</option><option value="sccs_c2p">SCCs — controller to processor</option><option value="sccs_p2p">SCCs — processor to processor</option><option value="bcrs">Binding Corporate Rules</option><option value="derogation">Art. 49 derogation</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Data categories transferred</label><input class="form-control" id="tia-data-cats" placeholder="e.g. Employee data, customer contact data"></div>
      <div class="form-group"><label>Purpose of transfer</label><input class="form-control" id="tia-purpose" placeholder="e.g. Cloud hosting, payroll processing"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Risk assessment outcome</label><select class="form-control" id="tia-risk"><option value="low">Low — transfer permitted</option><option value="medium">Medium — additional safeguards applied</option><option value="high">High — reassessment needed</option><option value="not_permitted">Not permitted</option></select></div>
      <div class="form-group"><label>Reassessment due date</label><input class="form-control" id="tia-reassess" type="date"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Supplementary measures (if any)</label><textarea class="form-control" id="tia-measures" rows="2" placeholder="e.g. Technical measures: end-to-end encryption. Contractual: enhanced audit rights. Organisational: access controls…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-tia')">Cancel</button><button class="btn btn-primary" onclick="saveTia()">Save TIA</button></div>
  </div>
</div>

<!-- DPA MODAL -->
<div class="overlay" id="modal-dpa">
  <div class="modal modal-wide">
    <div class="modal-title">Add Data Processing Agreement</div>
    <div class="modal-sub">Art. 28 GDPR · Agreements with processors (as controller) or controllers (as processor)</div>
    <div class="form-row">
      <div class="form-group"><label>Counterparty name</label><input class="form-control" id="dpa-counterparty" placeholder="Company name"></div>
      <div class="form-group"><label>Our role</label><select class="form-control" id="dpa-role"><option value="controller">Controller — counterparty is our processor</option><option value="processor">Processor — counterparty is our controller</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Purpose / scope of processing</label><input class="form-control" id="dpa-purpose" placeholder="e.g. Payroll processing, CRM hosting"></div>
      <div class="form-group"><label>Signed date</label><input class="form-control" id="dpa-signed" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Review date</label><input class="form-control" id="dpa-review" type="date"></div>
      <div class="form-group"><label>TIA linked?</label><input class="form-control" id="dpa-tia-ref" placeholder="TIA reference if third country transfer involved"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="dpa-notes" rows="2" placeholder="Any relevant notes about this agreement…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dpa')">Cancel</button><button class="btn btn-primary" onclick="saveDpa()">Save DPA</button></div>
  </div>
</div>

<!-- GIFT MODAL -->
<div class="overlay" id="modal-gift">
  <div class="modal modal-wide">
    <div class="modal-title">Log gift or hospitality</div>
    <div class="modal-sub">All gifts and entertainment must be recorded · Pre-clearance required above the policy threshold</div>
    <div class="form-row">
      <div class="form-group"><label>Employee name</label><input class="form-control" id="gift-employee" placeholder="Full name"></div>
      <div class="form-group"><label>Direction</label><select class="form-control" id="gift-direction"><option value="received">Received — from third party</option><option value="given">Given — to third party</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Type</label><select class="form-control" id="gift-type"><option value="gift">Gift (physical)</option><option value="meal">Meal / entertainment</option><option value="hospitality">Hospitality (event, travel)</option><option value="cash_equiv">Cash equivalent</option><option value="other">Other</option></select></div>
      <div class="form-group"><label>Third party (company)</label><input class="form-control" id="gift-third-party" placeholder="Company name"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Country</label><input class="form-control" id="gift-country" placeholder="e.g. BE, FR, DRC" maxlength="3"><div class="form-hint">Country code — high-risk countries flagged automatically</div></div>
      <div class="form-group"><label>Estimated value (€)</label><input class="form-control" id="gift-value" type="number" placeholder="0.00"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date</label><input class="form-control" id="gift-date" type="date"></div>
      <div class="form-group"><label>Business context</label><input class="form-control" id="gift-context" placeholder="e.g. Contract signing dinner, conference"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="gift-notes" rows="2" placeholder="Any additional context or justification…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-gift')">Cancel</button><button class="btn btn-primary" onclick="saveGift()">Log gift</button></div>
  </div>
</div>

<!-- COI MODAL -->
<div class="overlay" id="modal-coi">
  <div class="modal modal-wide">
    <div class="modal-title">Log COI declaration</div>
    <div class="modal-sub">Annual conflict of interest declaration · All employees and board members</div>
    <div class="form-row">
      <div class="form-group"><label>Person name</label><input class="form-control" id="coi-name" placeholder="Full name"></div>
      <div class="form-group"><label>Category</label><select class="form-control" id="coi-category"><option value="employee">Employee</option><option value="board">Board member</option><option value="consultant">Consultant / contractor</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Role / position</label><input class="form-control" id="coi-role" placeholder="e.g. Sales Director, CFO"></div>
      <div class="form-group"><label>Declaration year</label><input class="form-control" id="coi-year" type="number" placeholder="2026"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Declaration date</label><input class="form-control" id="coi-date" type="date"></div>
      <div class="form-group"><label>Conflict disclosed?</label><select class="form-control" id="coi-conflict" onchange="toggleCoiConflict(this)"><option value="none">No — no conflict to declare</option><option value="yes">Yes — conflict disclosed</option><option value="not_submitted">Not yet submitted</option></select></div>
    </div>
    <div id="coi-conflict-detail" style="display:none;">
      <div class="form-row"><div class="form-group"><label>Description of conflict</label><textarea class="form-control" id="coi-conflict-desc" rows="2" placeholder="Describe the nature of the conflict of interest…"></textarea></div></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes</label><textarea class="form-control" id="coi-notes" rows="2" placeholder="Any additional notes…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-coi')">Cancel</button><button class="btn btn-primary" onclick="saveCoi()">Save declaration</button></div>
  </div>
</div>

<!-- TPDD MODAL -->
<div class="overlay" id="modal-tpdd">
  <div class="modal modal-wide">
    <div class="modal-title">Add third party</div>
    <div class="modal-sub">Agents, intermediaries, JV partners, high-risk suppliers · DD level auto-set for high-risk countries</div>
    <div class="form-row">
      <div class="form-group"><label>Company name</label><input class="form-control" id="tpdd-company" placeholder="Full legal name"></div>
      <div class="form-group"><label>Type</label><select class="form-control" id="tpdd-type"><option value="agent">Commercial agent</option><option value="intermediary">Intermediary / broker</option><option value="jv_partner">JV partner</option><option value="supplier">High-risk supplier</option><option value="consultant">Consultant</option><option value="other">Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Country</label><input class="form-control" id="tpdd-country" placeholder="e.g. BE, DRC, US" maxlength="3"><div class="form-hint">Country code — risk auto-assessed, enhanced DD required for high-risk</div></div>
      <div class="form-group"><label>DD level</label><select class="form-control" id="tpdd-dd-level"><option value="standard">Standard</option><option value="enhanced">Enhanced</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Last DD completed</label><input class="form-control" id="tpdd-last-dd" type="date"></div>
      <div class="form-group"><label>Next review date</label><input class="form-control" id="tpdd-next-review" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Relationship description</label><textarea class="form-control" id="tpdd-description" rows="2" placeholder="Nature of the business relationship…"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-tpdd')">Cancel</button><button class="btn btn-primary" onclick="saveTpdd()">Add third party</button></div>
  </div>
</div>

<!-- DONATION MODAL -->
<div class="overlay" id="modal-donation">
  <div class="modal modal-wide">
    <div class="modal-title">Log donation or sponsorship</div>
    <div class="modal-sub">All corporate political donations, sponsorships and charitable contributions</div>
    <div class="form-row">
      <div class="form-group"><label>Recipient</label><input class="form-control" id="don-recipient" placeholder="Name of recipient organisation"></div>
      <div class="form-group"><label>Type</label><select class="form-control" id="don-type"><option value="political">Political donation</option><option value="sponsorship">Sponsorship</option><option value="charitable">Charitable contribution</option><option value="cultural">Cultural / arts</option><option value="sports">Sports sponsorship</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Amount (€)</label><input class="form-control" id="don-amount" type="number" placeholder="0.00"></div>
      <div class="form-group"><label>Date</label><input class="form-control" id="don-date" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Jurisdiction</label><input class="form-control" id="don-jurisdiction" placeholder="e.g. Belgium, France"></div>
      <div class="form-group"><label>Board approval required?</label><select class="form-control" id="don-board-approval"><option value="yes">Yes — board approval required</option><option value="no">No — below threshold</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Business justification</label><textarea class="form-control" id="don-justification" rows="2" placeholder="Reason for the donation or sponsorship…"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-donation')">Cancel</button><button class="btn btn-primary" onclick="saveDonation()">Log donation</button></div>
  </div>
</div>

<!-- RED FLAG MODAL -->
<div class="overlay" id="modal-flag">
  <div class="modal">
    <div class="modal-title">Log red flag concern</div>
    <div class="modal-sub">Confidential — restricted to editors and admin · For internal legal review</div>
    <div class="form-row">
      <div class="form-group"><label>Date identified</label><input class="form-control" id="flag-date" type="date"></div>
      <div class="form-group"><label>Severity</label><select class="form-control" id="flag-severity"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description</label><textarea class="form-control" id="flag-description" rows="2" placeholder="What was observed? Why is it a concern?"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Related party (if any)</label><input class="form-control" id="flag-party" placeholder="Company or person name"></div>
      <div class="form-group"><label>Country (if relevant)</label><input class="form-control" id="flag-country" placeholder="Country code" maxlength="3"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Source of concern</label><input class="form-control" id="flag-source" placeholder="e.g. Finance team, external audit, management"></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-flag')">Cancel</button><button class="btn btn-primary" onclick="saveFlag()">Log concern</button></div>
  </div>
</div>

<!-- WB MODAL -->
<div class="overlay" id="modal-wb">
  <div class="modal modal-wide">
    <div class="modal-title">Log whistleblowing report</div>
    <div class="modal-sub">EU Directive 2019/1937 · Reporter identity kept strictly separate from case record</div>
    <div class="form-row">
      <div class="form-group"><label>Category</label><select class="form-control" id="wb-category"><option value="">Select…</option><option value="financial_irregularity">Financial irregularity</option><option value="fraud">Fraud</option><option value="corruption">Bribery / corruption</option><option value="safety">Health &amp; safety violation</option><option value="environment">Environmental violation</option><option value="data_protection">Data protection breach</option><option value="harassment">Harassment / discrimination</option><option value="competition">Competition law violation</option><option value="other">Other</option></select></div>
      <div class="form-group"><label>Date received</label><input class="form-control" id="wb-received" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Channel</label><select class="form-control" id="wb-channel"><option value="internal_form">Internal online form</option><option value="email">Email</option><option value="verbal">Verbal (in person)</option><option value="post">Post</option><option value="external">External reporting channel</option></select></div>
      <div class="form-group"><label>Reporter type</label><select class="form-control" id="wb-reporter-type" onchange="toggleWbReporter(this)"><option value="anonymous">Anonymous</option><option value="named">Named — identity recorded separately</option></select></div>
    </div>
    <div id="wb-named-fields" style="display:none;">
      <div class="alert-bar alert-amber" style="margin-bottom:8px;"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Reporter identity is stored in a <strong>separate secure record</strong> and is not visible in the main case register. Only the assigned handler can access it.</span></div>
      <div class="form-row">
        <div class="form-group"><label>Reporter name</label><input class="form-control" id="wb-reporter-name" placeholder="Full name"></div>
        <div class="form-group"><label>Reporter contact</label><input class="form-control" id="wb-reporter-contact" placeholder="Email or phone"></div>
      </div>
    </div>
    <div class="form-row"><div class="form-group"><label>Case summary (do not include identifying details)</label><textarea class="form-control" id="wb-summary" rows="3" placeholder="Factual summary of the report — keep identity-neutral…"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Assigned handler</label><input class="form-control" id="wb-handler" placeholder="Name of the case handler"></div>
      <div class="form-group"><label>Alleged persons / entities involved</label><input class="form-control" id="wb-alleged" placeholder="Names / departments (if known)"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-wb')">Cancel</button><button class="btn btn-primary" onclick="saveWb()">Log report</button></div>
  </div>
</div>

<!-- UPLOAD POLICY MODAL -->
<div class="overlay" id="modal-upload-policy">
  <div class="modal">
    <div class="modal-title">Upload document</div>
    <div class="modal-sub">PDF, Word, Excel or text files · Max 20MB · Stored securely on your server</div>
    <input type="hidden" id="upload-module-target" value="">
    <div class="form-row"><div class="form-group"><label>Document title</label><input class="form-control" id="upload-title" placeholder="e.g. Data Protection Policy v2.1"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Document type</label><select class="form-control" id="upload-doc-type"><option value="policy">Policy</option><option value="template">Template</option><option value="procedure">Procedure</option><option value="guidance">Guidance</option><option value="external">External reference</option></select></div>
      <div class="form-group"><label>Jurisdictions (optional)</label><input class="form-control" id="upload-jurisdictions" placeholder="e.g. BE, FR — or leave blank for all"></div>
    </div>
    <div class="form-group" style="margin-bottom:10px;"><label>File</label>
      <div style="border:2px dashed var(--cream-dark);border-radius:var(--r-lg);padding:20px;text-align:center;cursor:pointer;background:var(--cream);" onclick="document.getElementById('upload-file-input').click()">
        <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:var(--text-faint);fill:none;stroke-width:1.85;margin-bottom:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <div style="font-size:12px;color:var(--text-muted);" id="upload-file-label">Click to choose file</div>
      </div>
      <input type="file" id="upload-file-input" style="display:none" accept=".pdf,.docx,.doc,.xlsx,.txt,.md" onchange="document.getElementById('upload-file-label').textContent=this.files[0]?.name||'Click to choose file'">
    </div>
    <div class="form-row"><div class="form-group"><label>Add to Knowledge Base?</label><select class="form-control" id="upload-kb"><option value="yes">Yes — make searchable in Knowledge Base</option><option value="no">No — compliance module only</option></select></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-upload-policy')">Cancel</button><button class="btn btn-primary" onclick="uploadPolicy()">Upload document</button></div>
  </div>
</div>

<!-- ADD ADVICE NOTE MODAL -->
<div class="overlay" id="modal-add-advice">
  <div class="modal modal-wide">
    <div class="modal-title">Add advice note</div>
    <div class="modal-sub">Record internal guidance, legal analysis or Mickey-generated advice</div>
    <input type="hidden" id="advice-module-target" value="">
    <div class="form-row"><div class="form-group"><label>Title</label><input class="form-control" id="advice-title" placeholder="e.g. Analysis: legitimate interest for direct marketing"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Type</label><select class="form-control" id="advice-type"><option value="advice">Advice note</option><option value="analysis">Legal analysis</option><option value="position">Legal position</option><option value="ai_output">Mickey-generated guidance</option></select></div>
      <div class="form-group"><label>Date</label><input class="form-control" id="advice-date" type="date"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Content</label><textarea class="form-control" id="advice-content" rows="6" placeholder="The advice, analysis or guidance…"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Jurisdictions (optional)</label><input class="form-control" id="advice-jurisdictions" placeholder="e.g. BE, FR — or leave blank for all"></div>
      <div class="form-group"><label>Add to Knowledge Base?</label><select class="form-control" id="advice-kb"><option value="yes">Yes — make searchable in Knowledge Base</option><option value="no">No — compliance module only</option></select></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-add-advice')">Cancel</button><button class="btn btn-primary" onclick="saveAdviceNote()">Save note</button></div>
  </div>
</div>

<!-- INVITE USER MODAL -->
<div class="overlay" id="modal-invite">
  <div class="modal">
    <div class="modal-title">Invite team member</div>
    <div class="modal-sub">They will receive an email invitation to set their password and join your firm</div>
    <div class="form-row">
      <div class="form-group"><label>Full name</label><input class="form-control" id="invite-name" placeholder="Full name"></div>
      <div class="form-group"><label>Email address</label><input class="form-control" id="invite-email" type="email" placeholder="name@company.com"></div>
    </div>
    <div class="form-group" style="margin-bottom:12px;"><label>Role</label>
      <select class="form-control" id="invite-role">
        <option value="viewer">Viewer — read-only access to assigned modules</option>
        <option value="editor">Editor — can create and edit records</option>
        <option value="admin">Admin — full access including user management</option>
      </select>
    </div>
    <div class="form-section-label">Module access</div>
    <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Select which modules this user can see. Unselected modules are hidden entirely from their sidebar.</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:4px;">
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-compliance" value="compliance"> Compliance (GDPR / ABC)</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-wb" value="whistleblowing"> Whistleblowing</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-documents" value="documents" checked> Documents</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-corporate" value="corporate" checked> Corporate</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-radar" value="radar" checked> Legal Radar</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:7px 10px;background:var(--cream);border-radius:var(--r);cursor:pointer;"><input type="checkbox" id="inv-mod-knowledge" value="knowledge" checked> Knowledge Base</label>
    </div>
    <div class="alert-bar alert-amber" style="margin-top:10px;">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span>Whistleblowing is hidden by default. Only enable for designated case handlers.</span>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-invite')">Cancel</button><button class="btn btn-primary" onclick="inviteUser()">Send invitation</button></div>
  </div>
</div>

<!-- ENTITY PICKER MODAL (for export firm name) -->
<div class="overlay" id="modal-entity-picker">
  <div class="modal" style="width:420px;">
    <div class="modal-title">Select legal entity</div>
    <div class="modal-sub">Choose which entity this register belongs to. The name will appear on the exported document.</div>
    <div class="form-group">
      <label>Legal entity</label>
      <select class="form-control" id="entity-picker-select"></select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-entity-picker')">Cancel</button>
      <button class="btn btn-primary" onclick="doExportWithEntity()">Export</button>
    </div>
  </div>
</div>

<!-- AI IMPORT MODAL -->
<div class="overlay" id="modal-import">
  <div class="modal modal-wide" style="width:700px;max-width:96vw;">
    <div class="modal-title">Import register — AI column mapping</div>
    <div class="modal-sub">Upload an existing Excel or Word register. Mickey will read the file and map the columns to the correct fields, even if the names differ. Review the preview before confirming.</div>
    <!-- Step 1: upload -->
    <div id="import-step-upload">
      <div id="import-drop-zone" style="border:2px dashed var(--cream-dark);border-radius:var(--r);padding:32px;text-align:center;cursor:pointer;transition:border-color .2s;" onclick="document.getElementById('import-file-input').click()" ondragover="event.preventDefault();this.style.borderColor='var(--green)'" ondragleave="this.style.borderColor='var(--cream-dark)'" ondrop="importHandleDrop(event)">
        <svg viewBox="0 0 24 24" style="width:36px;height:36px;stroke:var(--text-faint);stroke-width:1.5;fill:none;margin-bottom:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <div style="font-size:13px;color:var(--text-mid);margin-bottom:4px;">Drop file here or click to browse</div>
        <div style="font-size:11px;color:var(--text-faint);">Excel (.xlsx) or Word (.docx) · max 20 MB</div>
      </div>
      <input type="file" id="import-file-input" accept=".xlsx,.docx" style="display:none;" onchange="importFileSelected(this)">
      <div id="import-file-name" style="margin-top:10px;font-size:12px;color:var(--text-muted);text-align:center;"></div>
    </div>
    <!-- Step 2: loading -->
    <div id="import-step-loading" style="display:none;text-align:center;padding:32px 0;">
      <div class="thinking-dots" style="justify-content:center;margin-bottom:12px;"><span></span><span></span><span></span></div>
      <div style="font-size:13px;color:var(--text-mid);">Mickey is reading the file and mapping columns…</div>
      <div style="font-size:11px;color:var(--text-faint);margin-top:4px;">This takes a few seconds</div>
    </div>
    <!-- Step 3: preview -->
    <div id="import-step-preview" style="display:none;">
      <div id="import-mapping-info" style="font-size:12px;color:var(--text-mid);margin-bottom:12px;padding:10px 12px;background:var(--cream);border-radius:var(--r);"></div>
      <div style="overflow-x:auto;max-height:300px;border:1px solid var(--cream-dark);border-radius:var(--r);">
        <table id="import-preview-table" style="width:100%;border-collapse:collapse;font-size:11px;">
          <thead id="import-preview-head" style="position:sticky;top:0;background:var(--green);color:#fff;"></thead>
          <tbody id="import-preview-body"></tbody>
        </table>
      </div>
      <div id="import-skipped-note" style="font-size:11px;color:var(--text-faint);margin-top:8px;"></div>
    </div>
    <!-- Step 4: error -->
    <div id="import-step-error" style="display:none;padding:20px;text-align:center;">
      <div style="color:var(--red);font-size:13px;" id="import-error-msg"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="importReset()">Cancel</button>
      <button class="btn btn-primary" id="import-upload-btn" onclick="importUpload()">Analyse file</button>
      <button class="btn btn-primary" id="import-confirm-btn" style="display:none;" onclick="importConfirm()">Import <span id="import-count"></span> records</button>
    </div>
  </div>
</div>

      <!-- INFO & SETTINGS (merged: admin + info/legal + settings + storage) -->
      <div class="module" id="mod-settings">
        <div style="font-family:var(--font-serif);font-size:22px;font-weight:400;margin-bottom:4px;">Info &amp; Settings</div>
        <div style="font-size:12.5px;color:var(--text-muted);margin-bottom:22px;">Account, security, legal documents, storage and admin controls</div>
        <div style="display:flex;gap:0;margin-bottom:22px;border-bottom:2px solid var(--cream-mid);">
          <button class="md-tab active" onclick="switchSettingsTab(this,'account')">Account</button>
          <button class="md-tab" onclick="switchSettingsTab(this,'storage')">Storage</button>
          <button class="md-tab" onclick="switchSettingsTab(this,'legal')">Info &amp; Legal</button>
          <button class="md-tab" id="settings-tab-admin" onclick="switchSettingsTab(this,'admin')" style="display:none;">Admin</button>
        </div>

        <div id="stab-account">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:900px;">
            <div>
              <div class="panel" style="margin-bottom:14px;"><div class="panel-title">Account</div><div class="panel-sub" id="settings-info">—</div></div>
              <div class="panel"><div class="panel-title">Change password</div><div class="form-group" style="margin-top:10px;"><label>Current password</label><input type="password" id="pw-current" placeholder="••••••••"></div><div class="form-group"><label>New password</label><input type="password" id="pw-new" placeholder="Min 8 chars, number, uppercase, special"></div><div class="form-group"><label>Confirm</label><input type="password" id="pw-new2" placeholder="Repeat"></div><button class="btn btn-primary" onclick="changePw()">Change Password</button></div>
            </div>
            <div>
              <div class="panel"><div class="panel-title">Data &amp; Privacy</div><div class="panel-sub">Your rights under GDPR Art. 15, 17 and 20. Requests are reviewed by your admin.</div><div id="my-data-requests" style="margin:12px 0;"></div><div style="display:flex;gap:8px;flex-wrap:wrap;"><button class="btn" onclick="submitDataRequest('export')">&#128230; Request my data export</button><button class="btn btn-danger" onclick="submitDataRequest('deletion')">&#128465; Request account deletion</button></div><div class="info-box" style="margin-top:12px;"><strong>Export</strong> — receive a zip of your workspace documents, collections, and usage logs.<br><strong>Deletion</strong> — permanently removes your account and all associated data.</div></div>
            </div>
          </div>
        </div>

        <div id="stab-storage" style="display:none;">
          <div id="folder-list" style="margin-bottom:20px;"></div>
          <div class="section-label">Add a folder</div>
          <div class="panel" style="max-width:600px;">
            <div class="form-group"><label>Label</label><input type="text" id="st-label" placeholder="e.g. Work — OneDrive, Client Files…"></div>
            <div class="form-group"><label>Full folder path</label><input type="text" id="st-path" placeholder="e.g. C:\Users\YourName\OneDrive\Legal"></div>
            <details style="margin-bottom:14px;"><summary style="font-size:11px;color:var(--text-muted);cursor:pointer;">How to find your path</summary><div style="margin-top:8px;font-size:12px;color:var(--text-mid);line-height:1.8;padding:10px;background:var(--cream);border-radius:var(--r);"><strong>OneDrive:</strong> C:\Users\Name\OneDrive - Company\Work<br><strong>Google Drive:</strong> C:\Users\Name\Google Drive\My Drive<br><em>Tip: In Windows Explorer, click the address bar and copy the path</em></div></details>
            <button class="btn btn-primary" onclick="addFolder()">Add &amp; sync folder</button>
            <span id="st-status" style="margin-left:10px;font-size:12px;color:var(--text-muted);"></span>
          </div>
          <div id="sync-all-wrap" style="margin-top:16px;display:none;"><button class="btn" onclick="syncAll()">&#128260; Sync all folders</button></div>
        </div>

        <div id="stab-legal" style="display:none;">
          <div style="display:flex;gap:8px;margin-bottom:16px;">
            <button class="btn btn-sm" id="info-tab-terms" onclick="showInfoTab('terms')">Terms of use</button>
            <button class="btn btn-sm" id="info-tab-privacy" onclick="showInfoTab('privacy')">Privacy notice</button>
            <button class="btn btn-sm" id="info-tab-disclaimer" onclick="showInfoTab('disclaimer')">AI disclaimer</button>
          </div>
          <div class="result-box" id="info-content" style="min-height:300px;font-family:var(--font-serif);font-size:14px;line-height:1.7;">Select a document above</div>
        </div>

        <div id="stab-admin" style="display:none;">
          <div class="section-label">User management</div>
          <div style="overflow-x:auto;margin-bottom:20px;"><table class="admin-table"><thead><tr><th>Name</th><th>Username</th><th>Role</th><th>Created</th><th>Usage (7d)</th><th>Actions</th></tr></thead><tbody id="admin-user-tbody"></tbody></table></div>
          <div class="section-label">Pending data requests</div>
          <div id="admin-data-requests" style="margin-bottom:20px;"><div style="color:var(--text-muted);font-size:13px;">Loading…</div></div>
          <div class="section-label">API Keys</div>
          <div class="panel" style="max-width:560px;margin-bottom:12px;"><div class="panel-title">Anthropic (Claude)</div><div class="panel-sub" id="admin-key-status">Checking…</div><div class="form-group" style="margin-top:10px;"><label>Anthropic API Key</label><input type="password" id="admin-key-input" placeholder="sk-ant-api03-…"></div><button class="btn btn-primary" onclick="saveKey()">Save Anthropic Key</button></div>
          <div class="panel" style="max-width:560px;margin-bottom:12px;"><div class="panel-title">OpenAI (Semantic Search)</div><div class="panel-sub" id="admin-oai-status">Checking…</div><div class="form-group" style="margin-top:10px;"><label>OpenAI API Key</label><input type="password" id="admin-oai-input" placeholder="sk-…"></div><button class="btn btn-primary" onclick="saveOaiKey()">Save OpenAI Key</button></div>
          <div class="section-label">Usage (last 7 days)</div>
          <div id="admin-usage-wrap" style="margin-bottom:20px;"></div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<div class="toast" id="toast"></div>

<div id="col-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;align-items:center;justify-content:center;">
  <div style="background:var(--white);border-radius:14px;padding:28px;width:420px;max-width:90vw;animation:fadeUp .2s ease;border:1px solid var(--cream-mid);">
    <div style="font-family:var(--font-serif);font-size:19px;font-weight:500;margin-bottom:4px;">Save to collection</div>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px;" id="col-modal-title"></div>
    <div class="form-group"><label>Choose collection</label><select id="col-modal-select" style="width:100%;padding:8px 11px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:13px;background:var(--cream);"><option value="">Loading...</option></select></div>
    <div style="display:flex;gap:8px;"><button class="btn btn-primary" onclick="confirmSaveToCollection()" style="flex:1;">Save</button><button class="btn" onclick="closeColModal()">Cancel</button></div>
    <div style="margin-top:10px;border-top:1px solid var(--cream-mid);padding-top:10px;"><div style="display:flex;gap:8px;"><input type="text" id="col-modal-new" style="flex:1;padding:7px 10px;border:1px solid var(--cream-dark);border-radius:var(--r);font-family:var(--font-sans);font-size:13px;background:var(--cream);" placeholder="Or create new collection..."><button class="btn btn-sm" onclick="createAndSave()">Create &amp; save</button></div></div>
  </div>
</div>
<script>
let chatHistory=[],displayName='',isAdmin=false;
// ── Module registry ─────────────────────────────────────────────
// To add a new module: add entry here + nav-item + mod-* div.
// scalable: go() reads this map — nothing else needs changing.
const topbars={
  dashboard: 'Dashboard',
  discovery: 'Discovery',
  radar:     'Legal Radar',
  review:    'Documents',
  compare:   'Documents',
  draft:     'Documents',
  translate: 'Documents',
  vault:     'Corporate',
  minutes:   'Corporate',
  duediligence: 'Corporate',
  collections: 'Collections',
  knowledge:  'Knowledge Base',
  playbooks:  'Playbooks',
  compliance: 'Compliance',
  settings:   'Info & Settings',
};
let csrfToken='';
function ch(){return{'Content-Type':'application/json','X-CSRF-Token':csrfToken};}
async function chHeaders(){
  if(!csrfToken){try{const r=await fetch('/api/csrf');const d=await r.json();if(d.token)csrfToken=d.token;}catch(e){}}
  return{'Content-Type':'application/json','X-CSRF-Token':csrfToken};
}

// ── Widget store ────────────────────────────────────────────────
// Each module calls widgetPush(key, data) to surface data on dashboard.
// Dashboard widgets read from widgetStore[key].
// Scalable: adding a new module = call widgetPush, dashboard auto-picks up.
const widgetStore = {};
function widgetPush(key, data){
  widgetStore[key] = data;
  // If dashboard is currently active, refresh relevant widget
  const dash = document.getElementById('mod-dashboard');
  if(dash && dash.classList.contains('active')){
    renderDashboardWidgets();
  }
}
function renderDashboardWidgets(){
  // Corporate alerts widget
  const corpAlerts = widgetStore['corporate_alerts'] || [];
  const corpEl = document.getElementById('widget-corp-alerts');
  if(corpEl){
    const urgent = corpAlerts.filter(a=>a.level==='red');
    const warn   = corpAlerts.filter(a=>a.level==='amber');
    if(corpAlerts.length===0){
      corpEl.innerHTML = '<div class="widget-empty">No alerts — all entities clear</div>';
    } else {
      corpEl.innerHTML = [...urgent,...warn].slice(0,5).map(a=>`
        <div class="widget-item">
          <div style="width:6px;height:6px;border-radius:50%;background:${a.level==='red'?'#E85D4A':'var(--amber)'};flex-shrink:0;"></div>
          <div style="flex:1;min-width:0;"><div style="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${a.entity}</div><div style="font-size:11px;color:var(--text-muted);">${a.message}</div></div>
        </div>`).join('');
    }
  }
}

async function init(){
  const h=new Date().getHours();
  const greet=h<12?'Good morning':h<17?'Good afternoon':'Good evening';
  document.getElementById('dash-greeting-text').textContent=greet;
  const now=new Date();
  document.getElementById('dash-date-text').textContent=now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  const r=await fetch('/api/auth/status');const d=await r.json();
  if(d.logged_in){
    if(d.csrf_token)csrfToken=d.csrf_token;
    showApp(d.display_name,d.is_admin);
  } else {
    window.location.href='/signin';
  }
}

function showApp(name,admin){
  displayName=name;isAdmin=admin;
  document.getElementById('app').classList.add('visible');
  document.getElementById('sidebar-user').textContent=name;
  document.getElementById('hero-name').textContent=name+'?';
  const parts=name.trim().split(' ');
  const initials=parts.length>=2?parts[0][0]+parts[parts.length-1][0]:name.slice(0,2);
  document.getElementById('sb-avatar-initials').textContent=initials.toUpperCase();
  if(admin){
    document.getElementById('sidebar-admin').style.display='inline-block';
    document.getElementById('settings-tab-admin').style.display='';
    if(document.getElementById('nav-admin-library'))document.getElementById('nav-admin-library').style.display='block';
  }
  loadStats();loadWorkspace();loadLibrary();loadDashStats();
  if(localStorage.getItem('mickey-sidebar')==='1'){
    document.querySelector('.sidebar')?.classList.add('collapsed');
    const icon=document.getElementById('toggle-icon');
    if(icon)icon.innerHTML='<path d="M9 18l6-6-6-6"/>';
  }
  document.getElementById('radar-badge').style.display='flex';
  // Restore last visited page
  try{
    const lastPage=localStorage.getItem('mickey-page');
    if(lastPage&&lastPage!=='dashboard')go(lastPage);
  }catch(e){}
}

function loadDashStats(){
  const matters=document.querySelectorAll('#mod-dashboard .matter-item').length;
  const urgent=document.querySelectorAll('#mod-dashboard .matter-dot.dot-urgent').length;
  const radar=document.querySelectorAll('#mod-dashboard .radar-card-s').length;
  const radarReq=document.querySelectorAll('#mod-dashboard .rc-tag-req').length;
  if(document.getElementById('dash-matters-count'))document.getElementById('dash-matters-count').textContent=matters||'—';
  if(document.getElementById('dash-matters-sub'))document.getElementById('dash-matters-sub').textContent=urgent>0?`${urgent} need attention`:'Up to date';
  if(document.getElementById('dash-radar-count'))document.getElementById('dash-radar-count').textContent=radar||'—';
  if(document.getElementById('dash-radar-sub'))document.getElementById('dash-radar-sub').textContent=radarReq>0?`${radarReq} action required`:'No urgent alerts';
}

function showRegister(){document.getElementById('login-panel').style.display='none';document.getElementById('register-panel').style.display='block';}
function showLogin(){document.getElementById('register-panel').style.display='none';document.getElementById('login-panel').style.display='block';}

async function doLogin(){
  const u=document.getElementById('login-user').value.trim();const pw=document.getElementById('login-pw').value;
  const err=document.getElementById('login-error');err.style.display='none';
  const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:pw})});
  const d=await r.json();
  if(d.error){err.textContent=d.error;err.style.display='block';return;}
  if(d.csrf_token)csrfToken=d.csrf_token;
  showApp(d.display_name,d.is_admin);
}

async function doRegister(){
  const name=document.getElementById('reg-name').value.trim();const u=document.getElementById('reg-user').value.trim();
  const pw=document.getElementById('reg-pw').value;const pw2=document.getElementById('reg-pw2').value;
  const err=document.getElementById('reg-error');err.style.display='none';
  const r=await fetch('/api/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({display_name:name,username:u,password:pw,confirm:pw2})});
  const d=await r.json();
  if(d.error){err.textContent=d.error;err.style.display='block';return;}
  if(d.csrf_token)csrfToken=d.csrf_token;
  showApp(d.display_name,d.is_admin);
}

async function doSignout(){ window.location.href="/auth/signout-get"; }

function go(id,el){
  document.querySelectorAll('.module').forEach(m=>{m.classList.remove('active');m.style.display='none';});
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const mod=document.getElementById('mod-'+id);
  if(mod){mod.classList.add('active');mod.style.display=id==='compliance'?'flex':'block';}
  // Highlight the correct nav-item (Documents/Corporate share one nav item)
  if(el){el.classList.add('active');}
  else{
    // find by data-mod; for grouped modules find the parent nav item
    const navMap={'compare':'review','draft':'review','translate':'review',
                  'duediligence':'vault'};
    const navId=navMap[id]||id;
    const navEl=document.querySelector('[data-mod="'+navId+'"]');
    if(navEl)navEl.classList.add('active');
  }
  const title=topbars[id];
  if(title)document.getElementById('topbar-title').textContent=title;
  if(id==='settings'){loadSettingsInfo();if(isAdmin){loadAdminUsers();loadKeyStatus();loadAdminDataRequests();}loadMyDataRequests();}
  if(id==='knowledge')loadKnowledgeBase();
  if(id==='collections')loadCollections();
  if(id==='storage')loadStorage();
  if(id==='vault')chLoadOnVaultOpen();
  if(id==='compliance'){compInit();}
  // Persist page across reloads
  try{localStorage.setItem('mickey-page',id);}catch(e){}
}

function switchSettingsTab(btn,tab){
  document.querySelectorAll('#mod-settings .md-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ['account','storage','legal','admin'].forEach(t=>{const el=document.getElementById('stab-'+t);if(el)el.style.display=t===tab?'':'none';});
  if(tab==='admin'){loadAdminUsers();loadKeyStatus();loadAdminDataRequests();}
  if(tab==='storage')loadStorage();
  if(tab==='legal')showInfoTab('terms');
}

function corpTab(name, btn){
  // Only housekeeping is built — others are placeholders
  if(name !== 'housekeeping') return;
  document.querySelectorAll('.corp-mod-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
}

function toggleSidebar(){
  const sb=document.querySelector('.sidebar');const icon=document.getElementById('toggle-icon');
  sb.classList.toggle('collapsed');const collapsed=sb.classList.contains('collapsed');
  icon.innerHTML=collapsed?'<path d="M9 18l6-6-6-6"/>':'<path d="M15 18l-6-6 6-6"/>';
  localStorage.setItem('mickey-sidebar',collapsed?'1':'0');
}

function heroAsk(){const q=document.getElementById('hero-input').value.trim();if(!q)return;document.getElementById('hero-input').value='';sendChat(q);}
function askSug(card){sendChat(card.querySelector('.sug-text').textContent);}

async function sendChat(question){
  document.getElementById('sug-wrap').style.display='none';
  const ca=document.getElementById('chat-area');ca.style.display='flex';
  ca.insertAdjacentHTML('beforeend',`<div class="chat-user"><div class="bubble-user">${esc(question)}</div></div>`);
  const tid='t'+Date.now();
  ca.insertAdjacentHTML('beforeend',`<div class="chat-mickey" id="${tid}"><div class="mickey-av">M</div><div class="bubble-thinking"><div class="thinking-dots"><span></span><span></span><span></span></div><span style="font-size:11px;color:var(--text-faint);margin-left:4px">Thinking…</span></div></div>`);
  ca.scrollTop=ca.scrollHeight;
  chatHistory.push({role:'user',content:question});
  const useWeb=document.getElementById('web-toggle').checked;
  const r=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question,history:chatHistory.slice(0,-1),web_search:useWeb})});
  const d=await r.json();document.getElementById(tid).remove();
  if(d.error){
    if(d.need_key){toast('API key not configured — contact your admin',true);chatHistory.pop();return;}
    ca.insertAdjacentHTML('beforeend',`<div class="chat-mickey"><div class="mickey-av">M</div><div class="bubble-mickey" style="color:var(--red)">${esc(d.error)}</div></div>`);
    chatHistory.pop();
  }else{
    const ansId='a'+Date.now();
    ca.insertAdjacentHTML('beforeend',`<div class="chat-mickey"><div class="mickey-av">M</div><div style="flex:1"><div class="bubble-mickey md" id="${ansId}">${md(d.answer)}</div><div style="margin-top:5px;padding-left:2px"><button class="btn btn-sm" style="font-size:9.5px;padding:4px 10px;" onclick="openSaveToCollection('${ansId}','${esc(question.slice(0,60))}')">&#9733; Save to collection</button></div></div></div>`);
    chatHistory.push({role:'assistant',content:d.answer});
    document.getElementById('clear-btn').style.display='inline-flex';
    document.getElementById('disclaimer-bar').style.display='flex';
  }
  ca.scrollTop=ca.scrollHeight;
}

function clearChat(){
  chatHistory=[];document.getElementById('chat-area').innerHTML='';document.getElementById('chat-area').style.display='none';
  document.getElementById('sug-wrap').style.display='block';document.getElementById('clear-btn').style.display='none';
}

function radarAsk(card){document.getElementById('radar-input').value=card.querySelector('.sug-text').textContent;radarCustom();}
async function radarCustom(){
  const q=document.getElementById('radar-input').value.trim();if(!q)return;
  const box=document.getElementById('radar-result');box.classList.remove('empty');box.textContent='Mickey is checking…';
  const useWeb=document.getElementById('web-toggle').checked;
  const r=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,history:[],web_search:useWeb})});
  const d=await r.json();
  if(d.error){box.innerHTML=`<span style="color:var(--red)">${esc(d.error)}</span>`;box.classList.add('empty');}
  else{box.innerHTML='<div class="md" style="font-family:var(--font-sans);font-size:13px;line-height:1.65;">'+md(d.answer)+'</div><div style="margin-top:10px"><button class="btn btn-sm" style="font-size:9.5px" onclick="openSaveModal(document.getElementById(\'radar-result\').innerText,\'Legal Radar Answer\',\'radar\')">&#9733; Save to collection</button></div>';box.classList.remove('empty');}
}

// ══════════════════════════════════════════════════════════════
// DOCUMENTS MODULE
// ══════════════════════════════════════════════════════════════

// ── Tab navigation ────────────────────────────────────────────
function docsTab(name, btn) {
  document.querySelectorAll('.docs-mod-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.docs-tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  const panel = document.getElementById('dtab-' + name);
  if (panel) panel.classList.add('active');
}

// ── UI helpers ────────────────────────────────────────────────
function docsAudience(card, groupId) {
  document.querySelectorAll('#' + groupId + ' .docs-aud-card').forEach(c => c.classList.remove('active'));
  card.classList.add('active');
}
function docsChip(chip) {
  chip.classList.toggle('active');
}
function docsSegSelect(btn, segId) {
  document.querySelectorAll('#' + segId + ' .docs-seg-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function docsCmpMode(card) {
  document.querySelectorAll('#cmp-mode-grid .docs-mode-card').forEach(c => c.classList.remove('active'));
  card.classList.add('active');
  const mode = card.dataset.mode;
  document.getElementById('cmp-file2-zone').style.display = mode === 'draft' ? '' : 'none';
  document.getElementById('cmp-playbook-zone').style.display = mode === 'playbook' ? '' : 'none';
}
function docsAnonPreset(card) {
  document.querySelectorAll('#anon-preset-grid .docs-mode-card').forEach(c => c.classList.remove('active'));
  card.classList.add('active');
}
function docsDraftMode(mode, btn) {
  document.querySelectorAll('#draft-mode-seg .docs-seg-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const zone = document.getElementById('draft-upload-zone');
  const label = document.getElementById('draft-upload-label');
  if (mode === 'new') {
    zone.style.display = 'none';
  } else {
    zone.style.display = '';
    label.textContent = mode === 'improve' ? 'Upload clause to improve' : 'Upload their clause for counter-proposal';
  }
}

function docsShowFile(inputId, fnameId) {
  const file = document.getElementById(inputId).files[0];
  const el = document.getElementById(fnameId);
  if (!file) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  el.innerHTML = `<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>${esc(file.name)}`;
}

function docsGetChips(containerId) {
  return Array.from(document.querySelectorAll('#' + containerId + ' .docs-chip.active'))
    .map(c => c.textContent).join(', ');
}
function docsGetAudience(groupId) {
  const active = document.querySelector('#' + groupId + ' .docs-aud-card.active');
  return active ? active.textContent.trim() : 'Myself';
}
function docsGetSeg(segId) {
  const active = document.querySelector('#' + segId + ' .docs-seg-btn.active');
  return active ? active.textContent.trim() : '';
}

function docsShowOcr(show) {
  document.getElementById('docs-ocr-banner').style.display = show ? 'flex' : 'none';
}

function docsSetLoading(panelId, msg) {
  const p = document.getElementById(panelId);
  p.innerHTML = `<div class="docs-loading"><span class="spinner"></span>${msg}</div>`;
}

function docsShowResult(panelId, html, meta, obligations, actions) {
  const p = document.getElementById(panelId);
  let out = '';
  if (meta && meta.length) {
    out += '<div class="docs-result-meta">' + meta.map(m =>
      `<span class="dmeta ${m.cls}">${esc(m.text)}</span>`
    ).join('') + '</div>';
  }
  out += `<div class="docs-result-content">${html}</div>`;
  if (obligations && obligations.length) {
    out += `<div class="docs-obligations"><h4>Obligations &amp; deadlines extracted</h4>` +
      obligations.slice(0, 8).map(o => `<div class="docs-obl-item">${esc(o.description || o)}</div>`).join('') +
      '</div>';
  }
  if (actions && actions.length) {
    out += '<div class="docs-result-actions">' + actions.join('') + '</div>';
  }
  p.innerHTML = out;
}

// ── Anonymous custom fields ───────────────────────────────────
let docsCustomFieldCount = 0;
function docsAddCustomField() {
  docsCustomFieldCount++;
  const id = docsCustomFieldCount;
  const list = document.getElementById('anon-custom-list');
  const row = document.createElement('div');
  row.className = 'docs-custom-row';
  row.id = 'anon-custom-' + id;
  row.innerHTML = `
    <input type="text" placeholder="Find…" id="anon-cf-find-${id}">
    <input type="text" placeholder="Replace with…" id="anon-cf-replace-${id}">
    <button class="docs-custom-del" onclick="document.getElementById('anon-custom-${id}').remove()">×</button>`;
  list.appendChild(row);
}
function docsGetCustomFields() {
  const rows = document.querySelectorAll('#anon-custom-list .docs-custom-row');
  const result = [];
  rows.forEach(row => {
    const id = row.id.replace('anon-custom-', '');
    const find = document.getElementById('anon-cf-find-' + id)?.value?.trim();
    const replace = document.getElementById('anon-cf-replace-' + id)?.value?.trim();
    if (find) result.push({ find, replace: replace || '[REDACTED]' });
  });
  return result;
}

// ── REVIEW ────────────────────────────────────────────────────
async function docsRunReview() {
  const file = document.getElementById('review-file').files[0];
  if (!file) { toast('Upload a document first', true); return; }
  docsSetLoading('review-result-panel', 'Mickey is reviewing your document…');
  docsShowOcr(false);
  const headers = await chHeaders();
  const fd = new FormData();
  fd.append('file', file);
  fd.append('focus', docsGetChips('review-tags'));
  fd.append('playbook', document.getElementById('review-pb').value);
  fd.append('extra', document.getElementById('review-extra').value);
  fd.append('audience', docsGetAudience('review-audience'));
  fd.append('perspective', 'Neutral');
  fd.append('_csrf', headers['X-CSRF-Token']);
  try {
    const r = await fetch('/api/docs/review', { method: 'POST', body: fd, headers: { 'X-CSRF-Token': headers['X-CSRF-Token'] } });
    const d = await r.json();
    if (d.error) { docsShowResult('review-result-panel', `<p style="color:var(--red)">${esc(d.error)}</p>`); return; }
    if (d.ocr_needed) docsShowOcr(true);
    const meta = [
      { text: file.name, cls: 'dmeta-green' },
      d.pages ? { text: d.pages + ' pages', cls: 'dmeta-blue' } : null,
      d.ocr_needed ? { text: 'OCR', cls: 'dmeta-amber' } : null,
    ].filter(Boolean);
    const actions = [
      `<button class="btn btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('#review-result-panel .docs-result-content').innerText)">Copy text</button>`,
      `<button class="btn btn-sm btn-primary" onclick="docsTab('compare',document.querySelector('.docs-mod-tab:nth-child(2)'))">Compare this →</button>`
    ];
    docsShowResult('review-result-panel', md(d.result), meta, d.obligations, actions);
    if (d.obligations && d.obligations.length) widgetPush('doc_obligations', d.obligations);
  } catch(e) { docsShowResult('review-result-panel', `<p style="color:var(--red)">Error: ${esc(e.message)}</p>`); }
}

// ── COMPARE ───────────────────────────────────────────────────
async function docsRunCompare() {
  const file = document.getElementById('cmp-file').files[0];
  if (!file) { toast('Upload your document first', true); return; }
  const activeMode = document.querySelector('#cmp-mode-grid .docs-mode-card.active');
  const mode = activeMode ? activeMode.dataset.mode : 'draft';
  if (mode === 'draft' && !document.getElementById('cmp-file2').files[0]) {
    toast('Upload the reference document too', true); return;
  }
  docsSetLoading('compare-result-panel', 'Mickey is comparing…');
  const headers = await chHeaders();
  const fd = new FormData();
  fd.append('file', file);
  fd.append('mode', mode);
  fd.append('focus', docsGetChips('cmp-tags'));
  if (mode === 'draft') fd.append('file2', document.getElementById('cmp-file2').files[0]);
  if (mode === 'playbook') fd.append('playbook', document.getElementById('cmp-playbook').value);
  try {
    const r = await fetch('/api/docs/compare', { method: 'POST', body: fd, headers: { 'X-CSRF-Token': headers['X-CSRF-Token'] } });
    const d = await r.json();
    if (d.error) { docsShowResult('compare-result-panel', `<p style="color:var(--red)">${esc(d.error)}</p>`); return; }
    const modeLabel = {draft:'vs own draft', playbook:'vs playbook', contracts:'vs signed contracts', market:'vs market standard'}[mode] || mode;
    const meta = [{ text: file.name, cls: 'dmeta-green' }, { text: modeLabel, cls: 'dmeta-blue' }];
    const actions = [`<button class="btn btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('#compare-result-panel .docs-result-content').innerText)">Copy text</button>`];
    docsShowResult('compare-result-panel', md(d.result), meta, null, actions);
  } catch(e) { docsShowResult('compare-result-panel', `<p style="color:var(--red)">Error: ${esc(e.message)}</p>`); }
}

// ── DRAFT ─────────────────────────────────────────────────────
async function docsRunDraft() {
  const activeMode = document.querySelector('#draft-mode-seg .docs-seg-btn.active');
  const mode = activeMode ? (activeMode.textContent.includes('Improve') ? 'improve' : activeMode.textContent.includes('Counter') ? 'counter' : 'new') : 'new';
  if (mode !== 'new' && !document.getElementById('draft-file').files[0]) {
    toast('Upload the clause first', true); return;
  }
  docsSetLoading('draft-result-panel', 'Mickey is drafting…');
  const headers = await chHeaders();
  const fd = new FormData();
  fd.append('mode', mode);
  fd.append('doc_type', document.getElementById('draft-type').value);
  fd.append('clause_description', document.getElementById('draft-clause').value);
  fd.append('governing_law', document.getElementById('draft-law').value);
  fd.append('perspective', document.getElementById('draft-persp').value);
  fd.append('instructions', document.getElementById('draft-inst').value);
  if (mode !== 'new') fd.append('file', document.getElementById('draft-file').files[0]);
  try {
    const r = await fetch('/api/docs/draft', { method: 'POST', body: fd, headers: { 'X-CSRF-Token': headers['X-CSRF-Token'] } });
    const d = await r.json();
    if (d.error) { docsShowResult('draft-result-panel', `<p style="color:var(--red)">${esc(d.error)}</p>`); return; }
    const meta = [
      { text: document.getElementById('draft-type').value, cls: 'dmeta-green' },
      { text: document.getElementById('draft-law').value, cls: 'dmeta-blue' },
      { text: mode, cls: 'dmeta-amber' }
    ];
    const actions = [
      `<button class="btn btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('#draft-result-panel .docs-result-content').innerText)">Copy text</button>`,
    ];
    docsShowResult('draft-result-panel', md(d.result), meta, null, actions);
    if (d.mickey_notes && d.mickey_notes.length) {
      const panel = document.getElementById('draft-result-panel');
      panel.innerHTML += `<div class="docs-obligations"><h4>Mickey notes — verify before use</h4>${d.mickey_notes.map(n => `<div class="docs-obl-item">${esc(n)}</div>`).join('')}</div>`;
    }
  } catch(e) { docsShowResult('draft-result-panel', `<p style="color:var(--red)">Error: ${esc(e.message)}</p>`); }
}

// ── SUMMARISE ─────────────────────────────────────────────────
async function docsRunSummarise() {
  const file = document.getElementById('sum-file').files[0];
  if (!file) { toast('Upload a document first', true); return; }
  docsSetLoading('summarise-result-panel', 'Mickey is summarising…');
  docsShowOcr(false);
  const headers = await chHeaders();
  const fd = new FormData();
  fd.append('file', file);
  fd.append('audience', docsGetAudience('sum-audience'));
  fd.append('output_format', docsGetSeg('sum-format-seg').toLowerCase().replace(' ', '_'));
  fd.append('focus_areas', document.getElementById('sum-focus').value);
  try {
    const r = await fetch('/api/docs/summarise', { method: 'POST', body: fd, headers: { 'X-CSRF-Token': headers['X-CSRF-Token'] } });
    const d = await r.json();
    if (d.error) { docsShowResult('summarise-result-panel', `<p style="color:var(--red)">${esc(d.error)}</p>`); return; }
    if (d.ocr_needed) docsShowOcr(true);
    const meta = [
      { text: file.name, cls: 'dmeta-green' },
      d.governing_law ? { text: d.governing_law, cls: 'dmeta-blue' } : null,
      d.parties && d.parties.length ? { text: d.parties.slice(0,2).join(' · '), cls: 'dmeta-amber' } : null,
    ].filter(Boolean);
    const actions = [`<button class="btn btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('#summarise-result-panel .docs-result-content').innerText)">Copy text</button>`];
    docsShowResult('summarise-result-panel', md(d.result), meta, null, actions);
  } catch(e) { docsShowResult('summarise-result-panel', `<p style="color:var(--red)">Error: ${esc(e.message)}</p>`); }
}

// ── TRANSLATE ─────────────────────────────────────────────────
async function docsRunTranslate() {
  const file = document.getElementById('trans-file').files[0];
  if (!file) { toast('Upload a document first', true); return; }
  docsSetLoading('translate-result-panel', 'Mickey is translating…');
  docsShowOcr(false);
  const headers = await chHeaders();
  const fd = new FormData();
  fd.append('file', file);
  fd.append('src_lang', document.getElementById('trans-src').value);
  fd.append('tgt_lang', document.getElementById('trans-tgt').value);
  fd.append('style', docsGetSeg('trans-style-seg'));
  fd.append('extra', document.getElementById('trans-notes').value);
  try {
    const r = await fetch('/api/docs/translate', { method: 'POST', body: fd, headers: { 'X-CSRF-Token': headers['X-CSRF-Token'] } });
    const d = await r.json();
    if (d.error) { docsShowResult('translate-result-panel', `<p style="color:var(--red)">${esc(d.error)}</p>`); return; }
    if (d.ocr_needed) docsShowOcr(true);
    const meta = [
      { text: file.name, cls: 'dmeta-green' },
      { text: d.src_lang + ' → ' + d.tgt_lang, cls: 'dmeta-blue' },
      d.untranslatable && d.untranslatable.length ? { text: d.untranslatable.length + ' translator notes', cls: 'dmeta-amber' } : null,
    ].filter(Boolean);
    const actions = [`<button class="btn btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('#translate-result-panel .docs-result-content').innerText)">Copy translation</button>`];
    docsShowResult('translate-result-panel', md(d.result), meta, null, actions);
  } catch(e) { docsShowResult('translate-result-panel', `<p style="color:var(--red)">Error: ${esc(e.message)}</p>`); }
}

// ── ANONYMISE ─────────────────────────────────────────────────
async function docsRunAnonymise() {
  const file = document.getElementById('anon-file').files[0];
  if (!file) { toast('Upload a document first', true); return; }
  docsSetLoading('anonymise-result-panel', 'Mickey is anonymising…');
  const headers = await chHeaders();
  const activePreset = document.querySelector('#anon-preset-grid .docs-mode-card.active');
  const preset = activePreset ? activePreset.dataset.preset : '';
  const fd = new FormData();
  fd.append('file', file);
  fd.append('preset', preset);
  fd.append('custom_fields', JSON.stringify(docsGetCustomFields()));
  fd.append('include_map', document.getElementById('anon-include-map').checked ? 'true' : 'false');
  try {
    const r = await fetch('/api/docs/anonymise', { method: 'POST', body: fd, headers: { 'X-CSRF-Token': headers['X-CSRF-Token'] } });
    const d = await r.json();
    if (d.error) { docsShowResult('anonymise-result-panel', `<p style="color:var(--red)">${esc(d.error)}</p>`); return; }
    const meta = [
      { text: file.name, cls: 'dmeta-green' },
      { text: d.stats.total_redactions + ' redactions', cls: 'dmeta-blue' },
      { text: d.stats.categories_used.join(', '), cls: 'dmeta-amber' },
    ];
    const actions = [`<button class="btn btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('#anonymise-result-panel .docs-result-content').innerText)">Copy anonymised text</button>`];
    docsShowResult('anonymise-result-panel', '<pre style="white-space:pre-wrap;font-family:var(--font-sans);font-size:12.5px;line-height:1.7;">' + esc(d.result) + '</pre>', meta, null, actions);
    // Redaction map
    if (d.redaction_map && d.redaction_map.length) {
      const panel = document.getElementById('anonymise-result-panel');
      let mapHtml = '<div class="docs-redaction-map"><h4>Redaction map</h4><table class="docs-red-table"><tr><th>Original</th><th>Replaced with</th><th>Category</th><th>Count</th></tr>';
      d.redaction_map.forEach(row => {
        mapHtml += `<tr><td>${esc(row.original||'')}</td><td>${esc(row.replacement||'')}</td><td>${esc(row.category||'')}</td><td>${row.count||1}</td></tr>`;
      });
      mapHtml += '</table></div>';
      panel.innerHTML += mapHtml;
    }
  } catch(e) { docsShowResult('anonymise-result-panel', `<p style="color:var(--red)">Error: ${esc(e.message)}</p>`); }
}

// Legacy stubs — keep working for any remaining references
async function runReview(){ docsRunReview(); }
async function runCompare(){ docsRunCompare(); }
async function runDraft(){ docsRunDraft(); }
async function runTranslate(){ docsRunTranslate(); }
async function runDD(){
  const files=document.getElementById('dd-file')?.files;if(!files||!files.length){toast('Upload at least one document',true);return;}
  const container=document.getElementById('dd-results');if(!container)return;container.innerHTML='';
  for(const file of files){
    const box=document.createElement('div');box.className='result-box';
    box.innerHTML=`<div style="font-family:var(--font-serif);font-size:17px;font-weight:500;margin-bottom:10px;">${esc(file.name)}</div><span style="color:var(--text-muted)">Mickey is reviewing…</span>`;
    container.appendChild(box);
    const headers=await chHeaders();const fd=new FormData();fd.append('file',file);fd.append('module','review');
    fd.append('focus',getTags('#dd-tags')||'');fd.append('playbook',document.getElementById('dd-pb')?.value||'');fd.append('extra',document.getElementById('dd-extra')?.value||'');
    const r=await fetch('/api/analyze',{method:'POST',body:fd});const d=await r.json();
    box.innerHTML=`<div style="font-family:var(--font-serif);font-size:17px;font-weight:500;margin-bottom:10px;">${esc(file.name)}</div>`+(d.error?`<span style="color:var(--red)">${esc(d.error)}</span>`:md(d.result));
  }
}

// ══════════════════════════════════════════════════════════════
// CORPORATE HOUSEKEEPING
// ══════════════════════════════════════════════════════════════

let chEntities = [];          // full list from server
let chCurrentId = null;       // currently selected entity id
let chCurrentEntity = null;   // full entity object

// ── Entity list ───────────────────────────────────────────────

async function chLoadEntities() {
  const r = await fetch('/api/corp/entities');
  const d = await r.json();
  chEntities = d.entities || [];
  chRenderEntityList(chEntities);
}

function chRenderEntityList(entities) {
  const el = document.getElementById('ch-entity-list');
  if (!entities.length) {
    el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-faint);font-size:12px;font-style:italic;">No entities yet. Add one below.</div>';
    return;
  }
  // Group by jurisdiction
  const groups = {};
  entities.forEach(e => {
    const g = e.jurisdiction || 'Other';
    if (!groups[g]) groups[g] = [];
    groups[g].push(e);
  });
  const flagMap = {Belgium:'🇧🇪',Netherlands:'🇳🇱',Germany:'🇩🇪',France:'🇫🇷',Luxembourg:'🇱🇺',Serbia:'🇷🇸','United Kingdom':'🇬🇧'};
  let html = '';
  Object.entries(groups).forEach(([country, ents]) => {
    html += `<div class="ch-group-label">${flagMap[country]||'🌍'} ${country}</div>`;
    ents.forEach(e => {
      const alerts = e.alert_count > 0
        ? `<div class="ei-alerts"><div class="alert-dot alert-amber" title="${e.alert_count} alert(s)"></div></div>` : '';
      html += `<div class="entity-item${e.id===chCurrentId?' active':''}" onclick="chSelectEntity('${e.id}')">
        <div class="ei-name">${esc(e.name)}</div>
        <div class="ei-meta">
          <span class="ei-form">${esc(e.legal_form||'').split('—')[0].trim()}</span>
          <span class="ei-country">${esc(e.status==='active'?'Active':'Inactive')}</span>
        </div>
        ${alerts}
      </div>`;
    });
  });
  el.innerHTML = html;
}

function chFilterEntities(q) {
  if (!q) { chRenderEntityList(chEntities); return; }
  const lq = q.toLowerCase();
  chRenderEntityList(chEntities.filter(e =>
    e.name.toLowerCase().includes(lq) ||
    (e.legal_form||'').toLowerCase().includes(lq) ||
    (e.jurisdiction||'').toLowerCase().includes(lq)
  ));
}

// ── Select entity ─────────────────────────────────────────────

async function chSelectEntity(id) {
  chCurrentId = id;
  // Re-render list to update active state
  chRenderEntityList(document.getElementById('ch-search-input').value
    ? chEntities.filter(e => e.name.toLowerCase().includes(document.getElementById('ch-search-input').value.toLowerCase()))
    : chEntities);
  // Fetch full entity
  const r = await fetch(`/api/corp/entity?id=${id}`);
  const d = await r.json();
  if (d.error) { toast(d.error, true); return; }
  chCurrentEntity = d.entity;
  chShowEntity();
}

function chShowEntity() {
  const e = chCurrentEntity;
  document.getElementById('ch-empty').style.display = 'none';
  const view = document.getElementById('ch-entity-view');
  view.style.display = 'flex';
  // Header
  const flagMap = {Belgium:'🇧🇪',Netherlands:'🇳🇱',Germany:'🇩🇪',France:'🇫🇷',Luxembourg:'🇱🇺',Serbia:'🇷🇸','United Kingdom':'🇬🇧'};
  document.getElementById('ch-flag').textContent = flagMap[e.jurisdiction] || '🏢';
  document.getElementById('ch-entity-name').textContent = e.name;
  // Badges
  const form = (e.legal_form||'').split('—')[0].trim();
  const statusBadge = e.status === 'active'
    ? `<span class="cbadge cbadge-active">Active</span>`
    : `<span class="cbadge cbadge-inactive">${esc(e.status)}</span>`;
  const alertCount = chCountEntityAlerts(e);
  const alertBadge = alertCount > 0
    ? `<span class="cbadge cbadge-alert">⚠ ${alertCount} alert${alertCount>1?'s':''}</span>` : '';
  document.getElementById('ch-entity-badges').innerHTML =
    `<span class="cbadge cbadge-form">${esc(form)}</span>
     <span class="cbadge cbadge-country">${esc(e.jurisdiction||'')}</span>
     ${statusBadge}${alertBadge}`;
  // Show overview tab by default
  chTab('overview', document.querySelector('.ch-tab'));
}

function chCountEntityAlerts(e) {
  let count = 0;
  const today = new Date(); const warn = new Date(); warn.setDate(warn.getDate()+90);
  (e.directors||[]).forEach(d => {
    if (d.status==='active' && d.mandate_end) {
      const end = new Date(d.mandate_end);
      if (end <= warn) count++;
    }
  });
  (e.compliance||[]).forEach(c => {
    if ((c.status==='pending'||c.status==='overdue') && c.deadline) {
      if (new Date(c.deadline) < today) count++;
    }
  });
  return count;
}

// ── Tab switching ─────────────────────────────────────────────

function chTab(name, btn) {
  // Update tab button states
  document.querySelectorAll('.ch-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  // Hide all tab panels
  ['overview','identity','capital','governance','poa','compliance','history','documents'].forEach(t => {
    const el = document.getElementById('cht-'+t);
    if (el) el.style.display = 'none';
  });
  const panel = document.getElementById('cht-'+name);
  if (panel) panel.style.display = '';
  // Load tab data
  if (!chCurrentEntity) return;
  if (name==='overview')    chRenderOverview();
  if (name==='identity')    chLoadIdentityFields();
  if (name==='capital')     chRenderCapital();
  if (name==='governance')  chRenderGovernance();
  if (name==='poa')         chRenderPOA();
  if (name==='compliance')  chRenderCompliance();
  if (name==='history')     chRenderHistory();
  if (name==='documents')   chLoadDocuments();
}

// ── Overview ──────────────────────────────────────────────────

function chRenderOverview() {
  const e = chCurrentEntity;
  const today = new Date();

  // Summary cards
  const capital = e.share_capital ? `€${Number(e.share_capital).toLocaleString('de-DE')}` : '—';
  const activeDirs = (e.directors||[]).filter(d => d.status==='active').length;
  const expiringDirs = (e.directors||[]).filter(d => {
    if (d.status!=='active'||!d.mandate_end) return false;
    const end = new Date(d.mandate_end); const warn = new Date(); warn.setDate(warn.getDate()+90);
    return end <= warn;
  }).length;
  // Next AGM
  const openItems = chCountEntityAlerts(e);
  document.getElementById('ch-overview-cards').innerHTML = `
    <div class="ch-card c-green"><div class="ch-card-label">Share Capital</div><div class="ch-card-val">${capital}</div><div class="ch-card-sub">${esc(e.capital_currency||'EUR')}</div></div>
    <div class="ch-card${expiringDirs>0?' c-amber':' c-green'}"><div class="ch-card-label">Directors</div><div class="ch-card-val">${activeDirs}</div><div class="ch-card-sub">${expiringDirs>0?expiringDirs+' expiring soon':'All mandates current'}</div></div>
    <div class="ch-card c-blue"><div class="ch-card-label">Next AGM date rule</div><div class="ch-card-val" style="font-size:13px;line-height:1.3;margin-top:4px;">${esc(e.agm_date_rule||'Not set')}</div><div class="ch-card-sub">Notice: ${e.agm_notice_days||30} days</div></div>
    <div class="ch-card${openItems>0?' c-red':' c-green'}"><div class="ch-card-label">Open items</div><div class="ch-card-val">${openItems}</div><div class="ch-card-sub">${openItems>0?'Require attention':'All clear'}</div></div>`;

  // Deadlines
  const deadlines = chBuildDeadlines(e);
  const dlBody = document.getElementById('ch-deadlines-body');
  if (!deadlines.length) {
    dlBody.innerHTML = '<div style="padding:16px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No upcoming deadlines.</div>';
  } else {
    dlBody.innerHTML = deadlines.map(dl => {
      const cls = dl.days < 0 ? 'dl-red' : dl.days < 60 ? 'dl-amber' : 'dl-green';
      const dayCls = dl.days < 0 ? 'days-red' : dl.days < 60 ? 'days-amber' : 'days-green';
      const dayLabel = dl.days < 0 ? `${Math.abs(dl.days)}d overdue` : `${dl.days}d`;
      return `<div class="dl-item">
        <div class="dl-icon ${cls}"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
        <div class="dl-text"><div class="dl-title">${esc(dl.title)}</div><div class="dl-sub">${esc(dl.sub)}</div></div>
        <div class="dl-right"><div class="dl-date">${esc(dl.date)}</div><div class="days-badge ${dayCls}">${dayLabel}</div></div>
      </div>`;
    }).join('');
  }

  // Key identity summary
  document.getElementById('ch-overview-key').innerHTML = `
    <div class="cf-group"><label>KBO/BCE</label><div style="font-family:var(--font-mono);font-size:11.5px;">${esc(e.reg_number||'—')}</div></div>
    <div class="cf-group"><label>VAT</label><div style="font-family:var(--font-mono);font-size:11.5px;">${esc(e.vat_number||'—')}</div></div>
    <div class="cf-group"><label>LEI</label><div style="font-family:var(--font-mono);font-size:10.5px;word-break:break-all;">${esc(e.lei_code||'—')}</div></div>
    <div class="cf-group"><label>Registered office</label><div style="font-size:12px;">${esc([e.registered_street,e.registered_city,e.registered_country].filter(Boolean).join(', ')||'—')}</div></div>
    <div class="cf-group"><label>Financial year end</label><div style="font-size:12px;">${esc(e.financial_year_end||'—')}</div></div>
    <div class="cf-group"><label>Statutory auditor</label><div style="font-size:12px;">${esc(e.auditor_firm||'—')}</div></div>`;
}

function chBuildDeadlines(e) {
  const today = new Date(); const items = [];
  const daysDiff = d => Math.round((new Date(d)-today)/(1000*60*60*24));
  // Director mandates
  (e.directors||[]).filter(d=>d.status==='active'&&d.mandate_end).forEach(d => {
    const days = daysDiff(d.mandate_end);
    if (days <= 120) {
      const name = d.entity_name || `${d.first_name||''} ${d.last_name||''}`.trim();
      items.push({title:`Director mandate expiry — ${name}`,sub:`${d.role} · Consider renewal resolution`,date:d.mandate_end,days});
    }
  });
  // Compliance
  (e.compliance||[]).filter(c=>c.status!=='filed'&&c.deadline).forEach(c => {
    const days = daysDiff(c.deadline);
    if (days <= 180) items.push({title:c.obligation,sub:`${c.period||''} · ${c.authority||''}`.trim().replace(/^·\s*/,''),date:c.deadline,days});
  });
  // Auditor mandate
  if (e.auditor_mandate_end) {
    const days = daysDiff(e.auditor_mandate_end);
    if (days <= 180) items.push({title:`Auditor mandate end — ${e.auditor_firm||'Statutory auditor'}`,sub:'Consider renewal at next AGM',date:e.auditor_mandate_end,days});
  }
  return items.sort((a,b)=>a.days-b.days);
}

// ── Identity tab ──────────────────────────────────────────────

function chLoadIdentityFields() {
  const e = chCurrentEntity; if (!e) return;
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val||''; };
  set('fi-name', e.name);
  set('fi-trade-name', e.trade_name);
  set('fi-prev-names', e.previous_names);
  set('fi-legal-form', e.legal_form);
  set('fi-jurisdiction', e.jurisdiction);
  set('fi-status', e.status);
  set('fi-listed', String(e.listed||false));
  set('fi-reg-number', e.reg_number);
  set('fi-vat-number', e.vat_number);
  set('fi-lei-code', e.lei_code);
  set('fi-court', e.court_registration);
  set('fi-inc-date', e.incorporation_date);
  set('fi-duration', e.duration||'Unlimited');
  set('fi-street', e.registered_street);
  set('fi-postcode', e.registered_postcode);
  set('fi-city', e.registered_city);
  set('fi-country', e.registered_country);
  set('fi-fy-end', e.financial_year_end);
  set('fi-agm-rule', e.agm_date_rule);
  set('fi-agm-notice', e.agm_notice_days||30);
  // Auditor firm — N/A checkbox + plain text input
  const auditorNA = document.getElementById('fi-auditor-na');
  const auditorInput = document.getElementById('fi-auditor-firm');
  if (auditorNA && auditorInput) {
    const isNA = !e.auditor_firm || e.auditor_firm === 'N/A';
    auditorNA.checked = isNA;
    auditorInput.value = isNA ? '' : (e.auditor_firm || '');
  }
  chToggleAuditorFields();
  set('fi-auditor-partner', e.auditor_partner);
  set('fi-auditor-ire', e.auditor_ire);
  set('fi-auditor-end', e.auditor_mandate_end);
  set('fi-notes', e.notes);
  // Update dynamic fields
  chToggleAuditorFields();
  chUpdateCompanyNumLabel(e.jurisdiction);
}

async function chSaveIdentity() {
  const get = id => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
  const payload = {
    id: chCurrentId,
    name: get('fi-name'), trade_name: get('fi-trade-name'),
    previous_names: get('fi-prev-names'), legal_form: get('fi-legal-form'),
    jurisdiction: get('fi-jurisdiction'), status: get('fi-status'),
    listed: get('fi-listed')==='true',
    reg_number: get('fi-reg-number'), vat_number: get('fi-vat-number'),
    lei_code: get('fi-lei-code'), court_registration: get('fi-court'),
    incorporation_date: get('fi-inc-date'), duration: get('fi-duration'),
    registered_street: get('fi-street'), registered_postcode: get('fi-postcode'),
    registered_city: get('fi-city'), registered_country: get('fi-country'),
    financial_year_end: get('fi-fy-end'), agm_date_rule: get('fi-agm-rule'),
    agm_notice_days: parseInt(get('fi-agm-notice'))||30,
    auditor_firm: (() => {
      const na = document.getElementById('fi-auditor-na');
      if (na && na.checked) return 'N/A';
      return get('fi-auditor-firm') || 'N/A';
    })(),
    auditor_partner: get('fi-auditor-partner'), auditor_ire: get('fi-auditor-ire'), auditor_mandate_end: get('fi-auditor-end'),
    notes: get('fi-notes'),
  };
  const r = await fetch('/api/corp/entity/update', {method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) {
    // Update local cache
    Object.assign(chCurrentEntity, payload);
    // Refresh entity name in header + list
    document.getElementById('ch-entity-name').textContent = payload.name;
    chEntities = chEntities.map(e => e.id===chCurrentId ? {...e, name:payload.name, legal_form:payload.legal_form, jurisdiction:payload.jurisdiction, status:payload.status} : e);
    chRenderEntityList(chEntities);
    toast('Identity saved');
  } else toast(d.error||'Error saving', true);
}

// ── Auditor field toggle ──────────────────────────────────────
function chToggleAuditorFields() {
  const na = document.getElementById('fi-auditor-na');
  const firmInput = document.getElementById('fi-auditor-firm');
  const detailFields = document.getElementById('fi-auditor-detail-fields');
  if (!na || !firmInput || !detailFields) return;
  const isNA = na.checked;
  firmInput.disabled = isNA;
  firmInput.style.opacity = isNA ? '0.35' : '1';
  // Show detail fields only if a firm is named and not N/A
  const hasFirm = !isNA && firmInput.value.trim().length > 0;
  detailFields.style.display = hasFirm ? '' : 'none';
}

// Dynamic company number label per jurisdiction
const CH_REG_LABELS = {
  Belgium:       {label:'Company number (KBO/BCE)',    placeholder:'0 123.456.789'},
  Netherlands:   {label:'Company number (KvK)',         placeholder:'12345678'},
  Germany:       {label:'Handelsregisternummer (HRB)',   placeholder:'HRB 123456'},
  France:        {label:'SIREN / SIRET',                placeholder:'123 456 789'},
  Luxembourg:    {label:'RCS number',                   placeholder:'B 123456'},
  'United Kingdom': {label:'Companies House number',   placeholder:'12345678'},
  Serbia:        {label:'APR registration number',      placeholder:'12345678'},
};
function chUpdateCompanyNumLabel(juris) {
  // Works for both modals: cm- (new entity) and fi- (identity form)
  const jur = juris || document.getElementById('cm-jurisdiction')?.value
              || document.getElementById('fi-jurisdiction')?.value || 'Belgium';
  const info = CH_REG_LABELS[jur] || {label:'Company registration number', placeholder:''};
  ['cm-reg-number-label','fi-reg-number-label'].forEach(id => {
    const el = document.getElementById(id); if (el) el.textContent = info.label;
  });
  ['cm-reg-number','fi-reg-number'].forEach(id => {
    const el = document.getElementById(id); if (el) el.placeholder = info.placeholder;
  });
}

// ── Unlimited mandate toggle ──────────────────────────────────
function chToggleUnlimited() {
  const cb = document.getElementById('cd-unlimited');
  const dateField = document.getElementById('cd-mandate-end');
  if (!cb || !dateField) return;
  if (cb.checked) {
    dateField.value = '';
    dateField.disabled = true;
    dateField.style.opacity = '0.4';
  } else {
    dateField.disabled = false;
    dateField.style.opacity = '1';
  }
}

// ── Extract from Articles of Association ──────────────────────
async function chExtractFromAoA() {
  const file = document.getElementById('fi-aoa-file').files[0];
  if (!file) { toast('Upload a PDF or DOCX first', true); return; }
  const result = document.getElementById('fi-aoa-result');
  result.style.display = 'block';
  result.style.background = 'var(--green)';
  result.style.color = '#fff';
  result.style.border = 'none';
  result.style.whiteSpace = 'normal';
  result.textContent = '✦ Mickey is reading the articles of association…';
  const fd = new FormData();
  fd.append('file', file);
  fd.append('module', 'review');
  fd.append('extra', `You are a corporate legal data extractor. Extract ALL of the following from this document and return ONLY a JSON object (no markdown, no explanation) with these exact keys:
{
  "name": "full legal name of the company",
  "legal_form": "legal form abbreviation only (NV, BV, SA, SRL, etc.)",
  "reg_number": "KBO/BCE company number if present",
  "registered_street": "street and number of registered office",
  "registered_postcode": "postal code",
  "registered_city": "city",
  "registered_country": "country",
  "share_capital": "numeric share capital amount (digits only, no currency symbol)",
  "capital_currency": "EUR or other currency code",
  "total_shares": "total number of shares (numeric only)",
  "nominal_value": "nominal value per share or No par value",
  "board_model": "One-tier (Board of Directors) or Two-tier (Supervisory + Management) or Sole director",
  "financial_year_end": "e.g. 31 December",
  "agm_date_rule": "AGM date rule as stated in bylaws",
  "agm_notice_days": "notice period in days (number only)",
  "auditor_firm": "name of statutory auditor firm, or N/A if none",
  "signature_rule": "how the company is represented (e.g. Joint (2 directors) or Sole)",
  "min_directors": "minimum number of directors (number only)",
  "max_directors": "maximum number of directors (number only)",
  "duration": "Unlimited or a specific end date if fixed duration",
  "notes": "any other important governance rules (max 2 sentences)"
}
If a field cannot be found in the document, use null. Return ONLY the JSON.`);
  try {
    const r = await fetch('/api/analyze', { method: 'POST', body: fd });
    const d = await r.json();
    if (d.error) { result.textContent = '⚠ ' + d.error; result.style.background='var(--red-bg)'; result.style.color='var(--red)'; return; }
    let raw = (d.result || '').replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
    const start = raw.indexOf('{'); const end = raw.lastIndexOf('}');
    if (start === -1 || end === -1) throw new Error('No JSON found');
    const ex = JSON.parse(raw.slice(start, end + 1));

    // Helper: only apply if doc has a value AND (field is blank OR we choose to overwrite)
    const apply = (key, val) => {
      if (val === null || val === undefined || val === 'null' || String(val).trim() === '') return;
      // Only fill blank fields — never overwrite data the user has entered
      if (!chCurrentEntity[key]) chCurrentEntity[key] = val;
    };

    // Identity
    apply('name', ex.name);
    apply('legal_form', ex.legal_form);
    apply('reg_number', ex.reg_number);
    apply('registered_street', ex.registered_street);
    apply('registered_postcode', ex.registered_postcode);
    apply('registered_city', ex.registered_city);
    apply('registered_country', ex.registered_country);
    apply('financial_year_end', ex.financial_year_end);
    apply('agm_date_rule', ex.agm_date_rule);
    apply('duration', ex.duration);
    if (ex.agm_notice_days) apply('agm_notice_days', ex.agm_notice_days);
    apply('auditor_firm', ex.auditor_firm);
    if (ex.notes && !chCurrentEntity.notes) {
      chCurrentEntity.notes = ex.notes;
    }

    // Capital & Shares — always stored on entity
    apply('share_capital', ex.share_capital);
    apply('capital_currency', ex.capital_currency);
    apply('total_shares', ex.total_shares);
    apply('nominal_value', ex.nominal_value);

    // Governance
    apply('board_model', ex.board_model);
    apply('signature_rule', ex.signature_rule);
    apply('min_directors', ex.min_directors);
    apply('max_directors', ex.max_directors);

    // Re-render the identity tab fields from updated entity
    chLoadIdentityFields();

    result.textContent = '✓ Data extracted and applied. Review each tab, then save.';
    result.style.background = 'var(--green)';
    result.style.color = '#fff';

  } catch(e) {
    result.textContent = '⚠ Could not parse response. Try again.';
    result.style.background = 'var(--red-bg)';
    result.style.color = 'var(--red)';
  }
}

// ── Capital tab ───────────────────────────────────────────────

function chRenderCapital() {
  const e = chCurrentEntity;
  const setV = (id, val) => { const el = document.getElementById(id); if (el) el.value = val||''; };
  setV('fc-capital', e.share_capital);
  setV('fc-currency', e.capital_currency||'EUR');
  setV('fc-shares', e.total_shares);
  setV('fc-nominal', e.nominal_value||'No par value');
  const label = document.getElementById('fc-currency-label');
  if (label) label.textContent = e.capital_currency||'EUR';

  // Shareholders table
  const shs = e.shareholders || [];
  const tbody = document.getElementById('ch-shareholders-body');
  if (!shs.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-faint);font-style:italic;padding:16px;">No shareholders recorded</td></tr>';
  } else {
    tbody.innerHTML = shs.map(sh => {
      const typeBadge = sh.shareholder_type ? `<span style="font-size:9px;padding:1px 5px;border-radius:3px;background:var(--green-light);color:var(--green);font-weight:700;">${esc(sh.shareholder_type)}</span> ` : '';
      const pctBar = `<div class="pct-bar"><div class="pct-track"><div class="pct-fill" style="width:${Math.min(parseFloat(sh.pct)||0,100)}%"></div></div><span style="font-size:11px;min-width:34px;text-align:right;">${parseFloat(sh.pct||0).toFixed(1)}%</span></div>`;
      return `<tr>
        <td><strong>${esc(sh.name)}</strong> ${typeBadge}</td>
        <td style="font-size:11px;color:var(--text-muted);">${esc(sh.ownership_type||sh.type||'')}</td>
        <td class="mono">${Number(sh.shares||0).toLocaleString('de-DE')}</td>
        <td style="min-width:100px;">${pctBar}</td>
        <td style="font-size:11px;color:var(--text-muted);">${esc(sh.acquisition_date||'—')}</td>
        <td style="font-size:11px;color:var(--text-muted);">${esc(sh.encumbrance||'None')}</td>
        <td><div class="ch-row-actions"><button class="icon-btn danger" onclick="chDeleteShareholder('${sh.id}')" title="Remove"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></button></div></td>
      </tr>`;
    }).join('');
  }

  // UBO
  const ubos = shs.filter(s => s.is_ubo===true||s.is_ubo==='true');
  const uboBody = document.getElementById('ch-ubo-body');
  if (!ubos.length) {
    uboBody.innerHTML = '<div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No UBOs identified. Mark shareholders as UBO in the register above.</div>';
  } else {
    uboBody.innerHTML = ubos.map(u => {
      const initials = u.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
      const kyc = u.ubo_kyc_status==='confirmed' ? '<span class="st-badge st-filed">Confirmed</span>' : '<span class="st-badge st-pending">Pending</span>';
      return `<div class="ubo-item">
        <div class="ubo-av">${initials}</div>
        <div class="ubo-info"><div class="ubo-name">${esc(u.name)}</div><div class="ubo-sub">${esc(u.nationality||'')} · Direct ownership</div></div>
        <div class="ubo-pct">${parseFloat(u.pct||0).toFixed(1)}%</div>
        <div style="margin-left:10px;">${kyc}</div>
      </div>`;
    }).join('');
  }
}

// ── Governance tab ────────────────────────────────────────────

function chRenderGovernance() {
  const e = chCurrentEntity;
  // Directors
  const dirs = e.directors || [];
  const dirsBody = document.getElementById('ch-directors-body');
  if (!dirs.length) {
    dirsBody.innerHTML = '<div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No directors recorded.</div>';
  } else {
    dirsBody.innerHTML = dirs.map((d,i) => {
      const name = d.entity_name || `${d.first_name||''} ${d.last_name||''}`.trim();
      const sub = d.entity_name ? `<span class="psub">Permanent rep: ${esc(d.representative||'—')}</span>` : '';
      const today = new Date(); const warn = new Date(); warn.setDate(warn.getDate()+90);
      const isExpiring = d.status==='active' && d.mandate_end && new Date(d.mandate_end)<=warn;
      const isEnded = d.status==='ended';
      const dotCls = isEnded ? 's-expired' : isExpiring ? 's-expiring' : 's-active';
      const statusLabel = isEnded ? 'Ended' : isExpiring ? 'Expiring' : 'Active';
      const mandateCls = isExpiring ? ' expiring' : '';
      return `<div class="ch-person-row${isEnded?' ended':''}">
        <span class="ch-pnum">${i+1}</span>
        <div class="ch-pname">${esc(name)}${sub}</div>
        <span class="ch-prole">${esc(d.role||'')}</span>
        <span class="ch-pdate">${esc(d.appointment_date||'—')}</span>
        <span class="ch-pdate${mandateCls}">${esc(d.mandate_end||'Unlimited')}</span>
        <div class="ch-pstatus">
          <div class="sdot ${dotCls}"></div>
          <span style="font-size:11px;color:var(--text-muted);">${statusLabel}</span>
          ${!isEnded?`<button class="icon-btn danger" style="margin-left:4px;" onclick="chEndMandate('${d.id}')" title="End mandate"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`:''}
        </div>
      </div>`;
    }).join('');
  }
  // Governance settings
  const setV = (id,val) => { const el=document.getElementById(id); if(el) el.value=val||''; };
  setV('fg-model', e.board_model||'One-tier (Board of Directors)');
  setV('fg-sig', e.signature_rule||'Joint (2 directors)');
  setV('fg-ceo', e.daily_management_delegate);
  setV('fg-min-dir', e.min_directors||1);
  setV('fg-max-dir', e.max_directors||12);
  setV('fg-quorum', e.quorum_rule);
}

async function chSaveGovernance() {
  const get = id => { const el=document.getElementById(id); return el?el.value.trim():''; };
  const payload = {
    id: chCurrentId,
    board_model: get('fg-model'),
    signature_rule: get('fg-sig'),
    daily_management_delegate: get('fg-ceo'),
    min_directors: parseInt(get('fg-min-dir'))||1,
    max_directors: parseInt(get('fg-max-dir'))||12,
    quorum_rule: get('fg-quorum'),
  };
  const r = await fetch('/api/corp/entity/update',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) { Object.assign(chCurrentEntity, payload); toast('Governance settings saved'); }
  else toast(d.error||'Error', true);
}

// ── POA tab ───────────────────────────────────────────────────

function chRenderPOA() {
  const e = chCurrentEntity;
  const poas = e.poas || [];
  const body = document.getElementById('ch-poa-body');
  if (!poas.length) {
    body.innerHTML = '<div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No powers of attorney recorded.</div>';
    return;
  }
  body.innerHTML = poas.map(p => {
    const activeBadge = p.status==='revoked'
      ? '<span class="st-badge st-overdue">Revoked</span>'
      : '<span class="st-badge st-filed">Active</span>';
    const powers = (p.powers||[]).map(pw=>`<div>→ ${esc(pw)}</div>`).join('');
    const revokeBtn = p.status!=='revoked'
      ? `<button class="btn btn-sm btn-danger" onclick="chRevokePOA('${p.id}')">Revoke</button>` : '';
    return `<div class="poa-item">
      <div class="poa-head">
        <div class="poa-name">${esc(p.grantee_name)}</div>
        ${activeBadge}
        <span style="font-size:11px;color:var(--text-muted);margin-left:6px;">${esc(p.signature||'Sole')} signatory</span>
        ${revokeBtn}
      </div>
      <div class="poa-powers">${powers||'<em>No specific powers listed</em>'}</div>
      <div class="poa-meta">
        <span>Granted by: ${esc(p.granted_by||'—')}</span>
        <span>Grant date: ${esc(p.grant_date||'—')}</span>
        <span>Duration: ${esc(p.duration||'Unlimited')}</span>
        ${p.expiry_date?`<span>Expires: ${esc(p.expiry_date)}</span>`:''}
      </div>
    </div>`;
  }).join('');
}

// ── Compliance tab ────────────────────────────────────────────

function chRenderCompliance() {
  const e = chCurrentEntity;
  const comps = e.compliance || [];
  const tbody = document.getElementById('ch-compliance-body');
  if (!comps.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-faint);font-style:italic;padding:16px;">No compliance obligations recorded</td></tr>';
    return;
  }
  tbody.innerHTML = comps.map(c => {
    const stCls = {filed:'st-filed',pending:'st-pending',overdue:'st-overdue',exempt:'st-exempt'}[c.status]||'st-pending';
    return `<tr>
      <td><strong>${esc(c.obligation)}</strong></td>
      <td style="font-size:11.5px;">${esc(c.period||'—')}</td>
      <td style="font-size:11px;color:var(--text-muted);">${esc(c.authority||'—')}</td>
      <td class="mono" style="font-size:11px;">${esc(c.deadline||'—')}</td>
      <td class="mono" style="font-size:11px;">${esc(c.filed_date||'—')}</td>
      <td><span class="st-badge ${stCls}">${esc(c.status)}</span></td>
      <td><div class="ch-row-actions">
        ${c.status!=='filed'?`<button class="icon-btn" onclick="chMarkFiled('${c.id}')" title="Mark as filed"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></button>`:''}
        <button class="icon-btn danger" onclick="chDeleteCompliance('${c.id}')" title="Delete"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></button>
      </div></td>
    </tr>`;
  }).join('');
}

// ── History tab ───────────────────────────────────────────────

function chRenderHistory() {
  const e = chCurrentEntity;
  const hist = e.history || [];
  const body = document.getElementById('ch-history-body');
  if (!hist.length) {
    body.innerHTML = '<div style="padding:14px 18px;color:var(--text-faint);font-size:12px;font-style:italic;">No history recorded.</div>';
    return;
  }
  const dotColors = {governance:'var(--green)',capital:'var(--amber)',compliance:'var(--blue)',document:'#8A5AB0',other:'var(--text-faint)'};
  body.innerHTML = hist.map(h => `<div class="hist-item">
    <div class="hist-dot" style="background:${dotColors[h.type]||'var(--text-faint)'}"></div>
    <div class="hist-date">${esc((h.date||h.ts||'').slice(0,10))}</div>
    <div class="hist-body">
      <strong>${esc(h.description)}</strong>
      ${h.source?`<div class="hist-source">Source: ${esc(h.source)}</div>`:''}
      ${h.recorded_by?`<div class="hist-source">Recorded by: ${esc(h.recorded_by)}</div>`:''}
    </div>
  </div>`).join('');
}

// ── Mickey AI for entity ──────────────────────────────────────

function chSugAsk(el) {
  document.getElementById('ch-mickey-q').value = el.textContent;
  chAskEntity();
}

function chAskMickeyFocus() {
  chTab('overview', document.querySelector('.ch-tab'));
  setTimeout(()=>document.getElementById('ch-mickey-q').focus(), 100);
}

async function chAskEntity() {
  const q = document.getElementById('ch-mickey-q').value.trim();
  if (!q) return;
  const result = document.getElementById('ch-mickey-result');
  result.style.display = 'block';
  result.textContent = 'Mickey is thinking…';
  const r = await fetch('/api/corp/ask', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({entity_id: chCurrentId, question: q})
  });
  const d = await r.json();
  if (d.error) { result.innerHTML = `<span style="color:#ffaaaa">${esc(d.error)}</span>`; }
  else { result.innerHTML = `<div class="md">${md(d.answer)}</div>`; }
}

// ── New entity modal ──────────────────────────────────────────

function chOpenNewEntity() {
  // Clear fields
  ['cm-name','cm-reg-number','cm-inc-date'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('ch-modal-entity-title').textContent = 'New entity';
  document.getElementById('ch-modal-entity').style.display = 'flex';
  chUpdateCompanyNumLabel();
}

async function chSaveEntity() {
  const get = id => { const el=document.getElementById(id); return el?el.value.trim():''; };
  const name = get('cm-name');
  if (!name) { toast('Entity name is required', true); return; }
  const payload = {
    name, legal_form: get('cm-legal-form'), jurisdiction: get('cm-jurisdiction'),
    reg_number: get('cm-reg-number'), incorporation_date: get('cm-inc-date'),
    relationship: get('cm-relationship'), status: get('cm-status'),
  };
  const r = await fetch('/api/corp/entity/create',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) {
    chCloseModal('ch-modal-entity');
    toast(`Entity "${name}" created`);
    await chLoadEntities();
    chSelectEntity(d.id);
  } else toast(d.error||'Error creating entity', true);
}

function chOpenEditEntity() {
  if (!chCurrentEntity) return;
  const e = chCurrentEntity;
  document.getElementById('ch-modal-entity-title').textContent = 'Edit entity';
  const set = (id,val) => { const el=document.getElementById(id); if(el) el.value=val||''; };
  set('cm-name', e.name); set('cm-legal-form', e.legal_form);
  set('cm-jurisdiction', e.jurisdiction); set('cm-reg-number', e.reg_number);
  set('cm-inc-date', e.incorporation_date); set('cm-relationship', e.relationship);
  set('cm-status', e.status);
  document.getElementById('ch-modal-entity').style.display = 'flex';
}

// ── Add director modal ────────────────────────────────────────

function chOpenAddDirector() {
  ['cd-first-name','cd-last-name','cd-nationality','cd-address','cd-entity-name',
   'cd-representative','cd-address-entity','cd-deed','cd-notes'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  const appt=document.getElementById('cd-appoint-date');
  if(appt) appt.value=new Date().toISOString().slice(0,10);
  document.getElementById('cd-type').value='natural_person';
  chToggleDirType();
  chAutoSetMandateDuration();
  document.getElementById('ch-modal-director').style.display = 'flex';
}

function chToggleDirType() {
  const t = document.getElementById('cd-type').value;
  document.getElementById('cd-person-fields').style.display = t==='natural_person' ? '' : 'none';
  document.getElementById('cd-entity-fields').style.display = t==='legal_entity' ? '' : 'none';
}

// Auto-suggest unlimited mandate when current entity is a BV
function chAutoSetMandateDuration() {
  if (!chCurrentEntity) return;
  const form = (chCurrentEntity.legal_form||'').toLowerCase();
  const isBV = form.includes('bv') && !form.includes('bv (nl)') && !form.includes('nv');
  const cb = document.getElementById('cd-unlimited');
  if (cb && isBV && !cb.checked) {
    cb.checked = true;
    chToggleUnlimited();
  }
}

async function chSaveDirector() {
  const get = id => { const el=document.getElementById(id); return el?el.value.trim():''; };
  const type = get('cd-type');
  const payload = {
    entity_id: chCurrentId, type,
    first_name: get('cd-first-name'), last_name: get('cd-last-name'),
    entity_name: get('cd-entity-name'), representative: get('cd-representative'),
    nationality: get('cd-nationality'),
    address: type==='natural_person' ? get('cd-address') : get('cd-address-entity'),
    role: get('cd-role'), appointment_date: get('cd-appoint-date'),
    mandate_end: get('cd-mandate-end'), appointment_auth: get('cd-auth'),
    deed_ref: get('cd-deed'), remuneration: get('cd-remuneration'),
    signature_auth: get('cd-sig'), notes: get('cd-notes'),
  };
  if (!payload.first_name && !payload.last_name && !payload.entity_name) {
    toast('Enter a name for the director', true); return;
  }
  const r = await fetch('/api/corp/director/add',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) {
    chCloseModal('ch-modal-director');
    toast('Director added');
    await chRefreshEntity();
    chRenderGovernance();
  } else toast(d.error||'Error', true);
}

async function chEndMandate(directorId) {
  if (!confirm('End this director\'s mandate?')) return;
  const r = await fetch('/api/corp/director/end_mandate',{method:'POST',headers:await chHeaders(),
    body:JSON.stringify({entity_id:chCurrentId,director_id:directorId,reason:'Mandate ended'})});
  const d = await r.json();
  if (d.ok) { toast('Mandate ended'); await chRefreshEntity(); chRenderGovernance(); }
  else toast(d.error||'Error', true);
}

// ── Shareholder modal ─────────────────────────────────────────

function chOpenAddShareholder() {
  ['cs-name','cs-nationality','cs-shares','cs-pct','cs-acq-date','cs-encumbrance'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('ch-modal-shareholder').style.display = 'flex';
}

async function chSaveShareholder() {
  const get = id => { const el=document.getElementById(id); return el?el.value.trim():''; };
  if (!get('cs-name')) { toast('Enter shareholder name', true); return; }
  const payload = {
    entity_id: chCurrentId, name: get('cs-name'), type: get('cs-type'),
    shareholder_type: get('cs-sh-type'), nationality: get('cs-nationality'),
    shares: parseInt(get('cs-shares').replace(/[^0-9]/g,''))||0,
    pct: parseFloat(get('cs-pct'))||0,
    acquisition_date: get('cs-acq-date'), ownership_type: get('cs-ownership'),
    encumbrance: get('cs-encumbrance')||'None',
    is_ubo: get('cs-ubo')==='true',
  };
  const r = await fetch('/api/corp/shareholder/add',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) {
    chCloseModal('ch-modal-shareholder');
    toast('Shareholder added');
    await chRefreshEntity();
    chRenderCapital();
  } else toast(d.error||'Error', true);
}

async function chDeleteShareholder(sid) {
  if (!confirm('Remove this shareholder?')) return;
  const r = await fetch('/api/corp/shareholder/delete',{method:'POST',headers:await chHeaders(),
    body:JSON.stringify({entity_id:chCurrentId,shareholder_id:sid})});
  const d = await r.json();
  if (d.ok) { toast('Shareholder removed'); await chRefreshEntity(); chRenderCapital(); }
  else toast(d.error||'Error', true);
}

// ── POA modal ─────────────────────────────────────────────────

function chOpenAddPOA() {
  ['cp-grantee','cp-granted-by','cp-grant-date','cp-expiry','cp-powers','cp-thr-contracts','cp-thr-leases'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('ch-modal-poa').style.display = 'flex';
}

async function chSavePOA() {
  const get = id => { const el=document.getElementById(id); return el?el.value.trim():''; };
  if (!get('cp-grantee')) { toast('Enter grantee name', true); return; }
  const powersRaw = get('cp-powers');
  const powers = powersRaw ? powersRaw.split('\n').map(s=>s.trim()).filter(Boolean) : [];
  const payload = {
    entity_id: chCurrentId, grantee_name: get('cp-grantee'),
    granted_by: get('cp-granted-by'), grant_date: get('cp-grant-date'),
    duration: get('cp-duration'), expiry_date: get('cp-expiry'),
    signature: get('cp-sig'), powers,
    thresholds: {
      contracts: parseFloat(get('cp-thr-contracts'))||0,
      leases: parseFloat(get('cp-thr-leases'))||0,
    },
  };
  const r = await fetch('/api/corp/poa/add',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) {
    chCloseModal('ch-modal-poa');
    toast('Power of attorney created');
    await chRefreshEntity();
    chRenderPOA();
  } else toast(d.error||'Error', true);
}

async function chRevokePOA(pid) {
  if (!confirm('Revoke this power of attorney?')) return;
  const r = await fetch('/api/corp/poa/revoke',{method:'POST',headers:await chHeaders(),
    body:JSON.stringify({entity_id:chCurrentId,poa_id:pid})});
  const d = await r.json();
  if (d.ok) { toast('POA revoked'); await chRefreshEntity(); chRenderPOA(); }
  else toast(d.error||'Error', true);
}

// ── Compliance modal ──────────────────────────────────────────

function chOpenAddCompliance() {
  ['cc-obligation','cc-period','cc-authority','cc-deadline','cc-filed','cc-notes'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('ch-modal-compliance').style.display = 'flex';
}

async function chSaveCompliance() {
  const get = id => { const el=document.getElementById(id); return el?el.value.trim():''; };
  if (!get('cc-obligation')) { toast('Enter obligation description', true); return; }
  const payload = {
    entity_id: chCurrentId, obligation: get('cc-obligation'),
    period: get('cc-period'), authority: get('cc-authority'),
    deadline: get('cc-deadline'), filed_date: get('cc-filed'),
    status: get('cc-status'), notes: get('cc-notes'),
  };
  const r = await fetch('/api/corp/compliance/add',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) {
    chCloseModal('ch-modal-compliance');
    toast('Compliance obligation added');
    await chRefreshEntity();
    chRenderCompliance();
  } else toast(d.error||'Error', true);
}

async function chMarkFiled(itemId) {
  const payload = {
    entity_id: chCurrentId, item_id: itemId,
    status: 'filed', filed_date: new Date().toISOString().slice(0,10)
  };
  const r = await fetch('/api/corp/compliance/update',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) { toast('Marked as filed'); await chRefreshEntity(); chRenderCompliance(); }
  else toast(d.error||'Error', true);
}

async function chDeleteCompliance(itemId) {
  // We don't have a delete route but we can mark exempt
  const payload = { entity_id: chCurrentId, item_id: itemId, status: 'exempt' };
  const r = await fetch('/api/corp/compliance/update',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) { toast('Marked as exempt'); await chRefreshEntity(); chRenderCompliance(); }
  else toast(d.error||'Error', true);
}

// ── History modal ─────────────────────────────────────────────

function chOpenAddHistory() {
  ['ch-hist-source','ch-hist-desc'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('ch-modal-history').style.display = 'flex';
}

async function chSaveHistory() {
  const get = id => { const el=document.getElementById(id); return el?el.value.trim():''; };
  if (!get('ch-hist-desc')) { toast('Enter a description', true); return; }
  const payload = {
    entity_id: chCurrentId,
    type: get('ch-hist-type'),
    description: get('ch-hist-desc'),
    source: get('ch-hist-source'),
  };
  const r = await fetch('/api/corp/history/add',{method:'POST',headers:await chHeaders(),body:JSON.stringify(payload)});
  const d = await r.json();
  if (d.ok) {
    chCloseModal('ch-modal-history');
    toast('History entry added');
    await chRefreshEntity();
    chRenderHistory();
  } else toast(d.error||'Error', true);
}

// ── Documents tab ─────────────────────────────────────────────

let chAllDocs = [];
let chDocFilter = 'all';

function chOpenUploadDoc() {
  ['doc-name','doc-date','doc-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const fi=document.getElementById('doc-file'); if(fi)fi.value='';
  document.getElementById('doc-category').value = 'constitutional';
  const prog=document.getElementById('doc-upload-progress'); if(prog)prog.style.display='none';
  const btn=document.getElementById('doc-upload-btn'); if(btn){btn.disabled=false;btn.textContent='Upload';}
  document.getElementById('ch-modal-upload-doc').style.display='flex';
}

function chDocFileSelected(input) {
  if (!input.files[0]) return;
  const name = input.files[0].name.replace(/\.[^.]+$/,'').replace(/[-_]/g,' ');
  const nameEl = document.getElementById('doc-name');
  if (nameEl && !nameEl.value) nameEl.value = name;
  // Auto-detect category from filename
  const fn = input.files[0].name.toLowerCase();
  const cat = document.getElementById('doc-category');
  if (!cat) return;
  if (fn.includes('statut') || fn.includes('articles') || fn.includes('bylaws') || fn.includes('akte') || fn.includes('coordin')) cat.value = 'constitutional';
  else if (fn.includes('resol') || fn.includes('besluit') || fn.includes('besliss')) cat.value = 'resolutions';
  else if (fn.includes('agm') || fn.includes('av ') || fn.includes('algemeen') || fn.includes('annuel')) cat.value = 'agm_minutes';
  else if (fn.includes('register') || fn.includes('aandelen') || fn.includes('aandeelh')) cat.value = 'share_register';
  else if (fn.includes('volmacht') || fn.includes('poa') || fn.includes('procuration')) cat.value = 'poa';
  else if (fn.includes('nbb') || fn.includes('fsma') || fn.includes('regulatory') || fn.includes('compliance')) cat.value = 'regulatory';
  else if (fn.includes('overeenk') || fn.includes('agreement') || fn.includes('contract')) cat.value = 'agreements';
}

async function chDoUploadDoc() {
  const file = document.getElementById('doc-file').files[0];
  const name = document.getElementById('doc-name').value.trim();
  if (!file || !name) { toast('Choose a file and enter a name', true); return; }
  const btn = document.getElementById('doc-upload-btn');
  const prog = document.getElementById('doc-upload-progress');
  const status = document.getElementById('doc-upload-status');
  const bar = document.getElementById('doc-progress-bar');
  btn.disabled = true; btn.textContent = 'Uploading…';
  prog.style.display = 'block'; bar.style.width = '30%'; status.textContent = 'Uploading…';
  const fd = new FormData();
  fd.append('file', file);
  fd.append('entity_id', chCurrentId);
  fd.append('name', name);
  fd.append('category', document.getElementById('doc-category').value);
  fd.append('doc_date', document.getElementById('doc-date').value.trim());
  fd.append('notes', document.getElementById('doc-notes').value.trim());
  try {
    bar.style.width = '60%'; status.textContent = 'Processing…';
    const r = await fetch('/api/corp/doc/upload', { method:'POST', body:fd });
    bar.style.width = '100%';
    const d = await r.json();
    if (d.ok) {
      status.textContent = '✓ Uploaded successfully';
      setTimeout(()=>{
        chCloseModal('ch-modal-upload-doc');
        chLoadDocuments();
        toast(`"${name}" uploaded`);
      }, 600);
    } else {
      status.textContent = '⚠ ' + (d.error || 'Upload failed');
      status.style.color = 'var(--red)';
      btn.disabled = false; btn.textContent = 'Upload';
    }
  } catch(e) {
    status.textContent = '⚠ Network error';
    btn.disabled = false; btn.textContent = 'Upload';
  }
}

async function chLoadDocuments() {
  if (!chCurrentId) return;
  const r = await fetch(`/api/corp/docs?entity_id=${chCurrentId}`);
  const d = await r.json();
  chAllDocs = d.docs || [];
  chRenderDocuments();
}

function chFilterDocs(cat, el) {
  chDocFilter = cat;
  document.querySelectorAll('.ch-doc-cat-item').forEach(i=>i.classList.remove('active'));
  if (el) el.classList.add('active');
  chRenderDocuments();
}

const DOC_CAT_LABELS = {
  constitutional:'Constitutional', resolutions:'Resolutions', agm_minutes:'AGM minutes',
  share_register:'Share register', poa:'POA', regulatory:'Regulatory',
  agreements:'Agreements', other:'Other'
};

function chRenderDocuments() {
  const body = document.getElementById('ch-doc-body');
  if (!body) return;
  const docs = chDocFilter === 'all' ? chAllDocs : chAllDocs.filter(d => d.category === chDocFilter);
  if (!docs.length) {
    body.innerHTML = `<div style="padding:24px;text-align:center;color:var(--text-faint);font-size:12px;font-style:italic;">${chDocFilter==='all'?'No documents yet. Click + Upload to add your first document.':'No documents in this category.'}</div>`;
    return;
  }
  const extBadge = fn => {
    if (!fn) return '<span class="ch-doc-badge" style="background:#E8BCBC;color:#C0392B;">FILE</span>';
    const ext = fn.split('.').pop().toUpperCase();
    const colors = {PDF:'#E8BCBC:#C0392B', DOCX:'#BCD4E8:#2B6AC0', DOC:'#BCD4E8:#2B6AC0', XLSX:'#C4E8BC:#2BC046', XLS:'#C4E8BC:#2BC046', TXT:'#E8E4BC:#8A7A20'};
    const [bg, col] = (colors[ext]||'var(--cream-dark):var(--text-muted)').split(':');
    return `<span class="ch-doc-badge" style="background:${bg};color:${col};">${ext}</span>`;
  };
  body.innerHTML = docs.map(doc => `
    <div class="ch-doc-item" style="display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid var(--cream-mid);">
      ${extBadge(doc.filename)}
      <div style="flex:1;min-width:0;">
        <div style="font-size:12.5px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(doc.name)}</div>
        <div style="font-size:11px;color:var(--text-muted);">${esc(DOC_CAT_LABELS[doc.category]||doc.category||'')}${doc.notes?' · '+esc(doc.notes):''}</div>
      </div>
      <div style="font-size:11px;color:var(--text-faint);white-space:nowrap;text-align:right;">
        ${esc(doc.doc_date||'')}
        <div style="font-size:10px;margin-top:1px;">${esc((doc.uploaded_at||'').slice(0,10))}</div>
      </div>
      <button class="icon-btn danger" onclick="chDeleteDoc('${doc.id}')" title="Delete" style="flex-shrink:0;"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></button>
    </div>`).join('');
}

async function chDeleteDoc(docId) {
  if (!confirm('Remove this document?')) return;
  const r = await fetch('/api/corp/doc/delete', {method:'POST', headers:await chHeaders(),
    body:JSON.stringify({entity_id:chCurrentId, doc_id:docId})});
  const d = await r.json();
  if (d.ok) { chAllDocs = chAllDocs.filter(d=>d.id!==docId); chRenderDocuments(); toast('Document removed'); }
  else toast(d.error||'Error', true);
}

// ── Utility ───────────────────────────────────────────────────

function chCloseModal(id) {
  document.getElementById(id).style.display = 'none';
}

async function chRefreshEntity() {
  if (!chCurrentId) return;
  const r = await fetch(`/api/corp/entity?id=${chCurrentId}`);
  const d = await r.json();
  if (d.entity) chCurrentEntity = d.entity;
}

async function chLoadOnVaultOpen() {
  // Ensure CSRF token is fresh before any state-changing requests
  if (!csrfToken) {
    try {
      const r = await fetch('/api/csrf');
      const d = await r.json();
      if (d.token) csrfToken = d.token;
    } catch(e) {}
  }
  chLoadEntities();
}

function newMeetingDialog(){
  const f=document.getElementById('new-meeting-form');
  f.style.display=f.style.display==='none'||f.style.display===''?'block':'none';
  if(f.style.display==='block'){const d=new Date();document.getElementById('nm-date').value=d.toISOString().slice(0,10);}
}

function minutesTranscriptSelected(input){if(input.files[0]){document.getElementById('new-meeting-form').style.display='block';toast('Transcript ready — proceed to create meeting');}}

async function createMeeting(){
  const type=document.getElementById('nm-type').value;const date=document.getElementById('nm-date').value;
  const location=document.getElementById('nm-location').value;const attendees=document.getElementById('nm-attendees').value;
  const transcript=document.getElementById('nm-transcript').value.trim();
  if(!date||!type){toast('Enter meeting type and date',true);return;}
  const d=new Date(date);const dateStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  const listBody=document.getElementById('meetings-list-body');
  const newItem=document.createElement('div');newItem.className='meeting-item';
  newItem.innerHTML=`<div class="m-date">${dateStr}</div><div class="m-title">${esc(type)}</div><div class="m-sub">${esc(location)||'—'} · 0 actions</div>`;
  newItem.onclick=()=>{document.querySelectorAll('.meeting-item').forEach(i=>i.classList.remove('active'));newItem.classList.add('active');updateMinuteDetail(type,dateStr,location,attendees);};
  const emptyRow=document.getElementById('meetings-empty');
  if(emptyRow)emptyRow.remove();
  listBody.insertBefore(newItem,listBody.firstChild);
  document.getElementById('new-meeting-form').style.display='none';
  document.getElementById('nm-transcript').value='';
  toast('Meeting created');
  updateMinuteDetail(type,dateStr,location,attendees);
  if(transcript){
    document.getElementById('mintab-summary').innerHTML='<div class="ai-banner"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:var(--amber);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>Mickey is summarising your transcript…</div>';
    const r=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:`You are a legal secretary. Summarise this meeting transcript concisely: key discussion points (2-3 sentences), action items (with owner), and decisions taken.\n\nMeeting: ${type} on ${dateStr}\nAttendees: ${attendees}\n\n${transcript}`,history:[],web_search:false})});
    const d2=await r.json();
    if(d2.answer)document.getElementById('mintab-summary').innerHTML='<div class="ai-banner"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:var(--amber);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>AI summary · Verify against signed minutes</div><div class="md" style="font-size:13px;line-height:1.7;">'+md(d2.answer)+'</div>';
    toast('Meeting summarised by Mickey');
  }
}

function updateMinuteDetail(type,dateStr,location,attendees){
  document.getElementById('minutes-detail-empty').style.display='none';
  document.getElementById('minutes-detail-content').style.display='';
  document.getElementById('minutes-detail-title').textContent=`${type} — ${dateStr}`;
  document.getElementById('minutes-detail-sub').textContent=`${location||'—'} · ${attendees||'—'}`;
  document.getElementById('mintab-summary').innerHTML='<div class="ai-banner"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:var(--amber);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>No transcript yet. Paste notes in the new meeting form to generate a summary.</div>';
  document.getElementById('mintab-actions').innerHTML='<div class="actions-label">No action items yet.</div>';
  document.getElementById('mintab-decisions').innerHTML='<div class="actions-label">No decisions yet.</div>';
  const firstTab=document.querySelector('#mod-minutes .md-tab');
  if(firstTab)switchMinTab(firstTab,'summary');
}

function switchMinTab(btn,tab){
  document.querySelectorAll('#mod-minutes .md-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  ['summary','actions','decisions','full'].forEach(t=>{const el=document.getElementById('mintab-'+t);if(el)el.style.display=t===tab?'':'none';});
}

function selectMeeting(el,idx){document.querySelectorAll('.meeting-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}

async function loadLibrary(){
  const r=await fetch('/api/library');const d=await r.json();
  const list=document.getElementById('library-list');
  if(!d.docs||!d.docs.length){list.innerHTML='<div style="color:var(--text-muted);font-size:13px;">No documents in the Legal Library yet.</div>';return;}
  list.innerHTML=d.docs.map(doc=>`<div class="folder-card"><div class="folder-info"><div class="folder-label">${esc(doc.name)}</div><div class="folder-path">${esc(doc.jurisdiction||'')}${doc.topic?' · '+esc(doc.topic):''} · ${doc.size_kb||0} KB · Added ${(doc.added_at||'').slice(0,10)}</div></div>${isAdmin?`<div class="folder-actions"><button class="btn btn-sm btn-danger" onclick="deleteLibDoc('${doc.id}')">Remove</button></div>`:''}</div>`).join('');
  document.getElementById('kb-library').textContent=d.docs.length;
}

function libFileSelected(input){const f=input.files[0];if(f)document.getElementById('lib-filename').textContent=f.name;}

async function addLibDoc(){
  const file=document.getElementById('lib-file').files[0];const name=document.getElementById('lib-name').value.trim();
  if(!file||!name){toast('Upload a file and enter a name',true);return;}
  const fd=new FormData();fd.append('file',file);fd.append('name',name);fd.append('jurisdiction',document.getElementById('lib-jurisdiction').value);fd.append('topic',document.getElementById('lib-topic').value);
  const r=await fetch('/api/library/add',{method:'POST',body:fd});const d=await r.json();
  if(d.error){toast(d.error,true);return;}
  toast('Added to Legal Library');document.getElementById('lib-name').value='';document.getElementById('lib-jurisdiction').value='';document.getElementById('lib-topic').value='';document.getElementById('lib-filename').textContent='';
  loadLibrary();loadStats();
}

async function deleteLibDoc(id){
  if(!confirm('Remove this document from the Legal Library?'))return;
  await fetch('/api/library/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  toast('Removed');loadLibrary();loadStats();
}

function wsFileSelected(input){const f=input.files[0];if(f)document.getElementById('ws-filename').textContent=f.name;}

async function loadWorkspace(){
  const r=await fetch('/api/workspace');const d=await r.json();
  const list=document.getElementById('workspace-list');
  if(!d.docs||!d.docs.length){list.innerHTML='<div style="color:var(--text-muted);font-size:13px;">No documents yet</div>';document.getElementById('kb-workspace').textContent='0';return;}
  list.innerHTML=d.docs.map(doc=>`<div class="folder-card"><div class="folder-info"><div class="folder-label">${esc(doc.name.replace(/_/g,' '))}</div><div class="folder-path">${doc.size_kb} KB</div></div><div class="folder-actions"><button class="btn btn-sm btn-danger" onclick="deleteWsDoc('${doc.id}')">&#215;</button></div></div>`).join('');
  document.getElementById('kb-workspace').textContent=d.docs.length;
}
function loadWorkspaceDocs(){loadWorkspace();}

async function addWsDoc(){
  const file=document.getElementById('ws-file').files[0];const name=document.getElementById('ws-name').value.trim();
  if(!file||!name){toast('Upload a file and enter a name',true);return;}
  const fd=new FormData();fd.append('file',file);fd.append('name',name);
  const r=await fetch('/api/workspace/add',{method:'POST',body:fd});const d=await r.json();
  if(d.error){toast(d.error,true);return;}
  toast('Added to Workspace');document.getElementById('ws-name').value='';document.getElementById('ws-filename').textContent='';
  loadWorkspace();loadStats();
}

async function deleteWsDoc(id){
  if(!confirm('Remove this document?'))return;
  await fetch('/api/workspace/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  toast('Removed');loadWorkspace();loadStats();
}

function showKbTab(tab){
  document.getElementById('kb-panel-library').style.display=tab==='library'?'':'none';
  document.getElementById('kb-panel-workspace').style.display=tab==='workspace'?'':'none';
  const on='padding:8px 18px;background:none;border:none;border-bottom:2px solid var(--green);color:var(--green);font-size:13px;cursor:pointer;margin-bottom:-2px;font-weight:600;font-family:var(--font-sans);';
  const off='padding:8px 18px;background:none;border:none;border-bottom:2px solid transparent;color:var(--text-muted);font-size:13px;cursor:pointer;margin-bottom:-2px;font-weight:500;font-family:var(--font-sans);';
  document.getElementById('kb-tab-library').style.cssText=tab==='library'?on:off;
  document.getElementById('kb-tab-workspace').style.cssText=tab==='workspace'?on:off;
  if(tab==='library'){loadLibrary();if(isAdmin)document.getElementById('nav-admin-library').style.display='block';}
  if(tab==='workspace')loadWorkspaceDocs();
}

async function loadKnowledgeBase(){
  showKbTab('library');
  try{const r=await fetch('/api/stats');const d=await r.json();const lc=document.getElementById('kb-lib-count');const wc=document.getElementById('kb-ws-count');if(lc)lc.textContent=`(${d.library||0})`;if(wc)wc.textContent=`(${d.workspace||0})`;}catch(e){}
}

async function loadStorage(){
  const r=await fetch('/api/storage');const d=await r.json();
  const list=document.getElementById('folder-list');
  if(!d.folders||!d.folders.length){list.innerHTML='<div style="color:var(--text-muted);font-size:13px;margin-bottom:8px;">No folders connected yet.</div>';return;}
  list.innerHTML=d.folders.map((f)=>`<div class="folder-card"><div class="folder-info"><div class="folder-label">${esc(f.label)}</div><div class="folder-path">${esc(f.path)}</div></div><div class="folder-count"><div class="folder-count-n">${f.count}</div><div class="folder-count-l">indexed</div></div><div style="font-size:12px;">${f.exists?'✅':'❌'}</div><div class="folder-actions"><button class="btn btn-sm btn-primary" onclick="syncFolder('${esc(f.path)}','${esc(f.label)}',this)">Sync</button><button class="btn btn-sm btn-danger" onclick="removeFolder('${esc(f.label)}')">Remove</button></div></div>`).join('');
  document.getElementById('sync-all-wrap').style.display=d.folders.length?'block':'none';
  loadStats();
}

async function addFolder(){
  const label=document.getElementById('st-label').value.trim();const path=document.getElementById('st-path').value.trim();
  const status=document.getElementById('st-status');if(!label||!path){toast('Enter both a label and a path',true);return;}
  status.textContent='Scanning…';
  const r=await fetch('/api/storage/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,label})});
  const d=await r.json();status.textContent='';
  if(d.error){toast(d.error,true);return;}
  document.getElementById('st-label').value='';document.getElementById('st-path').value='';
  toast(`Added — ${d.new} files indexed`);loadStorage();
}

async function syncFolder(path,label,btn){
  const orig=btn.textContent;btn.innerHTML='<span class="spinner"></span>';btn.disabled=true;
  const r=await fetch('/api/storage/sync',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,label})});
  const d=await r.json();btn.textContent=orig;btn.disabled=false;
  if(d.error){toast(d.error,true);return;}toast(`${d.new} new files indexed`);loadStorage();
}

async function removeFolder(label){
  if(!confirm(`Remove "${label}"?`))return;
  await fetch('/api/storage/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({label})});
  loadStorage();
}

async function syncAll(){
  const r=await fetch('/api/storage');const d=await r.json();
  for(const f of d.folders)await fetch('/api/storage/sync',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:f.path,label:f.label})});
  toast('All folders synced');loadStorage();
}

async function loadStats(){
  const r=await fetch('/api/stats');const d=await r.json();
  document.getElementById('kb-library').textContent=d.library||0;
  document.getElementById('kb-workspace').textContent=d.workspace||0;
  document.getElementById('kb-drive').textContent=d.drive||0;
  if(document.getElementById('dash-docs-count'))document.getElementById('dash-docs-count').textContent=(d.library||0)+(d.workspace||0);
}

async function loadAdminUsers(){
  const r=await fetch('/api/admin/users');const d=await r.json();
  const tbody=document.getElementById('admin-user-tbody');
  tbody.innerHTML=d.users.map(u=>`<tr><td>${esc(u.display_name)}</td><td style="font-family:monospace;font-size:12px;">${esc(u.username)}</td><td><span class="admin-badge ${u.role==='admin'?'badge-admin':'badge-user'}">${u.role}</span></td><td style="font-size:11px;color:var(--text-muted);">${(u.created||'').slice(0,10)}</td><td style="font-size:12px;color:var(--text-muted);">${(u.usage?.calls||0)} calls / ${(((u.usage?.tokens||0)/1000).toFixed(1))}k tok</td><td><div style="display:flex;gap:6px;">${u.role!=='admin'?`<button class="btn btn-sm" onclick="promoteUser('${u.username}')">Make admin</button>`:''}<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')">Delete</button></div></td></tr>`).join('');
}

async function deleteUser(username){
  if(!confirm(`Delete user "${username}" and ALL their data permanently?`))return;
  const r=await fetch('/api/admin/users/delete',{method:'POST',headers:ch(),body:JSON.stringify({username})});
  const d=await r.json();if(d.error){toast(d.error,true);return;}toast('User deleted');loadAdminUsers();
}
async function promoteUser(username){
  if(!confirm(`Make "${username}" an admin?`))return;
  await fetch('/api/admin/users/promote',{method:'POST',headers:ch(),body:JSON.stringify({username})});
  toast('User promoted to admin');loadAdminUsers();
}

async function loadKeyStatus(){
  const r=await fetch('/api/key/status');const d=await r.json();
  const aks=document.getElementById('admin-key-status');const oas=document.getElementById('admin-oai-status');
  if(aks)aks.textContent=d.anthropic?'Configured: '+d.anthropic_masked:'Not configured — enter below.';
  if(oas)oas.textContent=d.openai?'Configured: '+d.openai_masked+' — Semantic search active':'Not configured — semantic search using fallback mode.';
  try{const ur=await fetch('/api/admin/usage');const ud=await ur.json();const wrap=document.getElementById('admin-usage-wrap');if(wrap&&ud){wrap.innerHTML='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;">'+Object.entries(ud).map(([user,stats])=>`<div class="panel" style="padding:14px;"><div style="font-weight:600;font-family:var(--font-serif);font-size:15px;margin-bottom:4px;">${esc(user)}</div><div style="font-size:11px;color:var(--text-muted);">${stats.calls} calls &nbsp;·&nbsp; ${((stats.tokens||0)/1000).toFixed(1)}k tokens<br>${Object.entries(stats.by_event||{}).map(([e,n])=>e+': '+n).join(' · ')}</div></div>`).join('')+'</div>';}}catch(e){}
}

async function saveKey(){
  const key=document.getElementById('admin-key-input').value.trim();if(!key){toast('Enter an Anthropic key',true);return;}
  const r=await fetch('/api/key/set',{method:'POST',headers:ch(),body:JSON.stringify({key})});const d=await r.json();
  if(d.ok){toast('Anthropic key saved');document.getElementById('admin-key-input').value='';loadKeyStatus();}else toast(d.error||'Error',true);
}
async function saveOaiKey(){
  const key=document.getElementById('admin-oai-input').value.trim();if(!key){toast('Enter an OpenAI key',true);return;}
  const r=await fetch('/api/key/set_oai',{method:'POST',headers:ch(),body:JSON.stringify({key})});const d=await r.json();
  if(d.ok){toast('OpenAI key saved');document.getElementById('admin-oai-input').value='';loadKeyStatus();}else toast(d.error||'Error',true);
}

function loadSettingsInfo(){document.getElementById('settings-info').textContent=`Signed in as ${displayName}${isAdmin?' (Admin)':''}`;}

async function changePw(){
  const current=document.getElementById('pw-current').value;const nw=document.getElementById('pw-new').value;const nw2=document.getElementById('pw-new2').value;
  const r=await fetch('/auth/change-password',{method:'POST',headers:ch(),body:JSON.stringify({current,new:nw,confirm:nw2})});const d=await r.json();
  if(d.ok){toast('Password changed');document.getElementById('pw-current').value='';document.getElementById('pw-new').value='';document.getElementById('pw-new2').value='';}else toast(d.error||'Error',true);
}

function createPB(){
  const name=document.getElementById('pb-name').value.trim();const desc=document.getElementById('pb-desc-input').value.trim();
  if(!name||!desc){toast('Enter a name and description',true);return;}
  document.getElementById('pb-grid').insertAdjacentHTML('beforeend',`<div class="pb-card"><div class="pb-name">${esc(name)}</div><div class="pb-desc">${esc(desc)}</div><div class="pb-meta">&#128203; Custom</div><button class="btn btn-sm" onclick="go('duediligence',document.querySelector('[data-mod=duediligence]'))">Use in Due Diligence &#8594;</button></div>`);
  document.getElementById('pb-name').value='';document.getElementById('pb-desc-input').value='';toast('Playbook created');
}

async function showInfoTab(tab){
  ['terms','privacy','disclaimer'].forEach(t=>{const b=document.getElementById('info-tab-'+t);if(b)b.classList.toggle('btn-primary',t===tab);});
  const box=document.getElementById('info-content');box.innerHTML='<span style="color:var(--text-muted)">Loading...</span>';
  const r=await fetch('/api/info/'+tab);const d=await r.json();
  box.innerHTML=d.content?md(d.content):'<span style="color:var(--red)">Could not load page</span>';
}

async function submitDataRequest(type){
  if(!confirm(`Submit a request for ${type==='export'?'data export':'account deletion'}?`))return;
  const r=await fetch('/api/data_request/submit',{method:'POST',headers:ch(),body:JSON.stringify({type})});const d=await r.json();
  if(d.error){toast(d.error,true);return;}toast('Request submitted.');loadMyDataRequests();
}

async function loadMyDataRequests(){
  const r=await fetch('/api/data_request/status');const d=await r.json();
  const el=document.getElementById('my-data-requests');if(!el)return;
  if(!d.requests||!d.requests.length){el.innerHTML='';return;}
  const statusColors={pending:'#e67e22',approved:'var(--green)',rejected:'var(--red)'};
  el.innerHTML=d.requests.map(req=>`<div style="background:var(--cream);border:1px solid var(--cream-mid);border-radius:var(--r);padding:9px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;"><div style="flex:1;"><div style="font-size:12px;font-weight:600;text-transform:capitalize;">${req.type} request</div><div style="font-size:10px;color:var(--text-muted);">${(req.submitted_at||'').slice(0,16).replace('T',' ')}</div></div><div style="font-size:11px;font-weight:600;color:${statusColors[req.status]||'#aaa'};text-transform:uppercase;">${req.status}</div></div>`).join('');
}

async function loadAdminDataRequests(){
  const wrap=document.getElementById('admin-data-requests');if(!wrap)return;
  const r=await fetch('/api/admin/data_requests');const d=await r.json();
  const pending=(d.requests||[]).filter(r=>r.status==='pending');
  if(!pending.length){wrap.innerHTML='<div style="color:var(--text-muted);font-size:13px;">No pending data requests.</div>';return;}
  wrap.innerHTML=pending.map(req=>`<div class="folder-card" style="align-items:flex-start;"><div style="flex:1;"><div style="font-family:var(--font-serif);font-size:15px;font-weight:500;">${esc(req.display_name)} (${esc(req.username)})</div><div style="font-size:11px;color:var(--text-muted);margin-top:2px;"><span style="text-transform:uppercase;font-weight:600;color:${req.type==='deletion'?'var(--red)':'var(--blue)'};">${req.type}</span> &nbsp;·&nbsp; ${(req.submitted_at||'').slice(0,16).replace('T',' ')}</div></div><div style="display:flex;gap:7px;flex-shrink:0;"><button class="btn btn-sm btn-primary" onclick="approveDataReq('${req.id}','${req.type}')">${req.type==='export'?'Approve & Download':'Approve deletion'}</button><button class="btn btn-sm btn-danger" onclick="rejectDataReq('${req.id}')">Reject</button></div></div>`).join('');
}

async function approveDataReq(rid,type){
  if(type==='deletion'&&!confirm('Approve this deletion request?'))return;
  const r=await fetch('/api/admin/data_request/approve',{method:'POST',headers:ch(),body:JSON.stringify({id:rid})});
  if(type==='export'&&r.ok&&r.headers.get('content-type')?.includes('zip')){const blob=await r.blob();const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='mickey_export.zip';a.click();URL.revokeObjectURL(url);toast('Export downloaded.');}
  else{const d=await r.json();if(d.error)toast(d.error,true);else toast(type==='deletion'?'Approved. Delete account via user management.':'Done.');}
  loadAdminDataRequests();
}

async function rejectDataReq(rid){
  const reason=prompt('Reason for rejection (optional):')||'';
  const r=await fetch('/api/admin/data_request/reject',{method:'POST',headers:ch(),body:JSON.stringify({id:rid,reason})});
  const d=await r.json();if(d.ok)toast('Request rejected');else toast(d.error||'Error',true);loadAdminDataRequests();
}

let currentCollectionId=null,colModalContent='',colModalTitle='';
function showNewCollection(){document.getElementById('new-col-form').style.display='block';document.getElementById('new-col-name').focus();}
function hideNewCollection(){document.getElementById('new-col-form').style.display='none';document.getElementById('new-col-name').value='';}

async function createCollection(){
  const name=document.getElementById('new-col-name').value.trim();if(!name){toast('Enter a collection name',true);return;}
  const r=await fetch('/api/collections/create',{method:'POST',headers:ch(),body:JSON.stringify({name})});const d=await r.json();
  if(d.ok){hideNewCollection();toast('Collection created');loadCollections();}else toast(d.error||'Error',true);
}

async function loadCollections(){
  const r=await fetch('/api/collections');const d=await r.json();const cols=d.collections||{};
  const list=document.getElementById('collections-list');
  document.getElementById('collection-detail').style.display='none';list.style.display='block';
  if(!Object.keys(cols).length){list.innerHTML='<div style="color:var(--text-muted);font-size:13px;padding:20px 0;">No collections yet. Create one above, or save an answer from Discovery.</div>';return;}
  list.innerHTML=Object.entries(cols).map(([cid,col])=>`<div class="folder-card" style="cursor:pointer;" onclick="openCollection('${cid}')"><div style="font-size:20px;margin-right:4px;">&#128218;</div><div class="folder-info"><div class="folder-label">${esc(col.name)}</div><div class="folder-path">${(col.items||[]).length} item${(col.items||[]).length===1?'':'s'} · Created ${(col.created||'').slice(0,10)}</div></div><div class="folder-actions" onclick="event.stopPropagation()"><button class="btn btn-sm btn-danger" onclick="deleteCol('${cid}')">Delete</button></div></div>`).join('');
}

async function openCollection(cid){
  currentCollectionId=cid;const r=await fetch('/api/collections');const d=await r.json();const col=d.collections[cid];if(!col)return;
  document.getElementById('collections-list').style.display='none';const detail=document.getElementById('collection-detail');detail.style.display='block';
  document.getElementById('col-detail-name').textContent=col.name;const items=col.items||[];
  const itemsList=document.getElementById('col-items-list');
  if(!items.length){itemsList.innerHTML='<div style="color:var(--text-muted);font-size:13px;padding:20px 0;">No items. Save answers from Discovery using the bookmark button.</div>';return;}
  const icons={answer:'&#128172;',document:'&#128196;',draft:'&#9999;'};
  itemsList.innerHTML=items.map(item=>`<div class="panel" style="margin-bottom:10px;padding:16px;"><div style="display:flex;align-items:flex-start;gap:10px;"><div style="font-size:18px;flex-shrink:0;">${icons[item.type]||'&#128204;'}</div><div style="flex:1;"><div style="font-family:var(--font-serif);font-size:15px;font-weight:500;margin-bottom:4px;">${esc(item.title||'')}</div><div style="font-size:10px;color:var(--text-muted);margin-bottom:8px;">${(item.saved_at||'').slice(0,16).replace('T',' ')} · ${esc(item.source||'')}</div><div class="md" style="font-size:13px;line-height:1.6;max-height:200px;overflow:hidden;">${md(item.content||'')}</div></div><button class="btn btn-sm btn-danger" onclick="deleteColItem('${cid}','${item.id}')">&#215;</button></div></div>`).join('');
}

function backToCollections(){currentCollectionId=null;document.getElementById('collection-detail').style.display='none';document.getElementById('collections-list').style.display='block';}
async function deleteCol(cid){if(!confirm('Delete this collection and all its items?'))return;await fetch('/api/collections/delete',{method:'POST',headers:ch(),body:JSON.stringify({collection_id:cid})});toast('Collection deleted');loadCollections();}
async function deleteCurrentCollection(){if(!currentCollectionId)return;await deleteCol(currentCollectionId);}
async function deleteColItem(cid,iid){await fetch('/api/collections/delete_item',{method:'POST',headers:ch(),body:JSON.stringify({collection_id:cid,item_id:iid})});toast('Item removed');openCollection(cid);}

function openSaveToCollection(answerId,title){
  const el=document.getElementById(answerId);colModalContent=el?el.innerText:'';colModalTitle=title;
  document.getElementById('col-modal-title').textContent='Saving: "'+title+'"';
  loadCollectionsIntoModal();document.getElementById('col-modal').style.display='flex';
}
function closeColModal(){document.getElementById('col-modal').style.display='none';document.getElementById('col-modal-new').value='';}

async function loadCollectionsIntoModal(){
  const r=await fetch('/api/collections');const d=await r.json();const cols=d.collections||{};const sel=document.getElementById('col-modal-select');
  if(!Object.keys(cols).length){sel.innerHTML='<option value="">No collections — create one below</option>';return;}
  sel.innerHTML=Object.entries(cols).map(([cid,col])=>`<option value="${cid}">${esc(col.name)}</option>`).join('');
}
async function confirmSaveToCollection(){const cid=document.getElementById('col-modal-select').value;if(!cid){toast('Select a collection',true);return;}await _doSave(cid);}
async function createAndSave(){const name=document.getElementById('col-modal-new').value.trim();if(!name){toast('Enter a collection name',true);return;}const r=await fetch('/api/collections/create',{method:'POST',headers:ch(),body:JSON.stringify({name})});const d=await r.json();if(!d.ok){toast(d.error||'Error',true);return;}await _doSave(d.id);}
async function _doSave(cid){const r=await fetch('/api/collections/save_item',{method:'POST',headers:ch(),body:JSON.stringify({collection_id:cid,title:colModalTitle,content:colModalContent,type:'answer',source:'Mickey Discovery'})});const d=await r.json();if(d.ok){toast('Saved to collection');closeColModal();}else toast(d.error||'Error',true);}

function toggleTag(el){el.classList.toggle('on');}
function getTags(sel){return Array.from(document.querySelectorAll(sel+' .tag.on')).map(t=>t.textContent).join(', ');}
function showFName(inputId,displayId){const f=document.getElementById(inputId).files[0];if(!f)return;const el=document.getElementById(displayId);el.classList.add('visible');const t=document.getElementById(displayId+'-t');if(t)t.textContent=f.name;}
function showFNames(inputId,containerId){const files=document.getElementById(inputId).files;document.getElementById(containerId).innerHTML=Array.from(files).map(f=>`<div class="file-name visible"><span>&#128196;</span><span>${esc(f.name)}</span></div>`).join('');}
function dragOver(e,el){e.preventDefault();el.classList.add('over');}
function dragLeave(el){el.classList.remove('over');}
function dropFile(e,inputId,dropEl){e.preventDefault();dropEl.classList.remove('over');if(e.dataTransfer.files.length){const input=document.getElementById(inputId);input.files=e.dataTransfer.files;input.dispatchEvent(new Event('change'));}}

function md(text){
  if(!text)return'';const lines=text.split('\n');let html='',inList=false;
  for(let i=0;i<lines.length;i++){
    let l=lines[i];
    if(/^### /.test(l)){if(inList){html+='</ul>';inList=false;}html+=`<h3>${inlinemd(l.slice(4))}</h3>`;continue;}
    if(/^## /.test(l)){if(inList){html+='</ul>';inList=false;}html+=`<h2>${inlinemd(l.slice(3))}</h2>`;continue;}
    if(/^# /.test(l)){if(inList){html+='</ul>';inList=false;}html+=`<h1>${inlinemd(l.slice(2))}</h1>`;continue;}
    if(/^[🔴🟡🟢]/.test(l)){if(inList){html+='</ul>';inList=false;}html+=`<div class="finding"><span class="finding-icon">${l[0]}</span><span>${inlinemd(l.slice(1).trim())}</span></div>`;continue;}
    if(/^[-*] /.test(l)||/^\d+\. /.test(l)){if(!inList){html+='<ul>';inList=true;}html+=`<li>${inlinemd(l.replace(/^[-*] /,'').replace(/^\d+\. /,''))}</li>`;continue;}
    if(l.trim()===''){if(inList){html+='</ul>';inList=false;}continue;}
    if(inList){html+='</ul>';inList=false;}html+=`<p>${inlinemd(l)}</p>`;
  }
  if(inList)html+='</ul>';return html;
}
function inlinemd(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/`(.+?)`/g,'<code style="background:var(--cream);padding:1px 4px;border-radius:3px;font-size:12px;">$1</code>');}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
let toastTimer;
function toast(msg,error=false,success=false){const el=document.getElementById('toast');clearTimeout(toastTimer);el.textContent=msg;el.className='toast show'+(error?' error':success?' success':'');toastTimer=setTimeout(()=>el.className='toast',2800);}

init();

// ── COMPLIANCE MODULE ──────────────────────────────────────
// Shorthand: get trimmed value of a form field by id
function v(id) { return (document.getElementById(id)?.value || '').trim(); }
// ── Compliance Module State ────────────────────────────────────────────────
const STATE = {
  role: '',
  firmId: '',
  modules: [],
  currentModule: 'gdpr',
  currentView: { gdpr:'dpo', abc:'gifts', wb:'wb-cases', settings:'settings-users' },
  data: { ropa:[], dsrs:[], breaches:[], dpias:[], tias:[], dpas:[], gifts:[], coi:[], tpdd:[], donations:[], flags:[], wb:[], policies:{gdpr:[],abc:[],wb:[]} },
  settings: {},
  dashboard: {}
};

// ── Compliance Init (called by go('compliance') in main app) ──────────────
async function compInit() {
  // Populate STATE from main app session
  try {
    const r = await fetch('/api/auth/status');
    const d = await r.json();
    if (d.logged_in) {
      STATE.role = d.compliance_role || d.role || 'viewer';
      STATE.firmId = d.firm_id || '';
      STATE.modules = d.modules || [];
    }
  } catch(e) {}
  applyRoleVisibility();
  // Restore previously visited compliance module/view
  try{
    const savedMod=localStorage.getItem('mickey-comp-module');
    if(savedMod)STATE.currentModule=savedMod;
    const savedViews=localStorage.getItem('mickey-comp-view');
    if(savedViews)Object.assign(STATE.currentView,JSON.parse(savedViews));
  }catch(e){}
  setModule(STATE.currentModule || 'gdpr');
  loadDashboardBadges();
}

function applyRoleVisibility() {
  const isEditor = STATE.role === 'admin' || STATE.role === 'editor';
  document.querySelectorAll('.editor-only').forEach(el => {
    if (!isEditor) el.style.display = 'none';
  });
  // Red flag log hidden from viewers
  if (!isEditor) {
    const flagItem = document.querySelector('[data-view="flags"]');
    if (flagItem) flagItem.style.display = 'none';
  }
}

function applyModuleVisibility() {
  // Hide WB links if user doesn't have whistleblowing module
  if (!STATE.modules.includes('whistleblowing')) {
    document.querySelectorAll('#sub-wb-link,#abc-wb-link').forEach(el => {
      if (el) el.style.display = 'none';
    });
  }
}

// loadSidebarUser: handled by main app

// ── Module / View switching ───────────────────────────────────────────────
function setModule(m) {
  STATE.currentModule = m;
  ['module-gdpr','module-abc','module-wb','module-settings'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });
  const mod = document.getElementById('module-' + m);
  if (mod) { mod.style.display = 'flex'; mod.style.flex = '1'; }
  const v = STATE.currentView[m] || '';
  if (v) setView(m, v);
  // Load data for this module
  loadModuleData(m);
  // Persist compliance module selection
  try{localStorage.setItem('mickey-comp-module',m);}catch(e){}
}

function setView(module, view) {
  STATE.currentView[module] = view;
  const contentId = module + '-content';
  const content = document.getElementById(contentId);
  if (!content) return;
  content.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  const target = document.getElementById('view-' + module + '-' + view);
  if (target) target.classList.add('active');
  // Persist compliance view selection
  try{localStorage.setItem('mickey-comp-view',JSON.stringify(STATE.currentView));}catch(e){}
  // Update sub-nav active state
  const modEl = document.getElementById('module-' + module);
  if (modEl) {
    modEl.querySelectorAll('.sub-item').forEach(el => {
      el.classList.toggle('active', el.dataset.view === view);
    });
  }
}

// ── Data loading ──────────────────────────────────────────────────────────
async function loadModuleData(m) {
  if (m === 'gdpr') {
    await Promise.all([loadRopa(), loadDsrs(), loadBreaches(), loadDpias(), loadTias(), loadDpas(), loadDpo()]);
    loadPolicies('gdpr');
  } else if (m === 'abc') {
    await Promise.all([loadGifts(), loadCoi(), loadTpdd(), loadDonations(), loadFlags()]);
    loadPolicies('abc');
  } else if (m === 'wb') {
    await Promise.all([loadWb(), loadWbStats()]);
    loadPolicies('wb');
  } else if (m === 'settings') {
    loadUsers();
    loadComplianceSettings();
  }
}

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(path, opts);
  const json = await r.json();
  if (!json.ok && !r.ok) throw new Error(json.error || 'Request failed');
  return json.data !== undefined ? json.data : json;
}

// ── DPO ──────────────────────────────────────────────────────────────────
async function loadDpo() {
  try {
    const d = await api('GET', '/api/compliance/dpo');
    renderDpo(d);
  } catch(e) { console.error(e); }
}

function renderDpo(d) {
  const content = document.getElementById('dpo-content');
  if (!d || !d.dpo_name) return; // show empty state
  const sa = d.supervisory_authority || '';
  content.innerHTML = `
    <div style="padding:0 0 14px;">
      <div class="dpo-hero">
        <div style="display:flex;align-items:center;gap:14px;">
          <div class="dpo-avatar">${(d.dpo_name||'?').split(' ').map(w=>w[0]).join('').substring(0,2)}</div>
          <div>
            <div style="font-family:var(--font-serif);font-size:16px;font-weight:500;">${d.dpo_name}</div>
            <div style="font-size:11.5px;color:var(--text-mid);">${d.dpo_title||''} · ${d.dpo_type==='external'?'External / contracted':'Internal employee'}</div>
          </div>
        </div>
        <div class="dpo-stats">
          <div class="dpo-stat"><div class="dpo-stat-num" style="color:var(--blue);">${STATE.data.dsrs.filter(x=>x.status==='open').length}</div><div class="dpo-stat-lbl">Open DSRs</div></div>
          <div class="dpo-stat"><div class="dpo-stat-num" style="color:var(--amber);">${STATE.data.dpias.filter(x=>x.status!=='completed').length}</div><div class="dpo-stat-lbl">DPIAs active</div></div>
          <div class="dpo-stat"><div class="dpo-stat-num" style="color:var(--success);">${STATE.data.ropa.length}</div><div class="dpo-stat-lbl">RoPA activities</div></div>
        </div>
      </div>
      <div class="info-grid" style="margin-bottom:12px;">
        <div class="info-card"><div class="info-label">Contact email (public)</div><div class="info-val">${d.dpo_email||'—'}</div></div>
        <div class="info-card"><div class="info-label">Contact phone</div><div class="info-val">${d.dpo_phone||'—'}</div></div>
        <div class="info-card"><div class="info-label">Date of appointment</div><div class="info-val">${fmtDate(d.dpo_appointed)||'—'}</div></div>
        <div class="info-card"><div class="info-label">Supervisory authority</div><div class="info-val">${sa}</div></div>
        <div class="info-card"><div class="info-label">SA registration reference</div><div class="info-val">${d.dpo_sa_ref||'—'}</div></div>
        <div class="info-card"><div class="info-label">Next review</div><div class="info-val ${reviewClass(d.dpo_review)}">${fmtDate(d.dpo_review)||'—'}</div></div>
      </div>
      ${d.dpo_justification ? `<div class="info-card"><div class="info-label" style="margin-bottom:5px;">Business justification</div><div style="font-size:12px;color:var(--text-mid);line-height:1.75;">${d.dpo_justification}</div></div>` : ''}
    </div>`;
}

async function saveDPO() {
  const d = {
    dpo_name: v('dpo-name'), dpo_title: v('dpo-title'), dpo_type: v('dpo-type'),
    dpo_email: v('dpo-email'), dpo_phone: v('dpo-phone'),
    dpo_appointed: v('dpo-appointed'), dpo_review: v('dpo-review'),
    dpo_sa_ref: v('dpo-sa-ref'), dpo_justification: v('dpo-justification')
  };
  try {
    await api('POST', '/api/compliance/dpo', d);
    closeModal('modal-dpo');
    toast('DPO record saved', 'ok');
    loadDpo();
  } catch(e) { toast(e.message, 'err'); }
}

// ── RoPA ─────────────────────────────────────────────────────────────────
async function loadRopa() {
  try {
    const data = await api('GET', '/api/compliance/ropa');
    STATE.data.ropa = data;
    renderRopa(data);
    updateBadge('badge-ropa', data.filter(r=>r._rag==='red'||r._rag==='amber').length);
  } catch(e) { console.error(e); }
}

function renderRopa(data) {
  const rag = ragCounts(data, '_rag');
  document.getElementById('ropa-rag').innerHTML = `
    ${ragCard(rag.red,'Overdue review','red')}${ragCard(rag.amber,'Due <30 days','amber')}${ragCard(rag.green,'Up to date','green')}
    <div class="rag-card" style="flex:.8;background:var(--blue-bg);border-color:var(--blue-border)"><div><div class="rag-num" style="color:var(--blue)">${data.filter(r=>r.dpia_required==='yes').length}</div><div class="rag-label" style="color:var(--blue)">DPIA required</div></div></div>`;
  const tbody = document.getElementById('ropa-tbody');
  if (!data.length) { tbody.innerHTML = `<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No activities recorded yet.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r => `
    <tr class="${rowClass(r._rag)}" onclick="editRopa('${r.id}')">
      <td><div class="td-main">${r.activity_name}</div>${r.role==='processor'?'<div class="td-sub">For: '+esc(r.controller_name||'')+'</div>':''}</td>
      <td><span class="badge-tag ${r.role==='controller'?'badge-blue':'badge-muted'}">${r.role==='controller'?'Controller':'Processor'}</span></td>
      <td style="font-size:11px;color:var(--text-muted)">${r.role==='controller'?esc(r.legal_basis||'—'):'N/A (processor)'}</td>
      <td style="font-size:11px;color:var(--text-muted)">${r.role==='controller'?esc(trunc(r.data_categories,40)||'—'):esc(trunc(r.proc_categories,40)||'—')}</td>
      <td style="font-size:11px;color:var(--text-muted)">${r.role==='controller'?esc(r.retention||'—'):'Set by controller'}</td>
      <td>${dlBadge(r._days_remaining, r.review_date)}</td>
      <td><span class="pill pill-${r._rag==='red'?'red':r._rag==='amber'?'amber':'green'}">${r._rag==='red'?'Overdue':r._rag==='amber'?'Due soon':'Up to date'}</span></td>
      <td><span class="chevron">›</span></td>
    </tr>`).join('');
}

function setRopaRole(btn, role) {
  btn.closest('.role-toggle').querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('ropa-controller-fields').style.display = role==='controller' ? 'block' : 'none';
  document.getElementById('ropa-processor-fields').style.display = role==='processor' ? 'block' : 'none';
}

async function saveRopa() {
  const isCtrl = document.querySelector('#modal-ropa .role-btn.active')?.textContent?.includes('Controller');
  const d = {
    activity_name: v('ropa-name'), role: isCtrl ? 'controller' : 'processor',
    review_date: v('ropa-review-date'), notes: v('ropa-notes')
  };
  if (isCtrl) {
    Object.assign(d, { purposes: v('ropa-purposes'), legal_basis: v('ropa-legal-basis'),
      data_subjects: v('ropa-subjects'), data_categories: v('ropa-categories'),
      recipients: v('ropa-recipients'), transfers: v('ropa-transfers'),
      retention: v('ropa-retention'), special_category: v('ropa-special'),
      security_measures: v('ropa-security'), dpia_required: v('ropa-dpia-req') });
  } else {
    Object.assign(d, { controller_name: v('ropa-controller-name'), controller_contact: v('ropa-controller-contact'),
      proc_categories: v('ropa-proc-categories'), dpa_ref: v('ropa-proc-dpa-ref'),
      transfers: v('ropa-proc-transfers'), security_measures: v('ropa-proc-security') });
  }
  if (!d.activity_name) { toast('Activity name required','err'); return; }
  try {
    await api('POST','/api/compliance/ropa',d);
    closeModal('modal-ropa'); resetForm('modal-ropa'); toast('Activity saved',false,true); loadRopa();
  } catch(e) { toast(e.message,'err'); }
}

// ── DSR ──────────────────────────────────────────────────────────────────
async function loadDsrs() {
  try {
    const data = await api('GET','/api/compliance/dsrs');
    STATE.data.dsrs = data;
    renderDsrs(data);
    const urgent = data.filter(d=>d.status==='open'&&(d._rag==='red'||d._rag==='amber')).length;
    updateBadge('badge-dsr', urgent);
  } catch(e) { console.error(e); }
}

function renderDsrs(data) {
  const open = data.filter(d=>d.status==='open');
  const rag = ragCounts(open,'_rag');
  document.getElementById('dsr-rag').innerHTML =
    `${ragCard(rag.red,'Overdue','red')}${ragCard(rag.amber,'Due <14 days','amber')}${ragCard(rag.green,'On track','green')}${ragCard(data.filter(d=>d.status==='closed').length,'Closed','muted')}`;
  const alerts = document.getElementById('dsr-alerts');
  const overdue = open.filter(d=>d._rag==='red');
  alerts.innerHTML = overdue.map(d=>`<div class="alert-bar alert-red"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span><strong>${esc(d.requester_name)}</strong> — ${esc(d.right)} — Deadline ${fmtDate(d.deadline)} — <strong>${Math.abs(d._days_remaining)} days overdue</strong></span></div>`).join('');
  const tbody = document.getElementById('dsr-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DSRs recorded yet.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${rowClass(r._rag)}" data-status="${r.status}" data-role="${r.role}">
      <td><div class="td-main">${esc(r.requester_name)}</div></td>
      <td style="font-size:11.5px">${esc(r.right)}</td>
      <td><span class="badge-tag ${r.role==='controller'?'badge-blue':'badge-muted'}">${r.role==='controller'?'Controller':'Processor'}</span></td>
      <td style="font-size:11.5px">${fmtDate(r.received_date)}</td>
      <td style="font-size:11.5px">${r.deadline?fmtDate(r.deadline):'Clock paused'}</td>
      <td>${r.status==='closed'?'<span style="color:var(--text-muted);font-size:11px">Closed</span>':daysLeft(r._days_remaining)}</td>
      <td><span class="pill pill-${r.status==='closed'?'muted':r._rag==='red'?'red':r._rag==='amber'?'amber':'green'}">${r.status==='closed'?'Closed':r._rag==='red'?'Overdue':r._rag==='amber'?'Due soon':'On track'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="closeDsr('${r.id}',event)" ${r.status==='closed'?'disabled':''}>Close</button></td>
    </tr>`).join('');
}

function setDsrRole(btn, role) {
  btn.closest('.role-toggle').querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('dsr-role-hint-ctrl').style.display = role==='controller'?'flex':'none';
  document.getElementById('dsr-role-hint-proc').style.display = role==='processor'?'flex':'none';
  document.getElementById('dsr-controller-notify-field').style.display = role==='processor'?'block':'none';
}

async function saveDsr() {
  const isCtrl = document.querySelector('#modal-dsr .role-btn.active')?.textContent?.includes('Controller');
  const d = {
    requester_name: v('dsr-requester'), right: v('dsr-right'),
    received_date: v('dsr-received'), channel: v('dsr-channel'),
    identity_verified: v('dsr-verified'), third_party: v('dsr-third-party'),
    notes: v('dsr-notes'), role: isCtrl ? 'controller' : 'processor',
    controller_notify: v('dsr-controller-notify')
  };
  if (!d.requester_name||!d.right||!d.received_date) { toast('Requester, right and date required','err'); return; }
  try {
    await api('POST','/api/compliance/dsrs',d);
    closeModal('modal-dsr'); resetForm('modal-dsr'); toast('DSR logged',false,true); loadDsrs();
  } catch(e) { toast(e.message,'err'); }
}

async function closeDsr(id, e) {
  e.stopPropagation();
  const outcome = prompt('Brief outcome summary:');
  if (outcome === null) return;
  try { await api('POST',`/api/compliance/dsrs/${id}/close`,{outcome}); toast('DSR closed',false,true); loadDsrs(); } catch(e){toast(e.message,'err');}
}

// ── Breach ────────────────────────────────────────────────────────────────
async function loadBreaches() {
  try {
    const data = await api('GET','/api/compliance/breaches');
    STATE.data.breaches = data;
    renderBreaches(data);
    updateBadge('badge-breach', data.filter(b=>b.status==='open').length);
  } catch(e) { console.error(e); }
}

function renderBreaches(data) {
  const open = data.filter(b=>b.status==='open');
  document.getElementById('breach-rag').innerHTML =
    `${ragCard(open.length,'Active','red')}${ragCard(data.filter(b=>b.sa_notified_at).length,'Notified to SA','green')}${ragCard(data.filter(b=>b.risk==='low'&&b.status!=='open').length,'No notification needed','muted')}`;
  const alerts = document.getElementById('breach-alerts');
  alerts.innerHTML = open.filter(b=>b._72h_rag==='red'||b._72h_rag==='amber').map(b=>`
    <div class="alert-bar alert-red"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    <span><strong>${esc(b.ref)}</strong> — 72h SA notification clock: <strong>${b._hours_remaining > 0 ? b._hours_remaining+'h remaining' : 'OVERDUE'}</strong>. ${b.risk==='high'||b.risk==='high_subjects'?'Notify your supervisory authority immediately.':''}</span></div>`).join('');
  const tbody = document.getElementById('breach-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No breaches recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.status==='open'&&r._72h_rag==='red'?'row-red':r.status==='open'&&r._72h_rag==='amber'?'row-amber':''}">
      <td class="mono">${esc(r.ref)}</td>
      <td><div class="td-main">${esc(trunc(r.description,50))}</div></td>
      <td style="font-size:11px">${esc(r.breach_type)}</td>
      <td style="font-size:11.5px">${fmtDateTime(r.detected_at)}</td>
      <td>${r.status==='open'&&r._hours_remaining!=null?`<div class="dl dl-${r._72h_rag}">${clockIcon()}${r._hours_remaining>0?r._hours_remaining+'h left':'OVERDUE'}</div>`:r.sa_notified_at?'<span class="pill pill-green">SA notified</span>':'<span class="pill pill-muted">Not required</span>'}</td>
      <td><span class="risk-box risk-${r.risk==='high'||r.risk==='high_subjects'?'high':r.risk==='medium'?'medium':'low'}">${r.risk}</span></td>
      <td><span class="pill pill-${r.status==='open'?'red':'green'}">${r.status==='open'?'Open':'Resolved'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="resolveBreachPrompt('${r.id}',event)">Update</button></td>
    </tr>`).join('');
}

async function saveBreach() {
  const d = {
    description: v('breach-description'), detected_at: v('breach-detected'),
    breach_type: v('breach-type'), records_affected: v('breach-records'),
    data_categories: v('breach-data-cats'), risk: v('breach-risk'),
    role: v('breach-role'), containment: v('breach-containment')
  };
  if (!d.description||!d.detected_at) { toast('Description and detection time required','err'); return; }
  try { await api('POST','/api/compliance/breaches',d); closeModal('modal-breach'); resetForm('modal-breach'); toast('Breach logged',false,true); loadBreaches(); } catch(e){toast(e.message,'err');}
}

async function resolveBreachPrompt(id, e) {
  e.stopPropagation();
  const action = prompt('Enter update (e.g. "SA notified", "Resolved", "No notification needed"):');
  if (!action) return;
  try { await api('PUT',`/api/compliance/breaches/${id}`,{status:'resolved',resolution_note:action,resolved_at:new Date().toISOString()}); toast('Breach updated',false,true); loadBreaches(); } catch(e){toast(e.message,'err');}
}

// ── DPIA ─────────────────────────────────────────────────────────────────
async function loadDpias() {
  try {
    const data = await api('GET','/api/compliance/dpias');
    STATE.data.dpias = data;
    renderDpias(data);
    updateBadge('badge-dpia', data.filter(d=>d.status!=='completed').length);
  } catch(e) { console.error(e); }
}

const DPIA_STAGES = ['Screening','Necessity','Risk ID','Risk Assessment','Mitigation','DPO Consultation','Final Review'];

function renderDpias(data) {
  const inProg = data.filter(d=>d.status!=='completed').length;
  document.getElementById('dpia-rag').innerHTML =
    `${ragCard(inProg,'In progress','amber')}${ragCard(data.filter(d=>d.status==='completed').length,'Completed','green')}${ragCard(data.filter(d=>d.risk==='very_high').length,'SA consultation may be needed','red')}`;
  const tbody = document.getElementById('dpia-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="7"><div class="empty" style="padding:30px"><p>No DPIAs started.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>{
    const pct = Math.round(((r.stage||0)+1)/7*100);
    const pbClass = r.status==='completed'?'pb-green':r.risk==='very_high'?'pb-red':'pb-amber';
    return `<tr>
      <td><div class="td-main">${esc(r.activity_name)}</div><div class="td-sub">${esc(r.trigger||'')}</div></td>
      <td>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">${DPIA_STAGES[r.stage||0]}</div>
        <div class="progress-wrap"><div class="progress-bar ${pbClass}" style="width:${pct}%"></div></div>
      </td>
      <td style="font-size:11.5px">${esc(r.assessor||'—')}</td>
      <td>${r.stage>=5?'<span class="pill pill-green">Consulted</span>':'<span class="pill pill-muted">Pending</span>'}</td>
      <td><span class="risk-box risk-${r.risk==='very_high'||r.risk==='high'?'high':r.risk==='medium'?'medium':'low'}">${r.risk||'medium'}</span></td>
      <td><span class="pill pill-${r.status==='completed'?'green':'amber'}">${r.status==='completed'?'Completed':'In progress'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="advanceDpia('${r.id}',event)" ${r.status==='completed'?'disabled':''}>Advance</button></td>
    </tr>`;}).join('');
}

async function saveDpia() {
  const d = { activity_name:v('dpia-name'), trigger:v('dpia-trigger'), risk:v('dpia-risk'), ropa_link:v('dpia-ropa-link'), assessor:v('dpia-assessor'), description:v('dpia-description') };
  if (!d.activity_name) { toast('Activity name required','err'); return; }
  try { await api('POST','/api/compliance/dpias',d); closeModal('modal-dpia'); resetForm('modal-dpia'); toast('DPIA started',false,true); loadDpias(); } catch(e){toast(e.message,'err');}
}

async function advanceDpia(id, e) {
  e.stopPropagation();
  if (!confirm('Advance this DPIA to the next stage?')) return;
  try { await api('POST',`/api/compliance/dpias/${id}/advance`,{}); toast('DPIA advanced',false,true); loadDpias(); } catch(e){toast(e.message,'err');}
}

// ── TIA ──────────────────────────────────────────────────────────────────
async function loadTias() {
  try {
    const data = await api('GET','/api/compliance/tias');
    STATE.data.tias = data;
    renderTias(data);
    updateBadge('badge-tia', data.length, 'nb-muted');
  } catch(e) { console.error(e); }
}

function renderTias(data) {
  const rag = ragCounts(data,'_rag');
  document.getElementById('tia-rag').innerHTML =
    `${ragCard(data.filter(r=>r.risk==='not_permitted').length,'Transfer not permitted','red')}${ragCard(rag.amber,'Reassessment due','amber')}${ragCard(rag.green,'Permitted','green')}`;
  const tbody = document.getElementById('tia-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No TIAs recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${rowClass(r._rag)}">
      <td><div class="td-main">${esc(r.importer_name)}</div><div class="td-sub">${esc(r.exporter||'')}</div></td>
      <td><span style="font-size:10px;background:var(--cream-mid);color:var(--text-mid);padding:2px 6px;border-radius:4px;font-weight:600;">${esc(r.destination_country)}</span></td>
      <td style="font-size:11px;color:var(--text-muted)">${esc(r.transfer_mechanism)}</td>
      <td><span class="risk-box risk-${r.risk==='high'||r.risk==='not_permitted'?'high':r.risk==='medium'?'medium':'low'}">${r.risk}</span></td>
      <td>${dlBadge(r._days_remaining, r.reassess_by)}</td>
      <td>${r.dpa_ref?'<span class="pill pill-green">Yes</span>':'<span class="pill pill-muted">No</span>'}</td>
      <td><span class="pill pill-${r.risk==='not_permitted'?'red':r._rag==='amber'?'amber':'green'}">${r.risk==='not_permitted'?'Not permitted':r._rag==='amber'?'Reassess due':'Permitted'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="deleteTia('${r.id}',event)">Remove</button></td>
    </tr>`).join('');
}

async function saveTia() {
  const d = { exporter:v('tia-exporter'), importer_name:v('tia-importer'), destination_country:v('tia-country').toUpperCase(), transfer_mechanism:v('tia-mechanism'), data_categories:v('tia-data-cats'), purpose:v('tia-purpose'), risk:v('tia-risk'), reassess_by:v('tia-reassess'), supplementary_measures:v('tia-measures') };
  if (!d.importer_name||!d.destination_country||!d.transfer_mechanism) { toast('Importer, country and mechanism required','err'); return; }
  try { await api('POST','/api/compliance/tias',d); closeModal('modal-tia'); resetForm('modal-tia'); toast('TIA saved',false,true); loadTias(); } catch(e){toast(e.message,'err');}
}

async function deleteTia(id, e) {
  e.stopPropagation();
  if (!confirm('Remove this TIA?')) return;
  try { await api('DELETE',`/api/compliance/tias/${id}`); toast('TIA removed',false,true); loadTias(); } catch(e){toast(e.message,'err');}
}

// ── DPA ──────────────────────────────────────────────────────────────────
async function loadDpas() {
  try {
    const data = await api('GET','/api/compliance/dpas');
    STATE.data.dpas = data;
    renderDpas(data);
    updateBadge('badge-dpa', data.length, 'nb-muted');
  } catch(e) { console.error(e); }
}

function renderDpas(data) {
  const tbody = document.getElementById('dpa-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No DPAs recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${rowClass(r._rag)}">
      <td><div class="td-main">${esc(r.counterparty)}</div></td>
      <td><span class="badge-tag ${r.our_role==='controller'?'badge-blue':'badge-muted'}">${r.our_role==='controller'?'Controller':'Processor'}</span></td>
      <td style="font-size:11px;color:var(--text-muted)">${esc(trunc(r.purpose,35)||'—')}</td>
      <td>${r.tia_ref?'<span class="pill pill-green">Linked</span>':'<span class="pill pill-muted">N/A</span>'}</td>
      <td style="font-size:11.5px">${fmtDate(r.signed)||'—'}</td>
      <td>${dlBadge(r._days_remaining, r.review_date)}</td>
      <td><span class="pill pill-${r._rag==='red'?'red':r._rag==='amber'?'amber':'green'}">${r._rag==='red'?'Overdue':r._rag==='amber'?'Review soon':'Current'}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="deleteDpa('${r.id}',event)">Remove</button></td>
    </tr>`).join('');
}

async function saveDpa() {
  const d = { counterparty:v('dpa-counterparty'), our_role:v('dpa-role'), purpose:v('dpa-purpose'), signed:v('dpa-signed'), review_date:v('dpa-review'), tia_ref:v('dpa-tia-ref'), notes:v('dpa-notes') };
  if (!d.counterparty) { toast('Counterparty name required','err'); return; }
  try { await api('POST','/api/compliance/dpas',d); closeModal('modal-dpa'); resetForm('modal-dpa'); toast('DPA saved',false,true); loadDpas(); } catch(e){toast(e.message,'err');}
}

async function deleteDpa(id, e) {
  e.stopPropagation();
  if (!confirm('Remove this DPA?')) return;
  try { await api('DELETE',`/api/compliance/dpas/${id}`); toast('DPA removed',false,true); loadDpas(); } catch(e){toast(e.message,'err');}
}

// ── Gifts ─────────────────────────────────────────────────────────────────
async function loadGifts() {
  try {
    const data = await api('GET','/api/compliance/gifts');
    STATE.data.gifts = data;
    renderGifts(data);
    updateBadge('badge-gifts', data.filter(g=>g.status==='pending').length);
  } catch(e) { console.error(e); }
}

function renderGifts(data) {
  const pending = data.filter(g=>g.status==='pending').length;
  const totalYtd = data.filter(g=>g.status!=='declined').reduce((s,g)=>s+(parseFloat(g.value)||0),0);
  document.getElementById('gifts-rag').innerHTML =
    `${ragCard(pending,'Awaiting approval','amber')}${ragCard(data.filter(g=>g.status==='approved').length,'Approved','green')}${ragCard(data.filter(g=>g.status==='declined').length,'Declined','red')}
    <div class="rag-card" style="flex:.8;background:var(--cream)"><div><div class="rag-num" style="font-size:16px">€ ${totalYtd.toLocaleString()}</div><div class="rag-label">Total value YTD</div></div></div>`;
  const tbody = document.getElementById('gifts-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="9"><div class="empty" style="padding:30px"><p>No gifts recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.status==='pending'?'row-amber':''}" data-direction="${r.direction}" data-status="${r.status}">
      <td><div class="td-main">${esc(r.employee_name)}</div></td>
      <td><span class="badge-tag ${r.direction==='received'?'badge-blue':'badge-muted'}">${r.direction}</span></td>
      <td style="font-size:11.5px">${esc(r.gift_type)}</td>
      <td style="font-size:11.5px">${esc(r.third_party)}</td>
      <td><span class="${r._country_risk==='high'?'country-risk-high':r._country_risk==='medium'?'country-risk-medium':'country-risk-low'}">${esc(r.country||'—')}</span></td>
      <td style="font-size:12px;font-weight:600">€ ${parseFloat(r.value||0).toFixed(2)}</td>
      <td style="font-size:11.5px">${fmtDate(r.gift_date)}</td>
      <td><span class="pill pill-${r.status==='approved'?'green':r.status==='declined'?'red':'amber'}">${r.status}</span></td>
      <td class="editor-only" style="display:flex;gap:4px;padding:6px;">${r.status==='pending'?`<button class="btn btn-ghost btn-sm" onclick="approveGift('${r.id}',event)">Approve</button><button class="btn btn-ghost btn-sm" onclick="declineGift('${r.id}',event)">Decline</button>`:'—'}</td>
    </tr>`).join('');
}

async function saveGift() {
  const d = { employee_name:v('gift-employee'), direction:v('gift-direction'), gift_type:v('gift-type'), third_party:v('gift-third-party'), country:v('gift-country').toUpperCase(), value:v('gift-value'), gift_date:v('gift-date'), context:v('gift-context'), notes:v('gift-notes') };
  if (!d.employee_name||!d.third_party||!d.value||!d.gift_date) { toast('Employee, third party, value and date required','err'); return; }
  try { await api('POST','/api/compliance/gifts',d); closeModal('modal-gift'); resetForm('modal-gift'); toast('Gift logged',false,true); loadGifts(); } catch(e){toast(e.message,'err');}
}

async function approveGift(id, e) { e.stopPropagation(); try { await api('POST',`/api/compliance/gifts/${id}/approve`,{}); toast('Gift approved',false,true); loadGifts(); } catch(e){toast(e.message,'err');} }
async function declineGift(id, e) { e.stopPropagation(); const note=prompt('Reason for decline:'); if(!note)return; try { await api('POST',`/api/compliance/gifts/${id}/decline`,{note}); toast('Gift declined',false,true); loadGifts(); } catch(e){toast(e.message,'err');} }

// ── COI ──────────────────────────────────────────────────────────────────
async function loadCoi() {
  try {
    const data = await api('GET','/api/compliance/coi');
    STATE.data.coi = data;
    renderCoi(data);
    updateBadge('badge-coi', data.filter(c=>c.conflict_status==='not_submitted').length);
  } catch(e) { console.error(e); }
}

function renderCoi(data) {
  const year = new Date().getFullYear();
  const thisYear = data.filter(c=>c.declaration_year==year);
  const missing = thisYear.filter(c=>c.conflict_status==='not_submitted').length;
  document.getElementById('coi-rag').innerHTML =
    `${ragCard(data.filter(c=>c.conflict_status==='yes').length,'Active conflicts','red')}${ragCard(missing,'Declaration missing','amber')}${ragCard(thisYear.filter(c=>c.conflict_status==='none').length,'Declared — no conflict','green')}`;
  const alerts = document.getElementById('coi-alerts');
  alerts.innerHTML = missing > 0 ? `<div class="alert-bar alert-amber"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span><strong>${missing} declaration${missing>1?'s':''} outstanding</strong> for ${year}.</span></div>` : '';
  const tbody = document.getElementById('coi-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No COI declarations recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.conflict_status==='not_submitted'?'row-amber':r.conflict_status==='yes'?'row-red':''}">
      <td><div class="td-main">${esc(r.person_name)}</div><div class="td-sub">${esc(r.person_role||'')}</div></td>
      <td><span class="badge-tag ${r.coi_category==='board'?'badge-blue':'badge-muted'}">${esc(r.coi_category||'employee')}</span></td>
      <td style="font-size:11.5px">${r.declaration_year}</td>
      <td style="font-size:11.5px">${r.declaration_date?fmtDate(r.declaration_date):'Not submitted'}</td>
      <td><span class="pill pill-${r.conflict_status==='yes'?'red':r.conflict_status==='none'?'green':'amber'}">${r.conflict_status==='yes'?'Conflict':r.conflict_status==='none'?'None':'Not submitted'}</span></td>
      <td style="font-size:11.5px">${esc(r.approved_by||'—')}</td>
      <td><span class="pill pill-${r.conflict_status==='not_submitted'?'amber':r.conflict_status==='yes'?'red':'green'}">${r.conflict_status==='not_submitted'?'Missing':r.conflict_status==='yes'?'Conflict disclosed':'Complete'}</span></td>
      <td></td>
    </tr>`).join('');
}

function toggleCoiConflict(sel) {
  document.getElementById('coi-conflict-detail').style.display = sel.value==='yes' ? 'block' : 'none';
}

async function saveCoi() {
  const d = { person_name:v('coi-name'), coi_category:v('coi-category'), person_role:v('coi-role'), declaration_year:v('coi-year'), declaration_date:v('coi-date'), conflict_status:v('coi-conflict'), conflict_description:v('coi-conflict-desc'), notes:v('coi-notes') };
  if (!d.person_name||!d.declaration_year) { toast('Name and year required','err'); return; }
  try { await api('POST','/api/compliance/coi',d); closeModal('modal-coi'); resetForm('modal-coi'); toast('Declaration saved',false,true); loadCoi(); } catch(e){toast(e.message,'err');}
}

// ── TPDD ─────────────────────────────────────────────────────────────────
async function loadTpdd() {
  try {
    const data = await api('GET','/api/compliance/tpdd');
    STATE.data.tpdd = data;
    renderTpdd(data);
    updateBadge('badge-tpdd', data.filter(t=>t._country_risk==='high'&&t.status!=='cleared').length);
  } catch(e) { console.error(e); }
}

function renderTpdd(data) {
  document.getElementById('tpdd-rag').innerHTML =
    `${ragCard(data.filter(t=>t._country_risk==='high'&&t.status!=='cleared').length,'High-risk — action needed','red')}${ragCard(data.filter(t=>t._rag==='amber').length,'Review due','amber')}${ragCard(data.filter(t=>t.status==='cleared').length,'Cleared','green')}`;
  const tbody = document.getElementById('tpdd-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="9"><div class="empty" style="padding:30px"><p>No third parties recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r._country_risk==='high'?'row-red':r._rag==='amber'?'row-amber':''}">
      <td><div class="td-main">${esc(r.company_name)}</div></td>
      <td style="font-size:11px;color:var(--text-muted)">${esc(r.third_party_type)}</td>
      <td><span class="${r._country_risk==='high'?'country-risk-high':r._country_risk==='medium'?'country-risk-medium':'country-risk-low'}">${esc(r.country||'—')}</span></td>
      <td><span style="font-size:10.5px;background:${r.dd_level==='enhanced'?'var(--red-bg)':'var(--cream-mid)'};color:${r.dd_level==='enhanced'?'var(--red)':'var(--text-mid)'};padding:2px 7px;border-radius:4px;font-weight:600;">${r.dd_level||'standard'}</span></td>
      <td style="font-size:11.5px">${r.last_dd?fmtDate(r.last_dd):'Never'}</td>
      <td>${dlBadge(r._days_remaining, r.next_review)}</td>
      <td><span class="risk-box risk-${r._country_risk==='high'?'high':r._country_risk==='medium'?'medium':'low'}">${r._country_risk}</span></td>
      <td><span class="pill pill-${r._country_risk==='high'&&r.status!=='cleared'?'red':r._rag==='amber'?'amber':'green'}">${r._country_risk==='high'&&r.status!=='cleared'?'Action needed':r._rag==='amber'?'Review due':'Cleared'}</span></td>
      <td></td>
    </tr>`).join('');
}

async function saveTpdd() {
  const d = { company_name:v('tpdd-company'), third_party_type:v('tpdd-type'), country:v('tpdd-country').toUpperCase(), dd_level:v('tpdd-dd-level'), last_dd:v('tpdd-last-dd'), next_review:v('tpdd-next-review'), description:v('tpdd-description') };
  if (!d.company_name||!d.country) { toast('Company name and country required','err'); return; }
  try { await api('POST','/api/compliance/tpdd',d); closeModal('modal-tpdd'); resetForm('modal-tpdd'); toast('Third party added',false,true); loadTpdd(); } catch(e){toast(e.message,'err');}
}

// ── Donations ─────────────────────────────────────────────────────────────
async function loadDonations() {
  try {
    const data = await api('GET','/api/compliance/donations');
    STATE.data.donations = data;
    renderDonations(data);
  } catch(e) { console.error(e); }
}

function renderDonations(data) {
  const tbody = document.getElementById('donations-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:30px"><p>No donations recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.status==='pending_board'?'row-amber':''}">
      <td><div class="td-main">${esc(r.recipient)}</div></td>
      <td style="font-size:11.5px">${esc(r.donation_type)}</td>
      <td style="font-size:12px;font-weight:600">€ ${parseFloat(r.amount||0).toFixed(2)}</td>
      <td style="font-size:11.5px">${fmtDate(r.donation_date)}</td>
      <td style="font-size:11.5px">${esc(r.jurisdiction||'—')}</td>
      <td>${r.board_approval_required==='yes'?'<span class="pill pill-amber">Required</span>':'<span class="pill pill-muted">Below threshold</span>'}</td>
      <td><span class="pill pill-${r.status==='approved'?'green':r.status==='declined'?'red':'amber'}">${r.status}</span></td>
      <td></td>
    </tr>`).join('');
}

async function saveDonation() {
  const d = { recipient:v('don-recipient'), donation_type:v('don-type'), amount:v('don-amount'), donation_date:v('don-date'), jurisdiction:v('don-jurisdiction'), board_approval_required:v('don-board-approval'), justification:v('don-justification') };
  if (!d.recipient||!d.amount||!d.donation_date) { toast('Recipient, amount and date required','err'); return; }
  try { await api('POST','/api/compliance/donations',d); closeModal('modal-donation'); resetForm('modal-donation'); toast('Donation logged',false,true); loadDonations(); } catch(e){toast(e.message,'err');}
}

// ── Red Flags ─────────────────────────────────────────────────────────────
async function loadFlags() {
  if (STATE.role==='viewer') return;
  try {
    const data = await api('GET','/api/compliance/flags');
    renderFlags(data);
  } catch(e) { console.error(e); }
}

function renderFlags(data) {
  const tbody = document.getElementById('flags-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="7"><div class="empty" style="padding:30px"><p>No red flags recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r.severity==='high'?'row-red':r.severity==='medium'?'row-amber':''}">
      <td style="font-size:11.5px">${fmtDate(r.identified_date)}</td>
      <td><div class="td-main">${esc(trunc(r.description,60))}</div></td>
      <td style="font-size:11.5px">${esc(r.related_party||'—')}</td>
      <td>${r.country?`<span class="country-risk-${r._country_risk||'low'}">${esc(r.country)}</span>`:'—'}</td>
      <td><span class="risk-box risk-${r.severity==='high'?'high':r.severity==='medium'?'medium':'low'}">${r.severity}</span></td>
      <td><span class="pill pill-${r.status==='open'?'amber':'muted'}">${r.status}</span></td>
      <td></td>
    </tr>`).join('');
}

async function saveFlag() {
  const d = { description:v('flag-description'), identified_date:v('flag-date'), severity:v('flag-severity'), related_party:v('flag-party'), country:v('flag-country').toUpperCase(), source:v('flag-source') };
  if (!d.description||!d.identified_date) { toast('Description and date required','err'); return; }
  try { await api('POST','/api/compliance/flags',d); closeModal('modal-flag'); resetForm('modal-flag'); toast('Concern logged',false,true); loadFlags(); } catch(e){toast(e.message,'err');}
}

// ── Whistleblowing ────────────────────────────────────────────────────────
async function loadWb() {
  try {
    const data = await api('GET','/api/compliance/wb');
    STATE.data.wb = data;
    renderWb(data);
    updateBadge('badge-wb', data.filter(w=>!['closed','no_action'].includes(w.status)).length);
  } catch(e) { console.error(e); }
}

function renderWb(data) {
  const open = data.filter(w=>!['closed','no_action'].includes(w.status));
  document.getElementById('wb-rag').innerHTML =
    `${ragCard(open.length,'Open — action needed','amber')}${ragCard(data.filter(w=>['closed','no_action'].includes(w.status)).length,'Closed YTD','green')}`;
  const alerts = document.getElementById('wb-alerts');
  alerts.innerHTML = open.filter(w=>w._ack_days!==null&&w._ack_days<=3&&w.status==='received').map(w=>`
    <div class="alert-bar alert-amber"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <span><strong>${esc(w.ref)}</strong> — Acknowledgement due by ${fmtDate(w.acknowledge_by)} (${w._ack_days<=0?'overdue':w._ack_days+' days'}). Access restricted to assigned handler.</span></div>`).join('');
  const tbody = document.getElementById('wb-tbody');
  if (!data.length) { tbody.innerHTML=`<tr><td colspan="9"><div class="empty" style="padding:30px"><p>No cases recorded.</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r=>`
    <tr class="${r._ack_days!==null&&r._ack_days<=3&&r.status==='received'?'row-amber':''}">
      <td class="mono">${esc(r.ref)}</td>
      <td style="font-size:11.5px">${esc(r.category)}</td>
      <td><span class="pill pill-${r.reporter_type==='anonymous'?'muted':'blue'}">${r.reporter_type==='anonymous'?'Anonymous':'Named'}</span></td>
      <td style="font-size:11.5px">${fmtDate(r.received_date)}</td>
      <td>${dlBadge(r._ack_days, r.acknowledge_by, 3)}</td>
      <td>${dlBadge(r._outcome_days, r.outcome_by, 14)}</td>
      <td><span class="av">${(r.handler||'?').substring(0,2).toUpperCase()}</span></td>
      <td><span class="pill pill-${r.status==='investigating'?'amber':r.status==='received'?'blue':r.status==='acknowledged'?'amber':'muted'}">${r.status}</span></td>
      <td class="editor-only"><button class="btn btn-ghost btn-sm" onclick="updateWbStatus('${r.id}',event)">Update</button></td>
    </tr>`).join('');
}

async function saveWb() {
  const isNamed = v('wb-reporter-type')==='named';
  const d = { category:v('wb-category'), received_date:v('wb-received'), channel:v('wb-channel'), reporter_type:v('wb-reporter-type'), summary:v('wb-summary'), handler:v('wb-handler'), alleged:v('wb-alleged') };
  if (isNamed) { d.reporter_name=v('wb-reporter-name'); d.reporter_contact=v('wb-reporter-contact'); }
  if (!d.category||!d.received_date||!d.summary) { toast('Category, date and summary required','err'); return; }
  try { await api('POST','/api/compliance/wb',d); closeModal('modal-wb'); resetForm('modal-wb'); toast('Report logged',false,true); loadWb(); } catch(e){toast(e.message,'err');}
}

async function updateWbStatus(id, e) {
  e.stopPropagation();
  const status = prompt('New status (acknowledged / investigating / closed / no_action):');
  if (!status) return;
  const note = prompt('Update note (optional):') || '';
  try { await api('POST',`/api/compliance/wb/${id}/status`,{status,note}); toast('Status updated',false,true); loadWb(); } catch(e){toast(e.message,'err');}
}

function toggleWbReporter(sel) {
  document.getElementById('wb-named-fields').style.display = sel.value==='named' ? 'block' : 'none';
}

async function loadWbStats() {
  try {
    const stats = await api('GET','/api/compliance/wb/stats');
    renderWbAnnual(stats);
  } catch(e) { console.error(e); }
}

function renderWbAnnual(stats) {
  const el = document.getElementById('wb-annual-content');
  if (!el) return;
  const cats = Object.entries(stats.by_category||{}).map(([k,v])=>`<tr><td style="font-size:12px">${k}</td><td style="font-size:12px;font-weight:600">${v}</td></tr>`).join('');
  el.innerHTML = `<div class="info-grid" style="padding:0 22px 14px;">
    <div class="info-card"><div class="info-label">Total reports ${stats.year}</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;">${stats.total}</div></div>
    <div class="info-card"><div class="info-label">Open</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;color:var(--amber)">${stats.open}</div></div>
    <div class="info-card"><div class="info-label">Closed</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;color:var(--success)">${stats.closed}</div></div>
    <div class="info-card"><div class="info-label">Anonymous reports</div><div class="info-val" style="font-family:var(--font-serif);font-size:28px;">${stats.anonymous}</div></div>
  </div>
  ${cats?`<div class="section"><div class="table-wrap"><table><thead><tr><th>Category</th><th>Count</th></tr></thead><tbody>${cats}</tbody></table></div></div>`:''}`;
}

// ── Policies ──────────────────────────────────────────────────────────────
async function loadPolicies(module) {
  try {
    const data = await api('GET',`/api/compliance/policies?module=${module}`);
    STATE.data.policies[module] = data;
    renderPolicies(module, data);
  } catch(e) { console.error(e); }
}

function renderPolicies(module, data) {
  const grid = document.getElementById('policies-' + module);
  if (!grid) return;
  const isEditor = STATE.role==='admin'||STATE.role==='editor';
  const cards = data.map(p=>`
    <div class="policy-card" onclick="openPolicy('${p.id}')">
      <div class="policy-card-top">
        <div class="p-icon ${p.from_radar?'p-icon-radar':p.doc_type==='advice'||p.doc_type==='ai_output'?'p-icon-advice':p.doc_type==='template'?'p-icon-template':'p-icon-doc'}">
          ${p.from_radar?radarIconSvg():p.doc_type==='advice'||p.doc_type==='ai_output'?infoIconSvg():docIconSvg()}
        </div>
        <div><div class="policy-name">${esc(p.title)}</div><div class="policy-meta">${p.doc_type}${p.created_at?' · '+fmtDate(p.created_at):''}${p.file_ext?' · '+p.file_ext.toUpperCase():''}</div></div>
      </div>
      <div class="policy-footer">
        ${p.in_kb!==false?'<span class="p-tag p-tag-kb">'+bookIconSvg()+' Knowledge Base</span>':''}
        ${p.from_radar?'<span class="p-tag p-tag-radar">'+radarIconSvg()+' From Radar</span>':''}
        <span class="p-tag p-tag-module">${module.toUpperCase()} · ${p.doc_type}</span>
      </div>
    </div>`).join('');
  const addCard = isEditor ? `<div class="policy-add-card" onclick="openModal('modal-upload-policy','${module}')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span style="font-size:11.5px">Upload or add note</span></div>` : '';
  grid.innerHTML = cards + addCard;
}

function openModal(id, moduleTarget) {
  const overlay = document.getElementById(id);
  if (!overlay) return;
  if (moduleTarget) {
    const t1 = document.getElementById('upload-module-target');
    const t2 = document.getElementById('advice-module-target');
    if (t1) t1.value = moduleTarget;
    if (t2) t2.value = moduleTarget;
  }
  overlay.classList.add('open');
}

async function uploadPolicy() {
  const moduleTarget = v('upload-module-target');
  const file = document.getElementById('upload-file-input').files[0];
  if (!file) { toast('Please select a file','err'); return; }
  const fd = new FormData();
  fd.append('file', file);
  fd.append('title', v('upload-title') || file.name);
  fd.append('doc_type', v('upload-doc-type'));
  fd.append('module', moduleTarget);
  fd.append('jurisdictions', v('upload-jurisdictions'));
  try {
    const r = await fetch('/api/compliance/policies/upload', { method:'POST', body:fd });
    const json = await r.json();
    if (!json.ok) throw new Error(json.error);
    closeModal('modal-upload-policy');
    document.getElementById('upload-file-input').value='';
    document.getElementById('upload-file-label').textContent='Click to choose file';
    toast('Document uploaded',false,true);
    loadPolicies(moduleTarget);
  } catch(e) { toast(e.message,'err'); }
}

async function saveAdviceNote() {
  const moduleTarget = v('advice-module-target');
  const d = { title:v('advice-title'), doc_type:v('advice-type'), module:moduleTarget, content:v('advice-content'), note_date:v('advice-date'), jurisdictions:v('advice-jurisdictions'), in_kb:v('advice-kb')==='yes' };
  if (!d.title||!d.content) { toast('Title and content required','err'); return; }
  try { await api('POST','/api/compliance/policies',d); closeModal('modal-add-advice'); resetForm('modal-add-advice'); toast('Advice note saved',false,true); loadPolicies(moduleTarget); } catch(e){toast(e.message,'err');}
}

function openPolicy(id) {
  // TODO: open a detail/view modal or download file
  toast('Opening document…');
}

function filterPolicies(module, search, type) {
  const data = STATE.data.policies[module] || [];
  let filtered = data;
  if (search) filtered = filtered.filter(p=>p.title.toLowerCase().includes(search.toLowerCase()));
  if (type) filtered = filtered.filter(p=>p.doc_type===type);
  renderPolicies(module, filtered);
}

// ── Settings: Users ───────────────────────────────────────────────────────
async function loadUsers() {
  try {
    const users = await api('GET','/api/settings/users');
    renderUsers(users);
  } catch(e) { console.error(e); }
}

const ALL_MODULES = ['compliance','whistleblowing','documents','corporate','radar','knowledge'];
const MODULE_LABELS = {compliance:'Compliance',whistleblowing:'Whistleblowing',documents:'Documents',corporate:'Corporate',radar:'Legal Radar',knowledge:'Knowledge Base'};

function renderUsers(users) {
  const wrap = document.getElementById('users-table-wrap');
  const isAdmin = STATE.role==='admin';
  wrap.innerHTML = `<div class="table-wrap"><table class="user-matrix">
    <thead><tr><th>Name</th><th>Email</th><th>Role</th>${ALL_MODULES.map(m=>`<th style="text-align:center;font-size:9px">${MODULE_LABELS[m]}</th>`).join('')}<th>Status</th>${isAdmin?'<th></th>':''}</tr></thead>
    <tbody>${users.map(u=>`
      <tr>
        <td><div style="font-weight:500">${esc(u.display_name||'—')}</div>${u.user_id===STATE.firmId?'<div class="td-sub">You</div>':''}</td>
        <td style="font-size:11.5px;color:var(--text-muted)">${esc(u.email)}</td>
        <td>${isAdmin?`<select class="form-control" style="padding:4px 7px;font-size:11.5px;" onchange="updateUserRole('${u.user_id}',this.value)"><option ${u.compliance_role==='admin'?'selected':''} value="admin">Admin</option><option ${u.compliance_role==='editor'?'selected':''} value="editor">Editor</option><option ${u.compliance_role==='viewer'?'selected':''} value="viewer">Viewer</option></select>`:`<span class="badge-tag badge-muted">${u.compliance_role}</span>`}</td>
        ${ALL_MODULES.map(m=>`<td style="text-align:center">${isAdmin?`<input type="checkbox" ${u.modules?.includes(m)?'checked':''} onchange="updateUserModule('${u.user_id}','${m}',this.checked)" ${m==='whistleblowing'?'title="Whistleblowing: enable only for designated handlers"':''}>`:u.modules?.includes(m)?'✓':'—'}</td>`).join('')}
        <td><span class="pill pill-${u.status==='active'?'green':u.status==='pending_invite'?'amber':'muted'}">${u.status}</span></td>
        ${isAdmin?`<td><button class="btn btn-ghost btn-sm" onclick="deactivateUser('${u.user_id}')" ${u.status==='inactive'?'disabled':''}>Deactivate</button></td>`:''}
      </tr>`).join('')}
    </tbody>
  </table></div>`;
}

async function updateUserRole(userId, role) {
  try { await api('PUT',`/api/settings/users/${userId}`,{compliance_role:role}); toast('Role updated',false,true); loadUsers(); } catch(e){toast(e.message,'err');}
}

async function updateUserModule(userId, module, enabled) {
  try {
    const users = await api('GET','/api/settings/users');
    const user = users.find(u=>u.user_id===userId);
    if (!user) return;
    let mods = user.modules || [];
    if (enabled) { if (!mods.includes(module)) mods.push(module); }
    else { mods = mods.filter(m=>m!==module); }
    await api('PUT',`/api/settings/users/${userId}`,{modules:mods});
    toast('Access updated',false,true);
  } catch(e){toast(e.message,'err');}
}

async function deactivateUser(userId) {
  if (!confirm('Deactivate this user? They will lose all access immediately.')) return;
  try { await api('POST',`/api/settings/users/${userId}/deactivate`,{}); toast('User deactivated',false,true); loadUsers(); } catch(e){toast(e.message,'err');}
}

async function inviteUser() {
  const mods = ALL_MODULES.filter(m=>document.getElementById('inv-mod-'+m)?.checked);
  const d = { display_name:v('invite-name'), email:v('invite-email'), compliance_role:v('invite-role'), modules:mods };
  if (!d.email) { toast('Email required','err'); return; }
  try { await api('POST','/api/settings/users/invite',d); closeModal('modal-invite'); resetForm('modal-invite'); toast('Invitation sent',false,true); loadUsers(); } catch(e){toast(e.message,'err');}
}

// ── Compliance settings ───────────────────────────────────────────────────
async function loadComplianceSettings() {
  try {
    const s = await api('GET','/api/compliance/settings');
    if (s.primary_jurisdiction) document.getElementById('setting-primary-jurisdiction').value = s.primary_jurisdiction;
    if (s.extra_jurisdictions) document.getElementById('setting-extra-jurisdictions').value = s.extra_jurisdictions;
    if (s.gift_threshold) document.getElementById('setting-gift-threshold').value = s.gift_threshold;
    if (s.gift_autodecline) document.getElementById('setting-gift-autodecline').value = s.gift_autodecline;
    if (s.wb_channel) document.getElementById('setting-wb-channel').value = s.wb_channel;
    if (s.wb_handler) document.getElementById('setting-wb-handler').value = s.wb_handler;
  } catch(e) { console.error(e); }
}

async function saveComplianceSettings() {
  const d = { primary_jurisdiction:v('setting-primary-jurisdiction'), extra_jurisdictions:v('setting-extra-jurisdictions'), gift_threshold:v('setting-gift-threshold'), gift_autodecline:v('setting-gift-autodecline'), wb_channel:v('setting-wb-channel'), wb_handler:v('setting-wb-handler') };
  try { await api('POST','/api/compliance/settings',d); toast('Settings saved',false,true); } catch(e){toast(e.message,'err');}
}

// ── Dashboard badges ──────────────────────────────────────────────────────
function loadDashboardBadges() {
  const d = STATE.dashboard;
  if (!d) return;
  const gdprUrgent = (d.gdpr?.dsr_overdue||0)+(d.gdpr?.breach_active||0)+(d.gdpr?.ropa_overdue||0);
  updateBadge('sb-compliance-badge', gdprUrgent);
}

// ── Export ────────────────────────────────────────────────────────────────
function toggleExportMenu(btn) {
  const dd = btn.nextElementSibling;
  const isOpen = dd.style.display === 'block';
  document.querySelectorAll('.export-dd').forEach(d => d.style.display = 'none');
  if (!isOpen) dd.style.display = 'block';
}
document.addEventListener('click', function(e) {
  if (!e.target.closest('.export-menu-wrap'))
    document.querySelectorAll('.export-dd').forEach(d => d.style.display = 'none');
});

let _pendingExport = null; // { register, format }

async function dlExport(register, format) {
  document.querySelectorAll('.export-dd').forEach(d => d.style.display = 'none');
  // Fetch legal entities from Corporate Housekeeping
  try {
    const r = await fetch('/api/corp/entities');
    const d = await r.json();
    const entities = Array.isArray(d) ? d : (d.entities || d.data || []);
    if (entities.length === 0) {
      // No entities — export with session firm name
      window.location.href = `/api/compliance/export/${register}?format=${format}`;
    } else if (entities.length === 1) {
      // One entity — use it directly
      const name = encodeURIComponent(entities[0].name || entities[0].legal_name || '');
      window.location.href = `/api/compliance/export/${register}?format=${format}&entity_name=${name}`;
    } else {
      // Multiple entities — show picker
      _pendingExport = { register, format };
      const sel = document.getElementById('entity-picker-select');
      sel.innerHTML = entities.map(e => `<option value="${esc(e.name||e.legal_name||'')}">${esc(e.name||e.legal_name||'')}${e.legal_form?' — '+esc(e.legal_form):''}</option>`).join('');
      openModal('modal-entity-picker');
    }
  } catch(err) {
    // On any error fall back to session firm name
    window.location.href = `/api/compliance/export/${register}?format=${format}`;
  }
}

function doExportWithEntity() {
  if (!_pendingExport) return;
  const name = document.getElementById('entity-picker-select').value;
  closeModal('modal-entity-picker');
  window.location.href = `/api/compliance/export/${_pendingExport.register}?format=${_pendingExport.format}&entity_name=${encodeURIComponent(name)}`;
  _pendingExport = null;
}

function exportRegister(type, format) { dlExport(type, format || 'xlsx'); }
function exportAudit(module) { dlExport(module, 'xlsx'); }

// ── AI Import ─────────────────────────────────────────────────────────────
let _importRegister = null;
let _importMappedData = null;

function openImport(register) {
  _importRegister = register;
  _importMappedData = null;
  importReset();
  openModal('modal-import');
}

function importReset() {
  _importMappedData = null;
  document.getElementById('import-step-upload').style.display = '';
  document.getElementById('import-step-loading').style.display = 'none';
  document.getElementById('import-step-preview').style.display = 'none';
  document.getElementById('import-step-error').style.display = 'none';
  document.getElementById('import-upload-btn').style.display = '';
  document.getElementById('import-confirm-btn').style.display = 'none';
  document.getElementById('import-file-name').textContent = '';
  document.getElementById('import-file-input').value = '';
  if (!_importRegister) closeModal('modal-import');
}

function importHandleDrop(e) {
  e.preventDefault();
  e.currentTarget.style.borderColor = 'var(--cream-dark)';
  const file = e.dataTransfer.files[0];
  if (file) { document.getElementById('import-file-input').files = e.dataTransfer.files; importFileSelected({files:[file]}); }
}

function importFileSelected(input) {
  const file = input.files && input.files[0];
  if (!file) return;
  document.getElementById('import-file-name').textContent = file.name + ' (' + (file.size/1024).toFixed(1) + ' KB)';
}

async function importUpload() {
  const fileInput = document.getElementById('import-file-input');
  const file = fileInput.files && fileInput.files[0];
  if (!file) { toast('Please select a file first', true); return; }
  const allowed = ['.xlsx','.docx'];
  if (!allowed.some(ext => file.name.toLowerCase().endsWith(ext))) {
    toast('Only .xlsx and .docx files are supported', true); return;
  }
  document.getElementById('import-step-upload').style.display = 'none';
  document.getElementById('import-step-loading').style.display = '';
  document.getElementById('import-upload-btn').style.display = 'none';

  const formData = new FormData();
  formData.append('file', file);

  try {
    const r = await fetch(`/api/compliance/import/${_importRegister}`, { method: 'POST', body: formData });
    const d = await r.json();
    document.getElementById('import-step-loading').style.display = 'none';
    if (!r.ok || d.error) {
      document.getElementById('import-step-error').style.display = '';
      document.getElementById('import-error-msg').textContent = d.error || 'Something went wrong. Please try a different file.';
      document.getElementById('import-upload-btn').style.display = '';
      return;
    }
    _importMappedData = d.records;
    const mappings = d.mappings || [];
    const skipped = d.skipped_columns || [];
    // Show mapping info
    document.getElementById('import-mapping-info').innerHTML =
      `<strong>${d.records.length}</strong> record${d.records.length!==1?'s':''} found · ` +
      `<strong>${mappings.length}</strong> column${mappings.length!==1?'s':''} mapped` +
      (skipped.length ? ` · <span style="color:var(--amber)">${skipped.length} column${skipped.length!==1?'s':''} skipped (no match found)</span>` : '');
    // Build preview table
    const headers = d.preview_headers || [];
    const rows = d.preview_rows || [];
    document.getElementById('import-preview-head').innerHTML = '<tr>' + headers.map(h=>`<th style="padding:6px 10px;font-weight:600;font-size:10px;white-space:nowrap;">${esc(h)}</th>`).join('') + '</tr>';
    document.getElementById('import-preview-body').innerHTML = rows.map((row,i)=>
      `<tr style="background:${i%2===0?'var(--cream)':'#fff'}">${row.map(v=>`<td style="padding:5px 10px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(v)}">${esc(v)}</td>`).join('')}</tr>`
    ).join('');
    if (skipped.length) {
      document.getElementById('import-skipped-note').textContent = 'Skipped columns: ' + skipped.join(', ');
    }
    document.getElementById('import-count').textContent = d.records.length;
    document.getElementById('import-step-preview').style.display = '';
    document.getElementById('import-confirm-btn').style.display = '';
  } catch(err) {
    document.getElementById('import-step-loading').style.display = 'none';
    document.getElementById('import-step-error').style.display = '';
    document.getElementById('import-error-msg').textContent = 'Network error — please try again.';
    document.getElementById('import-upload-btn').style.display = '';
  }
}

async function importConfirm() {
  if (!_importMappedData || !_importRegister) return;
  document.getElementById('import-confirm-btn').disabled = true;
  document.getElementById('import-confirm-btn').textContent = 'Importing…';
  try {
    const r = await fetch(`/api/compliance/import/${_importRegister}/confirm`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ records: _importMappedData })
    });
    const d = await r.json();
    if (!r.ok || d.error) { toast(d.error || 'Import failed', true); }
    else {
      closeModal('modal-import');
      toast(`${d.imported} record${d.imported!==1?'s':''} imported successfully`, false, true);
      // Reload the relevant module data
      loadModuleData(STATE.currentModule);
    }
  } catch(e) { toast('Network error during import', true); }
  document.getElementById('import-confirm-btn').disabled = false;
  document.getElementById('import-confirm-btn').textContent = 'Import ' + (_importMappedData?.length||0) + ' records';
}

// ── Utilities ─────────────────────────────────────────────────────────────
// (defined in main app)
// (defined in main app)
// (defined in main app)
function trunc(s,n){return s&&s.length>n?s.substring(0,n)+'\u2026':s||'';}
function fmtDate(d) { if(!d)return'—'; try{return new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});}catch{return d;} }
function fmtDateTime(d) { if(!d)return'—'; try{return new Date(d).toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});}catch{return d;} }
function reviewClass(d) { const days=daysUntil(d); return days!==null&&days<0?'color:var(--red)':days!==null&&days<30?'color:var(--amber)':''; }
function daysUntil(d) { if(!d)return null; try{return Math.round((new Date(d)-new Date())/86400000);}catch{return null;} }
function ragCounts(arr, field) { return {red:arr.filter(r=>r[field]==='red').length,amber:arr.filter(r=>r[field]==='amber').length,green:arr.filter(r=>r[field]==='green').length}; }
function rowClass(rag) { return rag==='red'?'row-red':rag==='amber'?'row-amber':''; }
function ragCard(num,label,colour) {
  const cols = {red:'var(--red)',amber:'var(--amber)',green:'var(--success)',muted:'var(--text-muted)',blue:'var(--blue)'};
  const bgs = {red:'',amber:'',green:'',muted:'background:var(--cream);',blue:'background:var(--blue-bg);border-color:var(--blue-border);'};
  return `<div class="rag-card" style="${bgs[colour]||''}"><div class="rag-dot" style="background:${cols[colour]||cols.muted}"></div><div><div class="rag-num" style="color:${cols[colour]||cols.muted}">${num}</div><div class="rag-label">${label}</div></div></div>`;
}
function daysLeft(days) {
  if (days===null||days===undefined) return '—';
  if (days<0) return `<span style="color:var(--red);font-size:11px;font-weight:600">${Math.abs(days)}d overdue</span>`;
  if (days===0) return `<span style="color:var(--red);font-size:11px;font-weight:600">Due today</span>`;
  return `<span style="color:${days<=7?'var(--red)':days<=14?'var(--amber)':'var(--text-muted)'};font-size:11.5px">${days}d</span>`;
}
function dlBadge(days, date, warn=30) {
  if (!date) return '—';
  const cls = days===null?'dl-ok':days<0?'dl-red':days<=warn?'dl-amber':'dl-ok';
  const label = days===null?fmtDate(date):days<0?Math.abs(days)+'d overdue':days===0?'Today':days+'d · '+fmtDate(date);
  return `<div class="dl ${cls}">${clockIcon()}${label}</div>`;
}
function clockIcon() { return `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`; }
function docIconSvg() { return `<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`; }
function infoIconSvg() { return `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`; }
function radarIconSvg() { return `<svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`; }
function bookIconSvg() { return `<svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>`; }
function updateBadge(id, count, cls) {
  const el = document.getElementById(id);
  if (!el) return;
  if (count > 0) { el.textContent=count; el.style.display='inline-block'; if(cls) el.className='nav-badge '+cls; }
  else { el.style.display='none'; }
}
function filterTable(tableId, search) {
  const rows = document.querySelectorAll('#'+tableId+' tbody tr');
  rows.forEach(r=>{ r.style.display=r.textContent.toLowerCase().includes(search.toLowerCase())?'':'none'; });
}
function filterChip(chip, tableId, value, attr) {
  chip.closest('.filter-bar').querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  if (!value) { document.querySelectorAll('#'+tableId+' tbody tr').forEach(r=>r.style.display=''); return; }
  document.querySelectorAll('#'+tableId+' tbody tr').forEach(r=>{ r.style.display=(r.dataset[attr]||'').toLowerCase()===value?'':'none'; });
}
function resetForm(modalId) {
  document.querySelectorAll('#'+modalId+' input:not([type=hidden]),#'+modalId+' textarea').forEach(el=>el.value='');
  document.querySelectorAll('#'+modalId+' select').forEach(el=>el.selectedIndex=0);
}
function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// Toast
// toast: defined in main app

// Sidebar nav to settings
document.getElementById('sb-settings')?.addEventListener('click', e=>{ e.preventDefault(); setModule('settings'); });

</script>
</body>
</html>
